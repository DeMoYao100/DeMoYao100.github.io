<!doctypehtml><html lang=en><meta charset=UTF-8><meta content=width=device-width,initial-scale=1,maximum-scale=2 name=viewport><meta content=#222 name=theme-color><meta content=IE=edge,chrome=1 http-equiv=X-UA-COMPATIBLE><meta content=webkit name=renderer><link href=/assets/favicon.ico rel=icon sizes=32x32 type=image/ico><link href=/assets/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/rss.xml rel=alternate title=rev@天枢 type=application/rss+xml><link href=/atom.xml rel=alternate title=rev@天枢 type=application/atom+xml><link href=https://demoyao100.github.io/feed.json rel=alternate title=rev@天枢 type=application/json><link href=https://lf9-cdn-tos.bytecdntp.com rel=preconnect><link href=https://cdn.jsdelivr.net rel=dns-prefetch><link href=https://unpkg.com rel=dns-prefetch><link href=https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext rel=stylesheet><link href=/css/app.css?v=0.3.15 rel=stylesheet><link href=https://demoyao100.github.io/2024/04/27/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/ rel=canonical><title>frida源码初探</title><meta content="Hexo 7.0.0" name=generator><body itemscope itemtype=http://schema.org/WebPage><div id=loading><div class=cat><div class=body></div><div class=head><div class=face></div></div><div class=foot><div class=tummy-end></div><div class=bottom></div><div class="legs left"></div><div class="legs right"></div></div><div class=paw><div class="hands left"></div><div class="hands right"></div></div></div></div><div id=container><header id=header itemscope itemtype=http://schema.org/WPHeader><div class=inner><div id=brand><div class=pjax><h1 itemprop="name headline">frida源码初探</h1><div class=meta><span title="Created: 2024-04-27 17:09:00" class=item><span class=icon><i class="ic i-calendar"></i></span><span class=text>Posted on</span><time itemprop="dateCreated datePublished" datetime=2024-04-27T17:09:00+08:00>2024-04-27</time></span><span title="Symbols count in article" class=item><span class=icon><i class="ic i-pen"></i></span><span class=text>Symbols count in article</span><span>19k</span><span class=text>words</span></span><span title="Reading time" class=item><span class=icon><i class="ic i-clock"></i></span><span class=text>Reading time</span><span>17 mins.</span></span></div></div></div><nav id=nav><div class=inner><div class=toggle><div aria-label="Toggle navigation bar" class=lines><span class=line></span><span class=line></span><span class=line></span></div></div><ul class=menu><li class="item title"><a href=/ rel=start>Moyao の小屋</a></ul><ul class=right id=rightNav><li class="item theme" @click=changeThemeByBtn><i :class="{'i-sun': !themeStatus,'i-moon': themeStatus}" class=ic></i><li class="item search"><i class="ic i-search"></i></ul></div></nav></div><div class=pjax id=imgs><img src=https://tva4.sinaimg.cn/mw690/6833939bly1gicit4jrvuj20zk0m8785.jpg></div></header><div id=waves><svg viewbox="0 24 150 28" class=waves preserveaspectratio=none shape-rendering=auto xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><defs><path d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" id=gentle-wave></path></defs><g class=parallax><use x=48 xlink:href=#gentle-wave y=0></use><use x=48 xlink:href=#gentle-wave y=3></use><use x=48 xlink:href=#gentle-wave y=5></use><use x=48 xlink:href=#gentle-wave y=7></use></g></svg></div><main><div class=inner><div class=pjax id=main><div class="article wrap"><div class=breadcrumb itemlistelement itemscope itemtype=https://schema.org/BreadcrumbList><i class="ic i-home"></i><span><a href=/>Home</a></span></div><article class="post block" itemscope itemtype=http://schema.org/Article lang=en><link href=https://demoyao100.github.io/2024/04/27/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta content=/assets/avatar.jpg itemprop=image><meta content=Moyao itemprop=name><meta content="Hi,I'm Moyaoxue, Write down something interesting I met<br />
Feel free to mail me if you have something wanted to talk about, plz
mail: &amplt;moyaoxue@outlook.com&ampgt;
" itemprop=description></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta content=rev@天枢 itemprop=name></span><div class="body md" itemprop=articleBody><h6 id=preface被拷打到frida和xpose的原理啥的啥啥不会爬来赶紧学学><a class=anchor href=#preface被拷打到frida和xpose的原理啥的啥啥不会爬来赶紧学学>#</a> PREFACE：被拷打到 frida 和 xpose 的原理啥的，啥啥不会，爬来赶紧学学</h6><p><span id=more></span><h3 id=总览><a class=anchor href=#总览>#</a> 总览</h3><p>首先是一整个<a href=https://github.com/frida/frida rel=noopener target=_blank> frida</a> 项目可以分为这些 subprojects：<ul><li><a href=https://github.com/frida/frida-clr rel=noopener target=_blank>frida-clr</a>：Frida .NET bindings<li><a href=https://github.com/frida/frida-core/tree/da417fd46b4fd7af8f157498e9e5f38e6242be45 rel=noopener target=_blank>frida-core</a>：Frida core library intended for static linking into bindings<li><a href=https://github.com/frida/frida-go/tree/fd52f64f49fbbde2820e02e6e6dd3aafd1ac0ce6 rel=noopener target=_blank>frida-go</a>：Frida Go bindings<li><a href=https://github.com/frida/frida-gum/tree/c385fac6e3b2512c64e10e3e039f2a7be6995ab9 rel=noopener target=_blank>frida-gum</a>：Cross-platform instrumentation and introspection library written in C<li><a href=https://github.com/frida/frida-node/tree/72b815e0fc7fb3ab4dc90e9532739b6dc99c3b8f rel=noopener target=_blank>frida-node</a>：Frida Node.js bindings<li><a href=https://github.com/frida/frida-python/tree/91e2e4ff54d7afa4a2d3660019da981e92967e8f rel=noopener target=_blank>frida-python</a>：Frida Python bindings<li><a href=https://github.com/frida/frida-qml/tree/5c8eb8c84a5f808cb109e67e80e8e77c4f80da77 rel=noopener target=_blank>frida-qml</a>：Frida Qml plugin<li><a href=https://github.com/frida/frida-swift/tree/ce8f781ef000b7bfc9f90f942df2d0c973d4f52b rel=noopener target=_blank>frida-swift</a>：Frida Swift bindings<li><a href=https://github.com/frida/frida-tools/tree/49f4330d8fde4e5250ac78f35ea71b4d7441fdb6 rel=noopener target=_blank>frida-tools</a>：Frida CLI tools</ul><p>感觉网上许多文章都着重在看 frida-core 和 frida-gum，那么就先看看这两部分<h3 id=frida-gum><a class=anchor href=#frida-gum>#</a> frida-gum</h3><p>分析过程中感觉直接干看还是有点困难，这里先整理一些 frida 所实现的功能，对照着功能看进去<h4 id=一-前置原理><a class=anchor href=#一-前置原理>#</a> 一、前置原理</h4><h5 id=11-inline-hook><a class=anchor href=#11-inline-hook>#</a> 1.1 inline hook</h5><p>​ 我们可以使用 Frida 的 API 在程序运行时拦截函数的调用，并且在拦截到函数调用时，通过修改函数的参数或者返回值来改变程序的行为。<p>​ 这里的核心原理是：动态替换需要 Hook 的指令片段为一段经过设计的跳板指令，即 trampoline ，目标为我们设计好的一段 shellCode，这里可以看 [<a href=https://bbs.kanxue.com/thread-273273.htm rel=noopener target=_blank>原创] Frida inlineHook 原理分析及简单设计一款 AArch64 inlineHook 工具 - Android 安全 - 看雪 - 安全社区 | 安全招聘 | kanxue.com</a> 这篇文章对于 Frida 生成的 shellcode 进行了详细的研究，暂时没有进行复现，先纸面学习，大概需要注意的点是：<ul><li>frida 寻找前后 128MB 的地址获取一个空闲地址，将 hook 的点的前 16 个字节（或 4 字节）替换掉为 LDR 和 BR 指令，并且利用 x16 寄存器作为 trampoline 跳板<li>第一段跳板跳到 shellcode 后 mmap 一段匿名内存，保存当前寄存器状态与用于写入第二段跳板指令<li>然后是 onenter 和 onleave 的编写，注入 shellcode 实现需求的逻辑即可（这里是简易的核心原理，后面代码会复杂很多）</ul><h6 id=12-inline-hook-检测><a class=anchor href=#12-inline-hook-检测>#</a> 1.2 inline hook 检测</h6><p>恰好学习的时候搜到<a href=https://www.cnblogs.com/r0ysue/p/15424821.html rel=noopener target=_blank>这篇文章</a>，一块记录了<p>​ 既然 frida 会生成 trampoline 和 shellcode，那么有个很简单的方法：开一个线程，检查函数开头有没有被替换过，并且有没有被替换成类似 BR 到 shellcode 的格式<h4 id=二-源码><a class=anchor href=#二-源码>#</a> 二、源码</h4><p>readme 描述：<p>Cross-platform instrumentation and introspection library written in C.<p>This library is consumed by <a href=https://github.com/frida/frida-core rel=noopener target=_blank>frida-core</a> through its JavaScript bindings, <a href=https://github.com/frida/frida-gum/tree/master/bindings/gumjs rel=noopener target=_blank>GumJS</a>.<p>然后文档有大概给出不同部分的功能（词汇量稍微有点不够咳咳）不过直接看着稍微有点没头绪，先看看<a href=https://o0xmuhe.github.io/2019/11/15/frida-gum%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/ rel=noopener target=_blank>别人的分析</a>，这篇写的不错)<p>偷看一下别人的阅读思路：<p><img alt=image-20240428202138661 data-src=frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/image-20240428202138661.png loading=lazy><p>首先有个 meson.build 构建文件，其中可以先看 gumtest.c 这一测试运行器（根据 testcase 递归看进代码）<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre>runner_sources <span class="token operator">=</span> <span class="token punctuation">[</span></pre><tr><td data-num=2><td><pre>  <span class="token char">'gumtest.c'</span><span class="token punctuation">,</span></pre><tr><td data-num=3><td><pre>  <span class="token char">'testutil.c'</span><span class="token punctuation">,</span></pre><tr><td data-num=4><td><pre>  <span class="token char">'stubs'</span> <span class="token operator">/</span> <span class="token char">'dummyclasses.c'</span><span class="token punctuation">,</span></pre><tr><td data-num=5><td><pre>  <span class="token char">'stubs'</span> <span class="token operator">/</span> <span class="token char">'fakebacktracer.c'</span><span class="token punctuation">,</span></pre><tr><td data-num=6><td><pre>  <span class="token char">'stubs'</span> <span class="token operator">/</span> <span class="token char">'fakeeventsink.c'</span><span class="token punctuation">,</span></pre><tr><td data-num=7><td><pre>  <span class="token char">'stalkerdummychannel.c'</span><span class="token punctuation">,</span></pre><tr><td data-num=8><td><pre>  <span class="token char">'lowlevelhelpers.c'</span><span class="token punctuation">,</span></pre><tr><td data-num=9><td><pre><span class="token punctuation">]</span></pre></table></figure><h5 id=gumtestc><a class=anchor href=#gumtestc>#</a> gumtest.c</h5><p>前面一大段代码根据宏来判断，是用于根据平台信息做初始化的<p>标记一个核心对象先：<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">struct</span> <span class="token class-name">_GumInterceptor</span></pre><tr><td data-num=2><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=3><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">GUM_DIET</span></span></pre><tr><td data-num=4><td><pre>  GObject parent<span class="token punctuation">;</span></pre><tr><td data-num=5><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre><tr><td data-num=6><td><pre>  GumObject parent<span class="token punctuation">;</span></pre><tr><td data-num=7><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre>  GRecMutex mutex<span class="token punctuation">;</span></pre><tr><td data-num=10><td><pre></pre><tr><td data-num=11><td><pre>  GHashTable <span class="token operator">*</span> function_by_address<span class="token punctuation">;</span></pre><tr><td data-num=12><td><pre></pre><tr><td data-num=13><td><pre>  GumInterceptorBackend <span class="token operator">*</span> backend<span class="token punctuation">;</span></pre><tr><td data-num=14><td><pre>  GumCodeAllocator allocator<span class="token punctuation">;</span></pre><tr><td data-num=15><td><pre></pre><tr><td data-num=16><td><pre>  <span class="token keyword">volatile</span> guint selected_thread_id<span class="token punctuation">;</span></pre><tr><td data-num=17><td><pre></pre><tr><td data-num=18><td><pre>  GumInterceptorTransaction current_transaction<span class="token punctuation">;</span></pre><tr><td data-num=19><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></table></figure><p>拦截器初始化<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre>GumInterceptor <span class="token operator">*</span></pre><tr><td data-num=2><td><pre><span class="token function">gum_interceptor_obtain</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=4><td><pre>  GumInterceptor <span class="token operator">*</span> interceptor<span class="token punctuation">;</span></pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre>  <span class="token function">g_mutex_lock</span> <span class="token punctuation">(</span><span class="token operator">&</span>_gum_interceptor_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=7><td><pre></pre><tr><td data-num=8><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">GUM_DIET</span></span></pre><tr><td data-num=9><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>_the_interceptor <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=11><td><pre>    interceptor <span class="token operator">=</span> <span class="token function">GUM_INTERCEPTOR</span> <span class="token punctuation">(</span><span class="token function">g_object_ref</span> <span class="token punctuation">(</span>_the_interceptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=12><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=13><td><pre>  <span class="token keyword">else</span></pre><tr><td data-num=14><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=15><td><pre>    _the_interceptor <span class="token operator">=</span> <span class="token function">g_object_new</span> <span class="token punctuation">(</span>GUM_TYPE_INTERCEPTOR<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=16><td><pre>    <span class="token function">g_object_weak_ref</span> <span class="token punctuation">(</span><span class="token function">G_OBJECT</span> <span class="token punctuation">(</span>_the_interceptor<span class="token punctuation">)</span><span class="token punctuation">,</span></pre><tr><td data-num=17><td><pre>        the_interceptor_weak_notify<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=18><td><pre></pre><tr><td data-num=19><td><pre>    interceptor <span class="token operator">=</span> _the_interceptor<span class="token punctuation">;</span></pre><tr><td data-num=20><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=21><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre><tr><td data-num=22><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>_the_interceptor <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre><tr><td data-num=23><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=24><td><pre>    interceptor <span class="token operator">=</span> <span class="token function">gum_object_ref</span> <span class="token punctuation">(</span>_the_interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=25><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=26><td><pre>  <span class="token keyword">else</span></pre><tr><td data-num=27><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=28><td><pre>    _the_interceptor <span class="token operator">=</span> <span class="token function">g_new0</span> <span class="token punctuation">(</span>GumInterceptor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=29><td><pre>    _the_interceptor<span class="token operator">-></span>parent<span class="token punctuation">.</span>ref_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre><tr><td data-num=30><td><pre>    _the_interceptor<span class="token operator">-></span>parent<span class="token punctuation">.</span>finalize <span class="token operator">=</span> gum_interceptor_finalize<span class="token punctuation">;</span></pre><tr><td data-num=31><td><pre>    <span class="token function">gum_interceptor_init</span> <span class="token punctuation">(</span>_the_interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=32><td><pre></pre><tr><td data-num=33><td><pre>    interceptor <span class="token operator">=</span> _the_interceptor<span class="token punctuation">;</span></pre><tr><td data-num=34><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=35><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre><tr><td data-num=36><td><pre></pre><tr><td data-num=37><td><pre>  <span class="token function">g_mutex_unlock</span> <span class="token punctuation">(</span><span class="token operator">&</span>_gum_interceptor_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=38><td><pre></pre><tr><td data-num=39><td><pre>  <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span></pre><tr><td data-num=40><td><pre><span class="token punctuation">}</span></pre></table></figure><p>attach 上函数的方法：<p>传入地址，调用 <code>gum_interceptor_resolve</code> ，这里的 <code>gum_interceptor_instrument</code> 后面也会看<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre>GumAttachReturn</pre><tr><td data-num=2><td><pre><span class="token function">gum_interceptor_attach</span> <span class="token punctuation">(</span>GumInterceptor <span class="token operator">*</span> self<span class="token punctuation">,</span></pre><tr><td data-num=3><td><pre>                        gpointer function_address<span class="token punctuation">,</span></pre><tr><td data-num=4><td><pre>                        GumInvocationListener <span class="token operator">*</span> listener<span class="token punctuation">,</span></pre><tr><td data-num=5><td><pre>                        gpointer listener_function_data<span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=7><td><pre>  GumAttachReturn result <span class="token operator">=</span> GUM_ATTACH_OK<span class="token punctuation">;</span></pre><tr><td data-num=8><td><pre>  GumFunctionContext <span class="token operator">*</span> function_ctx<span class="token punctuation">;</span></pre><tr><td data-num=9><td><pre>  GumInstrumentationError error<span class="token punctuation">;</span></pre><tr><td data-num=10><td><pre></pre><tr><td data-num=11><td><pre>  <span class="token function">gum_interceptor_ignore_current_thread</span> <span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=12><td><pre>  <span class="token function">GUM_INTERCEPTOR_LOCK</span> <span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=13><td><pre>  <span class="token function">gum_interceptor_transaction_begin</span> <span class="token punctuation">(</span><span class="token operator">&</span>self<span class="token operator">-></span>current_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=14><td><pre>  self<span class="token operator">-></span>current_transaction<span class="token punctuation">.</span>is_dirty <span class="token operator">=</span> TRUE<span class="token punctuation">;</span></pre><tr><td data-num=15><td><pre></pre><tr><td data-num=16><td><pre>  function_address <span class="token operator">=</span> <span class="token function">gum_interceptor_resolve</span> <span class="token punctuation">(</span>self<span class="token punctuation">,</span> function_address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=17><td><pre></pre><tr><td data-num=18><td><pre>  function_ctx <span class="token operator">=</span> <span class="token function">gum_interceptor_instrument</span> <span class="token punctuation">(</span>self<span class="token punctuation">,</span> GUM_INTERCEPTOR_TYPE_DEFAULT<span class="token punctuation">,</span></pre><tr><td data-num=19><td><pre>      function_address<span class="token punctuation">,</span> <span class="token operator">&</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=20><td><pre></pre><tr><td data-num=21><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>function_ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre><tr><td data-num=22><td><pre>    <span class="token keyword">goto</span> instrumentation_error<span class="token punctuation">;</span></pre><tr><td data-num=23><td><pre></pre><tr><td data-num=24><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gum_function_context_has_listener</span> <span class="token punctuation">(</span>function_ctx<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=25><td><pre>    <span class="token keyword">goto</span> already_attached<span class="token punctuation">;</span></pre><tr><td data-num=26><td><pre></pre><tr><td data-num=27><td><pre>  <span class="token function">gum_function_context_add_listener</span> <span class="token punctuation">(</span>function_ctx<span class="token punctuation">,</span> listener<span class="token punctuation">,</span></pre><tr><td data-num=28><td><pre>      listener_function_data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=29><td><pre></pre><tr><td data-num=30><td><pre>  <span class="token keyword">goto</span> beach<span class="token punctuation">;</span></pre><tr><td data-num=31><td><pre></pre><tr><td data-num=32><td><pre>instrumentation_error<span class="token operator">:</span></pre><tr><td data-num=33><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=34><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span></pre><tr><td data-num=35><td><pre>    <span class="token punctuation">{</span></pre><tr><td data-num=36><td><pre>      <span class="token keyword">case</span> GUM_INSTRUMENTATION_ERROR_WRONG_SIGNATURE<span class="token operator">:</span></pre><tr><td data-num=37><td><pre>        result <span class="token operator">=</span> GUM_ATTACH_WRONG_SIGNATURE<span class="token punctuation">;</span></pre><tr><td data-num=38><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre><tr><td data-num=39><td><pre>      <span class="token keyword">case</span> GUM_INSTRUMENTATION_ERROR_POLICY_VIOLATION<span class="token operator">:</span></pre><tr><td data-num=40><td><pre>        result <span class="token operator">=</span> GUM_ATTACH_POLICY_VIOLATION<span class="token punctuation">;</span></pre><tr><td data-num=41><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre><tr><td data-num=42><td><pre>      <span class="token keyword">case</span> GUM_INSTRUMENTATION_ERROR_WRONG_TYPE<span class="token operator">:</span></pre><tr><td data-num=43><td><pre>        result <span class="token operator">=</span> GUM_ATTACH_WRONG_TYPE<span class="token punctuation">;</span></pre><tr><td data-num=44><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre><tr><td data-num=45><td><pre>      <span class="token keyword">default</span><span class="token operator">:</span></pre><tr><td data-num=46><td><pre>        <span class="token function">g_assert_not_reached</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=47><td><pre>    <span class="token punctuation">}</span></pre><tr><td data-num=48><td><pre>    <span class="token keyword">goto</span> beach<span class="token punctuation">;</span></pre><tr><td data-num=49><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=50><td><pre>already_attached<span class="token operator">:</span></pre><tr><td data-num=51><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=52><td><pre>    result <span class="token operator">=</span> GUM_ATTACH_ALREADY_ATTACHED<span class="token punctuation">;</span></pre><tr><td data-num=53><td><pre>    <span class="token keyword">goto</span> beach<span class="token punctuation">;</span></pre><tr><td data-num=54><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=55><td><pre>beach<span class="token operator">:</span></pre><tr><td data-num=56><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=57><td><pre>    <span class="token function">gum_interceptor_transaction_end</span> <span class="token punctuation">(</span><span class="token operator">&</span>self<span class="token operator">-></span>current_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=58><td><pre>    <span class="token function">GUM_INTERCEPTOR_UNLOCK</span> <span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=59><td><pre>    <span class="token function">gum_interceptor_unignore_current_thread</span> <span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=60><td><pre></pre><tr><td data-num=61><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre><tr><td data-num=62><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=63><td><pre><span class="token punctuation">}</span></pre></table></figure><p>跟进看这里的实现<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">static</span> gpointer</pre><tr><td data-num=2><td><pre><span class="token function">gum_interceptor_resolve</span> <span class="token punctuation">(</span>GumInterceptor <span class="token operator">*</span> self<span class="token punctuation">,</span></pre><tr><td data-num=3><td><pre>                         gpointer address<span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=5><td><pre>  address <span class="token operator">=</span> <span class="token function">gum_strip_code_pointer</span> <span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">gum_interceptor_has</span> <span class="token punctuation">(</span>self<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=9><td><pre>    <span class="token keyword">const</span> gsize max_redirect_size <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span></pre><tr><td data-num=10><td><pre>    gpointer target<span class="token punctuation">;</span></pre><tr><td data-num=11><td><pre></pre><tr><td data-num=12><td><pre>    <span class="token function">gum_ensure_code_readable</span> <span class="token punctuation">(</span>address<span class="token punctuation">,</span> max_redirect_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=13><td><pre></pre><tr><td data-num=14><td><pre>    <span class="token comment">/* Avoid following grafted branches. */</span></pre><tr><td data-num=15><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gum_process_get_code_signing_policy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> GUM_CODE_SIGNING_REQUIRED<span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre>      <span class="token keyword">return</span> address<span class="token punctuation">;</span></pre><tr><td data-num=17><td><pre></pre><tr><td data-num=18><td><pre>    target <span class="token operator">=</span> <span class="token function">_gum_interceptor_backend_resolve_redirect</span> <span class="token punctuation">(</span>self<span class="token operator">-></span>backend<span class="token punctuation">,</span></pre><tr><td data-num=19><td><pre>        address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=20><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre><tr><td data-num=21><td><pre>      <span class="token keyword">return</span> <span class="token function">gum_interceptor_resolve</span> <span class="token punctuation">(</span>self<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=22><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=23><td><pre></pre><tr><td data-num=24><td><pre>  <span class="token keyword">return</span> address<span class="token punctuation">;</span></pre><tr><td data-num=25><td><pre><span class="token punctuation">}</span></pre></table></figure><p>可以进到：这部分是比较核心的生成跳转 shellcode 的部分，或许也可以从这部分下手来考虑对抗？(TODO+1)<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre>gpointer</pre><tr><td data-num=2><td><pre><span class="token function">gum_arm64_reader_try_get_relative_jump_target</span> <span class="token punctuation">(</span>gconstpointer address<span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=4><td><pre>  gpointer result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre><tr><td data-num=5><td><pre>  csh capstone<span class="token punctuation">;</span></pre><tr><td data-num=6><td><pre>  cs_insn <span class="token operator">*</span> insn<span class="token punctuation">;</span></pre><tr><td data-num=7><td><pre>  <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> code<span class="token punctuation">;</span></pre><tr><td data-num=8><td><pre>  size_t size<span class="token punctuation">;</span></pre><tr><td data-num=9><td><pre>  <span class="token keyword">uint64_t</span> pc<span class="token punctuation">;</span></pre><tr><td data-num=10><td><pre>  <span class="token keyword">const</span> cs_arm64_op <span class="token operator">*</span> ops<span class="token punctuation">;</span></pre><tr><td data-num=11><td><pre></pre><tr><td data-num=12><td><pre>  <span class="token function">cs_arch_register_arm64</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=13><td><pre>  <span class="token function">cs_open</span> <span class="token punctuation">(</span>CS_ARCH_ARM64<span class="token punctuation">,</span> GUM_DEFAULT_CS_ENDIAN<span class="token punctuation">,</span> <span class="token operator">&</span>capstone<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=14><td><pre>  <span class="token function">cs_option</span> <span class="token punctuation">(</span>capstone<span class="token punctuation">,</span> CS_OPT_DETAIL<span class="token punctuation">,</span> CS_OPT_ON<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=15><td><pre></pre><tr><td data-num=16><td><pre>  insn <span class="token operator">=</span> <span class="token function">cs_malloc</span> <span class="token punctuation">(</span>capstone<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=17><td><pre></pre><tr><td data-num=18><td><pre>  code <span class="token operator">=</span> address<span class="token punctuation">;</span></pre><tr><td data-num=19><td><pre>  size <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span></pre><tr><td data-num=20><td><pre>  pc <span class="token operator">=</span> <span class="token function">GPOINTER_TO_SIZE</span> <span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=21><td><pre></pre><tr><td data-num=22><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GUM_DISASM_NEXT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre><tr><td data-num=23><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cs_disasm_iter</span> <span class="token punctuation">(</span>capstone<span class="token punctuation">,</span> <span class="token operator">&</span>code<span class="token punctuation">,</span> <span class="token operator">&</span>size<span class="token punctuation">,</span> <span class="token operator">&</span>pc<span class="token punctuation">,</span> insn<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre><tr><td data-num=24><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach<span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre><tr><td data-num=25><td><pre>    <span class="token expression">ops <span class="token operator">=</span> insn<span class="token operator">-></span>detail<span class="token operator">-></span>arm64<span class="token punctuation">.</span>operands</span></pre><tr><td data-num=26><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GUM_CHECK_ID</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre><tr><td data-num=27><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>insn<span class="token operator">-></span>id <span class="token operator">!=</span> <span class="token function">G_PASTE</span> <span class="token punctuation">(</span>ARM64_INS_<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre><tr><td data-num=28><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach</span></pre><tr><td data-num=29><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GUM_CHECK_OP_TYPE</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">,</span> t<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre><tr><td data-num=30><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">!=</span> <span class="token function">G_PASTE</span> <span class="token punctuation">(</span>ARM64_OP_<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre><tr><td data-num=31><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach</span></pre><tr><td data-num=32><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GUM_CHECK_OP_REG</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">,</span> r<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre><tr><td data-num=33><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>reg <span class="token operator">!=</span> <span class="token function">G_PASTE</span> <span class="token punctuation">(</span>ARM64_REG_<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre><tr><td data-num=34><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach</span></pre><tr><td data-num=35><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GUM_CHECK_OP_MEM</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">,</span> b<span class="token punctuation">,</span> i<span class="token punctuation">,</span> d<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre><tr><td data-num=36><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token punctuation">.</span>base <span class="token operator">!=</span> <span class="token function">G_PASTE</span> <span class="token punctuation">(</span>ARM64_REG_<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre><tr><td data-num=37><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach<span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre><tr><td data-num=38><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token punctuation">.</span>index <span class="token operator">!=</span> <span class="token function">G_PASTE</span> <span class="token punctuation">(</span>ARM64_REG_<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre><tr><td data-num=39><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach<span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre><tr><td data-num=40><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token punctuation">.</span>disp <span class="token operator">!=</span> d<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre><tr><td data-num=41><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach</span></pre><tr><td data-num=42><td><pre></pre><tr><td data-num=43><td><pre>  <span class="token function">GUM_DISASM_NEXT</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=44><td><pre></pre><tr><td data-num=45><td><pre>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>insn<span class="token operator">-></span>id<span class="token punctuation">)</span></pre><tr><td data-num=46><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=47><td><pre>    <span class="token keyword">case</span> ARM64_INS_B<span class="token operator">:</span></pre><tr><td data-num=48><td><pre>      result <span class="token operator">=</span> <span class="token function">GSIZE_TO_POINTER</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=49><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre><tr><td data-num=50><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_DARWIN</span></span></pre><tr><td data-num=51><td><pre>    <span class="token keyword">case</span> ARM64_INS_ADRP<span class="token operator">:</span></pre><tr><td data-num=52><td><pre>    <span class="token punctuation">{</span></pre><tr><td data-num=53><td><pre>      GumAddress target<span class="token punctuation">;</span></pre><tr><td data-num=54><td><pre></pre><tr><td data-num=55><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X17<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=56><td><pre>      target <span class="token operator">=</span> ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imm<span class="token punctuation">;</span></pre><tr><td data-num=57><td><pre></pre><tr><td data-num=58><td><pre>      <span class="token function">GUM_DISASM_NEXT</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=59><td><pre>      <span class="token function">GUM_CHECK_ID</span> <span class="token punctuation">(</span>ADD<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=60><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X17<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=61><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> X17<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=62><td><pre>      <span class="token function">GUM_CHECK_OP_TYPE</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> IMM<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=63><td><pre>      target <span class="token operator">+=</span> ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imm<span class="token punctuation">;</span></pre><tr><td data-num=64><td><pre></pre><tr><td data-num=65><td><pre>      <span class="token function">GUM_DISASM_NEXT</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=66><td><pre>      <span class="token function">GUM_CHECK_ID</span> <span class="token punctuation">(</span>LDR<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=67><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X16<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=68><td><pre>      <span class="token function">GUM_CHECK_OP_TYPE</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> MEM<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=69><td><pre>      <span class="token function">GUM_CHECK_OP_MEM</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> X17<span class="token punctuation">,</span> INVALID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=70><td><pre></pre><tr><td data-num=71><td><pre>      <span class="token function">GUM_DISASM_NEXT</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=72><td><pre>      <span class="token function">GUM_CHECK_ID</span> <span class="token punctuation">(</span>BRAA<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=73><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X16<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=74><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> X17<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=75><td><pre></pre><tr><td data-num=76><td><pre>      result <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>gpointer <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">GSIZE_TO_POINTER</span> <span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=77><td><pre></pre><tr><td data-num=78><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre><tr><td data-num=79><td><pre>    <span class="token punctuation">}</span></pre><tr><td data-num=80><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre><tr><td data-num=81><td><pre>    <span class="token keyword">default</span><span class="token operator">:</span></pre><tr><td data-num=82><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre><tr><td data-num=83><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=84><td><pre></pre><tr><td data-num=85><td><pre>beach<span class="token operator">:</span></pre><tr><td data-num=86><td><pre>  <span class="token function">cs_free</span> <span class="token punctuation">(</span>insn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=87><td><pre></pre><tr><td data-num=88><td><pre>  <span class="token function">cs_close</span> <span class="token punctuation">(</span><span class="token operator">&</span>capstone<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=89><td><pre></pre><tr><td data-num=90><td><pre>  <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre><tr><td data-num=91><td><pre><span class="token punctuation">}</span></pre></table></figure><p>创建拦截器后端以及分配器初始化<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre><span class="token function">gum_interceptor_init</span> <span class="token punctuation">(</span>GumInterceptor <span class="token operator">*</span> self<span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=3><td><pre>  <span class="token function">g_rec_mutex_init</span> <span class="token punctuation">(</span><span class="token operator">&</span>self<span class="token operator">-></span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=4><td><pre></pre><tr><td data-num=5><td><pre>  self<span class="token operator">-></span>function_by_address <span class="token operator">=</span> <span class="token function">g_hash_table_new_full</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></pre><tr><td data-num=6><td><pre>      <span class="token punctuation">(</span>GDestroyNotify<span class="token punctuation">)</span> gum_function_context_destroy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=7><td><pre></pre><tr><td data-num=8><td><pre>  <span class="token function">gum_code_allocator_init</span> <span class="token punctuation">(</span><span class="token operator">&</span>self<span class="token operator">-></span>allocator<span class="token punctuation">,</span> GUM_INTERCEPTOR_CODE_SLICE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=9><td><pre></pre><tr><td data-num=10><td><pre>  <span class="token function">gum_interceptor_transaction_init</span> <span class="token punctuation">(</span><span class="token operator">&</span>self<span class="token operator">-></span>current_transaction<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=11><td><pre><span class="token punctuation">}</span></pre></table></figure><p>看到刚才 marked 的 <code>gum_interceptor_instrument</code> ，结合前面的代码，frida 似乎会将函数建哈希表用于寻址，并且进行了拦截器后端的初始化 <code>_gum_interceptor_backend_create</code> 以及生成跳板代码<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">static</span> GumFunctionContext <span class="token operator">*</span></pre><tr><td data-num=2><td><pre><span class="token function">gum_interceptor_instrument</span> <span class="token punctuation">(</span>GumInterceptor <span class="token operator">*</span> self<span class="token punctuation">,</span></pre><tr><td data-num=3><td><pre>                            GumInterceptorType type<span class="token punctuation">,</span></pre><tr><td data-num=4><td><pre>                            gpointer function_address<span class="token punctuation">,</span></pre><tr><td data-num=5><td><pre>                            GumInstrumentationError <span class="token operator">*</span> error<span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=7><td><pre>  GumFunctionContext <span class="token operator">*</span> ctx<span class="token punctuation">;</span></pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre>  <span class="token operator">*</span>error <span class="token operator">=</span> GUM_INSTRUMENTATION_ERROR_NONE<span class="token punctuation">;</span></pre><tr><td data-num=10><td><pre>  <span class="token comment">// 要 hook 的函数，封装成了 GumFunctionContext，此时</span></pre><tr><td data-num=11><td><pre>  <span class="token comment">// 根据 地址，得到与之对应的 GunFunctionContext 对象</span></pre><tr><td data-num=12><td><pre>  ctx <span class="token operator">=</span> <span class="token punctuation">(</span>GumFunctionContext <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">g_hash_table_lookup</span> <span class="token punctuation">(</span>self<span class="token operator">-></span>function_by_address<span class="token punctuation">,</span></pre><tr><td data-num=13><td><pre>      function_address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=14><td><pre></pre><tr><td data-num=15><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=17><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>type <span class="token operator">!=</span> type<span class="token punctuation">)</span></pre><tr><td data-num=18><td><pre>    <span class="token punctuation">{</span></pre><tr><td data-num=19><td><pre>      <span class="token operator">*</span>error <span class="token operator">=</span> GUM_INSTRUMENTATION_ERROR_WRONG_TYPE<span class="token punctuation">;</span></pre><tr><td data-num=20><td><pre>      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre><tr><td data-num=21><td><pre>    <span class="token punctuation">}</span></pre><tr><td data-num=22><td><pre>    <span class="token keyword">return</span> ctx<span class="token punctuation">;</span></pre><tr><td data-num=23><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=24><td><pre></pre><tr><td data-num=25><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-></span>backend <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre><tr><td data-num=26><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=27><td><pre>    self<span class="token operator">-></span>backend <span class="token operator">=</span></pre><tr><td data-num=28><td><pre>        <span class="token function">_gum_interceptor_backend_create</span> <span class="token punctuation">(</span><span class="token operator">&</span>self<span class="token operator">-></span>mutex<span class="token punctuation">,</span> <span class="token operator">&</span>self<span class="token operator">-></span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=29><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=30><td><pre></pre><tr><td data-num=31><td><pre>  ctx <span class="token operator">=</span> <span class="token function">gum_function_context_new</span> <span class="token punctuation">(</span>self<span class="token punctuation">,</span> function_address<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=32><td><pre></pre><tr><td data-num=33><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gum_process_get_code_signing_policy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> GUM_CODE_SIGNING_REQUIRED<span class="token punctuation">)</span></pre><tr><td data-num=34><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=35><td><pre>      <span class="token comment">// 创建跳板</span></pre><tr><td data-num=36><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_gum_interceptor_backend_claim_grafted_trampoline</span> <span class="token punctuation">(</span>self<span class="token operator">-></span>backend<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=37><td><pre>      <span class="token keyword">goto</span> policy_violation<span class="token punctuation">;</span></pre><tr><td data-num=38><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=39><td><pre>  <span class="token keyword">else</span></pre><tr><td data-num=40><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=41><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_gum_interceptor_backend_create_trampoline</span> <span class="token punctuation">(</span>self<span class="token operator">-></span>backend<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=42><td><pre>      <span class="token keyword">goto</span> wrong_signature<span class="token punctuation">;</span></pre><tr><td data-num=43><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=44><td><pre>  <span class="token comment">// 设置完成后， 添加到哈希表</span></pre><tr><td data-num=45><td><pre>  <span class="token comment">// hash_table, key, value</span></pre><tr><td data-num=46><td><pre>  <span class="token comment">//hook 函数地址，GumFunctionContext 对象对应， 方便查找</span></pre><tr><td data-num=47><td><pre>  <span class="token function">g_hash_table_insert</span> <span class="token punctuation">(</span>self<span class="token operator">-></span>function_by_address<span class="token punctuation">,</span> function_address<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=48><td><pre>  </pre><tr><td data-num=49><td><pre>    <span class="token comment">// 当前 transaction 添加到 任务中， 设置回调 函数 gum_interceptor_activate 拦截器激活函数</span></pre><tr><td data-num=50><td><pre>  <span class="token function">gum_interceptor_transaction_schedule_update</span> <span class="token punctuation">(</span><span class="token operator">&</span>self<span class="token operator">-></span>current_transaction<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span></pre><tr><td data-num=51><td><pre>      gum_interceptor_activate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=52><td><pre></pre><tr><td data-num=53><td><pre>  <span class="token keyword">return</span> ctx<span class="token punctuation">;</span></pre><tr><td data-num=54><td><pre></pre><tr><td data-num=55><td><pre>policy_violation<span class="token operator">:</span></pre><tr><td data-num=56><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=57><td><pre>    <span class="token operator">*</span>error <span class="token operator">=</span> GUM_INSTRUMENTATION_ERROR_POLICY_VIOLATION<span class="token punctuation">;</span></pre><tr><td data-num=58><td><pre>    <span class="token keyword">goto</span> propagate_error<span class="token punctuation">;</span></pre><tr><td data-num=59><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=60><td><pre>wrong_signature<span class="token operator">:</span></pre><tr><td data-num=61><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=62><td><pre>    <span class="token operator">*</span>error <span class="token operator">=</span> GUM_INSTRUMENTATION_ERROR_WRONG_SIGNATURE<span class="token punctuation">;</span></pre><tr><td data-num=63><td><pre>    <span class="token keyword">goto</span> propagate_error<span class="token punctuation">;</span></pre><tr><td data-num=64><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=65><td><pre>propagate_error<span class="token operator">:</span></pre><tr><td data-num=66><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=67><td><pre>    <span class="token function">gum_function_context_finalize</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=68><td><pre></pre><tr><td data-num=69><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre><tr><td data-num=70><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=71><td><pre><span class="token punctuation">}</span></pre></table></figure><p>先偷一个跳板代码：<pre><code class=language-assembly>00C30200  mov         al,byte ptr ds:[FF00C121h]  
00C30205  xor         eax,0C30200h  
00C3020A  jmp         00C30000   // 跳到上面的 enter_thunk
00C3020F  push        dword ptr ds:[0C30200h]  
00C30215  jmp         00C30100  // 跳到 leave_thunk
// 原函数修复的指令，7个字节
00C3021A  push        ebp  
00C3021B  mov         ebp,esp  
00C3021D  cmp         dword ptr [ebp+8],0  
00C30221  jmp         gum_test_target_function+7h (0D6FB97h) // 跳回原函数，因为写跳转用了7字节，所以+7
</code></pre><p>拦截器后端的初始化：这里初始化的 <code>writer</code> 和 <code>relocator</code> 分别用于指令写和指令恢复。<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre><span class="token function">_gum_interceptor_backend_create</span> <span class="token punctuation">(</span>GRecMutex <span class="token operator">*</span> mutex<span class="token punctuation">,</span></pre><tr><td data-num=2><td><pre>                                 GumCodeAllocator <span class="token operator">*</span> allocator<span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=4><td><pre>  GumInterceptorBackend <span class="token operator">*</span> backend<span class="token punctuation">;</span></pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre>  backend <span class="token operator">=</span> <span class="token function">g_slice_new</span> <span class="token punctuation">(</span>GumInterceptorBackend<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=7><td><pre>  backend<span class="token operator">-></span>allocator <span class="token operator">=</span> allocator<span class="token punctuation">;</span></pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre>  <span class="token function">gum_arm_writer_init</span> <span class="token punctuation">(</span><span class="token operator">&</span>backend<span class="token operator">-></span>arm_writer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=10><td><pre>  backend<span class="token operator">-></span>arm_writer<span class="token punctuation">.</span>cpu_features <span class="token operator">=</span> <span class="token function">gum_query_cpu_features</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=11><td><pre>  <span class="token function">gum_arm_relocator_init</span> <span class="token punctuation">(</span><span class="token operator">&</span>backend<span class="token operator">-></span>arm_relocator<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&</span>backend<span class="token operator">-></span>arm_writer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=12><td><pre></pre><tr><td data-num=13><td><pre>  <span class="token function">gum_thumb_writer_init</span> <span class="token punctuation">(</span><span class="token operator">&</span>backend<span class="token operator">-></span>thumb_writer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=14><td><pre>  <span class="token function">gum_thumb_relocator_init</span> <span class="token punctuation">(</span><span class="token operator">&</span>backend<span class="token operator">-></span>thumb_relocator<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></pre><tr><td data-num=15><td><pre>      <span class="token operator">&</span>backend<span class="token operator">-></span>thumb_writer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=16><td><pre></pre><tr><td data-num=17><td><pre>  <span class="token function">gum_interceptor_backend_create_thunks</span> <span class="token punctuation">(</span>backend<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=18><td><pre></pre><tr><td data-num=19><td><pre>  <span class="token keyword">return</span> backend<span class="token punctuation">;</span></pre><tr><td data-num=20><td><pre><span class="token punctuation">}</span></pre></table></figure><p>看到 thunks 的初始化，这里是关键函数，用来调度执行，对应进入 hook 和离开 hook<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span></pre><tr><td data-num=2><td><pre><span class="token function">gum_interceptor_backend_create_thunks</span> <span class="token punctuation">(</span>GumInterceptorBackend <span class="token operator">*</span> self<span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=4><td><pre>  GumArmWriter <span class="token operator">*</span> aw <span class="token operator">=</span> <span class="token operator">&</span>self<span class="token operator">-></span>arm_writer<span class="token punctuation">;</span></pre><tr><td data-num=5><td><pre>  GumThumbWriter <span class="token operator">*</span> tw <span class="token operator">=</span> <span class="token operator">&</span>self<span class="token operator">-></span>thumb_writer<span class="token punctuation">;</span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre>  self<span class="token operator">-></span>arm_thunks <span class="token operator">=</span> <span class="token function">gum_code_allocator_alloc_slice</span> <span class="token punctuation">(</span>self<span class="token operator">-></span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=8><td><pre>  <span class="token function">gum_arm_writer_reset</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> self<span class="token operator">-></span>arm_thunks<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=9><td><pre></pre><tr><td data-num=10><td><pre>  self<span class="token operator">-></span>enter_thunk_arm <span class="token operator">=</span> <span class="token function">gum_arm_writer_cur</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=11><td><pre>  <span class="token function">gum_emit_arm_enter_thunk</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=12><td><pre></pre><tr><td data-num=13><td><pre>  self<span class="token operator">-></span>leave_thunk_arm <span class="token operator">=</span> <span class="token function">gum_arm_writer_cur</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=14><td><pre>  <span class="token function">gum_emit_arm_leave_thunk</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=15><td><pre></pre><tr><td data-num=16><td><pre>  <span class="token function">gum_arm_writer_flush</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=17><td><pre>  <span class="token function">g_assert</span> <span class="token punctuation">(</span><span class="token function">gum_arm_writer_offset</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span> <span class="token operator"><=</span> self<span class="token operator">-></span>arm_thunks<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=18><td><pre></pre><tr><td data-num=19><td><pre>  self<span class="token operator">-></span>thumb_thunks <span class="token operator">=</span> <span class="token function">gum_code_allocator_alloc_slice</span> <span class="token punctuation">(</span>self<span class="token operator">-></span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=20><td><pre>  <span class="token function">gum_thumb_writer_reset</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span> self<span class="token operator">-></span>thumb_thunks<span class="token operator">-></span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=21><td><pre></pre><tr><td data-num=22><td><pre>  self<span class="token operator">-></span>enter_thunk_thumb <span class="token operator">=</span> <span class="token function">gum_thumb_writer_cur</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre><tr><td data-num=23><td><pre>  <span class="token function">gum_emit_thumb_enter_thunk</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=24><td><pre></pre><tr><td data-num=25><td><pre>  self<span class="token operator">-></span>leave_thunk_thumb <span class="token operator">=</span> <span class="token function">gum_thumb_writer_cur</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre><tr><td data-num=26><td><pre>  <span class="token function">gum_emit_thumb_leave_thunk</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=27><td><pre></pre><tr><td data-num=28><td><pre>  <span class="token function">gum_thumb_writer_flush</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=29><td><pre>  <span class="token function">g_assert</span> <span class="token punctuation">(</span><span class="token function">gum_thumb_writer_offset</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span> <span class="token operator"><=</span> self<span class="token operator">-></span>thumb_thunks<span class="token operator">-></span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=30><td><pre><span class="token punctuation">}</span></pre></table></figure><p>gum_emit_arm_enter_thunk：<figure class="highlight c"><figcaption data-lang=c></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span></pre><tr><td data-num=2><td><pre><span class="token function">gum_emit_arm_enter_thunk</span> <span class="token punctuation">(</span>GumArmWriter <span class="token operator">*</span> aw<span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=4><td><pre>  <span class="token comment">// 用于保存返回地址以及栈、寄存器情况</span></pre><tr><td data-num=5><td><pre>  <span class="token function">gum_emit_arm_prolog</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre>  <span class="token comment">// 构造自身函数栈以及寄存器</span></pre><tr><td data-num=8><td><pre>  <span class="token function">gum_arm_writer_put_add_reg_reg_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_R1<span class="token punctuation">,</span> ARM_REG_SP<span class="token punctuation">,</span></pre><tr><td data-num=9><td><pre>      GUM_FRAME_OFFSET_CPU_CONTEXT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=10><td><pre>  <span class="token function">gum_arm_writer_put_sub_reg_reg_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_R2<span class="token punctuation">,</span> ARM_REG_R4<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=11><td><pre>  <span class="token function">gum_arm_writer_put_add_reg_reg_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_R3<span class="token punctuation">,</span> ARM_REG_SP<span class="token punctuation">,</span></pre><tr><td data-num=12><td><pre>      GUM_FRAME_OFFSET_NEXT_HOP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=13><td><pre></pre><tr><td data-num=14><td><pre>  <span class="token comment">// 调用</span></pre><tr><td data-num=15><td><pre>  <span class="token function">gum_arm_writer_put_call_address_with_arguments</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span></pre><tr><td data-num=16><td><pre>      <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>_gum_function_context_begin_invocation<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span></pre><tr><td data-num=17><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R6<span class="token punctuation">,</span></pre><tr><td data-num=18><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R1<span class="token punctuation">,</span></pre><tr><td data-num=19><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R2<span class="token punctuation">,</span></pre><tr><td data-num=20><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R3<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=21><td><pre></pre><tr><td data-num=22><td><pre>  <span class="token function">gum_emit_arm_epilog</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=23><td><pre><span class="token punctuation">}</span></pre></table></figure><p>gum_emit_arm_leave_thunk：<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span></pre><tr><td data-num=2><td><pre><span class="token function">gum_emit_arm_leave_thunk</span> <span class="token punctuation">(</span>GumArmWriter <span class="token operator">*</span> aw<span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=4><td><pre>  <span class="token function">gum_emit_arm_prolog</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre>  <span class="token function">gum_arm_writer_put_add_reg_reg_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_R1<span class="token punctuation">,</span> ARM_REG_SP<span class="token punctuation">,</span></pre><tr><td data-num=7><td><pre>      GUM_FRAME_OFFSET_CPU_CONTEXT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=8><td><pre>  <span class="token function">gum_arm_writer_put_add_reg_reg_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_R2<span class="token punctuation">,</span> ARM_REG_SP<span class="token punctuation">,</span></pre><tr><td data-num=9><td><pre>      GUM_FRAME_OFFSET_NEXT_HOP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=10><td><pre></pre><tr><td data-num=11><td><pre>  <span class="token function">gum_arm_writer_put_call_address_with_arguments</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span></pre><tr><td data-num=12><td><pre>      <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>_gum_function_context_end_invocation<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span></pre><tr><td data-num=13><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R6<span class="token punctuation">,</span></pre><tr><td data-num=14><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R1<span class="token punctuation">,</span></pre><tr><td data-num=15><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=16><td><pre></pre><tr><td data-num=17><td><pre>  <span class="token function">gum_emit_arm_epilog</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=18><td><pre><span class="token punctuation">}</span></pre></table></figure><p>拦截器激活：<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span></pre><tr><td data-num=2><td><pre><span class="token function">gum_interceptor_activate</span> <span class="token punctuation">(</span>GumInterceptor <span class="token operator">*</span> self<span class="token punctuation">,</span></pre><tr><td data-num=3><td><pre>                          GumFunctionContext <span class="token operator">*</span> ctx<span class="token punctuation">,</span></pre><tr><td data-num=4><td><pre>                          gpointer prologue<span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=6><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>destroyed<span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre>  <span class="token function">g_assert</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token operator">-></span>activated<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=10><td><pre>  ctx<span class="token operator">-></span>activated <span class="token operator">=</span> TRUE<span class="token punctuation">;</span></pre><tr><td data-num=11><td><pre></pre><tr><td data-num=12><td><pre>  <span class="token function">_gum_interceptor_backend_activate_trampoline</span> <span class="token punctuation">(</span>self<span class="token operator">-></span>backend<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span></pre><tr><td data-num=13><td><pre>      prologue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=14><td><pre><span class="token punctuation">}</span></pre></table></figure><p>核心 bl 处：<figure class="highlight cpp"><figcaption data-lang=C++></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">void</span> <span class="token function">_gum_interceptor_backend_activate_trampoline</span> <span class="token punctuation">(</span>GumInterceptorBackend <span class="token operator">*</span> self<span class="token punctuation">,</span></pre><tr><td data-num=2><td><pre>                                              GumFunctionContext <span class="token operator">*</span> ctx<span class="token punctuation">,</span></pre><tr><td data-num=3><td><pre>                                              gpointer prologue<span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token punctuation">{</span></pre><tr><td data-num=5><td><pre>  GumAddress function_address<span class="token punctuation">;</span></pre><tr><td data-num=6><td><pre>  GumArmFunctionContextData <span class="token operator">*</span> data <span class="token operator">=</span> <span class="token function">GUM_FCDATA</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=7><td><pre></pre><tr><td data-num=8><td><pre>  function_address <span class="token operator">=</span> <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span></pre><tr><td data-num=9><td><pre>      <span class="token function">_gum_interceptor_backend_get_function_address</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=10><td><pre></pre><tr><td data-num=11><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FUNCTION_CONTEXT_ADDRESS_IS_THUMB</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=13><td><pre>    GumThumbWriter <span class="token operator">*</span> tw <span class="token operator">=</span> <span class="token operator">&</span>self<span class="token operator">-></span>thumb_writer<span class="token punctuation">;</span></pre><tr><td data-num=14><td><pre>	<span class="token comment">// 设置 base、pc</span></pre><tr><td data-num=15><td><pre>    <span class="token function">gum_thumb_writer_reset</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span> prologue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=16><td><pre>    tw<span class="token operator">-></span>pc <span class="token operator">=</span> function_address<span class="token punctuation">;</span></pre><tr><td data-num=17><td><pre></pre><tr><td data-num=18><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>trampoline_deflector <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre><tr><td data-num=19><td><pre>    <span class="token punctuation">{</span></pre><tr><td data-num=20><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-></span>redirect_code_size <span class="token operator">==</span> GUM_INTERCEPTOR_THUMB_LINK_REDIRECT_SIZE<span class="token punctuation">)</span></pre><tr><td data-num=21><td><pre>      <span class="token punctuation">{</span></pre><tr><td data-num=22><td><pre>        <span class="token function">gum_emit_thumb_push_cpu_context_high_part</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=23><td><pre>        <span class="token function">gum_thumb_writer_put_bl_imm</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span> <span class="token comment">// 写 bl，进行跳板操作</span></pre><tr><td data-num=24><td><pre>            <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>trampoline_deflector<span class="token operator">-></span>trampoline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=25><td><pre>      <span class="token punctuation">}</span></pre><tr><td data-num=26><td><pre>      <span class="token keyword">else</span></pre><tr><td data-num=27><td><pre>      <span class="token punctuation">{</span></pre><tr><td data-num=28><td><pre>        <span class="token function">g_assert</span> <span class="token punctuation">(</span>data<span class="token operator">-></span>redirect_code_size <span class="token operator">==</span></pre><tr><td data-num=29><td><pre>            GUM_INTERCEPTOR_THUMB_TINY_REDIRECT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=30><td><pre>        <span class="token function">gum_thumb_writer_put_b_imm</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span></pre><tr><td data-num=31><td><pre>            <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>trampoline_deflector<span class="token operator">-></span>trampoline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=32><td><pre>      <span class="token punctuation">}</span></pre><tr><td data-num=33><td><pre>    <span class="token punctuation">}</span></pre><tr><td data-num=34><td><pre>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>type <span class="token operator">==</span> GUM_INTERCEPTOR_TYPE_FAST<span class="token punctuation">)</span></pre><tr><td data-num=35><td><pre>    <span class="token punctuation">{</span></pre><tr><td data-num=36><td><pre>      <span class="token function">gum_thumb_writer_put_ldr_reg_address</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span> ARM_REG_PC<span class="token punctuation">,</span></pre><tr><td data-num=37><td><pre>          <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>replacement_function<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=38><td><pre>    <span class="token punctuation">}</span></pre><tr><td data-num=39><td><pre>    <span class="token keyword">else</span></pre><tr><td data-num=40><td><pre>    <span class="token punctuation">{</span></pre><tr><td data-num=41><td><pre>      <span class="token function">gum_thumb_writer_put_ldr_reg_address</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span> ARM_REG_PC<span class="token punctuation">,</span></pre><tr><td data-num=42><td><pre>          <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>on_enter_trampoline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=43><td><pre>    <span class="token punctuation">}</span></pre><tr><td data-num=44><td><pre></pre><tr><td data-num=45><td><pre>    <span class="token function">gum_thumb_writer_flush</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=46><td><pre>    <span class="token function">g_assert</span> <span class="token punctuation">(</span><span class="token function">gum_thumb_writer_offset</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span> <span class="token operator"><=</span> data<span class="token operator">-></span>redirect_code_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=47><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=48><td><pre>  <span class="token keyword">else</span></pre><tr><td data-num=49><td><pre>  <span class="token punctuation">{</span></pre><tr><td data-num=50><td><pre>    GumArmWriter <span class="token operator">*</span> aw <span class="token operator">=</span> <span class="token operator">&</span>self<span class="token operator">-></span>arm_writer<span class="token punctuation">;</span></pre><tr><td data-num=51><td><pre></pre><tr><td data-num=52><td><pre>    <span class="token function">gum_arm_writer_reset</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> prologue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=53><td><pre>    aw<span class="token operator">-></span>pc <span class="token operator">=</span> function_address<span class="token punctuation">;</span></pre><tr><td data-num=54><td><pre></pre><tr><td data-num=55><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>trampoline_deflector <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre><tr><td data-num=56><td><pre>    <span class="token punctuation">{</span></pre><tr><td data-num=57><td><pre>      <span class="token function">g_assert</span> <span class="token punctuation">(</span>data<span class="token operator">-></span>redirect_code_size <span class="token operator">==</span></pre><tr><td data-num=58><td><pre>          GUM_INTERCEPTOR_ARM_TINY_REDIRECT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=59><td><pre>      <span class="token function">gum_arm_writer_put_b_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span></pre><tr><td data-num=60><td><pre>          <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>trampoline_deflector<span class="token operator">-></span>trampoline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=61><td><pre>    <span class="token punctuation">}</span></pre><tr><td data-num=62><td><pre>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>type <span class="token operator">==</span> GUM_INTERCEPTOR_TYPE_FAST<span class="token punctuation">)</span></pre><tr><td data-num=63><td><pre>    <span class="token punctuation">{</span></pre><tr><td data-num=64><td><pre>      <span class="token function">gum_arm_writer_put_ldr_reg_address</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_PC<span class="token punctuation">,</span></pre><tr><td data-num=65><td><pre>          <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>replacement_function<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=66><td><pre>    <span class="token punctuation">}</span></pre><tr><td data-num=67><td><pre>    <span class="token keyword">else</span></pre><tr><td data-num=68><td><pre>    <span class="token punctuation">{</span></pre><tr><td data-num=69><td><pre>      <span class="token function">gum_arm_writer_put_ldr_reg_address</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_PC<span class="token punctuation">,</span></pre><tr><td data-num=70><td><pre>          <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>on_enter_trampoline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=71><td><pre>    <span class="token punctuation">}</span></pre><tr><td data-num=72><td><pre></pre><tr><td data-num=73><td><pre>    <span class="token function">gum_arm_writer_flush</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=74><td><pre>    <span class="token function">g_assert</span> <span class="token punctuation">(</span><span class="token function">gum_arm_writer_offset</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span> <span class="token operator">==</span> data<span class="token operator">-></span>redirect_code_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><tr><td data-num=75><td><pre>  <span class="token punctuation">}</span></pre><tr><td data-num=76><td><pre><span class="token punctuation">}</span></pre></table></figure><h4 id=三-执行流程><a class=anchor href=#三-执行流程>#</a> 三、执行流程</h4><p>偷一个（上面我们走的是 arm 的流程，函数名略有不同，但流程是一样的）<p><img alt=image-20240503113613151 data-src=frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/image-20240503113613151.png loading=lazy><h6 id=先这样~有机会再来调试><a class=anchor href=#先这样~有机会再来调试>#</a> 先这样～有机会再来调试</h6><h3 id=frida-core><a class=anchor href=#frida-core>#</a> frida-core</h3><h4 id=一-前置知识><a class=anchor href=#一-前置知识>#</a> 一、前置知识</h4><h5 id=1-vala语言><a class=anchor href=#1-vala语言>#</a> 1、vala 语言</h5><p>​ 介绍：<a href=https://wiki.gnome.org/Projects/Vala/ rel=noopener target=_blank>Projects/Vala - GNOME Wiki!</a>：Vala is a programming language using modern high level abstractions without imposing additional runtime requirements and without using a different ABI compared to applications and libraries written in C. Vala uses the GObject type system and has additional code generation routines that make targeting the GNOME stack simple. Vala has many other uses where native binaries are required.<p>​ vala 语言是 GNOME 中使用的一个高级语言，和传统高级语言不同的是 vala 代码会被编译器先编译成 C 代码，然后再编译成二进制文件，因此也可以认为 vala 语言是 C 的一个语法糖拓展。其使用使用 glib 的 <code>GObject</code> 类型系统来构造类和接口以实现面向对象，其语法有点类似于 <code>C#</code> ，支持许多现代语言的高级特性，包括但不限于接口、属性、内存管理、异常、lambda、信号等等。Vala 既可以通过 API 文件访问已有的 C 库文件，也可以从 C 中很容易调用 Vala 的方法。<p>​ <s>直接看也能大概看懂</s><p>​ <a href=https://wiki.gnome.org/Projects/Vala/Documentation#Sample_Code rel=noopener target=_blank>vala 官方文档</a><h5 id=2-进程问题><a class=anchor href=#2-进程问题>#</a> 2、进程问题</h5><p>​ 无论在 Android 还是 iOS 或者其他平台，进程和进程直接相互是透明的，就算对 Frida 来说目标进程并非透明的，但是对目标进程来说，至少 Frida 也该是透明的。但是现实情况显然是，二者往往需要相互之间识别并交互。<h4 id=二-源码分析><a class=anchor href=#二-源码分析>#</a> 二、源码分析</h4><p>vala 插件点不进去啊急了，看不动先鸽了 ××× 等 selinux 看看再回来</div><footer><div class=meta><span class=item><span class=icon><i class="ic i-calendar-check"></i></span><span class=text>Edited on</span><time title="Modified: 2024-05-03 19:38:02" datetime=2024-05-03T19:38:02+08:00 itemprop=dateModified>2024-05-03</time></span></div><div class=reward><button><i class="ic i-heartbeat"></i>Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*<div id=qr><div><img alt="Moyao WeChat Pay" data-src=/assets/wechatpay.png loading=lazy><p>WeChat Pay</div><div><img alt="Moyao Alipay" data-src=/assets/alipay.png loading=lazy><p>Alipay</div></div></div><div id=copyright><ul><li class=author><strong>Post author: </strong>Moyao<i class="ic i-at"><em>@</em></i>rev@天枢<li class=link><strong>Post link: </strong><a href=https://demoyao100.github.io/2024/04/27/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/ title=frida源码初探>https://demoyao100.github.io/2024/04/27/frida源码初探/</a><li class=license><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh rel=noopener target=_blank><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> unless stating additionally.</ul></div></footer></article></div><div class=post-nav><div class="item left"><a data-background-image=https://tva4.sinaimg.cn/mw690/6833939bly1gicis3attqj20zk0m8k7l.jpg href=/2024/04/24/%E9%93%81%E4%B8%89awd%E6%B8%97%E9%80%8F%E5%A4%8D%E7%9B%98/ itemprop=url rel=prev title=铁三awd渗透复盘><span class=type>Previous Post</span><h3>铁三awd渗透复盘</h3></a></div><div class="item right"><a title="不同的android hook姿势" data-background-image=https://tva4.sinaimg.cn/mw690/6833939bly1gicis081o9j20zk0m8dmr.jpg href=/2024/05/03/%E4%B8%8D%E5%90%8C%E7%9A%84android-hook%E5%A7%BF%E5%8A%BF/ itemprop=url rel=next><span class=type>Next Post</span><h3>不同的android hook姿势</h3></a></div></div></div><div id=sidebar><div class=inner><div class=panels><div class=inner><div class="contents panel pjax" data-title=Contents><ol class=toc><li class="toc-item toc-level-6"><a class=toc-link href=#preface%E8%A2%AB%E6%8B%B7%E6%89%93%E5%88%B0frida%E5%92%8Cxpose%E7%9A%84%E5%8E%9F%E7%90%86%E5%95%A5%E7%9A%84%E5%95%A5%E5%95%A5%E4%B8%8D%E4%BC%9A%E7%88%AC%E6%9D%A5%E8%B5%B6%E7%B4%A7%E5%AD%A6%E5%AD%A6><span class=toc-number>1.</span> <span class=toc-text> PREFACE：被拷打到 frida 和 xpose 的原理啥的，啥啥不会，爬来赶紧学学</span></a></ol><li class="toc-item toc-level-3"><a class=toc-link href=#%E6%80%BB%E8%A7%88><span class=toc-number></span> <span class=toc-text> 总览</span></a><li class="toc-item toc-level-3"><a class=toc-link href=#frida-gum><span class=toc-number></span> <span class=toc-text> frida-gum</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#%E4%B8%80-%E5%89%8D%E7%BD%AE%E5%8E%9F%E7%90%86><span class=toc-number></span> <span class=toc-text> 一、前置原理</span></a><ol class=toc-child><li class="toc-item toc-level-5"><a class=toc-link href=#11-inline-hook><span class=toc-number></span> <span class=toc-text> 1.1 inline hook</span></a><ol class=toc-child><li class="toc-item toc-level-6"><a class=toc-link href=#12-inline-hook-%E6%A3%80%E6%B5%8B><span class=toc-number>1.</span> <span class=toc-text> 1.2 inline hook 检测</span></a></ol></ol><li class="toc-item toc-level-4"><a class=toc-link href=#%E4%BA%8C-%E6%BA%90%E7%A0%81><span class=toc-number></span> <span class=toc-text> 二、源码</span></a><ol class=toc-child><li class="toc-item toc-level-5"><a class=toc-link href=#gumtestc><span class=toc-number></span> <span class=toc-text> gumtest.c</span></a></ol><li class="toc-item toc-level-4"><a class=toc-link href=#%E4%B8%89-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B><span class=toc-number></span> <span class=toc-text> 三、执行流程</span></a><ol class=toc-child><li class="toc-item toc-level-6"><a class=toc-link href=#%E5%85%88%E8%BF%99%E6%A0%B7~%E6%9C%89%E6%9C%BA%E4%BC%9A%E5%86%8D%E6%9D%A5%E8%B0%83%E8%AF%95><span class=toc-number>1.</span> <span class=toc-text> 先这样～有机会再来调试</span></a></ol></ol><li class="toc-item toc-level-3"><a class=toc-link href=#frida-core><span class=toc-number></span> <span class=toc-text> frida-core</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#%E4%B8%80-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86><span class=toc-number></span> <span class=toc-text> 一、前置知识</span></a><ol class=toc-child><li class="toc-item toc-level-5"><a class=toc-link href=#1-vala%E8%AF%AD%E8%A8%80><span class=toc-number></span> <span class=toc-text> 1、vala 语言</span></a><li class="toc-item toc-level-5"><a class=toc-link href=#2-%E8%BF%9B%E7%A8%8B%E9%97%AE%E9%A2%98><span class=toc-number></span> <span class=toc-text> 2、进程问题</span></a></ol><li class="toc-item toc-level-4"><a class=toc-link href=#%E4%BA%8C-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90><span class=toc-number></span> <span class=toc-text> 二、源码分析</span></a><div class="related panel pjax" data-title=Related></div><div class="overview panel" data-title=Overview><div class=author itemprop=author itemscope itemtype=http://schema.org/Person><img alt=Moyao class=image data-src=/assets/avatar.jpg itemprop=image loading=lazy><p class=name itemprop=name>Moyao<div class=description itemprop=description>Write down something interesting I met<br> Feel free to mail me if you have something wanted to talk about, plz mail: &LTmoyaoxue@outlook.com></div></div><nav class=state><div class="item posts"><a href=/archives/><span class=count>74</span><span class=name>posts</span></a></div><div class="item tags"><a href=/tags/><span class=count>14</span><span class=name>tags</span></a></div></nav><div class=social><a class="item github" href=https://github.com/name rel=noopener target=_blank title=https://github.com/name><i class="ic i-github"></i></a></div><div class=menu><li class=item><a href=/ rel=section><i class="ic i-home"></i>Home</a></div></div><ul id=quick><li class="prev pjax"><a title="Previous Post" href=/2024/05/03/%E4%B8%8D%E5%90%8C%E7%9A%84android-hook%E5%A7%BF%E5%8A%BF/ rel=prev><i class="ic i-chevron-left"></i></a><li class=up><i class="ic i-arrow-up"></i><li class=down><i class="ic i-arrow-down"></i><li class="next pjax"><a title="Next Post" href=/2024/04/24/%E9%93%81%E4%B8%89awd%E6%B8%97%E9%80%8F%E5%A4%8D%E7%9B%98/ rel=next><i class="ic i-chevron-right"></i></a><li class=percent></ul><div class=dimmer></div><footer id=footer><div class=inner><div class=widgets><div class="rpost pjax"><h2>Random Posts</h2><ul><li class=item><div class=breadcrumb></div><span><a href=/2023/11/26/laurelAndYanny/>laurelAndYanny</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/08/26/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E4%BB%A5%E5%8F%8A%E5%85%B6%E4%BB%96%E6%9E%B6%E6%9E%84%E9%80%86%E5%90%91%E5%88%9D%E6%8E%A2/>交叉编译以及其他架构逆向初探</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/11/27/Ghidra%E5%88%9D%E6%8E%A2/>Ghidra初探</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/10/17/ISITDTUCTF/>ISITDTUCTF</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/09/27/print%E5%8D%A0%E4%BD%8D%E7%AC%A6%E9%87%8D%E5%86%99%E5%88%9D%E6%8E%A2/>print占位符重写初探</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/11/12/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812023/>强网拟态2023</a></span><li class=item><div class=breadcrumb></div><span><a href=/2024/03/28/ACTF-flutter%E5%A4%8D%E7%8E%B0/>ACTF flutter复现</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/08/28/%E5%AE%89%E5%8D%93hook%E5%88%9D%E6%8E%A2/>安卓hook初探</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/08/23/%E5%88%9D%E6%8E%A2flutter/>初探flutter</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/07/11/%E5%AE%89%E5%8D%93%E8%B0%83%E8%AF%95%E5%88%9D%E6%8E%A2/>安卓调试初探</a></span></ul></div><div class="rpost pjax"><h2>Recent Comments</h2><ul class=leancloud-recent-comment id=new-comment></ul></div></div><div class=status><div class=copyright>© 2022 -<span itemprop=copyrightYear>2024</span><span class=with-love><i class="ic i-sakura rotate"></i></span><span class=author itemprop=copyrightHolder>Moyao @ Moyao の小屋</span></div><div class=count><span class=post-meta-item-icon><i class="ic i-chart-area"></i></span><span title="Symbols count total">649k words</span><span class=post-meta-divider>|</span><span class=post-meta-item-icon><i class="ic i-coffee"></i></span><span title="Reading time total">9:50</span></div><div class=powered-by>Powered by <a href=https://hexo.io/ rel=noopener target=_blank>Hexo</a> & Theme.<a href=https://github.com/theme-shoka-x/hexo-theme-shokaX/ rel=noopener target=_blank>ShokaX</a></div></div></div></footer><script data-config>var LOCAL = {
        path: `2024/04/27/frida源码初探/`,
        favicon: {
        show: `(●´3｀●) Here we go again.`,
        hide: `(´Д｀) It's a disaster!`
    },
    search: {
        placeholder: "Search for Posts",
        empty: "We didn't find any results for the search: ${query}",
        stats: "${hits} results found in ${time} ms"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">Article Timeliness Alert</span><br>This is an article published {{publish}} days ago and last updated {{updated}} days ago. Some information may have changed, so please be careful to screen it.</p></div>`,
    quiz: {
        choice: `Multiple Choice`,
        multiple: `Multiple Answer`,
        true_false: `True/False`,
        essay: `Questions`,
        gap_fill: `Gap Filling`,
        mistake: `Wrong Answer`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};</script><script src=https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.prod.min.js></script><script src=https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.2.4/pace.min.js></script><script src=https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/algoliasearch/4.12.1/algoliasearch-lite.umd.min.js></script><script src=https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/instantsearch.js/4.39.0/instantsearch.production.min.js></script><script src=https://npm.webcache.cn/quicklink@2.3.0/dist/quicklink.umd.js></script><script src=/js/app.js?v=0.3.15></script>