
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
        <title>Frida源码初探 | Moyao の小屋</title>
        <meta name="author" content="Moyao">
        <meta name="description" content="Write down something interesting I met
feel free to mail me if you have something wanted to talk about
mail: &lt;moyaoxue@outlook.com&gt;
">
        <meta name="keywords" content="">
        <link rel="icon" href="/images/head.jpg">
        <script src="https://cdn.staticfile.org/instant.page/5.1.0/instantpage.min.js" type="module"></script>
        <script src="https://cdn.staticfile.org/font-awesome/6.1.1/js/all.min.js"></script>
        
        <link rel="stylesheet" href="/css/fonts.min.css">
        <link rel="stylesheet" href="/css/particlex.css">
        
        <script src="https://cdn.staticfile.org/vue/3.2.33/vue.global.prod.min.js"></script>
    <meta name="generator" content="Hexo 6.2.0"></head>
    <body>
        <div id="loading" style="height:100vh;width:100vw;position:fixed;display:flex;z-index:200;justify-content:space-between;background:#fff;transition:opacity 0.3s ease-out"><div style="position:fixed;height:100vh;width:100vw;display:flex;justify-content:center;align-items:center"><div id="loadcontent" style="width:50vmin;height:50vmin;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px #a3ddfb;text-align:center"><div><h2>LOADING...</h2><p style="word-break:keep-all">加载过慢请开启缓存(浏览器默认开启)</p><div><img alt="loading" src="/loading.gif"></div></div></div></div></div>
        <div id="layout">
            <i data-fa-symbol="calendar-solid" class="fa-solid fa-calendar fa-fw"></i>
            <i data-fa-symbol="bookmark-solid" class="fa-solid fa-bookmark fa-fw"></i>
            <i data-fa-symbol="tags-solid" class="fa-solid fa-tags fa-fw"></i>
            <transition name="into">
                <div v-show="show_page" style="display: -not-none">
                    <div id="menu_show">
                         
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">Moyao の小屋</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;home</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;about</span>
        </a>
        
        <a target="_blank" rel="noopener" href="//tags/re/">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;tags</span>
        </a>
        
    </div>
    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div class="curtain" @click="menu_show = !menu_show" v-show="menu_show"></div>
        <div :class="'title'" @click="menu_show = !menu_show">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;Moyao の小屋</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="menu_show">
            
            <a href="">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">home</div>
                </div>
            </a>
            
            <a href="">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">about</div>
                </div>
            </a>
            
            <a href="/tags/re/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">tags</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>
                    </div>
                    <div id="main">
                        
<div class="article">
    <div>
        <h1>Frida源码初探 </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <svg class="fa-icon"><use xlink:href="#calendar-solid"></use></svg>
            </span>
            2024/4/27
        </span>
        
        
    </div>
    <div class="content" v-pre>
        <h6 id="PREFACE：被拷打到frida和xpose的原理啥的，啥啥不会，爬来赶紧学学"><a href="#PREFACE：被拷打到frida和xpose的原理啥的，啥啥不会，爬来赶紧学学" class="headerlink" title="PREFACE：被拷打到frida和xpose的原理啥的，啥啥不会，爬来赶紧学学"></a>PREFACE：被拷打到frida和xpose的原理啥的，啥啥不会，爬来赶紧学学</h6><span id="more"></span>

<h3 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h3><p>首先是一整个<a target="_blank" rel="noopener" href="https://github.com/frida/frida">frida</a>项目可以分为这些subprojects：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-clr">frida-clr</a>：Frida .NET bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-core/tree/da417fd46b4fd7af8f157498e9e5f38e6242be45">frida-core</a>：Frida core library intended for static linking into bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-go/tree/fd52f64f49fbbde2820e02e6e6dd3aafd1ac0ce6">frida-go</a>：Frida Go bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-gum/tree/c385fac6e3b2512c64e10e3e039f2a7be6995ab9">frida-gum</a>：Cross-platform instrumentation and introspection library written in C</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-node/tree/72b815e0fc7fb3ab4dc90e9532739b6dc99c3b8f">frida-node</a>：Frida Node.js bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-python/tree/91e2e4ff54d7afa4a2d3660019da981e92967e8f">frida-python</a>：Frida Python bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-qml/tree/5c8eb8c84a5f808cb109e67e80e8e77c4f80da77">frida-qml</a>：Frida Qml plugin</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-swift/tree/ce8f781ef000b7bfc9f90f942df2d0c973d4f52b">frida-swift</a>：Frida Swift bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-tools/tree/49f4330d8fde4e5250ac78f35ea71b4d7441fdb6">frida-tools</a>：Frida CLI tools</li>
</ul>
<p>感觉网上许多文章都着重在看frida-core和frida-gum，那么就先看看这两部分</p>
<h3 id="frida-gum"><a href="#frida-gum" class="headerlink" title="frida-gum"></a>frida-gum</h3><p>分析过程中感觉直接干看还是有点困难，这里先整理一些frida所实现的功能，对照着功能看进去</p>
<h4 id="一、前置原理"><a href="#一、前置原理" class="headerlink" title="一、前置原理"></a>一、前置原理</h4><h5 id="1-1-inline-hook"><a href="#1-1-inline-hook" class="headerlink" title="1.1 inline hook"></a>1.1 inline hook</h5><p>​		我们可以使用 Frida 的 API 在程序运行时拦截函数的调用，并且在拦截到函数调用时，通过修改函数的参数或者返回值来改变程序的行为。</p>
<p>​		这里的核心原理是：动态替换需要 Hook 的指令片段为一段经过设计的跳板指令，即 trampoline ，目标为我们设计好的一段 shellCode，这里可以看[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273273.htm">原创]Frida inlineHook原理分析及简单设计一款AArch64 inlineHook工具-Android安全-看雪-安全社区|安全招聘|kanxue.com</a>这篇文章对于Frida生成的shellcode进行了详细的研究，暂时没有进行复现，先纸面学习，大概需要注意的点是：</p>
<ul>
<li>frida寻找前后128MB的地址获取一个空闲地址，将hook的点的前16个字节（或4字节）替换掉为LDR和BR指令，并且利用x16寄存器作为trampoline跳板</li>
<li>第一段跳板跳到shellcode后mmap一段匿名内存，保存当前寄存器状态与用于写入第二段跳板指令</li>
<li>然后是onenter和onleave的编写，注入shellcode实现需求的逻辑即可（这里是简易的核心原理，后面代码会复杂很多）</li>
</ul>
<h6 id="1-2-inline-hook-检测"><a href="#1-2-inline-hook-检测" class="headerlink" title="1.2 inline hook 检测"></a>1.2 inline hook 检测</h6><p>恰好学习的时候搜到<a target="_blank" rel="noopener" href="https://www.cnblogs.com/r0ysue/p/15424821.html">这篇文章</a>，一块记录了</p>
<p>​		既然frida会生成trampoline和shellcode，那么有个很简单的方法：开一个线程，检查函数开头有没有被替换过，并且有没有被替换成类似BR到shellcode的格式</p>
<h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><p>readme描述：</p>
<p>Cross-platform instrumentation and introspection library written in C.</p>
<p>This library is consumed by <a target="_blank" rel="noopener" href="https://github.com/frida/frida-core">frida-core</a> through its JavaScript bindings, <a target="_blank" rel="noopener" href="https://github.com/frida/frida-gum/tree/master/bindings/gumjs">GumJS</a>.</p>
<p>然后文档有大概给出不同部分的功能（词汇量稍微有点不够咳咳）不过直接看着稍微有点没头绪，先看看<a target="_blank" rel="noopener" href="https://o0xmuhe.github.io/2019/11/15/frida-gum%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/">别人的分析</a>，这篇写的不错)</p>
<p>偷看一下别人的阅读思路：</p>
<p><img src="/2024/04/27/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/image-20240428202138661.png" alt="image-20240428202138661"></p>
<p>首先有个meson.build构建文件，其中可以先看gumtest.c这一测试运行器（根据testcase递归看进代码）</p>
<pre><code class="cpp">runner_sources = [
  &#39;gumtest.c&#39;,
  &#39;testutil.c&#39;,
  &#39;stubs&#39; / &#39;dummyclasses.c&#39;,
  &#39;stubs&#39; / &#39;fakebacktracer.c&#39;,
  &#39;stubs&#39; / &#39;fakeeventsink.c&#39;,
  &#39;stalkerdummychannel.c&#39;,
  &#39;lowlevelhelpers.c&#39;,
]
</code></pre>
<h5 id="gumtest-c"><a href="#gumtest-c" class="headerlink" title="gumtest.c"></a>gumtest.c</h5><p>前面一大段代码根据宏来判断，是用于根据平台信息做初始化的</p>
<p>标记一个核心对象先：</p>
<pre><code class="cpp">struct _GumInterceptor
&#123;
#ifndef GUM_DIET
  GObject parent;
#else
  GumObject parent;
#endif

  GRecMutex mutex;

  GHashTable * function_by_address;

  GumInterceptorBackend * backend;
  GumCodeAllocator allocator;

  volatile guint selected_thread_id;

  GumInterceptorTransaction current_transaction;
&#125;;
</code></pre>
<p>拦截器初始化</p>
<pre><code class="cpp">GumInterceptor *
gum_interceptor_obtain (void)
&#123;
  GumInterceptor * interceptor;

  g_mutex_lock (&amp;_gum_interceptor_lock);

#ifndef GUM_DIET
  if (_the_interceptor != NULL)
  &#123;
    interceptor = GUM_INTERCEPTOR (g_object_ref (_the_interceptor));
  &#125;
  else
  &#123;
    _the_interceptor = g_object_new (GUM_TYPE_INTERCEPTOR, NULL);
    g_object_weak_ref (G_OBJECT (_the_interceptor),
        the_interceptor_weak_notify, NULL);

    interceptor = _the_interceptor;
  &#125;
#else
  if (_the_interceptor != NULL)
  &#123;
    interceptor = gum_object_ref (_the_interceptor);
  &#125;
  else
  &#123;
    _the_interceptor = g_new0 (GumInterceptor, 1);
    _the_interceptor-&gt;parent.ref_count = 1;
    _the_interceptor-&gt;parent.finalize = gum_interceptor_finalize;
    gum_interceptor_init (_the_interceptor);

    interceptor = _the_interceptor;
  &#125;
#endif

  g_mutex_unlock (&amp;_gum_interceptor_lock);

  return interceptor;
&#125;
</code></pre>
<p>attach上函数的方法：</p>
<p>传入地址，调用<code>gum_interceptor_resolve</code></p>
<pre><code class="cpp">GumAttachReturn
gum_interceptor_attach (GumInterceptor * self,
                        gpointer function_address,
                        GumInvocationListener * listener,
                        gpointer listener_function_data)
&#123;
  GumAttachReturn result = GUM_ATTACH_OK;
  GumFunctionContext * function_ctx;
  GumInstrumentationError error;

  gum_interceptor_ignore_current_thread (self);
  GUM_INTERCEPTOR_LOCK (self);
  gum_interceptor_transaction_begin (&amp;self-&gt;current_transaction);
  self-&gt;current_transaction.is_dirty = TRUE;

  function_address = gum_interceptor_resolve (self, function_address);

  function_ctx = gum_interceptor_instrument (self, GUM_INTERCEPTOR_TYPE_DEFAULT,
      function_address, &amp;error);

  if (function_ctx == NULL)
    goto instrumentation_error;

  if (gum_function_context_has_listener (function_ctx, listener))
    goto already_attached;

  gum_function_context_add_listener (function_ctx, listener,
      listener_function_data);

  goto beach;

instrumentation_error:
  &#123;
    switch (error)
    &#123;
      case GUM_INSTRUMENTATION_ERROR_WRONG_SIGNATURE:
        result = GUM_ATTACH_WRONG_SIGNATURE;
        break;
      case GUM_INSTRUMENTATION_ERROR_POLICY_VIOLATION:
        result = GUM_ATTACH_POLICY_VIOLATION;
        break;
      case GUM_INSTRUMENTATION_ERROR_WRONG_TYPE:
        result = GUM_ATTACH_WRONG_TYPE;
        break;
      default:
        g_assert_not_reached ();
    &#125;
    goto beach;
  &#125;
already_attached:
  &#123;
    result = GUM_ATTACH_ALREADY_ATTACHED;
    goto beach;
  &#125;
beach:
  &#123;
    gum_interceptor_transaction_end (&amp;self-&gt;current_transaction);
    GUM_INTERCEPTOR_UNLOCK (self);
    gum_interceptor_unignore_current_thread (self);

    return result;
  &#125;
&#125;
</code></pre>
<p>跟进看这里的实现</p>
<pre><code class="cpp">static gpointer
gum_interceptor_resolve (GumInterceptor * self,
                         gpointer address)
&#123;
  address = gum_strip_code_pointer (address);

  if (!gum_interceptor_has (self, address))
  &#123;
    const gsize max_redirect_size = 16;
    gpointer target;

    gum_ensure_code_readable (address, max_redirect_size);

    /* Avoid following grafted branches. */
    if (gum_process_get_code_signing_policy () == GUM_CODE_SIGNING_REQUIRED)
      return address;

    target = _gum_interceptor_backend_resolve_redirect (self-&gt;backend,
        address);
    if (target != NULL)
      return gum_interceptor_resolve (self, target);
  &#125;

  return address;
&#125;
</code></pre>
<p>可以进到：这部分是比较核心的生成跳转shellcode的部分，或许也可以从这部分下手来考虑对抗？(TODO+1)</p>
<pre><code class="cpp">gpointer
gum_arm64_reader_try_get_relative_jump_target (gconstpointer address)
&#123;
  gpointer result = NULL;
  csh capstone;
  cs_insn * insn;
  const uint8_t * code;
  size_t size;
  uint64_t pc;
  const cs_arm64_op * ops;

  cs_arch_register_arm64 ();
  cs_open (CS_ARCH_ARM64, GUM_DEFAULT_CS_ENDIAN, &amp;capstone);
  cs_option (capstone, CS_OPT_DETAIL, CS_OPT_ON);

  insn = cs_malloc (capstone);

  code = address;
  size = 16;
  pc = GPOINTER_TO_SIZE (address);

#define GUM_DISASM_NEXT() \
    if (!cs_disasm_iter (capstone, &amp;code, &amp;size, &amp;pc, insn)) \
      goto beach; \
    ops = insn-&gt;detail-&gt;arm64.operands
#define GUM_CHECK_ID(i) \
    if (insn-&gt;id != G_PASTE (ARM64_INS_, i)) \
      goto beach
#define GUM_CHECK_OP_TYPE(n, t) \
    if (ops[n].type != G_PASTE (ARM64_OP_, t)) \
      goto beach
#define GUM_CHECK_OP_REG(n, r) \
    if (ops[n].reg != G_PASTE (ARM64_REG_, r)) \
      goto beach
#define GUM_CHECK_OP_MEM(n, b, i, d) \
    if (ops[n].mem.base != G_PASTE (ARM64_REG_, b)) \
      goto beach; \
    if (ops[n].mem.index != G_PASTE (ARM64_REG_, i)) \
      goto beach; \
    if (ops[n].mem.disp != d) \
      goto beach

  GUM_DISASM_NEXT ();

  switch (insn-&gt;id)
  &#123;
    case ARM64_INS_B:
      result = GSIZE_TO_POINTER (ops[0].imm);
      break;
#ifdef HAVE_DARWIN
    case ARM64_INS_ADRP:
    &#123;
      GumAddress target;

      GUM_CHECK_OP_REG (0, X17);
      target = ops[1].imm;

      GUM_DISASM_NEXT ();
      GUM_CHECK_ID (ADD);
      GUM_CHECK_OP_REG (0, X17);
      GUM_CHECK_OP_REG (1, X17);
      GUM_CHECK_OP_TYPE (2, IMM);
      target += ops[2].imm;

      GUM_DISASM_NEXT ();
      GUM_CHECK_ID (LDR);
      GUM_CHECK_OP_REG (0, X16);
      GUM_CHECK_OP_TYPE (1, MEM);
      GUM_CHECK_OP_MEM (1, X17, INVALID, 0);

      GUM_DISASM_NEXT ();
      GUM_CHECK_ID (BRAA);
      GUM_CHECK_OP_REG (0, X16);
      GUM_CHECK_OP_REG (1, X17);

      result = *((gpointer *) GSIZE_TO_POINTER (target));

      break;
    &#125;
#endif
    default:
      break;
  &#125;

beach:
  cs_free (insn, 1);

  cs_close (&amp;capstone);

  return result;
&#125;
</code></pre>
<p>创建拦截器后端以及分配器初始化</p>
<pre><code class="cpp">gum_interceptor_init (GumInterceptor * self)
&#123;
  g_rec_mutex_init (&amp;self-&gt;mutex);

  self-&gt;function_by_address = g_hash_table_new_full (NULL, NULL, NULL,
      (GDestroyNotify) gum_function_context_destroy);

  gum_code_allocator_init (&amp;self-&gt;allocator, GUM_INTERCEPTOR_CODE_SLICE_SIZE);

  gum_interceptor_transaction_init (&amp;self-&gt;current_transaction, self);
&#125;
</code></pre>

    </div>
    
</div>
                         
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 20xx - 2024 Moyao の小屋
            <span class="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            @Moyao
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a> & <a
                target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a></div>
        
    </div>
</footer>
                    </div>
                </div>
            </transition>
            <div id="img_show">
                <img id="img_content" alt="img_show">
            </div>
        </div>
        <script src="https://cdn.staticfile.org/highlight.js/11.5.1/highlight.min.js"></script>
        <script src="/js/particlex.js"></script>
        <script src="/js/showimg.js"></script>
        

    </body>
</html>