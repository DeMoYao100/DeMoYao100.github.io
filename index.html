<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"demoyao100.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Write down something interesting I met Feel free to mail me if you have something wanted to talk about, plz mail: <moyaoxue@outlook.com>">
<meta property="og:type" content="website">
<meta property="og:title" content="Moyao の小屋">
<meta property="og:url" content="https://demoyao100.github.io/index.html">
<meta property="og:site_name" content="Moyao の小屋">
<meta property="og:description" content="Write down something interesting I met Feel free to mail me if you have something wanted to talk about, plz mail: <moyaoxue@outlook.com>">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Moyao">
<meta property="article:tag" content="CTF, Rev, Pwn, 渗透, Web Security">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://demoyao100.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Moyao の小屋 - Hi,I'm Moyaoxue</title>
  
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KKC145B2WB"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KKC145B2WB","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Moyao の小屋</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Hi,I'm Moyaoxue</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags.html" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories.html" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        
        <div class="post-toc-wrap sidebar-panel">
        </div>
        

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Moyao" src="/images/avatar.webp">
  <p class="site-author-name" itemprop="name">Moyao</p>
  <div class="site-description" itemprop="description">Write down something interesting I met<br>
Feel free to mail me if you have something wanted to talk about, plz
mail: &lt;moyaoxue@outlook.com&gt;
</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">78</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags.html">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="/moyaoxue@outlook.com" title="E-Mail → moyaoxue@outlook.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://demoyao100.github.io/2024/05/08/%E8%BD%A6UDS%E8%AF%8A%E6%96%AD%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Moyao">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moyao の小屋">
      <meta itemprop="description" content="Write down something interesting I met<br />
Feel free to mail me if you have something wanted to talk about, plz
mail: <moyaoxue@outlook.com>
">
    </span>

    <span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moyao の小屋">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/08/%E8%BD%A6UDS%E8%AF%8A%E6%96%AD%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">车UDS诊断协议学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-08 00:40:00" itemprop="dateCreated datePublished" datetime="2024-05-08T00:40:00+08:00">2024-05-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="车uds诊断协议学习"><a class="anchor" href="#车uds诊断协议学习">#</a> 车 UDS 诊断协议学习</h1>
<h2 id="概念"><a class="anchor" href="#概念">#</a> 概念</h2>
<p><strong>统一诊断服务</strong>（英语：<strong>Unified Diagnostic Services</strong>，简称 UDS）是车用电子的通信协议，是电子控制器（ECU）中设备诊断用的网络传输协议，对应的标准是 ISO 14229-1。</p>
<p>诊断工具可以连接车上所有支持统一诊断服务功能的电子控制器。车上常用的控制器局域网只用到 OSI 模型的第一层及第二层，而统一诊断服务集成了 OSI 模型的第五层及第七层。服务标识符（Service ID、SID）及服务相关的参数都放在 8 个字节的消息框内。</p>
<p>现今的车辆有配合离线诊断的诊断接口，让电脑或是诊断工具（作为测试设备）可以连接到汽车上的通信系统。因此可以发送统一诊断服务的请求到控制器，控制器必须回复（可能是正面或是负面的回复），这样可以确认个别控制单元中的故障存储器、更新控制单元的固件、和硬件进行低端的交互（例如开启或关闭特定的输出）、或是进行特定的机能，目的是了了解电子控制器的环境或是操作条件，以<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%A8%BA%E6%96%B7_(%E5%B7%A5%E7%A8%8B)">诊断</a>故障或是不希望出现的行为。</p>
<h2 id="术语"><a class="anchor" href="#术语">#</a> 术语</h2>
<p><strong>Diagnostic Service （诊断服务）</strong></p>
<p>诊断服务是介于诊断设备和 ECU 之间的一种信息交互方式。通常由诊断设备发出请求，ECU 做出回应。</p>
<p><strong>Diagnostic Trouble Code （故障码）</strong></p>
<p>故障码是用来标记 ECU 故障的代码，它遵循一定的规则，存储在 ECU 的非易失性存储中。（以后别人提到 DTC，不要说不知道是什么了）</p>
<p><strong>Diagnostic Data （诊断数据）</strong></p>
<p>诊断数据是可以被诊断设备请求的 ECU 内部数据，它包括：</p>
<ul>
<li>当前数据：ECU 正在运行的数据，比如车速、节气门开度，发动机转速等；</li>
<li>存储数据：被 ECU 存储在存储器中某时刻的数据，比如 DTC；</li>
<li>静态数据：恒定不变的 ECU 内部数据，比如 VIN 码。</li>
</ul>
<p><strong>Diagnostic Session （诊断会话）</strong></p>
<p>可以理解为某种诊断模式或权限，即在不同的模式下，对不同的诊断服务的使用做了限制。</p>
<p><strong>Diagnostic Routine （诊断例程）</strong></p>
<p>驻留在被诊断 ECU 中的子程序，它可以被诊断设备启动和停止。比如格式化 EEPROM 的子程序。</p>
<p><strong>Addressing Type （寻址方式）</strong></p>
<p>寻址方式指的是诊断消息的传递方式，有两种寻址方式：</p>
<ul>
<li>物理寻址，即 1 对 1 通信，用于知道确切的被诊断 ECU 的地址；</li>
<li>功能寻址，即 1 对 n 通信，或者说广播发送，用于不知道确切的被诊断的 ECU 的地址，向一组或者全体 ECU 发送请求；</li>
</ul>
<p><strong>Response（响应）</strong></p>
<p>tester 请求诊断服务执行后，从 ECU 的返回结果。可以有两种结果：</p>
<ul>
<li>Positive Response，正响应，即诊断请求执行成功；</li>
<li>Negative Response，负响应，即诊断请求执行失败；</li>
</ul>
<p><strong>Service Identifier</strong></p>
<p>Service Identifier，诊断服务标识符，简称为 SID，一字节的无符号整数，用来指代某个诊断服务。诊断协议为每个诊断服务都分配唯一 SID，因此更方便协议的软件实现。同时，在开发过程中沟通更加方便。比如，ReadDataByIdentifier 服务是去按照 ID 去读诊断数据，直接说 22 服务会更加便捷。</p>
<p><strong>Data Identifier</strong></p>
<p>简称 DID，2 个字节无符号整数的 ID，用来标识 ECU 中存储的某个诊断数据单元。它的好处是当要读取某个单元的诊断数据时，只要读对应的 DID 就可以，不必知道数据的具体地址。即使当 ECU 中的数据地址发生变化时，改变 DID 和地址单元的映射关系即可，对于使用者来说 DID 屏蔽了具体实现细节，而将重点放在了数据本身。</p>
<p><strong>Negative Response Code</strong></p>
<p>可以简称为 NRC，或者叫负响应码，是一个字节的无符号整数。它是诊断协议为每种执行失败的诊断服务分配的失败原因代号。</p>
<p><strong>Sub-function</strong></p>
<p>有些诊断服务可以支持不同的诊断子服务，sub-function 就是用来定义这种子服务的，它将某一个服务细分为更为具体的服务，是一个字节的无符号整数。比如 ECU Reset 这个服务就有 0x01，0x02，0x03 等 sub-function 指代具体的 reset 方式。</p>
<h2 id="通信模式"><a class="anchor" href="#通信模式">#</a> 通信模式</h2>
<p>事件驱动型，一问一答。</p>
<p>类比 client-server 通信方式，诊断仪即客户端，发送 request，服务器即 ECU，收到 request 之后进行处理，然后向诊断仪回复 response。</p>
<p>有确认服务：</p>
<p>![Untitled](车 UDS 诊断协议学习 12f4a2023fb44b1abadd10b14d012d7c/Untitled.png)</p>
<p>无确认服务：</p>
<p>![Untitled](车 UDS 诊断协议学习 12f4a2023fb44b1abadd10b14d012d7c/Untitled 1.png)</p>
<p><strong>寻址模式</strong></p>
<ul>
<li>物理寻址，点对点，一对一，可根据物理地址的不同进行访问，但只能访问单个节点，各个 ECU 也采用不同的 CANID 针对提问作出应答。</li>
<li>功能寻址，广播模式，一对多，根据功能的不同进行访问，它可以访问多个 ECU 节点，各个 ECU 也采用不同的 CANID 针对提问作出应答。其 SID 对于标准帧来说，通常是 7DF。</li>
</ul>
<p>比如，通过诊断仪请求各控制器进入编程模式（10 02）：</p>
<p>** 物理寻址：** 诊断仪请求 EMS 进入刷新模式 7E0 10 02 ECU 响应诊断仪进入刷新模式 7E8 50 02</p>
<p>** 功能寻址：** 诊断仪请求所有控制器进入刷新模式 7DF 10 02EMS 应答诊断仪进入刷新模式 7E8 50 02TCU 应答诊断仪进入刷新模式 7E9 50 02MMI 应答诊断仪进入刷新模式 7EA 50 02</p>
<h2 id="请求和响应"><a class="anchor" href="#请求和响应">#</a> 请求和响应</h2>
<p><strong>基本格式</strong></p>
<p>归纳起来，诊断的 request 格式无非以下两种：</p>
<p>&lt;SID&gt; + &lt;Sub-function&gt; + &lt;Parameter&gt;</p>
<p>&lt;SID&gt; + &lt;Parameter&gt;</p>
<p>即有无 sub-function 的区别。Parameter 可以是 DID，可以是输入参数，可以是自定义的值，字节数视具体要求而定。</p>
<p><strong>有 sub-function</strong></p>
<p>首先，了解下 sub-function 的定义方法。</p>
<p><img src="https://pic2.zhimg.com/80/v2-77482878fd4af8374b34d8eb1cd648f1_1440w.webp" alt="https://pic2.zhimg.com/80/v2-77482878fd4af8374b34d8eb1cd648f1_1440w.webp"></p>
<p>功能寻址的客户端请求信息</p>
<p><img src="https://pic4.zhimg.com/80/v2-6ae2618313c5487b2c7579dc09455d7b_1440w.webp" alt="https://pic4.zhimg.com/80/v2-6ae2618313c5487b2c7579dc09455d7b_1440w.webp"></p>
<p>物理寻址的客户端请求信息</p>
<p>需要注意的是，Bit7 用来指示是否要抑制 Positive Response。当 Bit 7 为 1 时，对该 request 的 Positive Response 要被抑制，即不发送 Positive Response；当 Bit7 为 0 时，对该 request 的 Positive Response 不被抑制，正常发送。除了 Bit 7，Sub-function 有不同的值，具体的值和含义在协议中对每个服务的解释时都会有介绍。</p>
<p><strong>无 sub-function</strong></p>
<p>不带 sub-function 的服务，就带 parameter。Parameter 可以是 DID，可以是输入参数，可以是自定义的值，字节数目也是视具体要求而定。一般在协议内都会有表格，当遇到具体问题时，可查表确定。</p>
<p><img src="https://pic1.zhimg.com/80/v2-349d7a784958fa581ad5230392cad4ac_1440w.webp" alt="https://pic1.zhimg.com/80/v2-349d7a784958fa581ad5230392cad4ac_1440w.webp"></p>
<p>不带子功能 -- 功能寻址的客户端请求信息</p>
<p><img src="https://pic3.zhimg.com/80/v2-9a1eb7e0db90bcd3beffcf395c455e1e_1440w.webp" alt="https://pic3.zhimg.com/80/v2-9a1eb7e0db90bcd3beffcf395c455e1e_1440w.webp"></p>
<p>不带子功能 -- 物理寻址的客户端请求信息</p>
<p><strong>5.2 Response</strong></p>
<p>通常，response 会在服务被 request 且执行之后发送，成功的话就发 positive response，失败的话要发 negative response，但是也有例外的时候。比如，ECUreset，诊断仪要求先发送 response，然后再去执行具体的 reset，因为如果先 reset，那么 ECU 的通信模块 shut down，是无法发送出去 response 的。像这种特殊情况，协议会在描述具体服务时标注出来。</p>
<p><strong>Positive Response</strong></p>
<p>基本格式：</p>
<p>&lt;SID+0x40&gt; + &lt;Sub-function&gt; + &lt;Parameter&gt;</p>
<p>&lt;SID+0x40&gt; + &lt;Parameter&gt;</p>
<p>要注意，第一个字节是由 SID 和 0x40 的和构成。这里的 Parameter 项是 optional 的，具体要看协议规定。</p>
<p>比如，session control 这个服务：</p>
<p>Send：02 10 01（02 中的 0 代表网络层单帧 SF，2 代表数据域有 2 个字节；10 是 SID，02 是子功能）</p>
<p>肯定响应：</p>
<p>Receive：02 50 01 （02 同上，10+40 表示对 SID 的肯定回复，01 是 sub-funtion）</p>
<p>否定响应:</p>
<p>03 7F 10 22 xx xx xx xx；（03 同上，7F 表示否定响应，10 是 SID，22 是 NRC）不论是物理寻址还是功能寻址，对于 Positive Response 来说都没有影响，只需要关注 sub-function 中的 Bit 7 suppressPosRspMsgIndicationBit 是 0 还是 1，如果为 0 即 false，那么正常发送即可，如果是 1 即 true，那么就不发送 response。如果根本没有 subfunction 呢，那么什么都不要考虑，肯定是要发送 positive response 的。</p>
<p><img src="https://pic1.zhimg.com/80/v2-35fcf45931108493f16f71bbe0bba5e8_1440w.webp" alt="https://pic1.zhimg.com/80/v2-35fcf45931108493f16f71bbe0bba5e8_1440w.webp"></p>
<p>安全访问的过程</p>
<p>Negative Response</p>
<p>基本格式:</p>
<p>&lt;0x7F&gt; + &lt;SID&gt; + &lt;NRC&gt;</p>
<p>看起来比较简单，格式比较固定，只要是 Negative Response，第一字节就是 0x7F，第二字节照抄原来的 SID，第三个字节是错误响应码，指示具体错误响应的原因，这个 NRC 可以在下文中参看。</p>
<p>比如，session control 这个服务：</p>
<p>Send：10 05（现在 sun-function 变为 05 了，假定系统不支持这个 sub-function）</p>
<p>Receive：7F 10 12（7F 即指代错误响应，10 为 SID，12 是 NRC，查协议可知其指代 sub-function not supported 这个错误）</p>
<p><strong>常用的 NRC</strong></p>
<ul>
<li>11：ServiceNotSupported / 服务不支持，诊断仪发送的请求消息中服务标识符无法识别或不支持；</li>
<li>12：SubFunctionNotSupported / 不支持子服务，诊断仪发送的请求消息中子服务无法识别或不支持；</li>
<li>13：IncorrectMessageLengthOrInvalidFormat / 不正确的消息长度或无效的格式，请求消息长度与特定服务规定的长度不匹配或者是参数格式与特定服务规定的格式不匹配；</li>
<li>21：BusyRepeatRequest / 重复请求忙，表明 ECU 太忙而不能去执行请求。一般来说，在这种情况下，诊断仪应进行重复请求工作；</li>
<li>22：conditionsNotCorrect / 条件不正确，表明 ECU 的状态条件不允许支持该请求；</li>
<li>24：requestSequenceError / 请求序列错误，表明收到的是非预期的请求消息序列；</li>
<li>25：noResponseFromSubnetComponent / 子网节点无应答，表明 ECU 收到请求，但所请求的操作无法执行；</li>
<li>26：failurePreventsExecutionOfRequestedAction / 故障阻值请求工作执行，表明请求的动作因一故障原因而没有执行；</li>
<li>31：requestOutOfRange / 请求超出范围，请求消息包含一个超出允许范围的参数，或者是不支持的数据标识符 / 例程标识符的访问；</li>
<li>33：securityAccessDenied / 安全访问拒绝，诊断仪无法通过 ECU 的安全策略；</li>
<li>35：invalidKey / 密钥无效，诊断仪发送的密钥与 ECU 内存中的密钥不匹配；</li>
<li>36：exceedNumberOfAttempts / 超出尝试次数，诊断仪尝试获得安全访问失败次数超过了 ECU 安全策略允许的值；</li>
<li>37：requiredTimeDelayNotExpired / 所需时间延迟未到，在 ECU 所需的请求延迟时间过去之前诊断仪又执行了一次请求；</li>
<li>70：uploadDownloadNotAccepted / 不允许上传下载，表明试图向 ECU 内存上传 / 下载数据失败的原因是条件不允许；</li>
<li>71：transferDataSuspended / 数据传输暂停，表明由于错误导致数据传输操作的中止；</li>
<li>72：generalProgrammingFailure / 一般编程失败，表明在不可擦除的内存设备中进行擦除或编程时 ECU 检测到错误发生；</li>
<li>73：wrongBlockSequenceCounter / 错误的数据块序列计数器，ECU 在数据块序列计数序列中检测到错误发生；</li>
<li>78：requestCorrectlyReceived-ResponsePending / 正确接收请求消息 - 等待响应 表明 ECU 正确接收到请求消息，但是将执行的动作未完成且 ECU 未准备好接收其它请求；</li>
<li>7E：subFunctionNotSupportedInActiveSession / 激活会话不支持该子服务，当前会话模式下 ECU 不支持请求的子服务；</li>
<li>7F：serviceNotSupportedInActiveSession / 激活会话不支持该服务，当前会话模式下 ECU 不支持请求的服务；</li>
<li>92：voltageTooHigh / 电压过高，当前电压值超过了编程允许的最大门限值；</li>
<li>93：voltageTooLow / 电压过低，当前电压值低于了编程允许的最小门限值；</li>
</ul>
<p>诊断仪发送报文 “85 02” 要求 EMS 关闭故障管理 ，如果是肯定应答则 EMS 会回复 “C5 02”，表示已经关闭故障管理；如果是否定应答，EMS 会回复 “7F 85 22”，表示没有关闭故障管理，原因是条件不正确。</p>
<p>值得一提的是，在物理寻址和功能寻址情况下，Negative Response 有所不同。</p>
<p>在物理寻址情况下，只要是 Negative Response 就应该按照规定格式发送。而在功能寻址情况下，有一点特殊，对于 NRC 为 0x11（service not supported）、0x12（subfunction not supported）、0x31（request out of range）这三种情况，功能寻址是不会发送 response 的。</p>
<p><img src="https://pic2.zhimg.com/80/v2-f499d2093bc10d07c17db3b576d08975_1440w.webp" alt="https://pic2.zhimg.com/80/v2-f499d2093bc10d07c17db3b576d08975_1440w.webp"></p>
<h2 id="服务"><a class="anchor" href="#服务">#</a> 服务</h2>
<table>
<thead>
<tr>
<th>功能群</th>
<th>请求&nbsp; SID</th>
<th>回复&nbsp; SID</th>
<th>服务</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>诊断及通信管理</td>
<td>0x10</td>
<td>0x50</td>
<td>诊断会话控制 Diagnostic Session Control</td>
<td>UDS 会使用不同的会话（session），可以用诊断会话控制（Diagnostic Session Control）来切换。可用的服务会依照目前有效的会话而不同。在一开始，控制单元默认是在 “默认会话”（Default Session），有定义其他的会话，需要实现的会话会依照设备的种类而不同。</td>
</tr>
<tr>
<td>・“程序会话”（Programming Session）可以用来上传固件到设备，并更新设备的固件。</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>・“扩展诊断会话”（Extended Diagnostic Session）可解锁特定的诊断功能，例如调整传感器等。</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>・“安全系统诊断会话”（Safety system diagnostic session）用来测试安全相关的诊断机能，例如安全气囊的测试。</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>此外，也有一些保留的会话识别符，为了汽车生产者及供应商的特殊需求而设计。</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>诊断及通信管理</td>
<td>0x11</td>
<td>0x51</td>
<td>ECU 重置 ECU Reset</td>
<td>ECU 重置的服务是要重启 ECU。依照控制单元硬件以及实现方式的不同，有以下几种不同的重置：</td>
</tr>
<tr>
<td>・“硬重置” 模拟电源关闭的重置。</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>・“关闭锁匙重置” 模拟用锁匙将汽车熄火，再开启汽车的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%BB%9E%E7%81%AB%E9%96%8B%E9%97%9C%E3%80%82"> https://zh.wikipedia.org/wiki/ 點火開關。</a></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>・“软重置” 初始化特定程序单元以及存储结构。</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>也有一些汽车生产者及供应商定义的特殊数值。</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>诊断及通信管理</td>
<td>0x27</td>
<td>0x67</td>
<td>安全性访问 Security Access</td>
<td>可以用安全性检查（Security check）来启动大部分的安全关键性服务（security-critical services）。此情形下控制单元会发送 “密码种子（seed）” 到客户端（电脑或是诊断工具）。客户端再用密码种子计算密钥（key）送回控制单元，以此来解安全关键性服务</td>
</tr>
<tr>
<td>诊断及通信管理</td>
<td>0x28</td>
<td>0x68</td>
<td>通信控制 Communication Control</td>
<td>此服务可以关闭控制单元发送以及接收消息的功能。</td>
</tr>
<tr>
<td>诊断及通信管理</td>
<td>0x29</td>
<td>0x69</td>
<td>认证 Authentication</td>
<td>标准在 2020 年的更新版本，提供一种标准化的方式，可以提供一些安全性访问（0x27）服务无法支持的现代认证方式，包括以<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%85%AC%E9%96%8B%E9%87%91%E9%91%B0%E5%9F%BA%E7%A4%8E%E5%BB%BA%E8%A8%AD%E4%B8%BA%E5%9F%BA%E7%A1%80%E7%9A%84%E8%AE%A4%E8%AF%81%E4%BA%A4%E6%8D%A2%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%8F%8C%E5%90%91%E7%9A%84https://zh.wikipedia.org/wiki/%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E6%9C%BA%E5%88%B6%E3%80%82"> https://zh.wikipedia.org/wiki/ 公開金鑰基礎建設为基础的认证交换，以及双向的 https://zh.wikipedia.org/wiki/ 身份验证机制。</a></td>
</tr>
<tr>
<td>诊断及通信管理</td>
<td>0x3E</td>
<td>0x7E</td>
<td>测试者存在 Tester Present</td>
<td>若客户端长时间没有交换通信资料，控制单元会自动离开目前的会话，回到 “默认会话”，也可能会进入休眠模式。而此一服务的目的就是让控制单元知道客户端仍存在。</td>
</tr>
<tr>
<td>诊断及通信管理</td>
<td>0x83</td>
<td>0xC3</td>
<td>访问时序参数 Access Timing Parameters</td>
<td>在控制器及从机的通信中，需要观察一定的时间，若时间超过此限制，仍没有提交消息，就会假设连接已有问题。可以读取及修改此时间。</td>
</tr>
<tr>
<td>诊断及通信管理</td>
<td>0x84</td>
<td>0xC4</td>
<td>安全资料传输 Secured Data Transmission</td>
<td></td>
</tr>
<tr>
<td>诊断及通信管理</td>
<td>0x85</td>
<td>0xC5</td>
<td>控制 DTC 设置 Control DTC Settings</td>
<td>启动或关闭部分（或所有）错误的侦测。若诊断工作是在车内进行的，这个机能格外重要，因为诊断工作有可能造成部分零件的异常行为。</td>
</tr>
<tr>
<td>诊断及通信管理</td>
<td>0x86</td>
<td>0xC6</td>
<td>事件回复 Response On Event</td>
<td></td>
</tr>
<tr>
<td>诊断及通信管理</td>
<td>0x87</td>
<td>0xC7</td>
<td>链接控制 Link Control</td>
<td>服务链接控制是用来设置诊断访问的比特率。多半只在中间网关上实现此一机能。</td>
</tr>
<tr>
<td>资料传输</td>
<td>0x22</td>
<td>0x62</td>
<td>根据标识符读取资料 Read Data By Identifier</td>
<td>透过此服务可以读取控制单元中一个或多个的资料。这些资料的种类不限，也可以有不同的长度，例如料号或是软件版本等。也可以读取像是传感器状态之类会变动的值。每一个值会对一个资料标识符（Data Identifier、简称 DID），数值从 0 到 65535。会用正常的 CAN 信号来发送特定 ECU 使用的资料。DID 资料只用在资料请求上，也可以用一些没有 ECU 使用的 DID 来发送信息，虽 ECU 不会使用，但服务工具或软件测试程序可以使用这类的信息。</td>
</tr>
<tr>
<td>资料传输</td>
<td>0x23</td>
<td>0x63</td>
<td>根据地址读取存储器 Read Memory By Address</td>
<td>依给定地址读取物理内存中的值。测试工具可以用此机能来读取软件内部的行为。</td>
</tr>
<tr>
<td>资料传输</td>
<td>0x24</td>
<td>0x64</td>
<td>根据标识符读取缩放比例资料 Read Scaling Data By Identifier</td>
<td></td>
</tr>
<tr>
<td>资料传输</td>
<td>0x2A</td>
<td>0x6A</td>
<td>周期性根据标识符读取资料 Read Data By Identifier Periodic</td>
<td>透过此服务可以让控制单元周期性发送资料。只能发送透过 “动态定义资料标识符” 定义的标识符</td>
</tr>
<tr>
<td>资料传输</td>
<td>0x2C</td>
<td>0x6C</td>
<td>动态定义资料标识符 Dynamically Define Data Identifier</td>
<td>此服务提供一个修正设备资料标识符（DID）的方式，可以重新调整资料标识符。这个通常是不同资料标识符的组合，或者单纯是所有 DID 的串接。请求资料可以依以下的原则规划配置：</td>
</tr>
<tr>
<td>・原始资料标识符、位置、长度（依字节表示）、子功能字节：defineByIdentifier</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>・存储器位置、长度（依字节表示）、子功能字节：defineByMemoryAddress</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>・可以结合上述二种方式</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>资料传输</td>
<td>0x2E</td>
<td>0x6E</td>
<td>根据标识符写入资料 Write Data By Identifier</td>
<td>可以更改资料标识符中的数值，命令中除了资料标识符外，也要同时提供要修改的数值</td>
</tr>
<tr>
<td>资料传输</td>
<td>0x3D</td>
<td>0x7D</td>
<td>根据地址写入到存储器 Write Memory By Address</td>
<td>“根据地址写入到存储器” 可以让外面诊断工具写信息到 ECU 里的特定地址，或特定的连续地址</td>
</tr>
<tr>
<td>存储资料发送</td>
<td>0x14</td>
<td>0x54</td>
<td>清除诊断信息 Clear Diagnostic Information</td>
<td>清除已存储的诊断问题码（Diagnostic Trouble Code，简称 DTC）</td>
</tr>
<tr>
<td>存储资料发送</td>
<td>0x19</td>
<td>0x59</td>
<td>读取 DTC 信息 Read DTC Information</td>
<td>DTC 是诊断问题码。每一个 DTC 对应一个控制单元的故障，会以其编码存储在错误存储器中，可以在任意时候读取。除了错误外，也可能会记录一些相关的信息，也可以一并读取。</td>
</tr>
<tr>
<td>输入／输出控制</td>
<td>0x2F</td>
<td>0x6F</td>
<td>根据标识符的输入／输出控制 Input Output Control By Identifier</td>
<td>此服务可以让外部系统接口透过诊断接口控制输入／输出信号透过设置选择字节，可以设置有关请求的特殊条件，可以设置以下的值：</td>
</tr>
<tr>
<td>ReturnControlToECU：设备需将信号的控制权送回</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ResetToDefault：测试者试图重置信号，回到系统的默认值</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Freeze Current State：设备需冻结目前的信号，不允许变化</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ShortTermAdjustment：设备需使用目前提供的信号值</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>远程启动程序</td>
<td>0x31</td>
<td>0x71</td>
<td>远程控制 Routine Control</td>
<td>此控制服务程序可以进行各种的服务，有三种不同的信息种类：</td>
</tr>
<tr>
<td>・配合启始信息，可以开始服务。可以定义此信息来确认要执行各动作，或是提示服务已经完成。</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>・配合停止信息，运行中的服务可以在任何时间下中断。</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>・第三个选项是查询服务状态的信息</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>可以特别标示启始及结束的信息参数，因此可以实现每一种项目特定的服务。</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>上传／下载</td>
<td>0x34</td>
<td>0x74</td>
<td>请求下载 Request Download</td>
<td>利用 “请求下载” 服务，可以下载新的软件或是其他资料到控制单元内。需标示资料的位置以及长度，因此，控制器可以知道数据包的大小。</td>
</tr>
<tr>
<td>上传／下载</td>
<td>0x35</td>
<td>0x75</td>
<td>请求上传 Request Upload</td>
<td>“请求上传” 服务和 “请求下载” 服务是类似的，此服务可以将控制单元的软件发送给测试者。也需标示资料的位置以及长度，测试者需指定数据包的大小。</td>
</tr>
<tr>
<td>上传／下载</td>
<td>0x36</td>
<td>0x76</td>
<td>发送资料 Transfer Data</td>
<td>在真正发送资料时，会用到此一服务，不论是上传或是下载都是使用此一服务。发送的方向则视之前是 “请求上传” 服务或 “请求下载” 服务而不同。此一服务会用之前指定的最大数据包长度发送资料，若资料长度超过最大数据包长度，需要用数个数据包来发送，直到发送完成为止。</td>
</tr>
<tr>
<td>上传／下载</td>
<td>0x37</td>
<td>0x77</td>
<td>请求结束发送 Request Transfer Exit</td>
<td>可以用此服务中止资料发送。此服务用在测试着和控制单元比较时。在执行时，控制单元可以负面回应来中止资料发送请求。若指定的资料量还没发送完，也可以用此服务中止发送。</td>
</tr>
<tr>
<td>上传／下载</td>
<td>0x38</td>
<td>0x78</td>
<td>请求文件发送 Request File Transfer</td>
<td>此服务用来启始客户端到服务器的文件下载，或是服务器到客户端的文件上传。也可以提供一些文件系统的相关信息。</td>
</tr>
<tr>
<td></td>
<td></td>
<td>0x7F</td>
<td>否定回应 Negative Response</td>
<td>此回应会在服务无法进行时回复，例如不支持的资料识别符。此时会加上否定的回应码。</td>
</tr>
</tbody>
</table>
<h2 id="nrc-negative-response-codes"><a class="anchor" href="#nrc-negative-response-codes">#</a> NRC: Negative response codes</h2>
<p>来自 ECU 的否定回应 (Negative Response) 包含 SID 0x7F 和两个有效负载字节：请求的 SID 和错误代码。</p>
<p>错误代码 (NRC) 如下：</p>
<table>
<thead>
<tr>
<th>NRC</th>
<th>Description</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>0x10</td>
<td>General reject</td>
<td>一般拒绝</td>
</tr>
<tr>
<td>0x11</td>
<td>Service not supported</td>
<td>不支持的服务</td>
</tr>
<tr>
<td>0x12</td>
<td>Subfunction not supported</td>
<td>不支持的子功能</td>
</tr>
<tr>
<td>0x13</td>
<td>Incorrect message length or invalid format</td>
<td>消息长度不正确或格式错误</td>
</tr>
<tr>
<td>0x14</td>
<td>Response too long</td>
<td>反应时间太长</td>
</tr>
<tr>
<td>0x21</td>
<td>Busy, repeat request</td>
<td>忙碌 / 重复请求</td>
</tr>
<tr>
<td>0x22</td>
<td>Conditions not correct</td>
<td>条件不正确</td>
</tr>
<tr>
<td>0x24</td>
<td>Request sequence error</td>
<td>请求顺序错误</td>
</tr>
<tr>
<td>0x25</td>
<td>No response from subnet component</td>
<td>子网组件无回应</td>
</tr>
<tr>
<td>0x26</td>
<td>Failure prevents execution of requested action</td>
<td>阻止执行请求的操作失败</td>
</tr>
<tr>
<td>0x31</td>
<td>Request out of range</td>
<td>请求超出范围</td>
</tr>
<tr>
<td>0x33</td>
<td>Security access denied</td>
<td>安全访问被拒绝</td>
</tr>
<tr>
<td>0x34</td>
<td>Authentication failed</td>
<td>认证失败</td>
</tr>
<tr>
<td>0x35</td>
<td>Invalid key</td>
<td>无效的密钥</td>
</tr>
<tr>
<td>0x36</td>
<td>Exceeded number of attempts</td>
<td>超过尝试次数</td>
</tr>
<tr>
<td>0x37</td>
<td>Required time delay not expired</td>
<td>要求的延迟时间未到</td>
</tr>
<tr>
<td>0x38</td>
<td>Secure data transmission required</td>
<td>需要安全的资料传输 (SID=0x84)</td>
</tr>
<tr>
<td>0x39</td>
<td>Secure data transmission not allowed</td>
<td>不允许安全资料传输</td>
</tr>
<tr>
<td>0x3A</td>
<td>Secure data verification failed</td>
<td>安全资料验证失败</td>
</tr>
<tr>
<td>0x50</td>
<td>Certificate validation failed, invalid time period</td>
<td>证书验证失败，时段无效</td>
</tr>
<tr>
<td>0x51</td>
<td>Certificate validation failed, invalid signature</td>
<td>证书验证失败，签名无效</td>
</tr>
<tr>
<td>0x52</td>
<td>Certificate validation failed, invalid chain of trust</td>
<td>证书验证失败，信任链无效</td>
</tr>
<tr>
<td>0x53</td>
<td>Certificate validation failed, invalid type</td>
<td>证书验证失败，类型无效</td>
</tr>
<tr>
<td>0x54</td>
<td>Certificate validation failed, invalid format</td>
<td>证书验证失败，格式无效</td>
</tr>
<tr>
<td>0x55</td>
<td>Certificate validation failed, invalid content</td>
<td>证书验证失败，内容无效</td>
</tr>
<tr>
<td>0x56</td>
<td>Certificate validation failed, invalid scope</td>
<td>证书验证失败，范围无效</td>
</tr>
<tr>
<td>0x57</td>
<td>Certificate validation failed, invalid certificate</td>
<td>证书验证失败，证书无效</td>
</tr>
<tr>
<td>0x58</td>
<td>Ownership verification failed</td>
<td>所有权验证失败</td>
</tr>
<tr>
<td>0x59</td>
<td>Challenge calculation failed</td>
<td>挑战计算失败</td>
</tr>
<tr>
<td>0x5A</td>
<td>Setting access right failed</td>
<td>设置访问权限失败</td>
</tr>
<tr>
<td>0x5B</td>
<td>Session key creation/derivation failed</td>
<td>会话密钥建立 / 派生失败</td>
</tr>
<tr>
<td>0x5C</td>
<td>Configuration data usage failed</td>
<td>配置资料使用失败</td>
</tr>
<tr>
<td>0x5D</td>
<td>Deauthentication failed</td>
<td>取消认证失败</td>
</tr>
<tr>
<td>0x70</td>
<td>Upload download not accepted</td>
<td>上传下载不被接受</td>
</tr>
<tr>
<td>0x71</td>
<td>Transfer data suspended</td>
<td>传输资料暂停</td>
</tr>
<tr>
<td>0x72</td>
<td>General programming failure</td>
<td>一般程序设计失败</td>
</tr>
<tr>
<td>0x73</td>
<td>Wrong block sequence number</td>
<td>错误的区块序号</td>
</tr>
<tr>
<td>0x78</td>
<td>Request correctly received, response pending</td>
<td>请求已正确接收，回应待处理</td>
</tr>
<tr>
<td>0x7E</td>
<td>Subfunction not supported in active session</td>
<td>当前会话中不支持子功能</td>
</tr>
<tr>
<td>0x7F</td>
<td>Service not supported in active session</td>
<td>当前会话中不支持服务</td>
</tr>
<tr>
<td>0x81</td>
<td>RPM too high</td>
<td>转速太高</td>
</tr>
<tr>
<td>0x82</td>
<td>RPM too low</td>
<td>转速太低</td>
</tr>
<tr>
<td>0x83</td>
<td>Engine is running</td>
<td>引擎正在运转</td>
</tr>
<tr>
<td>0x84</td>
<td>Engine is not running</td>
<td>引擎未运转</td>
</tr>
<tr>
<td>0x85</td>
<td>Engine run time too low</td>
<td>引擎运转时间太短</td>
</tr>
<tr>
<td>0x86</td>
<td>Temperature too high</td>
<td>温度过高</td>
</tr>
<tr>
<td>0x87</td>
<td>Temperature too low</td>
<td>温度太低</td>
</tr>
<tr>
<td>0x88</td>
<td>Vehicle speed too high</td>
<td>车速太高</td>
</tr>
<tr>
<td>0x89</td>
<td>Vehicle speed too low</td>
<td>车速太低</td>
</tr>
<tr>
<td>0x8A</td>
<td>Throttle/pedal too high</td>
<td>油门 / 踏板太高</td>
</tr>
<tr>
<td>0x8B</td>
<td>Throttle/pedal too low</td>
<td>油门 / 踏板太低</td>
</tr>
<tr>
<td>0x8C</td>
<td>Transmission range not in neutral</td>
<td>传输范围不在空档</td>
</tr>
<tr>
<td>0x8D</td>
<td>Transmission range not in gear</td>
<td>未挂档的传动范围</td>
</tr>
<tr>
<td>0x8F</td>
<td>Brake switch not closed</td>
<td>刹车开关未闭合</td>
</tr>
<tr>
<td>0x90</td>
<td>Shifter lever not in park</td>
<td>变速杆不在停车位置</td>
</tr>
<tr>
<td>0x91</td>
<td>Torque converter clutch locked</td>
<td>变矩器离合器锁止</td>
</tr>
<tr>
<td>0x92</td>
<td>Voltage too high</td>
<td>电压过高</td>
</tr>
<tr>
<td>0x93</td>
<td>Voltage too low</td>
<td>电压太低</td>
</tr>
<tr>
<td>0x94</td>
<td>Resource temporary unavailable</td>
<td>资源暂时无法使用</td>
</tr>
</tbody>
</table>
<p>参考：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/%E7%BB%9F%E4%B8%80%E8%AF%8A%E6%96%AD%E6%9C%8D%E5%8A%A1">统一诊断服务 - 维基百科，自由的百科全书 (wikipedia.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/162710671">汽车 UDS：统一诊断服务概览 - 知乎 (zhihu.com)</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://demoyao100.github.io/2024/05/08/%E8%BD%A6CAN%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Moyao">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moyao の小屋">
      <meta itemprop="description" content="Write down something interesting I met<br />
Feel free to mail me if you have something wanted to talk about, plz
mail: <moyaoxue@outlook.com>
">
    </span>

    <span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moyao の小屋">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/08/%E8%BD%A6CAN%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">车CAN总线协议学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-08 00:32:00" itemprop="dateCreated datePublished" datetime="2024-05-08T00:32:00+08:00">2024-05-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="基本概念"><a class="anchor" href="#基本概念">#</a> 基本概念：</h3>
<p>CAN（Controller Area Network）总线协议是由 BOSCH 发明的一种<strong>基于消息广播模式的串行通信总线</strong>，它起初用于实现汽车内 ECU 之间可靠的通信，后因其简单实用可靠等特点，而广泛应用于工业自动化、船舶、医疗等其它领域。</p>
<p>ECU（Electronic Control Unit）电子控制器单元，它们的用途就是控制汽车的行驶状态以及实现其各种功能。主要是利用各种传感器、总线的数据采集与交换，来判断车辆状态以及司机的意图并通过执行器来操控汽车。</p>
<p>简而言之 CAN 总线是<strong>用于各个 ECU 之间互相通信的网络以及协议</strong>。</p>
<p><img src="/2024/05/08/%E8%BD%A6CAN%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/Untitled.webp" alt="Untitled"></p>
<h3 id="can协议标准"><a class="anchor" href="#can协议标准">#</a> <strong>CAN 协议标准</strong></h3>
<p>底层协议：</p>
<p>CAN 总线协议大的分类包含底层的标准协议和上层协议两种；其中以 ISO 11898-1；ISO 11898-2 和 ISO11898-3 这三种协议为主，下面介绍这三种协议的主要作用和应用方向。</p>
<p>ISO 11898-1: 2015 定义 CAN 总线的数据链路层（DLL）和电气信号标准，描述 CAN 总线的基本架构，定义不同 CAN 总线设备在数据链路层通信方式，详细说明逻辑链接控制（LLC）和介质访问控制（MAC）子层部分；</p>
<p>ISO 11898-2: 2003 定义高速 CAN 总线（HS-CAN）物理层标准，最高数据传输速率 1Mbps ，应用为两线平衡式信号（CAN_H, CAN_L），HS CAN 是汽车动力和工业控制网络中应用最为广泛的物理层协议；</p>
<p>ISO 11898-3: 2006 定义低速 CAN 总线（LS-CAN, Fault-Tolerant CAN）物理层标准，数据传输速率在 40Kbps ~ 125Kbps 。Fault-Tolerant 是指总线上一根传输信号失效时，依靠另外的单根信号也可以通信，LS CAN 主要应用于汽车车身电控单元之间通信；</p>
<p><img src="/2024/05/08/%E8%BD%A6CAN%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/Untitled-17150996115501.webp" alt="Untitled"></p>
<p>![Untitled (1)](车 CAN 总线协议学习 / Untitled (1).png)</p>
<p>上层协议：</p>
<p>![Untitled (2)](车 CAN 总线协议学习 / Untitled (2).png)</p>
<p>CAN 总线特性 CAN 总线具有多种特点其中包括：多主的工作方式；每条协议具有不同的优先级；采用非破坏性总线仲裁技术；CAN 可以通过报文实现点对点、一点对多点以及全局广播方式传送数据；节点数取决于总线驱动电路；采用短帧结构（8/16 字节），传输时间短，鲁棒性强，抗干扰；CRC 帧校验，数据出错率低。</p>
<p>这其中最重要的特点是多主的工作方式，一般操作系统都有一个大脑，对整个操作系统的环境进行管理，但是 CAN 总线的是多主的工作方式，各个 ECU 只负责往总线上收发它们的协议帧即可，所以当多个 ECU 同时收发消息时，就会导致冲突，这就又和它第二三个特点相关了。仲裁的特点是基于协议的优先级进行仲裁的，主要是为了给 CAN 总线上的协议进行优先级排序，决定发生冲突的时候哪个协议先占用 CAN 总线进行通讯。同时 CAN 协议的一些特点比如短帧结构，鲁棒性强，抗干扰等等能力也让 CAN 总线具有了在汽车上适用的条件。</p>
<p>CAN 总线的布局 之前汽车的各个 ECU 之间是通过点对点连接的，但是随着现代汽车内的 ECU 单元愈发增多，CAN 总线连接的方式可以显著降低汽车内部布线的复杂程度。</p>
<p><strong>CAN 总线结构特征</strong></p>
<p>CAN 总线定义四种帧类型，分别为数据帧、远程帧、错误帧和过载帧。各种帧的用途分别为：</p>
<p>![Untitled (3)](车 CAN 总线协议学习 / Untitled (3).png)</p>
<h3 id="攻击面分析"><a class="anchor" href="#攻击面分析">#</a> 攻击面分析</h3>
<p><strong>访问车载诊断 II（OBD-II）操纵 CAN 来控制各种模块</strong>，达到的效果是可以控制制动以及发动机模块。另外还可以产生虚假的仪表盘数据，改变发动机参数</p>
<p>![Untitled (4)](车 CAN 总线协议学习 / Untitled (4).png)</p>
<p><strong>第一阶段是入侵负责无线接口的 ECU。第二阶段是注入报文，与安全关键的 ECU 进行通信。最后一个阶段是修改 ECU，使 ECU 表现出恶意行为。</strong></p>
<p>另外，通过 OTA 软件进行攻击也是一种方法。<strong>OTA 软件是一种低成本、可扩展、可远程更新的软件解决方案。</strong></p>
<p>ICSim 模拟器</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment"># 安装依赖</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libsdl2-dev libsdl2-image-dev can-utils  </pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 下载 ICSim</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">git</span> clone <span class="token operator">&lt;</span>https://github.com/zombieCraig/ICSim.git<span class="token operator">&gt;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 编译</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token builtin class-name">cd</span> ICSim</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">sudo</span> <span class="token function">make</span></pre></td></tr></tbody></table></figure><p>安装 can-utils</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>sudo apt<span class="token operator">-</span>get install can<span class="token operator">-</span>utils <span class="token operator">-</span>y</pre></td></tr></tbody></table></figure><p>setip_vcan.sh：</p>
<p>加载 CAN 的内核模块以及虚拟 CAN 的内核模块：</p>
<blockquote>
<p>sudo modprobe can sudo modprobe vcan</p>
</blockquote>
<p>验证是否加载了所需的内核模块：</p>
<blockquote>
<p>lsmod | grep can</p>
</blockquote>
<p><img src="https://prod-files-secure.s3.us-west-2.amazonaws.com/ec8fd2f2-1649-4985-8970-ff7b57d45517/3c4bc8bb-b692-4c50-885c-fd078b888f07/Untitled.png" alt="Untitled"></p>
<p>接下来设置虚拟接口：</p>
<blockquote>
<p>sudo ip link add dev vcan0 type vcan sudo ip link set up vcan0</p>
</blockquote>
<p>可以通过下面方法来验证虚拟 CAN 接口：</p>
<blockquote>
<p>ifconfig vcan0</p>
</blockquote>
<p><img src="https://prod-files-secure.s3.us-west-2.amazonaws.com/ec8fd2f2-1649-4985-8970-ff7b57d45517/a0ad02d0-2945-48e6-8118-da4bb208ddc7/Untitled.png" alt="Untitled"></p>
<p>运行 ICSim 模拟器（注意：wsl 没有内核模式所以不支持）：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token punctuation">.</span><span class="token operator">/</span>setup_vcan<span class="token punctuation">.</span>sh</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">.</span><span class="token operator">/</span>controls vcan0</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">.</span><span class="token operator">/</span>icsim vcan0</pre></td></tr></tbody></table></figure><p><img src="https://prod-files-secure.s3.us-west-2.amazonaws.com/ec8fd2f2-1649-4985-8970-ff7b57d45517/c92d912a-80d6-4ee1-a953-03562064c020/Untitled.png" alt="Untitled"></p>
<p>虚拟 CAN 接口设置成功后就可以在这个接口中发送或接收 CAN 数据包，使用 can-utils 中的 cangen 的工具来生成虚拟的 CAN 数据包。</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>cangen vcan0</pre></td></tr></tbody></table></figure><p>使用 candump 查看包：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>candump vcan0</pre></td></tr></tbody></table></figure><p>存入 log：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>candump <span class="token operator">-</span>l vcan0</pre></td></tr></tbody></table></figure><p>重放报文（可以测试发现仪表盘复现了前面的操作，但没那么稳定）：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>canplayer <span class="token operator">-</span>I xxx<span class="token punctuation">.</span>log <span class="token operator">-</span>v</pre></td></tr></tbody></table></figure><p>cansniffer 是用于嗅探 CAN 数据包的工具。cansniffer 的 -c 参数可以通过颜色高亮突出变化的字节，当需要判断执行某些操作是否会导致 CAN 数据变化时使用。</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>cansniffer <span class="token operator">-</span>c vcan0</pre></td></tr></tbody></table></figure><p>cansend 是用于将 CAN 帧发送到特定 CAN 接口的工具：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>cansend interface frame</pre></td></tr></tbody></table></figure><p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46640144/article/details/119006095">山石岩读丨前沿领域探析 —— 汽车 CAN 总线协议详解及攻击面分析_商用车 can 协议与乘用车 can 的区别 - CSDN 博客</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2338608">CAN 总线安全之 ICSim 模拟器 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</a></p>
<p>这几篇还没看：</p>
<p><a target="_blank" rel="noopener" href="https://yogeshojha.com/me/car-hacking-101-practical-guide-to-exploiting-can-bus-using-instrument-cluster-simulator-part-i-setting-up/">https://yogeshojha.com/me/car-hacking-101-practical-guide-to-exploiting-can-bus-using-instrument-cluster-simulator-part-i-setting-up/</a></p>
<p><a target="_blank" rel="noopener" href="https://yogeshojha.com/me/car-hacking-101-practical-guide-to-exploiting-can-bus-using-instrument-cluster-simulator-part-ii-exploitation/">https://yogeshojha.com/me/car-hacking-101-practical-guide-to-exploiting-can-bus-using-instrument-cluster-simulator-part-ii-exploitation/</a></p>
<p><a target="_blank" rel="noopener" href="https://yogeshojha.com/me/car-hacking-101-practical-guide-to-exploiting-can-bus-using-instrument-cluster-simulator">https://yogeshojha.com/me/car-hacking-101-practical-guide-to-exploiting-can-bus-using-instrument-cluster-simulator</a> - part-iii-savvycan-fuzzing-can-frame-and-playing-around-with-can-frames/</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://demoyao100.github.io/2024/05/08/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%9D%E6%8E%A2/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Moyao">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moyao の小屋">
      <meta itemprop="description" content="Write down something interesting I met<br />
Feel free to mail me if you have something wanted to talk about, plz
mail: <moyaoxue@outlook.com>
">
    </span>

    <span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moyao の小屋">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/08/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">反序列化初探</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-08 00:31:13" itemprop="dateCreated datePublished" datetime="2024-05-08T00:31:13+08:00">2024-05-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="概念"><a class="anchor" href="#概念">#</a> 概念</h3>
<blockquote>
<p>序列化：把对象转换为字节序列的过程，即把对象转换为可以存储或传输的数据的过程。例如将内存中的对象转换为二进制数据流或文件，在网络传输过程中，可以是字节或是 XML 等格式。</p>
<p><strong>反序列化</strong>：把字节序列恢复为对象的过程，即把可以存储或传输的数据转换为对象的过程。例如将二进制数据流或文件加载到内存中还原为对象。</p>
</blockquote>
<h3 id="漏洞成因"><a class="anchor" href="#漏洞成因">#</a> <strong>漏洞成因</strong></h3>
<p>在身份验证，文件读写，数据传输等功能处，在未对反序列化接口做访问控制，未对序列化数据做加密和签名，加密密钥使用硬编码（如 Shiro 1.2.4），使用不安全的反序列化框架库（如 Fastjson 1.2.24）或函数的情况下，由于序列化数据可被用户控制，攻击者可以精心构造恶意的序列化数据（执行特定代码或命令的数据）传递给应用程序，在应用程序反序列化对象时执行攻击者构造的恶意代码，达到攻击者的目的。</p>
<h3 id="漏洞可能出现的位置"><a class="anchor" href="#漏洞可能出现的位置">#</a> <strong>漏洞可能出现的位置</strong></h3>
<p>1. 解析认证 token、session 的位置</p>
<p>2. 将序列化的对象存储到磁盘文件或存入数据库后反序列化时的位置，如读取 json 文件，xml 文件等</p>
<p>3. 将对象序列化后在网络中传输，如传输 json 数据，xml 数据等</p>
<p>4. 参数传递给程序</p>
<p>5. 使用 RMI 协议，被广泛使用的 RMI 协议完全基于序列化</p>
<p>6. 使用了不安全的框架或基础类库，如 JMX 、Fastjson 和 Jackson 等</p>
<p>7. 定义协议用来接收与发送原始的 java 对象</p>
<p>询问了 web 手相关事宜，反序列化大概考点是 python、php、java 三种语言</p>
<p>在 Python 和 PHP 中，一般通过构造一个包含魔术方法（在发生特定事件或场景时被自动调用的函数，通常是构造函数或析构函数）的类，然后在魔术方法中调用命令执行或代码执行函数，接着实例化这个类的一个对象并将该对象序列化后传递给程序，当程序反序列化该对象时触发魔术方法从而执行命令或代码。</p>
<p>在 Java 中没有魔术方法，但是有<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7029/">反射（reflection）机制</a>：在程序的运行状态中，可以构造任意一个类的对象，可以了解任意一个对象所属的类，可以了解任意一个类的成员变量和方法，可以调用任意一个对象的属性和方法，这种动态获取程序信息以及动态调用对象的功能称为 Java 语言的反射机制。一般利用反射机制来构造一个执行命令的对象或直接调用一个具有命令执行或代码执行功能的方法实现任意代码执行。</p>
<p>python：pickle 模块</p>
<p>php：serialize 函数</p>
<h2 id="php"><a class="anchor" href="#php">#</a> php</h2>
<p>php class 序列化后：</p>
<p>public：属性被序列化的时候属性值会变成  <code>属性名</code></p>
<p>protected：属性被序列化的时候属性值会变成  <code>\\x00*\\x00属性名</code></p>
<p>private：属性被序列化的时候属性值会变成  <code>\\x00类名\\x00属性名</code></p>
<p>php 魔术方法：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>__construct<span class="token punctuation">(</span><span class="token punctuation">)</span>            //类的构造函数，创建对象时触发</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>__destruct<span class="token punctuation">(</span><span class="token punctuation">)</span>             //类的析构函数，对象被销毁时触发</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>__call<span class="token punctuation">(</span><span class="token punctuation">)</span>                 //在对象上下文中调用不可访问的方法时触发</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>__callStatic<span class="token punctuation">(</span><span class="token punctuation">)</span>           //在静态上下文中调用不可访问的方法时触发</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>__get<span class="token punctuation">(</span><span class="token punctuation">)</span>                  //读取不可访问属性的值时，这里的不可访问包含私有属性或未定义</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>__set<span class="token punctuation">(</span><span class="token punctuation">)</span>                  //在给不可访问属性赋值时触发</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>__isset<span class="token punctuation">(</span><span class="token punctuation">)</span>                //当对不可访问属性调用 isset<span class="token punctuation">(</span><span class="token punctuation">)</span> 或 empty<span class="token punctuation">(</span><span class="token punctuation">)</span> 时触发</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>__unset<span class="token punctuation">(</span><span class="token punctuation">)</span>                //在不可访问的属性上使用unset<span class="token punctuation">(</span><span class="token punctuation">)</span>时触发</pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>__invoke<span class="token punctuation">(</span><span class="token punctuation">)</span>               //当尝试以调用函数的方式调用一个对象时触发</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>__sleep<span class="token punctuation">(</span><span class="token punctuation">)</span>                //执行serialize<span class="token punctuation">(</span><span class="token punctuation">)</span>时，先会调用这个方法</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>__wakeup<span class="token punctuation">(</span><span class="token punctuation">)</span>               //执行unserialize<span class="token punctuation">(</span><span class="token punctuation">)</span>时，先会调用这个方法</pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>__toString<span class="token punctuation">(</span><span class="token punctuation">)</span>             //当反序列化后的对象被输出在模板中的时候（转换成字符串的时候）自动调用</pre></td></tr></tbody></table></figure><p>serialize () 函数会检查类中是否存在一个魔术方法。如果存在，该方法会先被调用，然后才执行序列化操作。</p>
<p>从序列化到反序列化这几个函数的执行过程是：</p>
<pre><code>__construct()` -&gt;`__sleep()` -&gt; `__wakeup()` -&gt; `__toString()` -&gt; `__destruct()
</code></pre>
<p><code>_sleep</code>  方法在一个对象被序列化时调用， <code>_wakeup</code>  方法在一个对象被反序列化时调用</p>
<p>__tostring () 触发时机：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token number">1</span>.  echo<span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">)</span>/print<span class="token punctuation">(</span><span class="token variable">$obj</span><span class="token punctuation">)</span>打印时会触发 </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2</span>.  反序列化对象与字符串连接时 </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">3</span>.  反序列化对象参与格式化字符串时 </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">4</span>.  反序列化对象与字符串进行<span class="token operator">==</span>比较时（PHP进行<span class="token operator">==</span>比较的时候会转换参数类型） </pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">5</span>.  反序列化对象参与格式化SQL语句，绑定参数时 </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">6</span>.  反序列化对象在经过php字符串处理函数，如strlen<span class="token punctuation">(</span><span class="token punctuation">)</span>、strops<span class="token punctuation">(</span><span class="token punctuation">)</span>、strcmp<span class="token punctuation">(</span><span class="token punctuation">)</span>、addslashes<span class="token punctuation">(</span><span class="token punctuation">)</span>等 </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">7</span>.  在in_array<span class="token punctuation">(</span><span class="token punctuation">)</span>方法中，第一个参数时反序列化对象，第二个参数的数组中有__toString<span class="token punctuation">(</span><span class="token punctuation">)</span>返回的字符串的时候__toString<span class="token punctuation">(</span><span class="token punctuation">)</span>会被调用 </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">8</span>.  反序列化的对象作为class_exists<span class="token punctuation">(</span><span class="token punctuation">)</span>的参数的时候</pre></td></tr></tbody></table></figure><p>PHP 序列化需注意以下几点：</p>
<p>1、序列化只序列属性，不序列方法 2、因为序列化不序列方法，所以反序列化之后如果想正常使用这个对象的话我们必须要依托这个类要在当前作用域存在的条件 3、我们能控制的只有类的属性，攻击就是寻找合适能被控制的属性，利用作用域本身存在的方法，基于属性发动攻击</p>
<p>4、PHP 对象是存放在<strong>内存的堆空间段</strong>上的，PHP 文件在<strong>执行结束的时候会将对象销毁</strong>。</p>
<h3 id="cve-2016-7124"><a class="anchor" href="#cve-2016-7124">#</a> CVE-2016-7124</h3>
<p>CVE-2016-7124：当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup 的执行</p>
<h2 id="java反序列化"><a class="anchor" href="#java反序列化">#</a> java 反序列化</h2>
<p>Java 中通常使用 <code>Java.io.ObjectOutputStream</code>  类中的 <code>writeObject</code>  方法进行序列化， <code>java.io.ObjectInputStream</code>  类中的 <code>readObject</code>  方法进行反序列化。使用下面代码将字符串进行序列化和反序列化：</p>
<pre><code>package com.company;

import java.io.ObjectOutputStream;
import java.io.ObjectInputStream;
import java.io.FileOutputStream;
import java.io.FileInputStream;

public class Main{

    public static void main(String args[]) throws Exception {
        String obj = "hello";

        // 将序列化后的数据写入文件a.ser中，当序列化一个对象到文件时， 按照 Java 的标准约定是给文件一个 .ser 扩展名
        FileOutputStream fos = new FileOutputStream("a.ser");
        ObjectOutputStream os = new ObjectOutputStream(fos);
        os.writeObject(obj);
        os.close();

        // 从文件a.ser中读取数据
        FileInputStream fis = new FileInputStream("a.ser");
        ObjectInputStream ois = new ObjectInputStream(fis);

        // 通过反序列化恢复字符串
        String obj2 = (String)ois.readObject();
        System.out.println(obj2);
        ois.close();
    }
}
</code></pre>
<p>程序执行后生成 a.ser 文件</p>
<p>以十六进制查看 a.ser 文件内容，如图：</p>
<p><img src="/2024/05/08/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%9D%E6%8E%A2/image-20240508003638454.webp" alt="image-20240508003638454"></p>
<p><code>ac ed 00 05</code>  是 java 序列化内容的特征，如果经过 base64 编码，那么相对应的是 <code>rO0AB</code> ：</p>
<p>一个 Java 类的对象要想序列化成功，必须满足两个条件：</p>
<p>1. 该类必须实现 <code>java.io.Serializable</code>  接口。</p>
<p>2. 该类的所有属性必须是可序列化的，如果有一个属性不是可序列化的，则该属性必须注明是短暂的。</p>
<h2 id="java反序列化漏洞成因"><a class="anchor" href="#java反序列化漏洞成因">#</a> <strong>java 反序列化漏洞成因</strong></h2>
<p>暴露或间接暴露反序列化 API ，导致用户可以操作传入数据，攻击者可以精心构造反序列化对象并执行恶意代码</p>
<p>反序列化时会调用 readObject () 函数，如果重写了 readObject 函数，并且里面含有恶意代码，那么在反序列化时调用这个函数就会直接执行恶意代码。</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">import</span> java.io.*<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>class MyObject implements Serializable<span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    public String name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    //重写readObject<span class="token punctuation">(</span><span class="token punctuation">)</span>方法</pre></td></tr><tr><td data-num="6"></td><td><pre>    private void readObject<span class="token punctuation">(</span>java.io.ObjectInputStream <span class="token keyword">in</span><span class="token punctuation">)</span> throws IOException, ClassNotFoundException, IOException <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        //执行默认的readObject<span class="token punctuation">(</span><span class="token punctuation">)</span>方法</pre></td></tr><tr><td data-num="8"></td><td><pre>        in.defaultReadObject<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        //执行打开计算器程序命令</pre></td></tr><tr><td data-num="10"></td><td><pre>        Runtime.getRuntime<span class="token punctuation">(</span><span class="token punctuation">)</span>.exec<span class="token punctuation">(</span><span class="token string">"calc.exe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>public class testSerialize <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    public static void main<span class="token punctuation">(</span>String args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> throws Exception<span class="token punctuation">{</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        //定义myObj对象</pre></td></tr><tr><td data-num="17"></td><td><pre>        MyObject myObj <span class="token operator">=</span> new MyObject<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        myObj.name <span class="token operator">=</span> <span class="token string">"hi"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        //创建一个包含对象进行反序列化信息的”object”数据文件</pre></td></tr><tr><td data-num="20"></td><td><pre>        FileOutputStream fos <span class="token operator">=</span> new FileOutputStream<span class="token punctuation">(</span><span class="token string">"object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        ObjectOutputStream os <span class="token operator">=</span> new ObjectOutputStream<span class="token punctuation">(</span>fos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        //writeObject<span class="token punctuation">(</span><span class="token punctuation">)</span>方法将myObj对象写入object文件</pre></td></tr><tr><td data-num="23"></td><td><pre>        os.writeObject<span class="token punctuation">(</span>myObj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        os.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        //从文件中反序列化obj对象</pre></td></tr><tr><td data-num="26"></td><td><pre>        FileInputStream fis <span class="token operator">=</span> new FileInputStream<span class="token punctuation">(</span><span class="token string">"object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        ObjectInputStream ois <span class="token operator">=</span> new ObjectInputStream<span class="token punctuation">(</span>fis<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        //恢复对象</pre></td></tr><tr><td data-num="29"></td><td><pre>        MyObject objectFromDisk <span class="token operator">=</span> <span class="token punctuation">(</span>MyObject<span class="token punctuation">)</span>ois.readObject<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        System.out.println<span class="token punctuation">(</span>objectFromDisk.name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        ois.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p><strong>这里定义了一个 Myobject 类并继承了 Serializable 接口，并且重写了 readObject 方法。在反序列化时会执行 readObject 方法。在 readObject () 方法中写入了 Runtime.getRuntime ().exec ("calc.exe")，在反序列化时就会执行相应的命令。</strong></p>
<p>这么看起来原理挺简单的，不过实际上就没有这种运气了，都得靠自己构造链子，不过这里先不探讨了，这里只是入个门…</p>
<p>这篇打算来看看，用工具比较多：<a target="_blank" rel="noopener" href="https://blog.csdn.net/miuzzx/article/details/128221385">CTFSHOW web 入门 java 反序列化篇（更新中）_ctfshow java 反序列化 - CSDN 博客</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Hardworking666/article/details/122373938">PHP 反序列化漏洞详解（万字分析、由浅入深）_php 反序列化漏洞原理 - CSDN 博客</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/276624.html">常见的 Web 漏洞 —— 反序列化漏洞 - FreeBuf 网络安全行业门户</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/367585.html">java 反序列化漏洞详解 - FreeBuf 网络安全行业门户</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://demoyao100.github.io/2024/05/08/shiro%E5%AE%89%E5%85%A8%E6%B5%85%E6%8E%A2/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Moyao">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moyao の小屋">
      <meta itemprop="description" content="Write down something interesting I met<br />
Feel free to mail me if you have something wanted to talk about, plz
mail: <moyaoxue@outlook.com>
">
    </span>

    <span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moyao の小屋">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/08/shiro%E5%AE%89%E5%85%A8%E6%B5%85%E6%8E%A2/" class="post-title-link" itemprop="url">shiro安全浅探</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-08 00:26:13" itemprop="dateCreated datePublished" datetime="2024-05-08T00:26:13+08:00">2024-05-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h6 id="preface渗透和awd里面都遇到了web手说这个容易那就看看呗反正也得多看java这把当个web手呗"><a class="anchor" href="#preface渗透和awd里面都遇到了web手说这个容易那就看看呗反正也得多看java这把当个web手呗">#</a> PREFACE：渗透和 awd 里面都遇到了，web 手说这个容易… 那就看看呗，反正也得多看 java，这把当个 web 手呗</h6>
<p>写很好，二进制也能看:&gt;，下面的基本上是扣这里的：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/367363.html">https://www.freebuf.com/articles/web/367363.html</a></p>
<h2 id="shiro-550反序列化漏洞cve-2016-4437"><a class="anchor" href="#shiro-550反序列化漏洞cve-2016-4437">#</a> Shiro-550 反序列化漏洞（CVE-2016-4437）</h2>
<h4 id="漏洞简介"><a class="anchor" href="#漏洞简介">#</a> 漏洞简介</h4>
<p>shiro-550 主要是由 shiro 的 rememberMe 内容反序列化导致的命令执行漏洞，造成的原因是<strong>默认加密密钥是硬编码在 shiro 源码中</strong>，任何有权访问源代码的人都可以知道默认加密密钥。于是攻击者可以创建一个恶意对象，对其进行序列化、编码，然后将其作为 cookie 的 rememberMe 字段内容发送，Shiro 将对其解码和反序列化，导致服务器运行一些恶意代码。</p>
<p>特征： <code>cookie中含有rememberMe字段</code></p>
<p>修复建议：</p>
<ul>
<li>更新 shiro 到 1.2.4 以上的版本。</li>
<li>不使用默认的加密密钥，改为随机生成密钥。</li>
</ul>
<h4 id="漏洞原理"><a class="anchor" href="#漏洞原理">#</a> 漏洞原理</h4>
<p>在 Apache Shiro&lt;=1.2.4 版本中 AES 加密时采用的 key 是<strong>硬编码</strong>在代码中的，于是我们就可以构造 RememberMe 的值，然后让其反序列化执行。</p>
<p><img src="/2024/05/08/shiro%E5%AE%89%E5%85%A8%E6%B5%85%E6%8E%A2/Untitled.webp" alt="Untitled"></p>
<p>Primary Cocnerns（基本关注点）:</p>
<ul>
<li>Authentication（认证）：经常和登录挂钩，是证明用户说他们是谁的一个工作</li>
<li>Authorization（授权）：访问控制的过程，即，决定‘谁’可以访问‘什么</li>
<li>Session Management（会话管理）：管理用户特定的会话，即使在非 web 或是 EJB 的应用中</li>
<li>Crytography（加密）：通过加密算法保证数据的安全，且易于使用</li>
</ul>
<p>Supporting Features（辅助特性）:</p>
<ul>
<li>Web Support（网络支持）:web support API 可以帮助在 web 应用中方便的使用 shiro</li>
<li>Caching（缓存）: 保证安全操作使用快速有效</li>
<li>Concurrency（并发）: 支持多线程应用</li>
<li>Testing（测试）：支持集成单元测试</li>
<li>Run As（以.. 运行）：可以假定用户为另一个用户</li>
<li>Remeber Me: 记住用户，无需再次登录</li>
</ul>
<h3 id="一-shiro服务器识别身份加解密处理的流程"><a class="anchor" href="#一-shiro服务器识别身份加解密处理的流程">#</a> 一、Shiro 服务器识别身份加解密处理的流程</h3>
<h4 id="1-加密"><a class="anchor" href="#1-加密">#</a> <strong>1、加密</strong></h4>
<ol>
<li>用户使用账号密码进行登录，并勾选”Remember Me“。</li>
<li>Shiro 验证用户登录信息，通过后，查看用户是否勾选了”Remember Me“。</li>
<li>若勾选，则将用户身份序列化，并将序列化后的内容进行 AES 加密，再使用 base64 编码。</li>
<li>最后将处理好的内容放于 cookie 中的 rememberMe 字段。</li>
</ol>
<h4 id="2-解密"><a class="anchor" href="#2-解密">#</a> <strong>2、解密</strong></h4>
<ol>
<li>当服务端收到来自未经身份验证的用户的请求时，会在客户端发送请求中的 cookie 中获取 rememberMe 字段内容。</li>
<li>将获取到的 rememberMe 字段进行 base64 解码，再使用 AES 解密。</li>
<li>最后将解密的内容进行反序列化，获取到用户身份。</li>
</ol>
<h3 id="二-key"><a class="anchor" href="#二-key">#</a> 二、Key</h3>
<p>AES 加密的密钥 Key 被硬编码在代码里</p>
<h2 id="shiro-721反序列化漏洞cve-2019-12422"><a class="anchor" href="#shiro-721反序列化漏洞cve-2019-12422">#</a> Shiro-721 反序列化漏洞（CVE-2019-12422）</h2>
<p><strong>Shiro550 和 Shiro721 的区别：</strong></p>
<pre><code>Shiro550只需要通过碰撞key，爆破出来密钥，就可以进行利用
Shiro721的ase加密的key一般情况下猜不到，是系统随机生成的，并且当存在有效的用户信息时才会进入下一阶段的流程所以我们需要使用登录后的rememberMe Cookie，才可以进行下一步攻击
</code></pre>
<h3 id="漏洞指纹"><a class="anchor" href="#漏洞指纹">#</a> 漏洞指纹</h3>
<ul>
<li>URL 中含有 Shiro 字段</li>
<li>cookie 中含有 rememberMe 字段</li>
<li>返回包中含有 rememberMe</li>
</ul>
<h3 id="漏洞介绍"><a class="anchor" href="#漏洞介绍">#</a> 漏洞介绍</h3>
<p>在 Shiro721 中，Shiro 通过 AES-128-CBC 对 cookie 中的 <code>rememberMe</code>  字段进行加密，所以用户可以通过 <code>Padding Oracle</code>  加密生成的攻击代码来构造恶意的 <code>rememberMe</code>  字段，进行反序列化攻击，需要执行的命令越复杂，生成 payload 需要的时间就越长。</p>
<h3 id="漏洞原理-2"><a class="anchor" href="#漏洞原理-2">#</a> 漏洞原理</h3>
<p>由于 Apache Shiro cookie 中通过 AES-128-CBC 模式加密的 rememberMe 字段存在问题，用户可通过 Padding Oracle 加密生成的攻击代码来构造恶意的 rememberMe 字段，用有效的 RememberMe cookie 作为 Padding Oracle Attack 的前缀，然后制作精心制作的 RememberMe 来执行 Java 反序列化攻击</p>
<h3 id="攻击流程"><a class="anchor" href="#攻击流程">#</a> 攻击流程</h3>
<p>登录网站，并从 cookie 中获取 RememberMe。使用 RememberMe cookie 作为 Padding Oracle Attack 的前缀。加密 syserial 的序列化有效负载，以通过 Padding Oracle Attack 制作精心制作的 RememberMe。请求带有新的 RememberMe cookie 的网站，以执行反序列化攻击。攻击者无需知道 RememberMe 加密的密码密钥。</p>
<h4 id="aes-128-cbc"><a class="anchor" href="#aes-128-cbc">#</a> <strong>AES-128-CBC</strong></h4>
<p>属于 AES 加密算法的 CBC 模式，使用 128 位数据块为一组进行加密解密，即 16 字节明文，对应 16 字节密文，，明文加密时，如果数据不够 16 字节，则会将数据补全剩余字节</p>
<ul>
<li>若最后剩余的明文不够 16 字节，需要进行填充，通常采用 PKCS7 进行填充。比如最后缺 3 个字节，则填充 3 个字节的 0x03; 若最后缺 10 个字节，则填充 10 个字节的 0x0a;</li>
<li>若明文正好是 16 个字节的整数倍，最后要再加入一个 16 字节 0x10 的组再进行加密</li>
</ul>
<h4 id="padding-oracle-attack原理"><a class="anchor" href="#padding-oracle-attack原理">#</a> Padding Oracle Attack 原理</h4>
<p>Padding Oracle 攻击可以在没有密钥的情况下加密或解密密文</p>
<p>Shiro Padding Oracle Attack（Shiro 填充 Oracle 攻击）是一种针对 Apache Shiro 身份验证框架的安全漏洞攻击。Apache Shiro 是 Java 应用程序中广泛使用的身份验证和授权框架，用于管理用户会话、权限验证等功能。</p>
<p>Padding Oracle Attack（填充 Oracle 攻击）是一种针对加密算法使用填充的安全漏洞攻击。在加密通信中，填充用于将明文数据扩展到加密算法块大小的倍数。在此攻击中，攻击者利用填充的响应信息来推断出加密算法中的秘密信息。</p>
<p>Shiro Padding Oracle Attack 利用了 Shiro 框架中的身份验证过程中的一个漏洞，该漏洞允许攻击者通过填充信息的不同响应时间来确定身份验证过程中的错误。通过不断尝试不同的填充方式，攻击者可以逐步推断出加密秘钥，并最终获取访问权限。</p>
<p>这种攻击利用了填充错误的身份验证响应来获取关于秘密信息的信息泄漏，然后根据这些信息进行进一步的攻击。为了防止 Shiro Padding Oracle Attack，建议及时更新 Apache Shiro 版本，确保已修复该漏洞，并采取其他安全措施，如使用安全的加密算法和密钥管理策略。</p>
<h2 id="shiro-认证绕过漏洞cve-2020-1957"><a class="anchor" href="#shiro-认证绕过漏洞cve-2020-1957">#</a> Shiro 认证绕过漏洞（CVE-2020-1957）</h2>
<h3 id="漏洞原理-3"><a class="anchor" href="#漏洞原理-3">#</a> 漏洞原理</h3>
<p>在 Apache Shiro 1.5.2 以前的版本中，在使用 Spring 动态控制器时，攻击者通过构造 <code>..;</code>  这样的跳转，可以绕过 Shiro 中对目录的权限限制。</p>
<p>URL 请求过程：</p>
<ul>
<li>客户端请求 URL: <code>/xxx/..;/admin/</code></li>
<li>Shrio 内部处理得到校验 URL 为 <code>/xxxx/..</code> , 校验通过</li>
<li>SpringBoot 处理 <code>/xxx/..;/admin/</code> , 最终请求 <code>/admin/</code> , 成功访问了后台请求。</li>
</ul>
<h2 id="shiro-身份验证绕过-cve-2020-13933"><a class="anchor" href="#shiro-身份验证绕过-cve-2020-13933">#</a> Shiro 身份验证绕过 （CVE-2020-13933）</h2>
<h3 id="漏洞简介-2"><a class="anchor" href="#漏洞简介-2">#</a> 漏洞简介</h3>
<p>CVE-2020-11989 的修复补丁存在缺陷，在 1.5.3 及其之前的版本，由于 shiro 在处理 url 时与 spring 仍然存在差异，依然存在身份校验绕过漏洞由于处理身份验证请求时出错，远程攻击者可以发送特制的 HTTP 请求，绕过身份验证过程并获得对应用程序的未授权访问。</p>
<p>该漏洞产生的原因主要是 <code>shiro</code>  层在处理 <code>url</code>  上和 <code>spring</code>  上存在差异，主要是在处理 <code>;</code>  上的问题，通过构造含有 <code>;</code>  符号的 <code>url</code>  即可绕过 <code>shiro</code>  在权限上的处理，而 <code>spring</code>  不负责权限管控，所以最终会导致权限绕过。 <code>ant</code>  风格的路径仅出现一个 <code>*</code>  时才能成功，而 <code>**</code>  无法绕过， <code>*</code> ：匹配一个或者多个任意的字符。</p>
<ul>
<li><code>*</code> ：匹配零个或者多个目录。</li>
</ul>
<h2 id="shiro-授权绕过-cve-2022-32532"><a class="anchor" href="#shiro-授权绕过-cve-2022-32532">#</a> Shiro 授权绕过 （CVE-2022-32532）</h2>
<h3 id="漏洞简介-3"><a class="anchor" href="#漏洞简介-3">#</a> 漏洞简介</h3>
<p>Apache Shiro 是一个强大且易用的 Java 安全框架，执行身份验证、授权、密码和会话管理。</p>
<p>1.9.1 之前的 Apache Shiro，RegexRequestMatcher 可能被错误配置为在某些 servlet 容器上被绕过。在正则表达式中使用带有 <code>.</code>  的 RegExPatternMatcher 的应用程序可能容易受到授权绕过。</p>
<h3 id="漏洞概述"><a class="anchor" href="#漏洞概述">#</a> 漏洞概述</h3>
<p>2022 年 6 月 29 日，Apache 官方披露 Apache Shiro 权限绕过漏洞 (CVE-2022-32532)，当 Apache Shiro 中使用 RegexRequestMatcher 进行权限配置，且正则表达式中携带 “.” 时，未经授权的远程攻击者可通过构造恶意数据包绕过身份认证。</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/367363.html">https://www.freebuf.com/articles/web/367363.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://demoyao100.github.io/2024/05/03/selinux%E5%88%9D%E6%8E%A2/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Moyao">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moyao の小屋">
      <meta itemprop="description" content="Write down something interesting I met<br />
Feel free to mail me if you have something wanted to talk about, plz
mail: <moyaoxue@outlook.com>
">
    </span>

    <span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moyao の小屋">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/05/03/selinux%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">selinux初探</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-05-03 19:37:56" itemprop="dateCreated datePublished" datetime="2024-05-03T19:37:56+08:00">2024-05-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>PREFACE：啥也不懂，爬来学学</p>
<p></p>
          
            <div class="post-button">
              <a class="btn" href="/2024/05/03/selinux%E5%88%9D%E6%8E%A2/#more" rel="contents">
                Read more »
              </a>
            </div>
          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">…</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    © 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Moyao</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> &amp; <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>





</body></html>