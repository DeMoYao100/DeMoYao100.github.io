<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin="">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"demoyao100.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="# PREFACE：被拷打到 frida 和 xpose 的原理啥的，啥啥不会，爬来赶紧学学">
<meta property="og:type" content="article">
<meta property="og:title" content="frida源码初探">
<meta property="og:url" content="https://demoyao100.github.io/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/index.html">
<meta property="og:site_name" content="Moyao の小屋">
<meta property="og:description" content="# PREFACE：被拷打到 frida 和 xpose 的原理啥的，啥啥不会，爬来赶紧学学">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://demoyao100.github.io/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/image-20240428202138661.png">
<meta property="og:image" content="https://demoyao100.github.io/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/image-20240503113613151.png">
<meta property="article:published_time" content="2024-04-27T09:09:00.000Z">
<meta property="article:modified_time" content="2024-05-03T11:38:02.167Z">
<meta property="article:author" content="Moyao">
<meta property="article:tag" content="CTF, Rev, Pwn, 渗透, Web Security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://demoyao100.github.io/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/image-20240428202138661.png">


<link rel="canonical" href="https://demoyao100.github.io/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://demoyao100.github.io/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/","path":"frida源码初探/","title":"frida源码初探"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>frida源码初探 | Moyao の小屋</title>
  
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KKC145B2WB"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-KKC145B2WB","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Moyao の小屋</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Hi,I'm Moyaoxue</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags.html" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories.html" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>RSS</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-6"><a class="nav-link" href="#preface%E8%A2%AB%E6%8B%B7%E6%89%93%E5%88%B0frida%E5%92%8Cxpose%E7%9A%84%E5%8E%9F%E7%90%86%E5%95%A5%E7%9A%84%E5%95%A5%E5%95%A5%E4%B8%8D%E4%BC%9A%E7%88%AC%E6%9D%A5%E8%B5%B6%E7%B4%A7%E5%AD%A6%E5%AD%A6"><span class="nav-number">1.</span> <span class="nav-text"> PREFACE：被拷打到 frida 和 xpose 的原理啥的，啥啥不会，爬来赶紧学学</span></a></li></ol><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E8%A7%88"><span class="nav-number"></span> <span class="nav-text"> 总览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida-gum"><span class="nav-number"></span> <span class="nav-text"> frida-gum</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-%E5%89%8D%E7%BD%AE%E5%8E%9F%E7%90%86"><span class="nav-number"></span> <span class="nav-text"> 一、前置原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#11-inline-hook"><span class="nav-number"></span> <span class="nav-text"> 1.1 inline hook</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#12-inline-hook-%E6%A3%80%E6%B5%8B"><span class="nav-number">1.</span> <span class="nav-text"> 1.2 inline hook 检测</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E6%BA%90%E7%A0%81"><span class="nav-number"></span> <span class="nav-text"> 二、源码</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#gumtestc"><span class="nav-number"></span> <span class="nav-text"> gumtest.c</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number"></span> <span class="nav-text"> 三、执行流程</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%85%88%E8%BF%99%E6%A0%B7~%E6%9C%89%E6%9C%BA%E4%BC%9A%E5%86%8D%E6%9D%A5%E8%B0%83%E8%AF%95"><span class="nav-number">1.</span> <span class="nav-text"> 先这样～有机会再来调试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida-core"><span class="nav-number"></span> <span class="nav-text"> frida-core</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number"></span> <span class="nav-text"> 一、前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-vala%E8%AF%AD%E8%A8%80"><span class="nav-number"></span> <span class="nav-text"> 1、vala 语言</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E8%BF%9B%E7%A8%8B%E9%97%AE%E9%A2%98"><span class="nav-number"></span> <span class="nav-text"> 2、进程问题</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number"></span> <span class="nav-text"> 二、源码分析</span></a></li></ol></li></div>
        </div>
        

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Moyao" src="/images/avatar.webp">
  <p class="site-author-name" itemprop="name">Moyao</p>
  <div class="site-description" itemprop="description">Write down something interesting I met<br>
Feel free to mail me if you have something wanted to talk about, plz
mail: &lt;moyaoxue@outlook.com&gt;
</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">78</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags.html">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="/moyaoxue@outlook.com" title="E-Mail → moyaoxue@outlook.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope="" itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://demoyao100.github.io/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/">

    <span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Moyao">
    </span>

    <span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moyao の小屋">
      <meta itemprop="description" content="Write down something interesting I met<br />
Feel free to mail me if you have something wanted to talk about, plz
mail: <moyaoxue@outlook.com>
">
    </span>

    <span hidden="" itemprop="post" itemscope="" itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="frida源码初探 | Moyao の小屋">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          frida源码初探
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-04-27 17:09:00" itemprop="dateCreated datePublished" datetime="2024-04-27T17:09:00+08:00">2024-04-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h6 id="preface被拷打到frida和xpose的原理啥的啥啥不会爬来赶紧学学"><a class="markdownIt-Anchor" href="#preface被拷打到frida和xpose的原理啥的啥啥不会爬来赶紧学学">#</a> PREFACE：被拷打到 frida 和 xpose 的原理啥的，啥啥不会，爬来赶紧学学</h6>
<span id="more"></span>
<h3 id="总览"><a class="markdownIt-Anchor" href="#总览">#</a> 总览</h3>
<p>首先是一整个<a target="_blank" rel="noopener" href="https://github.com/frida/frida"> frida</a> 项目可以分为这些 subprojects：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-clr">frida-clr</a>：Frida .NET bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-core/tree/da417fd46b4fd7af8f157498e9e5f38e6242be45">frida-core</a>：Frida core library intended for static linking into bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-go/tree/fd52f64f49fbbde2820e02e6e6dd3aafd1ac0ce6">frida-go</a>：Frida Go bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-gum/tree/c385fac6e3b2512c64e10e3e039f2a7be6995ab9">frida-gum</a>：Cross-platform instrumentation and introspection library written in C</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-node/tree/72b815e0fc7fb3ab4dc90e9532739b6dc99c3b8f">frida-node</a>：Frida Node.js bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-python/tree/91e2e4ff54d7afa4a2d3660019da981e92967e8f">frida-python</a>：Frida Python bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-qml/tree/5c8eb8c84a5f808cb109e67e80e8e77c4f80da77">frida-qml</a>：Frida Qml plugin</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-swift/tree/ce8f781ef000b7bfc9f90f942df2d0c973d4f52b">frida-swift</a>：Frida Swift bindings</li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida-tools/tree/49f4330d8fde4e5250ac78f35ea71b4d7441fdb6">frida-tools</a>：Frida CLI tools</li>
</ul>
<p>感觉网上许多文章都着重在看 frida-core 和 frida-gum，那么就先看看这两部分</p>
<h3 id="frida-gum"><a class="markdownIt-Anchor" href="#frida-gum">#</a> frida-gum</h3>
<p>分析过程中感觉直接干看还是有点困难，这里先整理一些 frida 所实现的功能，对照着功能看进去</p>
<h4 id="一-前置原理"><a class="markdownIt-Anchor" href="#一-前置原理">#</a> 一、前置原理</h4>
<h5 id="11-inline-hook"><a class="markdownIt-Anchor" href="#11-inline-hook">#</a> 1.1 inline hook</h5>
<p>​		我们可以使用 Frida 的 API 在程序运行时拦截函数的调用，并且在拦截到函数调用时，通过修改函数的参数或者返回值来改变程序的行为。</p>
<p>​		这里的核心原理是：动态替换需要 Hook 的指令片段为一段经过设计的跳板指令，即 trampoline ，目标为我们设计好的一段 shellCode，这里可以看 [<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273273.htm">原创] Frida inlineHook 原理分析及简单设计一款 AArch64 inlineHook 工具 - Android 安全 - 看雪 - 安全社区 | 安全招聘 | kanxue.com</a> 这篇文章对于 Frida 生成的 shellcode 进行了详细的研究，暂时没有进行复现，先纸面学习，大概需要注意的点是：</p>
<ul>
<li>frida 寻找前后 128MB 的地址获取一个空闲地址，将 hook 的点的前 16 个字节（或 4 字节）替换掉为 LDR 和 BR 指令，并且利用 x16 寄存器作为 trampoline 跳板</li>
<li>第一段跳板跳到 shellcode 后 mmap 一段匿名内存，保存当前寄存器状态与用于写入第二段跳板指令</li>
<li>然后是 onenter 和 onleave 的编写，注入 shellcode 实现需求的逻辑即可（这里是简易的核心原理，后面代码会复杂很多）</li>
</ul>
<h6 id="12-inline-hook-检测"><a class="markdownIt-Anchor" href="#12-inline-hook-检测">#</a> 1.2 inline hook 检测</h6>
<p>恰好学习的时候搜到<a target="_blank" rel="noopener" href="https://www.cnblogs.com/r0ysue/p/15424821.html">这篇文章</a>，一块记录了</p>
<p>​		既然 frida 会生成 trampoline 和 shellcode，那么有个很简单的方法：开一个线程，检查函数开头有没有被替换过，并且有没有被替换成类似 BR 到 shellcode 的格式</p>
<h4 id="二-源码"><a class="markdownIt-Anchor" href="#二-源码">#</a> 二、源码</h4>
<p>readme 描述：</p>
<p>Cross-platform instrumentation and introspection library written in C.</p>
<p>This library is consumed by <a target="_blank" rel="noopener" href="https://github.com/frida/frida-core">frida-core</a> through its JavaScript bindings, <a target="_blank" rel="noopener" href="https://github.com/frida/frida-gum/tree/master/bindings/gumjs">GumJS</a>.</p>
<p>然后文档有大概给出不同部分的功能（词汇量稍微有点不够咳咳）不过直接看着稍微有点没头绪，先看看<a target="_blank" rel="noopener" href="https://o0xmuhe.github.io/2019/11/15/frida-gum%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/">别人的分析</a>，这篇写的不错)</p>
<p>偷看一下别人的阅读思路：</p>
<p><img src="/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/image-20240428202138661.webp" alt="image-20240428202138661"></p>
<p>首先有个 meson.build 构建文件，其中可以先看 gumtest.c 这一测试运行器（根据 testcase 递归看进代码）</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>runner_sources <span class="token operator">=</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token char">'gumtest.c'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token char">'testutil.c'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token char">'stubs'</span> <span class="token operator">/</span> <span class="token char">'dummyclasses.c'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token char">'stubs'</span> <span class="token operator">/</span> <span class="token char">'fakebacktracer.c'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token char">'stubs'</span> <span class="token operator">/</span> <span class="token char">'fakeeventsink.c'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token char">'stalkerdummychannel.c'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token char">'lowlevelhelpers.c'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">]</span></pre></td></tr></tbody></table></figure><h5 id="gumtestc"><a class="markdownIt-Anchor" href="#gumtestc">#</a> gumtest.c</h5>
<p>前面一大段代码根据宏来判断，是用于根据平台信息做初始化的</p>
<p>标记一个核心对象先：</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">_GumInterceptor</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">GUM_DIET</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>  GObject parent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>  GumObject parent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  GRecMutex mutex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  GHashTable <span class="token operator">*</span> function_by_address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  GumInterceptorBackend <span class="token operator">*</span> backend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  GumCodeAllocator allocator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">volatile</span> guint selected_thread_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  GumInterceptorTransaction current_transaction<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>拦截器初始化</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>GumInterceptor <span class="token operator">*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">gum_interceptor_obtain</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  GumInterceptor <span class="token operator">*</span> interceptor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">g_mutex_lock</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_gum_interceptor_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">GUM_DIET</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>_the_interceptor <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    interceptor <span class="token operator">=</span> <span class="token function">GUM_INTERCEPTOR</span> <span class="token punctuation">(</span><span class="token function">g_object_ref</span> <span class="token punctuation">(</span>_the_interceptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    _the_interceptor <span class="token operator">=</span> <span class="token function">g_object_new</span> <span class="token punctuation">(</span>GUM_TYPE_INTERCEPTOR<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">g_object_weak_ref</span> <span class="token punctuation">(</span><span class="token function">G_OBJECT</span> <span class="token punctuation">(</span>_the_interceptor<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        the_interceptor_weak_notify<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    interceptor <span class="token operator">=</span> _the_interceptor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>_the_interceptor <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    interceptor <span class="token operator">=</span> <span class="token function">gum_object_ref</span> <span class="token punctuation">(</span>_the_interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    _the_interceptor <span class="token operator">=</span> <span class="token function">g_new0</span> <span class="token punctuation">(</span>GumInterceptor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    _the_interceptor<span class="token operator">-&gt;</span>parent<span class="token punctuation">.</span>ref_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    _the_interceptor<span class="token operator">-&gt;</span>parent<span class="token punctuation">.</span>finalize <span class="token operator">=</span> gum_interceptor_finalize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">gum_interceptor_init</span> <span class="token punctuation">(</span>_the_interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    interceptor <span class="token operator">=</span> _the_interceptor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token function">g_mutex_unlock</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_gum_interceptor_lock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>attach 上函数的方法：</p>
<p>传入地址，调用 <code>gum_interceptor_resolve</code> ，这里的 <code>gum_interceptor_instrument</code>  后面也会看</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>GumAttachReturn</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">gum_interceptor_attach</span> <span class="token punctuation">(</span>GumInterceptor <span class="token operator">*</span> self<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                        gpointer function_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                        GumInvocationListener <span class="token operator">*</span> listener<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                        gpointer listener_function_data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  GumAttachReturn result <span class="token operator">=</span> GUM_ATTACH_OK<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  GumFunctionContext <span class="token operator">*</span> function_ctx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  GumInstrumentationError error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token function">gum_interceptor_ignore_current_thread</span> <span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token function">GUM_INTERCEPTOR_LOCK</span> <span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">gum_interceptor_transaction_begin</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>current_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  self<span class="token operator">-&gt;</span>current_transaction<span class="token punctuation">.</span>is_dirty <span class="token operator">=</span> TRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  function_address <span class="token operator">=</span> <span class="token function">gum_interceptor_resolve</span> <span class="token punctuation">(</span>self<span class="token punctuation">,</span> function_address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  function_ctx <span class="token operator">=</span> <span class="token function">gum_interceptor_instrument</span> <span class="token punctuation">(</span>self<span class="token punctuation">,</span> GUM_INTERCEPTOR_TYPE_DEFAULT<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      function_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>function_ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">goto</span> instrumentation_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gum_function_context_has_listener</span> <span class="token punctuation">(</span>function_ctx<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">goto</span> already_attached<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token function">gum_function_context_add_listener</span> <span class="token punctuation">(</span>function_ctx<span class="token punctuation">,</span> listener<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      listener_function_data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">goto</span> beach<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>instrumentation_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token keyword">case</span> GUM_INSTRUMENTATION_ERROR_WRONG_SIGNATURE<span class="token operator">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        result <span class="token operator">=</span> GUM_ATTACH_WRONG_SIGNATURE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token keyword">case</span> GUM_INSTRUMENTATION_ERROR_POLICY_VIOLATION<span class="token operator">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        result <span class="token operator">=</span> GUM_ATTACH_POLICY_VIOLATION<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token keyword">case</span> GUM_INSTRUMENTATION_ERROR_WRONG_TYPE<span class="token operator">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        result <span class="token operator">=</span> GUM_ATTACH_WRONG_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token function">g_assert_not_reached</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">goto</span> beach<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="50"></td><td><pre>already_attached<span class="token operator">:</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    result <span class="token operator">=</span> GUM_ATTACH_ALREADY_ATTACHED<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">goto</span> beach<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="55"></td><td><pre>beach<span class="token operator">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token function">gum_interceptor_transaction_end</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>current_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token function">GUM_INTERCEPTOR_UNLOCK</span> <span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token function">gum_interceptor_unignore_current_thread</span> <span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>跟进看这里的实现</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> gpointer</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">gum_interceptor_resolve</span> <span class="token punctuation">(</span>GumInterceptor <span class="token operator">*</span> self<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                         gpointer address<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  address <span class="token operator">=</span> <span class="token function">gum_strip_code_pointer</span> <span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">gum_interceptor_has</span> <span class="token punctuation">(</span>self<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">const</span> gsize max_redirect_size <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    gpointer target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">gum_ensure_code_readable</span> <span class="token punctuation">(</span>address<span class="token punctuation">,</span> max_redirect_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">/* Avoid following grafted branches. */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gum_process_get_code_signing_policy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> GUM_CODE_SIGNING_REQUIRED<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token keyword">return</span> address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    target <span class="token operator">=</span> <span class="token function">_gum_interceptor_backend_resolve_redirect</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>backend<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token keyword">return</span> <span class="token function">gum_interceptor_resolve</span> <span class="token punctuation">(</span>self<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">return</span> address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>可以进到：这部分是比较核心的生成跳转 shellcode 的部分，或许也可以从这部分下手来考虑对抗？(TODO+1)</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>gpointer</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">gum_arm64_reader_try_get_relative_jump_target</span> <span class="token punctuation">(</span>gconstpointer address<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  gpointer result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  csh capstone<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  cs_insn <span class="token operator">*</span> insn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">const</span> <span class="token keyword">uint8_t</span> <span class="token operator">*</span> code<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  size_t size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">uint64_t</span> pc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">const</span> cs_arm64_op <span class="token operator">*</span> ops<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token function">cs_arch_register_arm64</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">cs_open</span> <span class="token punctuation">(</span>CS_ARCH_ARM64<span class="token punctuation">,</span> GUM_DEFAULT_CS_ENDIAN<span class="token punctuation">,</span> <span class="token operator">&amp;</span>capstone<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token function">cs_option</span> <span class="token punctuation">(</span>capstone<span class="token punctuation">,</span> CS_OPT_DETAIL<span class="token punctuation">,</span> CS_OPT_ON<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  insn <span class="token operator">=</span> <span class="token function">cs_malloc</span> <span class="token punctuation">(</span>capstone<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  code <span class="token operator">=</span> address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  size <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  pc <span class="token operator">=</span> <span class="token function">GPOINTER_TO_SIZE</span> <span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GUM_DISASM_NEXT</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cs_disasm_iter</span> <span class="token punctuation">(</span>capstone<span class="token punctuation">,</span> <span class="token operator">&amp;</span>code<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pc<span class="token punctuation">,</span> insn<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach<span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token expression">ops <span class="token operator">=</span> insn<span class="token operator">-&gt;</span>detail<span class="token operator">-&gt;</span>arm64<span class="token punctuation">.</span>operands</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GUM_CHECK_ID</span><span class="token expression"><span class="token punctuation">(</span>i<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>insn<span class="token operator">-&gt;</span>id <span class="token operator">!=</span> <span class="token function">G_PASTE</span> <span class="token punctuation">(</span>ARM64_INS_<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GUM_CHECK_OP_TYPE</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">,</span> t<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">!=</span> <span class="token function">G_PASTE</span> <span class="token punctuation">(</span>ARM64_OP_<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GUM_CHECK_OP_REG</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">,</span> r<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>reg <span class="token operator">!=</span> <span class="token function">G_PASTE</span> <span class="token punctuation">(</span>ARM64_REG_<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GUM_CHECK_OP_MEM</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">,</span> b<span class="token punctuation">,</span> i<span class="token punctuation">,</span> d<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token punctuation">.</span>base <span class="token operator">!=</span> <span class="token function">G_PASTE</span> <span class="token punctuation">(</span>ARM64_REG_<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach<span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token punctuation">.</span>index <span class="token operator">!=</span> <span class="token function">G_PASTE</span> <span class="token punctuation">(</span>ARM64_REG_<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach<span class="token punctuation">;</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>mem<span class="token punctuation">.</span>disp <span class="token operator">!=</span> d<span class="token punctuation">)</span> </span><span class="token punctuation">\</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token expression"><span class="token keyword">goto</span> beach</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token function">GUM_DISASM_NEXT</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>insn<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">case</span> ARM64_INS_B<span class="token operator">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      result <span class="token operator">=</span> <span class="token function">GSIZE_TO_POINTER</span> <span class="token punctuation">(</span>ops<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">HAVE_DARWIN</span></span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">case</span> ARM64_INS_ADRP<span class="token operator">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      GumAddress target<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X17<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      target <span class="token operator">=</span> ops<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imm<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>      <span class="token function">GUM_DISASM_NEXT</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token function">GUM_CHECK_ID</span> <span class="token punctuation">(</span>ADD<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X17<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> X17<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token function">GUM_CHECK_OP_TYPE</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> IMM<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      target <span class="token operator">+=</span> ops<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imm<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token function">GUM_DISASM_NEXT</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token function">GUM_CHECK_ID</span> <span class="token punctuation">(</span>LDR<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X16<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token function">GUM_CHECK_OP_TYPE</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> MEM<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>      <span class="token function">GUM_CHECK_OP_MEM</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> X17<span class="token punctuation">,</span> INVALID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>      <span class="token function">GUM_DISASM_NEXT</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token function">GUM_CHECK_ID</span> <span class="token punctuation">(</span>BRAA<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> X16<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>      <span class="token function">GUM_CHECK_OP_REG</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> X17<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>      result <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>gpointer <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">GSIZE_TO_POINTER</span> <span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">default</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre>beach<span class="token operator">:</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token function">cs_free</span> <span class="token punctuation">(</span>insn<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token function">cs_close</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>capstone<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>  <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>创建拦截器后端以及分配器初始化</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">gum_interceptor_init</span> <span class="token punctuation">(</span>GumInterceptor <span class="token operator">*</span> self<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token function">g_rec_mutex_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>  self<span class="token operator">-&gt;</span>function_by_address <span class="token operator">=</span> <span class="token function">g_hash_table_new_full</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">(</span>GDestroyNotify<span class="token punctuation">)</span> gum_function_context_destroy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">gum_code_allocator_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>allocator<span class="token punctuation">,</span> GUM_INTERCEPTOR_CODE_SLICE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token function">gum_interceptor_transaction_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>current_transaction<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>看到刚才 marked 的 <code>gum_interceptor_instrument</code> ，结合前面的代码，frida 似乎会将函数建哈希表用于寻址，并且进行了拦截器后端的初始化 <code>_gum_interceptor_backend_create</code>  以及生成跳板代码</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> GumFunctionContext <span class="token operator">*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">gum_interceptor_instrument</span> <span class="token punctuation">(</span>GumInterceptor <span class="token operator">*</span> self<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                            GumInterceptorType type<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                            gpointer function_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                            GumInstrumentationError <span class="token operator">*</span> error<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  GumFunctionContext <span class="token operator">*</span> ctx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token operator">*</span>error <span class="token operator">=</span> GUM_INSTRUMENTATION_ERROR_NONE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// 要 hook 的函数，封装成了 GumFunctionContext，此时</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// 根据 地址，得到与之对应的 GunFunctionContext 对象</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  ctx <span class="token operator">=</span> <span class="token punctuation">(</span>GumFunctionContext <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">g_hash_table_lookup</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>function_by_address<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      function_address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>type <span class="token operator">!=</span> type<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token operator">*</span>error <span class="token operator">=</span> GUM_INSTRUMENTATION_ERROR_WRONG_TYPE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">return</span> ctx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>backend <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    self<span class="token operator">-&gt;</span>backend <span class="token operator">=</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">_gum_interceptor_backend_create</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>mutex<span class="token punctuation">,</span> <span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  ctx <span class="token operator">=</span> <span class="token function">gum_function_context_new</span> <span class="token punctuation">(</span>self<span class="token punctuation">,</span> function_address<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">gum_process_get_code_signing_policy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> GUM_CODE_SIGNING_REQUIRED<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token comment">// 创建跳板</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_gum_interceptor_backend_claim_grafted_trampoline</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>backend<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token keyword">goto</span> policy_violation<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_gum_interceptor_backend_create_trampoline</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>backend<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token keyword">goto</span> wrong_signature<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token comment">// 设置完成后， 添加到哈希表</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">// hash_table, key, value</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token comment">//hook 函数地址，GumFunctionContext 对象对应， 方便查找</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token function">g_hash_table_insert</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>function_by_address<span class="token punctuation">,</span> function_address<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  </pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">// 当前 transaction 添加到 任务中， 设置回调 函数 gum_interceptor_activate 拦截器激活函数</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token function">gum_interceptor_transaction_schedule_update</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>current_transaction<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      gum_interceptor_activate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token keyword">return</span> ctx<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>policy_violation<span class="token operator">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token operator">*</span>error <span class="token operator">=</span> GUM_INSTRUMENTATION_ERROR_POLICY_VIOLATION<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">goto</span> propagate_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="60"></td><td><pre>wrong_signature<span class="token operator">:</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token operator">*</span>error <span class="token operator">=</span> GUM_INSTRUMENTATION_ERROR_WRONG_SIGNATURE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">goto</span> propagate_error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="65"></td><td><pre>propagate_error<span class="token operator">:</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token function">gum_function_context_finalize</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>先偷一个跳板代码：</p>
<pre><code class="language-assembly">00C30200  mov         al,byte ptr ds:[FF00C121h]  
00C30205  xor         eax,0C30200h  
00C3020A  jmp         00C30000   // 跳到上面的 enter_thunk
00C3020F  push        dword ptr ds:[0C30200h]  
00C30215  jmp         00C30100  // 跳到 leave_thunk
// 原函数修复的指令，7个字节
00C3021A  push        ebp  
00C3021B  mov         ebp,esp  
00C3021D  cmp         dword ptr [ebp+8],0  
00C30221  jmp         gum_test_target_function+7h (0D6FB97h) // 跳回原函数，因为写跳转用了7字节，所以+7
</code></pre>
<p>拦截器后端的初始化：这里初始化的 <code>writer</code>  和 <code>relocator</code>  分别用于指令写和指令恢复。</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">_gum_interceptor_backend_create</span> <span class="token punctuation">(</span>GRecMutex <span class="token operator">*</span> mutex<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                 GumCodeAllocator <span class="token operator">*</span> allocator<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  GumInterceptorBackend <span class="token operator">*</span> backend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  backend <span class="token operator">=</span> <span class="token function">g_slice_new</span> <span class="token punctuation">(</span>GumInterceptorBackend<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  backend<span class="token operator">-&gt;</span>allocator <span class="token operator">=</span> allocator<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token function">gum_arm_writer_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>backend<span class="token operator">-&gt;</span>arm_writer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  backend<span class="token operator">-&gt;</span>arm_writer<span class="token punctuation">.</span>cpu_features <span class="token operator">=</span> <span class="token function">gum_query_cpu_features</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token function">gum_arm_relocator_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>backend<span class="token operator">-&gt;</span>arm_relocator<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>backend<span class="token operator">-&gt;</span>arm_writer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token function">gum_thumb_writer_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>backend<span class="token operator">-&gt;</span>thumb_writer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token function">gum_thumb_relocator_init</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>backend<span class="token operator">-&gt;</span>thumb_relocator<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token operator">&amp;</span>backend<span class="token operator">-&gt;</span>thumb_writer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token function">gum_interceptor_backend_create_thunks</span> <span class="token punctuation">(</span>backend<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">return</span> backend<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>看到 thunks 的初始化，这里是关键函数，用来调度执行，对应进入 hook 和离开 hook</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">gum_interceptor_backend_create_thunks</span> <span class="token punctuation">(</span>GumInterceptorBackend <span class="token operator">*</span> self<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  GumArmWriter <span class="token operator">*</span> aw <span class="token operator">=</span> <span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>arm_writer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  GumThumbWriter <span class="token operator">*</span> tw <span class="token operator">=</span> <span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>thumb_writer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  self<span class="token operator">-&gt;</span>arm_thunks <span class="token operator">=</span> <span class="token function">gum_code_allocator_alloc_slice</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">gum_arm_writer_reset</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> self<span class="token operator">-&gt;</span>arm_thunks<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  self<span class="token operator">-&gt;</span>enter_thunk_arm <span class="token operator">=</span> <span class="token function">gum_arm_writer_cur</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token function">gum_emit_arm_enter_thunk</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  self<span class="token operator">-&gt;</span>leave_thunk_arm <span class="token operator">=</span> <span class="token function">gum_arm_writer_cur</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token function">gum_emit_arm_leave_thunk</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token function">gum_arm_writer_flush</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token function">g_assert</span> <span class="token punctuation">(</span><span class="token function">gum_arm_writer_offset</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token operator">-&gt;</span>arm_thunks<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  self<span class="token operator">-&gt;</span>thumb_thunks <span class="token operator">=</span> <span class="token function">gum_code_allocator_alloc_slice</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>allocator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token function">gum_thumb_writer_reset</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span> self<span class="token operator">-&gt;</span>thumb_thunks<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  self<span class="token operator">-&gt;</span>enter_thunk_thumb <span class="token operator">=</span> <span class="token function">gum_thumb_writer_cur</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token function">gum_emit_thumb_enter_thunk</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  self<span class="token operator">-&gt;</span>leave_thunk_thumb <span class="token operator">=</span> <span class="token function">gum_thumb_writer_cur</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token function">gum_emit_thumb_leave_thunk</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token function">gum_thumb_writer_flush</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token function">g_assert</span> <span class="token punctuation">(</span><span class="token function">gum_thumb_writer_offset</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token operator">-&gt;</span>thumb_thunks<span class="token operator">-&gt;</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>gum_emit_arm_enter_thunk：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">gum_emit_arm_enter_thunk</span> <span class="token punctuation">(</span>GumArmWriter <span class="token operator">*</span> aw<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// 用于保存返回地址以及栈、寄存器情况</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token function">gum_emit_arm_prolog</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// 构造自身函数栈以及寄存器</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">gum_arm_writer_put_add_reg_reg_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_R1<span class="token punctuation">,</span> ARM_REG_SP<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      GUM_FRAME_OFFSET_CPU_CONTEXT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token function">gum_arm_writer_put_sub_reg_reg_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_R2<span class="token punctuation">,</span> ARM_REG_R4<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token function">gum_arm_writer_put_add_reg_reg_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_R3<span class="token punctuation">,</span> ARM_REG_SP<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      GUM_FRAME_OFFSET_NEXT_HOP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// 调用</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token function">gum_arm_writer_put_call_address_with_arguments</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>_gum_function_context_begin_invocation<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R6<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R1<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R2<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R3<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token function">gum_emit_arm_epilog</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>gum_emit_arm_leave_thunk：</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">gum_emit_arm_leave_thunk</span> <span class="token punctuation">(</span>GumArmWriter <span class="token operator">*</span> aw<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">gum_emit_arm_prolog</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">gum_arm_writer_put_add_reg_reg_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_R1<span class="token punctuation">,</span> ARM_REG_SP<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      GUM_FRAME_OFFSET_CPU_CONTEXT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">gum_arm_writer_put_add_reg_reg_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_R2<span class="token punctuation">,</span> ARM_REG_SP<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      GUM_FRAME_OFFSET_NEXT_HOP<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token function">gum_arm_writer_put_call_address_with_arguments</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>_gum_function_context_end_invocation<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R6<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R1<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      GUM_ARG_REGISTER<span class="token punctuation">,</span> ARM_REG_R2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token function">gum_emit_arm_epilog</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>拦截器激活：</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">void</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">gum_interceptor_activate</span> <span class="token punctuation">(</span>GumInterceptor <span class="token operator">*</span> self<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                          GumFunctionContext <span class="token operator">*</span> ctx<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                          gpointer prologue<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>destroyed<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token function">g_assert</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token operator">-&gt;</span>activated<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  ctx<span class="token operator">-&gt;</span>activated <span class="token operator">=</span> TRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token function">_gum_interceptor_backend_activate_trampoline</span> <span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>backend<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      prologue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>核心 bl 处：</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">_gum_interceptor_backend_activate_trampoline</span> <span class="token punctuation">(</span>GumInterceptorBackend <span class="token operator">*</span> self<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                              GumFunctionContext <span class="token operator">*</span> ctx<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                                              gpointer prologue<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  GumAddress function_address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  GumArmFunctionContextData <span class="token operator">*</span> data <span class="token operator">=</span> <span class="token function">GUM_FCDATA</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  function_address <span class="token operator">=</span> <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token function">_gum_interceptor_backend_get_function_address</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FUNCTION_CONTEXT_ADDRESS_IS_THUMB</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    GumThumbWriter <span class="token operator">*</span> tw <span class="token operator">=</span> <span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>thumb_writer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token comment">// 设置 base、pc</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">gum_thumb_writer_reset</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span> prologue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    tw<span class="token operator">-&gt;</span>pc <span class="token operator">=</span> function_address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>trampoline_deflector <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>redirect_code_size <span class="token operator">==</span> GUM_INTERCEPTOR_THUMB_LINK_REDIRECT_SIZE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token function">gum_emit_thumb_push_cpu_context_high_part</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">gum_thumb_writer_put_bl_imm</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span> <span class="token comment">// 写 bl，进行跳板操作</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>trampoline_deflector<span class="token operator">-&gt;</span>trampoline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token keyword">else</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">g_assert</span> <span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>redirect_code_size <span class="token operator">==</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            GUM_INTERCEPTOR_THUMB_TINY_REDIRECT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token function">gum_thumb_writer_put_b_imm</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>trampoline_deflector<span class="token operator">-&gt;</span>trampoline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>type <span class="token operator">==</span> GUM_INTERCEPTOR_TYPE_FAST<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token function">gum_thumb_writer_put_ldr_reg_address</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span> ARM_REG_PC<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>replacement_function<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token function">gum_thumb_writer_put_ldr_reg_address</span> <span class="token punctuation">(</span>tw<span class="token punctuation">,</span> ARM_REG_PC<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>          <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>on_enter_trampoline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token function">gum_thumb_writer_flush</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token function">g_assert</span> <span class="token punctuation">(</span><span class="token function">gum_thumb_writer_offset</span> <span class="token punctuation">(</span>tw<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> data<span class="token operator">-&gt;</span>redirect_code_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token keyword">else</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    GumArmWriter <span class="token operator">*</span> aw <span class="token operator">=</span> <span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>arm_writer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token function">gum_arm_writer_reset</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> prologue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    aw<span class="token operator">-&gt;</span>pc <span class="token operator">=</span> function_address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>trampoline_deflector <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token function">g_assert</span> <span class="token punctuation">(</span>data<span class="token operator">-&gt;</span>redirect_code_size <span class="token operator">==</span></pre></td></tr><tr><td data-num="58"></td><td><pre>          GUM_INTERCEPTOR_ARM_TINY_REDIRECT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token function">gum_arm_writer_put_b_imm</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>          <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>trampoline_deflector<span class="token operator">-&gt;</span>trampoline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>type <span class="token operator">==</span> GUM_INTERCEPTOR_TYPE_FAST<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token function">gum_arm_writer_put_ldr_reg_address</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_PC<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="65"></td><td><pre>          <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>replacement_function<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="69"></td><td><pre>      <span class="token function">gum_arm_writer_put_ldr_reg_address</span> <span class="token punctuation">(</span>aw<span class="token punctuation">,</span> ARM_REG_PC<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="70"></td><td><pre>          <span class="token function">GUM_ADDRESS</span> <span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>on_enter_trampoline<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token function">gum_arm_writer_flush</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token function">g_assert</span> <span class="token punctuation">(</span><span class="token function">gum_arm_writer_offset</span> <span class="token punctuation">(</span>aw<span class="token punctuation">)</span> <span class="token operator">==</span> data<span class="token operator">-&gt;</span>redirect_code_size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><h4 id="三-执行流程"><a class="markdownIt-Anchor" href="#三-执行流程">#</a> 三、执行流程</h4>
<p>偷一个（上面我们走的是 arm 的流程，函数名略有不同，但流程是一样的）</p>
<p><img src="/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/image-20240503113613151.webp" alt="image-20240503113613151"></p>
<h6 id="先这样~有机会再来调试"><a class="markdownIt-Anchor" href="#先这样~有机会再来调试">#</a> 先这样～有机会再来调试</h6>
<h3 id="frida-core"><a class="markdownIt-Anchor" href="#frida-core">#</a> frida-core</h3>
<h4 id="一-前置知识"><a class="markdownIt-Anchor" href="#一-前置知识">#</a> 一、前置知识</h4>
<h5 id="1-vala语言"><a class="markdownIt-Anchor" href="#1-vala语言">#</a> 1、vala 语言</h5>
<p>​		介绍：<a target="_blank" rel="noopener" href="https://wiki.gnome.org/Projects/Vala/">Projects/Vala - GNOME Wiki!</a>：Vala is a programming language using modern high level abstractions without imposing additional runtime requirements and without using a different ABI compared to applications and libraries written in C. Vala uses the GObject type system and has additional code generation routines that make targeting the GNOME stack simple. Vala has many other uses where native binaries are required.</p>
<p>​		vala 语言是 GNOME 中使用的一个高级语言，和传统高级语言不同的是 vala 代码会被编译器先编译成 C 代码，然后再编译成二进制文件，因此也可以认为 vala 语言是 C 的一个语法糖拓展。其使用使用 glib 的  <code>GObject</code>  类型系统来构造类和接口以实现面向对象，其语法有点类似于  <code>C#</code> ，支持许多现代语言的高级特性，包括但不限于接口、属性、内存管理、异常、lambda、信号等等。Vala 既可以通过 API 文件访问已有的 C 库文件，也可以从 C 中很容易调用 Vala 的方法。</p>
<p>​		<s>直接看也能大概看懂</s></p>
<p>​		<a target="_blank" rel="noopener" href="https://wiki.gnome.org/Projects/Vala/Documentation#Sample_Code">vala 官方文档</a></p>
<h5 id="2-进程问题"><a class="markdownIt-Anchor" href="#2-进程问题">#</a> 2、进程问题</h5>
<p>​		无论在 Android 还是 iOS 或者其他平台，进程和进程直接相互是透明的，就算对 Frida 来说目标进程并非透明的，但是对目标进程来说，至少 Frida 也该是透明的。但是现实情况显然是，二者往往需要相互之间识别并交互。</p>
<h4 id="二-源码分析"><a class="markdownIt-Anchor" href="#二-源码分析">#</a> 二、源码分析</h4>
<p>vala 插件点不进去啊急了，看不动先鸽了 ××× 等 selinux 看看再回来</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>Moyao
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://demoyao100.github.io/frida%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/" title="frida源码初探">https://demoyao100.github.io/frida源码初探/</a>
  </li>
  <li class="post-copyright-license">
      <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E9%93%81%E4%B8%89awd%E6%B8%97%E9%80%8F%E5%A4%8D%E7%9B%98/" rel="prev" title="铁三awd渗透复盘">
                  <i class="fa fa-angle-left"></i> 铁三awd渗透复盘
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/%E4%B8%8D%E5%90%8C%E7%9A%84android-hook%E5%A7%BF%E5%8A%BF/" rel="next" title="不同的android hook姿势">
                  不同的android hook姿势 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    © 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Moyao</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> &amp; <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>





</body></html>