
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
        <title>D3ctf 2023 | Moyao の小屋</title>
        <meta name="author" content="Moyao">
        <meta name="description" content="Write down something interesting I met
feel free to mail me if you have something wanted to talk about
mail: <moyaoxue@outlook.com> 
">
        <meta name="keywords" content="">
        <link rel="icon" href="/images/head.jpg">
        <script src="https://cdn.staticfile.org/instant.page/5.1.0/instantpage.min.js" type="module"></script>
        <script src="https://cdn.staticfile.org/font-awesome/6.1.1/js/all.min.js"></script>
        
        <link rel="stylesheet" href="/css/fonts.min.css">
        <link rel="stylesheet" href="/css/particlex.css">
        
        <script src="https://cdn.staticfile.org/vue/3.2.33/vue.global.prod.min.js"></script>
    <meta name="generator" content="Hexo 6.2.0"></head>
    <body>
        <div id="loading" style="height:100vh;width:100vw;position:fixed;display:flex;z-index:200;justify-content:space-between;background:#fff;transition:opacity 0.3s ease-out"><div style="position:fixed;height:100vh;width:100vw;display:flex;justify-content:center;align-items:center"><div id="loadcontent" style="width:50vmin;height:50vmin;padding:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:solid 10px #a3ddfb;text-align:center"><div><h2>LOADING...</h2><p style="word-break:keep-all">加载过慢请开启缓存(浏览器默认开启)</p><div><img alt="loading" src="/loading.gif"></div></div></div></div></div>
        <div id="layout">
            <i data-fa-symbol="calendar-solid" class="fa-solid fa-calendar fa-fw"></i>
            <i data-fa-symbol="bookmark-solid" class="fa-solid fa-bookmark fa-fw"></i>
            <i data-fa-symbol="tags-solid" class="fa-solid fa-tags fa-fw"></i>
            <transition name="into">
                <div v-show="show_page" style="display: -not-none">
                    <div id="menu_show">
                         
<nav id="menu">
    <div class="desktop-menu">
        <a href="/">
            <span class="title">Moyao の小屋</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;home</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;about</span>
        </a>
        
        <a target="_blank" rel="noopener" href="//tags/re/">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;tags</span>
        </a>
        
    </div>
    <div :class="'phone-menu ' + menu_show" id="phone-menu">
        <div class="curtain" @click="menu_show = !menu_show" v-show="menu_show"></div>
        <div :class="'title'" @click="menu_show = !menu_show">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;Moyao の小屋</span>
        </div>
        <transition name="slide">
        <div class="items" v-show="menu_show">
            
            <a href="">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-house fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">home</div>
                </div>
            </a>
            
            <a href="">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-id-card fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">about</div>
                </div>
            </a>
            
            <a href="/tags/re/">
                <div class="item">
                    <div style="min-width: 20px; max-width: 50px; width: 10%">
                        <i class="fa-solid fa-tags fa-fw"></i>
                    </div>
                    <div style="min-width: 100px; max-width: 150%; width: 20%">tags</div>
                </div>
            </a>
            
        </div>
        </transition>
    </div>
</nav>
                    </div>
                    <div id="main">
                        
<div class="article">
    <div>
        <h1>D3ctf 2023 </h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <svg class="fa-icon"><use xlink:href="#calendar-solid"></use></svg>
            </span>
            2023/7/11
        </span>
        
        
    </div>
    <div class="content" v-pre>
        <h6 id="好久没写blog了QAQ，受到某人启发觉得有空还是写写，多少动动笔吧。本来是打算先写安卓学习的那篇，想着找个题复现吧，回来看看d3那个写不明白的android，结果一看d3好几个题读作solved，写作看一眼毫无印象，遂决定回来重新做一次"><a href="#好久没写blog了QAQ，受到某人启发觉得有空还是写写，多少动动笔吧。本来是打算先写安卓学习的那篇，想着找个题复现吧，回来看看d3那个写不明白的android，结果一看d3好几个题读作solved，写作看一眼毫无印象，遂决定回来重新做一次" class="headerlink" title="好久没写blog了QAQ，受到某人启发觉得有空还是写写，多少动动笔吧。本来是打算先写安卓学习的那篇，想着找个题复现吧，回来看看d3那个写不明白的android，结果一看d3好几个题读作solved，写作看一眼毫无印象，遂决定回来重新做一次"></a>好久没写blog了QAQ，受到某人启发觉得有空还是写写，多少动动笔吧。本来是打算先写安卓学习的那篇，想着找个题复现吧，回来看看d3那个写不明白的android，<del>结果一看d3好几个题读作solved，写作看一眼毫无印象</del>，遂决定回来重新做一次</h6><span id="more"></span>
<h2 id="d3hell-attachment"><a href="#d3hell-attachment" class="headerlink" title="d3hell_attachment"></a>d3hell_attachment</h2><p><img src="/2023/07/11/d3ctf-2023/image-20230711190621273.png" alt="image-20230711190621273"></p>
<p>首先这里的d3runtime.dll就够可疑的了，调起来就有点印象。先在main开头断下来，果不其然modules里面的d3runtime.dll里面的东西很可疑</p>
<p><img src="/2023/07/11/d3ctf-2023/image-20230711191017764.png" alt="image-20230711191017764"></p>
<p>之前自己弄过一点dll加载相关的出题（后面有空写个blog记录一下，<del>希望不鸽,虽然已经鸽了半年</del>）这个位置直接调有时候窗口不会自己跳转过来，这里函数不多，直接往每个函数开头下断点</p>
<p>main里面的sleep常规nop掉，下面的逻辑看着是在骗人，真正的逻辑在dll里</p>
<p>胆大的直接F9，出锅了，调了调发现卡在sub_40216A，重来</p>
<p>压根没进main，tls_callback就把dll起起来了（第一遍动态的时候在dll下了断点，第二遍就直接发现了）</p>
<p>直接进了<code>d3runtime__61FC1628</code>看不出来啥用，有点像花但不能nop的</p>
<p><img src="/2023/07/11/d3ctf-2023/image-20230711192346716.png" alt="image-20230711192346716"></p>
<p>感觉是故意的…编译器会这么优化么…不能删这里，逻辑是中间的mov 和add 走两次，下面有个一样的操作</p>
<p>谁教的……</p>
<p>不能F5，单步往下</p>
<p>而后<code>d3runtime__61FC1578</code>函数，TEA加密，但是不知道啥用，接着调</p>
<p><img src="/2023/07/11/d3ctf-2023/image-20230711192920527.png" alt="image-20230711192920527"></p>
<p>这里上了反调，直接过掉，但是后面的代码很奇怪，明显反编译有问题，重调</p>
<p>注意到一个很奇怪的事情，这里：</p>
<p><img src="/2023/07/11/d3ctf-2023/image-20230711194724759.png" alt="image-20230711194724759"></p>
<p>合理的话按照上面相同的写法，应该是<code>E8 00 00 00 00</code>，但是这里少了一个00，一开始以为可以不需要，但是想想不对。这里怎么想都应该是<code>call $5</code>的操作，然后后面可以还原出上面的逻辑</p>
<p>哦，动动脑子，这里换32-bit了，天堂之门，对应题目hell</p>
<p>这里确实萌新没接触过天堂之门的，没从<code>tls</code>和<code>DllMainCRTStartup</code>里看出什么端倪，但是总归这里是32bit，那dump下来放进ida里看看，呜哇，修了半个小时修不明白</p>
<p>那也可以硬调吧，不妨碍，既然他能运行那姑且也可以调</p>
<p><img src="/2023/07/11/d3ctf-2023/image-20230711200137667.png" alt="image-20230711200137667"></p>
<p>调dll的确实…<del>不知道谁也出过类似的恶心题目</del></p>
<p>但是主逻辑有了的，下面<code>isdebuggerpresent</code>给他拿掉，这里主要是V0没有识别出来，跳转的时候没有找到jmp的位置，否则不会有那么多逃逸变量…</p>
<p>勉强可以辨认这里修改的表</p>
<p>回到main里，实际操作也就这里面：</p>
<p><img src="/2023/07/11/d3ctf-2023/image-20230711200826897.png" alt="image-20230711200826897"></p>
<p><code>byte_405060</code>刚才在dll已经走过了，差这个flag表，应当在这里走走：</p>
<p><img src="/2023/07/11/d3ctf-2023/image-20230711201100046.png" alt="image-20230711201100046"></p>
<p>再往前推么发现跟v12有关，于是牵扯到了<code>sub_40216A</code>，这里确实确实看不懂了，即使出题人好心没去结构体的符号表…</p>
<p>先说结论，这里是大整数分解。其次，看的别人的wp知道的</p>
<p>结论是这里把换后的表带入大整数分解，得到的两段拼接起来是flag…</p>
<h6 id="合着练了一下动调……实话说目前算是做不出来这个题的……"><a href="#合着练了一下动调……实话说目前算是做不出来这个题的……" class="headerlink" title="合着练了一下动调……实话说目前算是做不出来这个题的……"></a>合着练了一下动调……实话说目前算是做不出来这个题的……</h6><h6 id="嗯，天堂之门有空来写一个试试…-参考-原创-天堂之门-Heaven’s-Gate-C语言实现-软件逆向-看雪-安全社区-安全招聘-kanxue-com"><a href="#嗯，天堂之门有空来写一个试试…-参考-原创-天堂之门-Heaven’s-Gate-C语言实现-软件逆向-看雪-安全社区-安全招聘-kanxue-com" class="headerlink" title="嗯，天堂之门有空来写一个试试…[参考]([原创]天堂之门 (Heaven’s Gate) C语言实现-软件逆向-看雪-安全社区|安全招聘|kanxue.com)"></a>嗯，天堂之门有空来写一个试试…[参考]([<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-270153.htm">原创]天堂之门 (Heaven’s Gate) C语言实现-软件逆向-看雪-安全社区|安全招聘|kanxue.com</a>)</h6><h6 id="结论，有经验的话就不算难题，但是初见还挺可怕的"><a href="#结论，有经验的话就不算难题，但是初见还挺可怕的" class="headerlink" title="结论，有经验的话就不算难题，但是初见还挺可怕的"></a>结论，有经验的话就不算难题，但是初见还挺可怕的</h6><h2 id><a href="#" class="headerlink" title></a></h2>
    </div>
    
</div>
                         
<footer id="footer">
    <div class="footer-wrap">
        <div>
            © 20xx - 2023 Moyao の小屋
            <span class="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            @Moyao
        </div>
        <div></div>
        <div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo Engine</a> & <a
                target="_blank" rel="noopener" href="https://github.com/argvchs/hexo-theme-particlex">ParticleX Theme</a></div>
        
    </div>
</footer>
                    </div>
                </div>
            </transition>
            <div id="img_show">
                <img id="img_content" alt="img_show">
            </div>
        </div>
        <script src="https://cdn.staticfile.org/highlight.js/11.5.1/highlight.min.js"></script>
        <script src="/js/particlex.js"></script>
        <script src="/js/showimg.js"></script>
        

    </body>
</html>