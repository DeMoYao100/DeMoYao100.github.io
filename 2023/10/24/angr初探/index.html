<!doctypehtml><html lang=en><meta charset=UTF-8><meta content=width=device-width,initial-scale=1,maximum-scale=2 name=viewport><meta content=#222 name=theme-color><meta content=IE=edge,chrome=1 http-equiv=X-UA-COMPATIBLE><meta content=webkit name=renderer><link href=/assets/favicon.ico rel=icon sizes=32x32 type=image/ico><link href=/assets/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/rss.xml rel=alternate title=rev@天枢 type=application/rss+xml><link href=/atom.xml rel=alternate title=rev@天枢 type=application/atom+xml><link href=https://demoyao100.github.io/feed.json rel=alternate title=rev@天枢 type=application/json><link href=https://lf9-cdn-tos.bytecdntp.com rel=preconnect><link href=https://cdn.jsdelivr.net rel=dns-prefetch><link href=https://unpkg.com rel=dns-prefetch><link href=https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext rel=stylesheet><link href=/css/app.css?v=0.3.15 rel=stylesheet><meta content=re name=keywords><link href=https://demoyao100.github.io/2023/10/24/angr%E5%88%9D%E6%8E%A2/ rel=canonical><title>angr初探</title><meta content="Hexo 7.0.0" name=generator><body itemscope itemtype=http://schema.org/WebPage><div id=loading><div class=cat><div class=body></div><div class=head><div class=face></div></div><div class=foot><div class=tummy-end></div><div class=bottom></div><div class="legs left"></div><div class="legs right"></div></div><div class=paw><div class="hands left"></div><div class="hands right"></div></div></div></div><div id=container><header id=header itemscope itemtype=http://schema.org/WPHeader><div class=inner><div id=brand><div class=pjax><h1 itemprop="name headline">angr初探</h1><div class=meta><span title="Created: 2023-10-24 07:48:40" class=item><span class=icon><i class="ic i-calendar"></i></span><span class=text>Posted on</span><time itemprop="dateCreated datePublished" datetime=2023-10-24T07:48:40+08:00>2023-10-24</time></span><span title="Symbols count in article" class=item><span class=icon><i class="ic i-pen"></i></span><span class=text>Symbols count in article</span><span>107k</span><span class=text>words</span></span><span title="Reading time" class=item><span class=icon><i class="ic i-clock"></i></span><span class=text>Reading time</span><span>1:37</span></span></div></div></div><nav id=nav><div class=inner><div class=toggle><div aria-label="Toggle navigation bar" class=lines><span class=line></span><span class=line></span><span class=line></span></div></div><ul class=menu><li class="item title"><a href=/ rel=start>Moyao の小屋</a></ul><ul class=right id=rightNav><li class="item theme" @click=changeThemeByBtn><i :class="{'i-sun': !themeStatus,'i-moon': themeStatus}" class=ic></i><li class="item search"><i class="ic i-search"></i></ul></div></nav></div><div class=pjax id=imgs><img src=https://tva4.sinaimg.cn/mw690/6833939bly1gicitcxhpij20zk0m8hdt.jpg></div></header><div id=waves><svg viewbox="0 24 150 28" class=waves preserveaspectratio=none shape-rendering=auto xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><defs><path d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" id=gentle-wave></path></defs><g class=parallax><use x=48 xlink:href=#gentle-wave y=0></use><use x=48 xlink:href=#gentle-wave y=3></use><use x=48 xlink:href=#gentle-wave y=5></use><use x=48 xlink:href=#gentle-wave y=7></use></g></svg></div><main><div class=inner><div class=pjax id=main><div class="article wrap"><div class=breadcrumb itemlistelement itemscope itemtype=https://schema.org/BreadcrumbList><i class="ic i-home"></i><span><a href=/>Home</a></span></div><article class="post block" itemscope itemtype=http://schema.org/Article lang=en><link href=https://demoyao100.github.io/2023/10/24/angr%E5%88%9D%E6%8E%A2/ itemprop=mainEntityOfPage><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta content=/assets/avatar.jpg itemprop=image><meta content=Moyao itemprop=name><meta content="Hi,I'm Moyaoxue, Write down something interesting I met<br />
Feel free to mail me if you have something wanted to talk about, plz
mail: &amplt;moyaoxue@outlook.com&ampgt;
" itemprop=description></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta content=rev@天枢 itemprop=name></span><div class="body md" itemprop=articleBody><h6 id=preface最近遇到需要动态模拟的题比较多这里还是系统学一下angr><a class=anchor href=#preface最近遇到需要动态模拟的题比较多这里还是系统学一下angr>#</a> PREFACE：最近遇到需要动态模拟的题比较多，这里还是系统学一下 angr</h6><h6 id=ps-angr的文档还是写的比较有意思而且详细的适合当睡前读物点名批评某二进制分析工具的文档><a class=anchor href=#ps-angr的文档还是写的比较有意思而且详细的适合当睡前读物点名批评某二进制分析工具的文档>#</a> ps. angr 的文档还是写的比较有意思而且详细的，适合当睡前读物，点名批评某二进制分析工具的文档......</h6><p><span id=more></span><h4 id=参考链接><a class=anchor href=#参考链接>#</a> 参考链接：</h4><p><a href=https://docs.angr.io/en/latest/ rel=noopener target=_blank>angr documentation</a><p><a href=https://github.com/jakespringer/angr_ctf rel=noopener target=_blank>jakespringer/angr_ctf (github.com)</a><h4 id=虚拟环境><a class=anchor href=#虚拟环境>#</a> 虚拟环境</h4><p><code>angr</code> 官方推荐在虚拟环境中运行，防止与外部包冲突（例如 <code>keystone</code> 和 <code>keystone-engine</code> 冲突，这里用的是 <code>keystone-engine</code> ）<pre><code>pip install virtualenv

# 在当前目录下创建名为 angr-venv的新目录，包含干净的python环境
virtualenv angr-venv

Windows：
angr-venv\Scripts\activate

Linux/Mac：
source angr-venv/bin/activate

pip install angr

退出虚拟环境：
deactivate
</code></pre><h3 id=使用样例><a class=anchor href=#使用样例>#</a> 使用样例</h3><h4 id=导入模块><a class=anchor href=#导入模块>#</a> 导入模块</h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./file'</span><span class="token punctuation">)</span></pre></table></figure><h4 id=命令行使用时可以导入monkeyhex转化为十六进制输出><a class=anchor href=#命令行使用时可以导入monkeyhex转化为十六进制输出>#</a> 命令行使用时可以导入 <code>monkeyhex</code> 转化为十六进制输出</h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> monkeyhex <span class="token comment"># this will format numerical results in hexadecimal</span></pre></table></figure><h4 id=project的基础属性><a class=anchor href=#project的基础属性>#</a> project 的基础属性</h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre>proj<span class="token punctuation">.</span>entry <span class="token comment"># 文件的入口点</span></pre><tr><td data-num=2><td><pre></pre><tr><td data-num=3><td><pre>proj<span class="token punctuation">.</span>filename <span class="token comment"># 文件名</span></pre><tr><td data-num=4><td><pre></pre><tr><td data-num=5><td><pre>proj<span class="token punctuation">.</span>arch <span class="token comment"># 文件的架构</span></pre><tr><td data-num=6><td><pre><span class="token operator">-</span> proj<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>name <span class="token comment"># x86/x86-64/ARM</span></pre><tr><td data-num=7><td><pre><span class="token operator">-</span> proj<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>bits <span class="token comment"># 32/64</span></pre><tr><td data-num=8><td><pre><span class="token operator">-</span> proj<span class="token punctuation">.</span>arch<span class="token punctuation">.</span><span class="token builtin">bytes</span> <span class="token comment"># bytes per instruction, eg : 4/8</span></pre><tr><td data-num=9><td><pre><span class="token operator">-</span> proj<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness <span class="token comment"># 字节序，例如 Iend_LE 代表小端序</span></pre></table></figure><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre>proj<span class="token punctuation">.</span>loader <span class="token comment"># 显示已加载对象，内存映射的地址范围</span></pre><tr><td data-num=2><td><pre><span class="token comment"># &LTLoaded [file_name], maps [0x400000:0x5004000]></span></pre><tr><td data-num=3><td><pre></pre><tr><td data-num=4><td><pre>proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>shared_objects <span class="token comment"># 已加载的所有共享对象，共享库或动态链接库及其内存映射</span></pre><tr><td data-num=5><td><pre><span class="token comment"># OrderedDict([('angr', &LTELF Object angr, maps [0x8048000:0x804c033]>), ('libc.so.6', &LTELF Object libc.so.6, maps [0x8100000:0x83347bb]>), ('ld-linux.so.2', &LTELF Object ld-linux.so.2, maps [0x8400000:0x8437a37]>), ('extern-address space', &LTExternObject Object cle##externs, maps [0x8500000:0x8507fff]>), ('cle##tls', &LTELFTLSObjectV2 Object cle##tls, maps [0x8600000:0x8614807]>)])</span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre>proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>min_addr <span class="token comment"># 加载的二进制文件占用的内存空间的界限</span></pre><tr><td data-num=8><td><pre><span class="token comment"># 0x8048000</span></pre><tr><td data-num=9><td><pre>proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>max_addr</pre><tr><td data-num=10><td><pre><span class="token comment"># 0x8707fff</span></pre><tr><td data-num=11><td><pre></pre><tr><td data-num=12><td><pre>proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>main_object <span class="token comment"># 返回代表主要加载的二进制文件的对象</span></pre><tr><td data-num=13><td><pre><span class="token comment"># &LTELF Object angr, maps [0x8048000:0x804c033]></span></pre><tr><td data-num=14><td><pre></pre><tr><td data-num=15><td><pre>proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>main_object<span class="token punctuation">.</span>execstack <span class="token comment"># 返回 bool，代表主二进制文件是否具有可执行堆栈</span></pre><tr><td data-num=16><td><pre><span class="token comment"># False</span></pre><tr><td data-num=17><td><pre></pre><tr><td data-num=18><td><pre>proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>main_object<span class="token punctuation">.</span>pic <span class="token comment"># 二进制文件是否为位置独立代码，若返回 True，则说明开启了 ASLR</span></pre><tr><td data-num=19><td><pre><span class="token comment"># False</span></pre></table></figure><h4 id=对基本块的操作><a class=anchor href=#对基本块的操作>#</a> 对基本块的操作</h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre>block <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>block<span class="token punctuation">(</span>proj<span class="token punctuation">.</span>entry<span class="token punctuation">)</span> <span class="token comment"># 打印入口的基本块的汇编</span></pre><tr><td data-num=2><td><pre>block<span class="token punctuation">.</span>pp<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token triple-quoted-string string">"""</span></pre><tr><td data-num=4><td><pre>80490b0  endbr32 </pre><tr><td data-num=5><td><pre>80490b4  xor     ebp, ebp</pre><tr><td data-num=6><td><pre>80490b6  pop     esi</pre><tr><td data-num=7><td><pre>80490b7  mov     ecx, esp</pre><tr><td data-num=8><td><pre>80490b9  and     esp, 0xfffffff0</pre><tr><td data-num=9><td><pre>80490bc  push    eax</pre><tr><td data-num=10><td><pre>80490bd  push    esp</pre><tr><td data-num=11><td><pre>80490be  push    edx</pre><tr><td data-num=12><td><pre>80490bf  call    0x80490dd</pre><tr><td data-num=13><td><pre>"""</pre><tr><td data-num=14><td><pre></pre><tr><td data-num=15><td><pre>block<span class="token punctuation">.</span>instructions                  <span class="token comment"># 该基本块的指令数量</span></pre><tr><td data-num=16><td><pre><span class="token comment"># 9</span></pre><tr><td data-num=17><td><pre>block<span class="token punctuation">.</span>instruction_addrs             <span class="token comment"># 该基本块指令地址</span></pre><tr><td data-num=18><td><pre><span class="token comment"># (134516912, 134516916, 134516918, 134516919, 134516921, 134516924, 134516925, 134516926, 134516927)</span></pre><tr><td data-num=19><td><pre></pre><tr><td data-num=20><td><pre>block<span class="token punctuation">.</span>capstone <span class="token comment"># 打印人类可读汇编形式（与.pp () 类同）</span></pre><tr><td data-num=21><td><pre>block<span class="token punctuation">.</span>vex <span class="token comment"># 打印 IR 代码形式</span></pre><tr><td data-num=22><td><pre><span class="token triple-quoted-string string">"""</span></pre><tr><td data-num=23><td><pre>IRSB {</pre><tr><td data-num=24><td><pre>   t0:Ity_I32 t1:Ity_I32 t2:Ity_I32 t3:Ity_I32 t4:Ity_I32 t5:Ity_I32 t6:Ity_I32 t7:Ity_I32 t8:Ity_I32 t9:Ity_I32 t10:Ity_I32 t11:Ity_I32 t12:Ity_I32 t13:Ity_I32 t14:Ity_I32 t15:Ity_I32 t16:Ity_I32 t17:Ity_I32 t18:Ity_I32 t19:Ity_I32 t20:Ity_I32 t21:Ity_I32 t22:Ity_I32 t23:Ity_I32 t24:Ity_I32 t25:Ity_I32</pre><tr><td data-num=25><td><pre></pre><tr><td data-num=26><td><pre>   00 | ------ IMark(0x80490b0, 4, 0) ------</pre><tr><td data-num=27><td><pre>   01 | ------ IMark(0x80490b4, 2, 0) ------</pre><tr><td data-num=28><td><pre>   02 | PUT(ebp) = 0x00000000</pre><tr><td data-num=29><td><pre>   03 | PUT(eip) = 0x080490b6</pre><tr><td data-num=30><td><pre>   04 | ------ IMark(0x80490b6, 1, 0) ------</pre><tr><td data-num=31><td><pre>   05 | t4 = GET:I32(esp)</pre><tr><td data-num=32><td><pre>   06 | t3 = LDle:I32(t4)</pre><tr><td data-num=33><td><pre>   07 | t15 = Add32(t4,0x00000004)</pre><tr><td data-num=34><td><pre>   08 | PUT(esi) = t3</pre><tr><td data-num=35><td><pre>   09 | ------ IMark(0x80490b7, 2, 0) ------</pre><tr><td data-num=36><td><pre>   10 | PUT(ecx) = t15</pre><tr><td data-num=37><td><pre>   11 | ------ IMark(0x80490b9, 3, 0) ------</pre><tr><td data-num=38><td><pre>   12 | t5 = And32(t15,0xfffffff0)</pre><tr><td data-num=39><td><pre>   13 | PUT(cc_op) = 0x0000000f</pre><tr><td data-num=40><td><pre>   14 | PUT(cc_dep1) = t5</pre><tr><td data-num=41><td><pre>   15 | PUT(cc_dep2) = 0x00000000</pre><tr><td data-num=42><td><pre>   16 | PUT(cc_ndep) = 0x00000000</pre><tr><td data-num=43><td><pre>   17 | PUT(eip) = 0x080490bc</pre><tr><td data-num=44><td><pre>   18 | ------ IMark(0x80490bc, 1, 0) ------</pre><tr><td data-num=45><td><pre>   19 | t8 = GET:I32(eax)</pre><tr><td data-num=46><td><pre>   20 | t17 = Sub32(t5,0x00000004)</pre><tr><td data-num=47><td><pre>   21 | PUT(esp) = t17</pre><tr><td data-num=48><td><pre>   22 | STle(t17) = t8</pre><tr><td data-num=49><td><pre>   23 | PUT(eip) = 0x080490bd</pre><tr><td data-num=50><td><pre>   24 | ------ IMark(0x80490bd, 1, 0) ------</pre><tr><td data-num=51><td><pre>   25 | t19 = Sub32(t17,0x00000004)</pre><tr><td data-num=52><td><pre>   26 | PUT(esp) = t19</pre><tr><td data-num=53><td><pre>   27 | STle(t19) = t17</pre><tr><td data-num=54><td><pre>   28 | PUT(eip) = 0x080490be</pre><tr><td data-num=55><td><pre>   29 | ------ IMark(0x80490be, 1, 0) ------</pre><tr><td data-num=56><td><pre>   30 | t12 = GET:I32(edx)</pre><tr><td data-num=57><td><pre>   31 | t21 = Sub32(t19,0x00000004)</pre><tr><td data-num=58><td><pre>   32 | PUT(esp) = t21</pre><tr><td data-num=59><td><pre>   33 | STle(t21) = t12</pre><tr><td data-num=60><td><pre>   34 | PUT(eip) = 0x080490bf</pre><tr><td data-num=61><td><pre>   35 | ------ IMark(0x80490bf, 5, 0) ------</pre><tr><td data-num=62><td><pre>   36 | t23 = Sub32(t21,0x00000004)</pre><tr><td data-num=63><td><pre>   37 | PUT(esp) = t23</pre><tr><td data-num=64><td><pre>   38 | STle(t23) = 0x080490c4</pre><tr><td data-num=65><td><pre>   NEXT: PUT(eip) = 0x080490dd; Ijk_Call</pre><tr><td data-num=66><td><pre>}</pre><tr><td data-num=67><td><pre>"""</pre></table></figure><h4 id=模拟状态-simstate><a class=anchor href=#模拟状态-simstate>#</a> 模拟状态 <code>SimState</code></h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre>state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span> </pre><tr><td data-num=2><td><pre><span class="token comment"># &LTSimState @ 0x80490b0></span></pre><tr><td data-num=3><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eip<span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>mem<span class="token punctuation">[</span>proj<span class="token punctuation">.</span>entry<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">.</span>resolved<span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre><span class="token triple-quoted-string string">"""</span></pre><tr><td data-num=8><td><pre>&LTBV32 0x80490b0></pre><tr><td data-num=9><td><pre>&LTBV32 0x1c></pre><tr><td data-num=10><td><pre>&LTBV32 0xfb1e0ff3></pre><tr><td data-num=11><td><pre>"""</pre><tr><td data-num=12><td><pre><span class="token comment"># 注意这里的描述，给出官方解释：</span></pre><tr><td data-num=13><td><pre><span class="token comment"># - Those aren’t Python ints! Those are bitvectors. Python integers don’t have the same semantics as words on a CPU, e.g. wrapping on overflow, so we work with bitvectors, which you can think of as an integer as represented by a series of bits, to represent CPU data in angr. Note that each bitvector has a .length property describing how wide it is in bits.</span></pre><tr><td data-num=14><td><pre></pre><tr><td data-num=15><td><pre>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span> <span class="token comment"># 转化为 python int</span></pre><tr><td data-num=16><td><pre>bv <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0x1234</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>       <span class="token comment"># 反过来创建，create a 32-bit-wide bitvector with value 0x1234</span></pre><tr><td data-num=17><td><pre></pre><tr><td data-num=18><td><pre>bv <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0x1111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token comment"># 修改寄存器值</span></pre><tr><td data-num=19><td><pre>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> bv</pre><tr><td data-num=20><td><pre></pre><tr><td data-num=21><td><pre>state<span class="token punctuation">.</span>mem<span class="token punctuation">[</span><span class="token number">0x1000</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span> <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment"># 修改内存中的值</span></pre><tr><td data-num=22><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>mem<span class="token punctuation">[</span><span class="token number">0x1000</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">.</span>resolved<span class="token punctuation">)</span></pre><tr><td data-num=23><td><pre><span class="token comment"># &LTBV32 0x4></span></pre><tr><td data-num=24><td><pre><span class="token triple-quoted-string string">"""</span></pre><tr><td data-num=25><td><pre>mem的官方描述：</pre><tr><td data-num=26><td><pre>The mem interface is a little confusing at first, since it’s using some pretty hefty Python magic. The short version of how to use it is:</pre><tr><td data-num=27><td><pre></pre><tr><td data-num=28><td><pre>Use array[index] notation to specify an address</pre><tr><td data-num=29><td><pre></pre><tr><td data-num=30><td><pre>Use .&LTtype> to specify that the memory should be interpreted as type (common values: char, short, int, long, size_t, uint8_t, uint16_t…)</pre><tr><td data-num=31><td><pre></pre><tr><td data-num=32><td><pre>From there, you can either:</pre><tr><td data-num=33><td><pre></pre><tr><td data-num=34><td><pre>Store a value to it, either a bitvector or a Python int</pre><tr><td data-num=35><td><pre></pre><tr><td data-num=36><td><pre>Use .resolved to get the value as a bitvector</pre><tr><td data-num=37><td><pre></pre><tr><td data-num=38><td><pre>Use .concrete to get the value as a Python int</pre><tr><td data-num=39><td><pre>"""</pre></table></figure><h4 id=模拟管理器-simulation-managers><a class=anchor href=#模拟管理器-simulation-managers>#</a> 模拟管理器 <code>Simulation Managers</code></h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token comment"># 创建一个新的 SimulationManager 实例，它将负责管理程序的所有可能的执行路径，包括路径的分叉、合并和死亡</span></pre><tr><td data-num=2><td><pre></pre><tr><td data-num=3><td><pre>simgr<span class="token punctuation">.</span>active </pre><tr><td data-num=4><td><pre><span class="token triple-quoted-string string">"""</span></pre><tr><td data-num=5><td><pre>拟管理器维护了几个不同的状态列表，这些列表代表了程序执行的不同阶段。这些列表包括：active、unconstrained、deadended、errored等。</pre><tr><td data-num=6><td><pre>simgr.active是一个包含所有“活动”路径的列表。所谓“活动”路径，指的是那些还在进行中、未遇到任何终止条件的路径。这些是可以继续推进执行的路径。</pre><tr><td data-num=7><td><pre>通过查看simgr.active列表，您可以了解当前有多少执行路径正在被模拟管理器管理，并且可以对这些路径进行进一步的查询或操作。</pre><tr><td data-num=8><td><pre>"""</pre></table></figure><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre>state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>state<span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>active<span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>active<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eip<span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre>simgr<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>active<span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>active<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eip<span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre></pre><tr><td data-num=13><td><pre><span class="token triple-quoted-string string">""" 这里执行了一整个基本块（注意：smigr不会改变state的信息）</span></pre><tr><td data-num=14><td><pre>&LTSimulationManager with 1 active></pre><tr><td data-num=15><td><pre>[&LTSimState @ 0x80490b0>]</pre><tr><td data-num=16><td><pre>&LTBV32 0x80490b0></pre><tr><td data-num=17><td><pre>---</pre><tr><td data-num=18><td><pre>[&LTSimState @ 0x80490dd>]</pre><tr><td data-num=19><td><pre>&LTBV32 0x80490dd></pre><tr><td data-num=20><td><pre>"""</pre></table></figure><h4 id=analyses><a class=anchor href=#analyses>#</a> Analyses</h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>            <span class="token comment"># Press TAB here in ipython to get an autocomplete-listing of everything:</span></pre><tr><td data-num=2><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>BackwardSlice        proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>CongruencyCheck      </pre><tr><td data-num=3><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>reload_analyses		proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>BinaryOptimizer      </pre><tr><td data-num=4><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>DDG                  proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>StaticHooker</pre><tr><td data-num=5><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>BinDiff              proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>DFG                  </pre><tr><td data-num=6><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>VariableRecovery		proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>BoyScout             </pre><tr><td data-num=7><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>Disassembly          proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>VariableRecoveryFast</pre><tr><td data-num=8><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>CDG                  proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>GirlScout            </pre><tr><td data-num=9><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>Veritesting			proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>CFG                  </pre><tr><td data-num=10><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>Identifier           proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>VFG</pre><tr><td data-num=11><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>CFGEmulated          proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>LoopFinder           </pre><tr><td data-num=12><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>VSA_DDG				proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>CFGFast              </pre><tr><td data-num=13><td><pre> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>Reassembler</pre></table></figure><p>（未必准确的解释，后续慢慢验证）<p><img alt=image-20231024094301794 data-src=angr%E5%88%9D%E6%8E%A2/image-20231024094301794-16981317832354.png loading=lazy><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 不加载所有依赖的外部动态链接库，防止出现额外开销以及库不兼容的报错等等问题</span></pre><tr><td data-num=3><td><pre>cfg <span class="token operator">=</span> proj<span class="token punctuation">.</span>analyses<span class="token punctuation">.</span>CFGFast<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'----'</span><span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>nodes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre>entry_node <span class="token operator">=</span> cfg<span class="token punctuation">.</span>get_any_node<span class="token punctuation">(</span>proj<span class="token punctuation">.</span>entry<span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'----'</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>entry_node<span class="token punctuation">)</span></pre></table></figure><p><img alt=image-20231024095601415 data-src=angr%E5%88%9D%E6%8E%A2/image-20231024095601415-16981317771273.png loading=lazy><h4 id=the-loader><a class=anchor href=#the-loader>#</a> The Loader</h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># All loaded objects</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>all_objects</pre><tr><td data-num=3><td><pre><span class="token punctuation">[</span><span class="token operator"><</span>ELF Object fauxware<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x400000</span><span class="token punctuation">:</span><span class="token number">0x60105f</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=4><td><pre> <span class="token operator"><</span>ELF Object libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x1000000</span><span class="token punctuation">:</span><span class="token number">0x13c999f</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=5><td><pre> <span class="token operator"><</span>ELF Object ld<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x2000000</span><span class="token punctuation">:</span><span class="token number">0x2227167</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=6><td><pre> <span class="token operator"><</span>ELFTLSObject Object cle<span class="token comment">##tls, maps [0x3000000:0x3015010]>,</span></pre><tr><td data-num=7><td><pre> <span class="token operator"><</span>ExternObject Object cle<span class="token comment">##externs, maps [0x4000000:0x4008000]>,</span></pre><tr><td data-num=8><td><pre> <span class="token operator"><</span>KernelObject Object cle<span class="token comment">##kernel, maps [0x5000000:0x5008000]>]</span></pre><tr><td data-num=9><td><pre></pre><tr><td data-num=10><td><pre><span class="token comment"># This is the "main" object, the one that you directly specified when loading the project</span></pre><tr><td data-num=11><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>main_object</pre><tr><td data-num=12><td><pre><span class="token operator"><</span>ELF Object fauxware<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x400000</span><span class="token punctuation">:</span><span class="token number">0x60105f</span><span class="token punctuation">]</span><span class="token operator">></span></pre><tr><td data-num=13><td><pre></pre><tr><td data-num=14><td><pre><span class="token comment"># This is a dictionary mapping from shared object name to object</span></pre><tr><td data-num=15><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>shared_objects</pre><tr><td data-num=16><td><pre><span class="token punctuation">{</span> <span class="token string">'fauxware'</span><span class="token punctuation">:</span> <span class="token operator"><</span>ELF Object fauxware<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x400000</span><span class="token punctuation">:</span><span class="token number">0x60105f</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=17><td><pre>  <span class="token string">'libc.so.6'</span><span class="token punctuation">:</span> <span class="token operator"><</span>ELF Object libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x1000000</span><span class="token punctuation">:</span><span class="token number">0x13c999f</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=18><td><pre>  <span class="token string">'ld-linux-x86-64.so.2'</span><span class="token punctuation">:</span> <span class="token operator"><</span>ELF Object ld<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x2000000</span><span class="token punctuation">:</span><span class="token number">0x2227167</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">}</span></pre><tr><td data-num=19><td><pre></pre><tr><td data-num=20><td><pre><span class="token comment"># Here's all the objects that were loaded from ELF files</span></pre><tr><td data-num=21><td><pre><span class="token comment"># If this were a windows program we'd use all_pe_objects!</span></pre><tr><td data-num=22><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>all_elf_objects</pre><tr><td data-num=23><td><pre><span class="token punctuation">[</span><span class="token operator"><</span>ELF Object fauxware<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x400000</span><span class="token punctuation">:</span><span class="token number">0x60105f</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=24><td><pre> <span class="token operator"><</span>ELF Object libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x1000000</span><span class="token punctuation">:</span><span class="token number">0x13c999f</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=25><td><pre> <span class="token operator"><</span>ELF Object ld<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x2000000</span><span class="token punctuation">:</span><span class="token number">0x2227167</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">]</span></pre><tr><td data-num=26><td><pre></pre><tr><td data-num=27><td><pre><span class="token comment"># Here's the "externs object", which we use to provide addresses for unresolved imports and angr internals</span></pre><tr><td data-num=28><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>extern_object</pre><tr><td data-num=29><td><pre><span class="token operator"><</span>ExternObject Object cle<span class="token comment">##externs, maps [0x4000000:0x4008000]></span></pre><tr><td data-num=30><td><pre></pre><tr><td data-num=31><td><pre><span class="token comment"># This object is used to provide addresses for emulated syscalls</span></pre><tr><td data-num=32><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>kernel_object</pre><tr><td data-num=33><td><pre><span class="token operator"><</span>KernelObject Object cle<span class="token comment">##kernel, maps [0x5000000:0x5008000]></span></pre><tr><td data-num=34><td><pre></pre><tr><td data-num=35><td><pre><span class="token comment"># Finally, you can to get a reference to an object given an address in it</span></pre><tr><td data-num=36><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>find_object_containing<span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">)</span></pre><tr><td data-num=37><td><pre><span class="token operator"><</span>ELF Object fauxware<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x400000</span><span class="token punctuation">:</span><span class="token number">0x60105f</span><span class="token punctuation">]</span><span class="token operator">></span></pre></table></figure><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> obj <span class="token operator">=</span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>main_object</pre><tr><td data-num=2><td><pre></pre><tr><td data-num=3><td><pre><span class="token comment"># The entry point of the object</span></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>entry</pre><tr><td data-num=5><td><pre><span class="token number">0x400580</span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre><span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>min_addr<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>max_addr</pre><tr><td data-num=8><td><pre><span class="token punctuation">(</span><span class="token number">0x400000</span><span class="token punctuation">,</span> <span class="token number">0x60105f</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre></pre><tr><td data-num=10><td><pre><span class="token comment"># Retrieve this ELF's segments and sections</span></pre><tr><td data-num=11><td><pre><span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>segments</pre><tr><td data-num=12><td><pre><span class="token operator"><</span>Regions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator"><</span>ELFSegment memsize<span class="token operator">=</span><span class="token number">0xa74</span><span class="token punctuation">,</span> filesize<span class="token operator">=</span><span class="token number">0xa74</span><span class="token punctuation">,</span> vaddr<span class="token operator">=</span><span class="token number">0x400000</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0x5</span><span class="token punctuation">,</span> offset<span class="token operator">=</span><span class="token number">0x0</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=13><td><pre>           <span class="token operator"><</span>ELFSegment memsize<span class="token operator">=</span><span class="token number">0x238</span><span class="token punctuation">,</span> filesize<span class="token operator">=</span><span class="token number">0x228</span><span class="token punctuation">,</span> vaddr<span class="token operator">=</span><span class="token number">0x600e28</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0x6</span><span class="token punctuation">,</span> offset<span class="token operator">=</span><span class="token number">0xe28</span><span class="token operator">></span><span class="token punctuation">]</span><span class="token operator">></span></pre><tr><td data-num=14><td><pre><span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>sections</pre><tr><td data-num=15><td><pre><span class="token operator"><</span>Regions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator"><</span>Unnamed <span class="token operator">|</span> offset <span class="token number">0x0</span><span class="token punctuation">,</span> vaddr <span class="token number">0x0</span><span class="token punctuation">,</span> size <span class="token number">0x0</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=16><td><pre>           <span class="token operator"><</span><span class="token punctuation">.</span>interp <span class="token operator">|</span> offset <span class="token number">0x238</span><span class="token punctuation">,</span> vaddr <span class="token number">0x400238</span><span class="token punctuation">,</span> size <span class="token number">0x1c</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=17><td><pre>           <span class="token operator"><</span><span class="token punctuation">.</span>note<span class="token punctuation">.</span>ABI<span class="token operator">-</span>tag <span class="token operator">|</span> offset <span class="token number">0x254</span><span class="token punctuation">,</span> vaddr <span class="token number">0x400254</span><span class="token punctuation">,</span> size <span class="token number">0x20</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=18><td><pre>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>etc</pre><tr><td data-num=19><td><pre></pre><tr><td data-num=20><td><pre><span class="token comment"># You can get an individual segment or section by an address it contains:</span></pre><tr><td data-num=21><td><pre><span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>find_segment_containing<span class="token punctuation">(</span>obj<span class="token punctuation">.</span>entry<span class="token punctuation">)</span></pre><tr><td data-num=22><td><pre><span class="token operator"><</span>ELFSegment memsize<span class="token operator">=</span><span class="token number">0xa74</span><span class="token punctuation">,</span> filesize<span class="token operator">=</span><span class="token number">0xa74</span><span class="token punctuation">,</span> vaddr<span class="token operator">=</span><span class="token number">0x400000</span><span class="token punctuation">,</span> flags<span class="token operator">=</span><span class="token number">0x5</span><span class="token punctuation">,</span> offset<span class="token operator">=</span><span class="token number">0x0</span><span class="token operator">></span></pre><tr><td data-num=23><td><pre><span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>find_section_containing<span class="token punctuation">(</span>obj<span class="token punctuation">.</span>entry<span class="token punctuation">)</span></pre><tr><td data-num=24><td><pre><span class="token operator"><</span><span class="token punctuation">.</span>text <span class="token operator">|</span> offset <span class="token number">0x580</span><span class="token punctuation">,</span> vaddr <span class="token number">0x400580</span><span class="token punctuation">,</span> size <span class="token number">0x338</span><span class="token operator">></span></pre><tr><td data-num=25><td><pre></pre><tr><td data-num=26><td><pre><span class="token comment"># Get the address of the PLT stub for a symbol</span></pre><tr><td data-num=27><td><pre><span class="token operator">>></span><span class="token operator">></span> addr <span class="token operator">=</span> obj<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'strcmp'</span><span class="token punctuation">]</span></pre><tr><td data-num=28><td><pre><span class="token operator">>></span><span class="token operator">></span> addr</pre><tr><td data-num=29><td><pre><span class="token number">0x400550</span></pre><tr><td data-num=30><td><pre><span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>reverse_plt<span class="token punctuation">[</span>addr<span class="token punctuation">]</span></pre><tr><td data-num=31><td><pre><span class="token string">'strcmp'</span></pre><tr><td data-num=32><td><pre></pre><tr><td data-num=33><td><pre><span class="token comment"># Show the prelinked base of the object and the location it was actually mapped into memory by CLE</span></pre><tr><td data-num=34><td><pre><span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>linked_base</pre><tr><td data-num=35><td><pre><span class="token number">0x400000</span></pre><tr><td data-num=36><td><pre><span class="token operator">>></span><span class="token operator">></span> obj<span class="token punctuation">.</span>mapped_base</pre><tr><td data-num=37><td><pre><span class="token number">0x400000</span></pre></table></figure><h4 id=symbols-and-relocations><a class=anchor href=#symbols-and-relocations>#</a> Symbols and Relocations</h4><p>CLE 寻找符号地址<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> strcmp <span class="token operator">=</span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>find_symbol<span class="token punctuation">(</span><span class="token string">'strcmp'</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> strcmp</pre><tr><td data-num=3><td><pre><span class="token operator"><</span>Symbol <span class="token string">"strcmp"</span> <span class="token keyword">in</span> libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token number">6</span> at <span class="token number">0x1089cd0</span><span class="token operator">></span></pre></table></figure><p>The Symbol object has three ways of reporting its address:<ul><li><code>.rebased_addr</code> is its address in the global address space. This is what is shown in the print output.<li><code>.linked_addr</code> is its address relative to the prelinked base of the binary. This is the address reported in, for example, <code>readelf(1)</code> .<li><code>.relative_addr</code> is its address relative to the object base. This is known in the literature (particularly the Windows literature) as an RVA (relative virtual address).</ul><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> strcmp<span class="token punctuation">.</span>name</pre><tr><td data-num=2><td><pre><span class="token string">'strcmp'</span></pre><tr><td data-num=3><td><pre></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> strcmp<span class="token punctuation">.</span>owner</pre><tr><td data-num=5><td><pre><span class="token operator"><</span>ELF Object libc<span class="token operator">-</span><span class="token number">2.23</span><span class="token punctuation">.</span>so<span class="token punctuation">,</span> maps <span class="token punctuation">[</span><span class="token number">0x1000000</span><span class="token punctuation">:</span><span class="token number">0x13c999f</span><span class="token punctuation">]</span><span class="token operator">></span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre><span class="token operator">>></span><span class="token operator">></span> strcmp<span class="token punctuation">.</span>rebased_addr <span class="token comment"># 进程虚拟内存中的地址</span></pre><tr><td data-num=8><td><pre><span class="token number">0x1089cd0</span></pre><tr><td data-num=9><td><pre><span class="token operator">>></span><span class="token operator">></span> strcmp<span class="token punctuation">.</span>linked_addr <span class="token comment">#链接时分配的地址</span></pre><tr><td data-num=10><td><pre><span class="token number">0x89cd0</span></pre><tr><td data-num=11><td><pre><span class="token operator">>></span><span class="token operator">></span> strcmp<span class="token punctuation">.</span>relative_addr <span class="token comment"># 被加载到的预定基地址</span></pre><tr><td data-num=12><td><pre><span class="token number">0x89cd0</span></pre></table></figure><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> strcmp<span class="token punctuation">.</span>is_export</pre><tr><td data-num=2><td><pre><span class="token boolean">True</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> strcmp<span class="token punctuation">.</span>is_import</pre><tr><td data-num=4><td><pre><span class="token boolean">False</span></pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre><span class="token comment"># On Loader, the method is find_symbol because it performs a search operation to find the symbol.</span></pre><tr><td data-num=7><td><pre><span class="token comment"># On an individual object, the method is get_symbol because there can only be one symbol with a given name.</span></pre><tr><td data-num=8><td><pre><span class="token operator">>></span><span class="token operator">></span> main_strcmp <span class="token operator">=</span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>main_object<span class="token punctuation">.</span>get_symbol<span class="token punctuation">(</span><span class="token string">'strcmp'</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre><span class="token operator">>></span><span class="token operator">></span> main_strcmp</pre><tr><td data-num=10><td><pre><span class="token operator"><</span>Symbol <span class="token string">"strcmp"</span> <span class="token keyword">in</span> fauxware <span class="token punctuation">(</span><span class="token keyword">import</span><span class="token punctuation">)</span><span class="token operator">></span></pre><tr><td data-num=11><td><pre><span class="token operator">>></span><span class="token operator">></span> main_strcmp<span class="token punctuation">.</span>is_export</pre><tr><td data-num=12><td><pre><span class="token boolean">False</span></pre><tr><td data-num=13><td><pre><span class="token operator">>></span><span class="token operator">></span> main_strcmp<span class="token punctuation">.</span>is_import</pre><tr><td data-num=14><td><pre><span class="token boolean">True</span></pre><tr><td data-num=15><td><pre><span class="token operator">>></span><span class="token operator">></span> main_strcmp<span class="token punctuation">.</span>resolvedby</pre><tr><td data-num=16><td><pre><span class="token operator"><</span>Symbol <span class="token string">"strcmp"</span> <span class="token keyword">in</span> libc<span class="token punctuation">.</span>so<span class="token punctuation">.</span><span class="token number">6</span> at <span class="token number">0x1089cd0</span><span class="token operator">></span></pre></table></figure><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># Relocations don't have a good pretty-printing, so those addresses are Python-internal, unrelated to our program</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>shared_objects<span class="token punctuation">[</span><span class="token string">'libc.so.6'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imports</pre><tr><td data-num=3><td><pre><span class="token punctuation">{</span><span class="token string">'__libc_enable_secure'</span><span class="token punctuation">:</span> <span class="token operator"><</span>cle<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>elf<span class="token punctuation">.</span>relocation<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>R_X86_64_GLOB_DAT at <span class="token number">0x7ff5c5fce780</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=4><td><pre> <span class="token string">'__tls_get_addr'</span><span class="token punctuation">:</span> <span class="token operator"><</span>cle<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>elf<span class="token punctuation">.</span>relocation<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>R_X86_64_JUMP_SLOT at <span class="token number">0x7ff5c6018358</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=5><td><pre> <span class="token string">'_dl_argv'</span><span class="token punctuation">:</span> <span class="token operator"><</span>cle<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>elf<span class="token punctuation">.</span>relocation<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>R_X86_64_GLOB_DAT at <span class="token number">0x7ff5c5fd2e48</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=6><td><pre> <span class="token string">'_dl_find_dso_for_object'</span><span class="token punctuation">:</span> <span class="token operator"><</span>cle<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>elf<span class="token punctuation">.</span>relocation<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>R_X86_64_JUMP_SLOT at <span class="token number">0x7ff5c6018588</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=7><td><pre> <span class="token string">'_dl_starting_up'</span><span class="token punctuation">:</span> <span class="token operator"><</span>cle<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>elf<span class="token punctuation">.</span>relocation<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>R_X86_64_GLOB_DAT at <span class="token number">0x7ff5c5fd2550</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=8><td><pre> <span class="token string">'_rtld_global'</span><span class="token punctuation">:</span> <span class="token operator"><</span>cle<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>elf<span class="token punctuation">.</span>relocation<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>R_X86_64_GLOB_DAT at <span class="token number">0x7ff5c5fce4e0</span><span class="token operator">></span><span class="token punctuation">,</span></pre><tr><td data-num=9><td><pre> <span class="token string">'_rtld_global_ro'</span><span class="token punctuation">:</span> <span class="token operator"><</span>cle<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>elf<span class="token punctuation">.</span>relocation<span class="token punctuation">.</span>amd64<span class="token punctuation">.</span>R_X86_64_GLOB_DAT at <span class="token number">0x7ff5c5fcea20</span><span class="token operator">></span><span class="token punctuation">}</span></pre></table></figure><h4 id=loading-options><a class=anchor href=#loading-options>#</a> Loading Options</h4><p>If you are loading something with <code>angr.Project</code> and you want to pass an option to the <code>cle.Loader</code> instance that Project implicitly creates, you can just pass the keyword argument directly to the Project constructor, and it will be passed on to CLE. You should look at the <a href=https://docs.angr.io/projects/cle/en/latest/api.html rel=noopener target=_blank>CLE API docs.</a> if you want to know everything that could possibly be passed in as an option, but we will go over some important and frequently used options here.<p>We’ve discussed <code>auto_load_libs</code> already - it enables or disables CLE’s attempt to automatically resolve shared library dependencies, and is on by default. Additionally, there is the opposite, <code>except_missing_libs</code> , which, if set to true, will cause an exception to be thrown whenever a binary has a shared library dependency that cannot be resolved.<p>You can pass a list of strings to <code>force_load_libs</code> and anything listed will be treated as an unresolved shared library dependency right out of the gate, or you can pass a list of strings to <code>skip_libs</code> to prevent any library of that name from being resolved as a dependency. Additionally, you can pass a list of strings (or a single string) to <code>ld_path</code> , which will be used as an additional search path for shared libraries, before any of the defaults: the same directory as the loaded program, the current working directory, and your system libraries.<p>If you want to specify some options that only apply to a specific binary object, CLE will let you do that too. The parameters <code>main_opts</code> and <code>lib_opts</code> do this by taking dictionaries of options. <code>main_opts</code> is a mapping from option names to option values, while <code>lib_opts</code> is a mapping from library name to dictionaries mapping option names to option values.<p>The options that you can use vary from backend to backend, but some common ones are:<ul><li><code>backend</code> - which backend to use, as either a class or a name<li><code>base_addr</code> - a base address to use<li><code>entry_point</code> - an entry point to use<li><code>arch</code> - the name of an architecture to use</ul><p>Example:<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'examples/fauxware/fauxware'</span><span class="token punctuation">,</span> main_opts<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'backend'</span><span class="token punctuation">:</span> <span class="token string">'blob'</span><span class="token punctuation">,</span> <span class="token string">'arch'</span><span class="token punctuation">:</span> <span class="token string">'i386'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> lib_opts<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'libc.so.6'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'backend'</span><span class="token punctuation">:</span> <span class="token string">'elf'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre><span class="token operator"><</span>Project examples<span class="token operator">/</span>fauxware<span class="token operator">/</span>fauxware<span class="token operator">></span></pre></table></figure><h4 id=symbolic-function-summaries><a class=anchor href=#symbolic-function-summaries>#</a> Symbolic Function Summaries</h4><p><a href=https://github.com/angr/angr/tree/master/angr/procedures rel=noopener target=_blank>angr/angr/procedures at master · angr/angr (github.com)</a><h4 id=hook><a class=anchor href=#hook>#</a> hook</h4><figure class="highlight wiki"><figcaption data-lang="Wiki markup"></figcaption><table><tr><td data-num=1><td><pre>The mechanism by which angr replaces library code with a Python summary is called hooking, and you can do it too! When performing simulation, at every step angr checks if the current address has been hooked, and if so, runs the hook instead of the binary code at that address. The API to let you do this is proj.hook(addr, hook), where hook is a SimProcedure instance. You can manage your project’s hooks with .is_hooked, .unhook, and .hooked_by, which should hopefully not require explanation.</pre><tr><td data-num=2><td><pre></pre><tr><td data-num=3><td><pre>There is an alternate API for hooking an address that lets you specify your own off-the-cuff function to use as a hook, by using proj.hook(addr) as a function decorator. If you do this, you can also optionally specify a length keyword argument to make execution jump some number of bytes forward after your hook finishes.</pre></table></figure><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre>stub_func <span class="token operator">=</span> angr<span class="token punctuation">.</span>SIM_PROCEDURES<span class="token punctuation">[</span><span class="token string">'stubs'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'ReturnUnconstrained'</span><span class="token punctuation">]</span> <span class="token comment"># this is a CLASS</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>hook<span class="token punctuation">(</span><span class="token number">0x10000</span><span class="token punctuation">,</span> stub_func<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># hook with an instance of the class</span></pre><tr><td data-num=3><td><pre></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>is_hooked<span class="token punctuation">(</span><span class="token number">0x10000</span><span class="token punctuation">)</span>            <span class="token comment"># these functions should be pretty self-explanitory</span></pre><tr><td data-num=5><td><pre><span class="token boolean">True</span></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>hooked_by<span class="token punctuation">(</span><span class="token number">0x10000</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre><span class="token operator"><</span>ReturnUnconstrained<span class="token operator">></span></pre><tr><td data-num=8><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>unhook<span class="token punctuation">(</span><span class="token number">0x10000</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre></pre><tr><td data-num=10><td><pre><span class="token operator">>></span><span class="token operator">></span> @proj<span class="token punctuation">.</span>hook<span class="token punctuation">(</span><span class="token number">0x20000</span><span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">def</span> <span class="token function">my_hook</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=12><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">1</span></pre><tr><td data-num=13><td><pre></pre><tr><td data-num=14><td><pre><span class="token operator">>></span><span class="token operator">></span> proj<span class="token punctuation">.</span>is_hooked<span class="token punctuation">(</span><span class="token number">0x20000</span><span class="token punctuation">)</span></pre><tr><td data-num=15><td><pre><span class="token boolean">True</span></pre></table></figure><p>可以尝试<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre>state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre></pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre><span class="token decorator annotation punctuation">@proj<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span>proj<span class="token punctuation">.</span>entry<span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre><span class="token keyword">def</span> <span class="token function">my_hook</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=8><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'startttttttt!!!!!!!!'</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre></pre><tr><td data-num=10><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>state<span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre>simgr<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre></pre><tr><td data-num=13><td><pre><span class="token comment"># startttttttt!!!!!!!!</span></pre></table></figure><p>然后可以进行 hook 修改寄存器等操作<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre>state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simulation_manager<span class="token punctuation">(</span>state<span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>active<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre><span class="token decorator annotation punctuation">@proj<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span>proj<span class="token punctuation">.</span>entry<span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre><span class="token keyword">def</span> <span class="token function">my_hook</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=9><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'startttttttt!!!!!!!!'</span><span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre>    simgr<span class="token punctuation">.</span>active<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0x1111</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>active<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre>    </pre><tr><td data-num=13><td><pre>simgr<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=14><td><pre></pre><tr><td data-num=15><td><pre><span class="token triple-quoted-string string">"""</span></pre><tr><td data-num=16><td><pre>&LTBV32 0x1c></pre><tr><td data-num=17><td><pre>startttttttt!!!!!!!!</pre><tr><td data-num=18><td><pre>&LTBV32 0x1111></pre><tr><td data-num=19><td><pre>"""</pre></table></figure><h3 id=符号样例><a class=anchor href=#符号样例>#</a> 符号样例</h3><h4 id=bitvectors><a class=anchor href=#bitvectors>#</a> Bitvectors</h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> one <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> one</pre><tr><td data-num=3><td><pre> <span class="token operator"><</span>BV64 <span class="token number">0x1</span><span class="token operator">></span></pre><tr><td data-num=4><td><pre><span class="token comment"># Create a bitvector symbol named "x" of length 64 bits</span></pre><tr><td data-num=5><td><pre><span class="token operator">>></span><span class="token operator">></span> x <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> x</pre><tr><td data-num=7><td><pre><span class="token operator"><</span>BV64 x_9_64<span class="token operator">></span></pre><tr><td data-num=8><td><pre><span class="token operator">>></span><span class="token operator">></span> y <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">"y"</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre><span class="token operator">>></span><span class="token operator">></span> y</pre><tr><td data-num=10><td><pre><span class="token operator"><</span>BV64 y_10_64<span class="token operator">></span></pre><tr><td data-num=11><td><pre></pre><tr><td data-num=12><td><pre><span class="token operator">>></span><span class="token operator">></span> x <span class="token operator">+</span> one</pre><tr><td data-num=13><td><pre><span class="token operator"><</span>BV64 x_9_64 <span class="token operator">+</span> <span class="token number">0x1</span><span class="token operator">></span></pre><tr><td data-num=14><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span>x <span class="token operator">+</span> one<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span></pre><tr><td data-num=15><td><pre><span class="token operator"><</span>BV64 <span class="token punctuation">(</span>x_9_64 <span class="token operator">+</span> <span class="token number">0x1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0x2</span><span class="token operator">></span></pre><tr><td data-num=16><td><pre><span class="token operator">>></span><span class="token operator">></span> x <span class="token operator">-</span> y</pre><tr><td data-num=17><td><pre><span class="token operator"><</span>BV64 x_9_64 <span class="token operator">-</span> y_10_64<span class="token operator">></span></pre></table></figure><p>可以通过 ASTs 分析<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> tree <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> tree</pre><tr><td data-num=3><td><pre><span class="token operator"><</span>BV64 <span class="token punctuation">(</span>x_9_64 <span class="token operator">+</span> <span class="token number">0x1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>y_10_64 <span class="token operator">+</span> <span class="token number">0x2</span><span class="token punctuation">)</span><span class="token operator">></span></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> tree<span class="token punctuation">.</span>op</pre><tr><td data-num=5><td><pre><span class="token string">'__floordiv__'</span></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> tree<span class="token punctuation">.</span>args</pre><tr><td data-num=7><td><pre><span class="token punctuation">(</span><span class="token operator"><</span>BV64 x_9_64 <span class="token operator">+</span> <span class="token number">0x1</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator"><</span>BV64 y_10_64 <span class="token operator">+</span> <span class="token number">0x2</span><span class="token operator">></span><span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre><span class="token operator">>></span><span class="token operator">></span> tree<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>op</pre><tr><td data-num=9><td><pre><span class="token string">'__add__'</span></pre><tr><td data-num=10><td><pre><span class="token operator">>></span><span class="token operator">></span> tree<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args</pre><tr><td data-num=11><td><pre><span class="token punctuation">(</span><span class="token operator"><</span>BV64 x_9_64<span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator"><</span>BV64 <span class="token number">0x1</span><span class="token operator">></span><span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre><span class="token operator">>></span><span class="token operator">></span> tree<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>op</pre><tr><td data-num=13><td><pre><span class="token string">'BVV'</span></pre><tr><td data-num=14><td><pre><span class="token operator">>></span><span class="token operator">></span> tree<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>args</pre><tr><td data-num=15><td><pre><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></pre></table></figure><h4 id=symbolic-constraints><a class=anchor href=#symbolic-constraints>#</a> Symbolic Constraints</h4><p>Performing comparison operations between any two similarly-typed ASTs will yield another AST - not a bitvector, but now a symbolic boolean.<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> x <span class="token operator">==</span> <span class="token number">1</span></pre><tr><td data-num=2><td><pre><span class="token operator"><</span>Bool x_9_64 <span class="token operator">==</span> <span class="token number">0x1</span><span class="token operator">></span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> x <span class="token operator">==</span> one</pre><tr><td data-num=4><td><pre><span class="token operator"><</span>Bool x_9_64 <span class="token operator">==</span> <span class="token number">0x1</span><span class="token operator">></span></pre><tr><td data-num=5><td><pre><span class="token operator">>></span><span class="token operator">></span> x <span class="token operator">></span> <span class="token number">2</span></pre><tr><td data-num=6><td><pre><span class="token operator"><</span>Bool x_9_64 <span class="token operator">></span> <span class="token number">0x2</span><span class="token operator">></span></pre><tr><td data-num=7><td><pre><span class="token operator">>></span><span class="token operator">></span> x <span class="token operator">+</span> y <span class="token operator">==</span> one_hundred <span class="token operator">+</span> <span class="token number">5</span></pre><tr><td data-num=8><td><pre><span class="token operator"><</span>Bool <span class="token punctuation">(</span>x_9_64 <span class="token operator">+</span> y_10_64<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x69</span><span class="token operator">></span></pre><tr><td data-num=9><td><pre><span class="token operator">>></span><span class="token operator">></span> one_hundred <span class="token operator">></span> <span class="token number">5</span></pre><tr><td data-num=10><td><pre><span class="token operator"><</span>Bool <span class="token boolean">True</span><span class="token operator">></span></pre><tr><td data-num=11><td><pre><span class="token operator">>></span><span class="token operator">></span> one_hundred <span class="token operator">></span> <span class="token operator">-</span><span class="token number">5</span> <span class="token comment"># One tidbit you can see from this is that the comparisons are unsigned by default. The -5 in the last example is coerced to &LTBV64 0xfffffffffffffffb>, which is definitely not less than one hundred. </span></pre><tr><td data-num=12><td><pre><span class="token comment"># signed : one_hundred.SGT(-5)</span></pre><tr><td data-num=13><td><pre><span class="token operator"><</span>Bool <span class="token boolean">False</span><span class="token operator">></span></pre></table></figure><p>判断<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre>yes <span class="token operator">=</span> one <span class="token operator">==</span> <span class="token number">1</span></pre><tr><td data-num=2><td><pre>no <span class="token operator">=</span> one <span class="token operator">==</span> <span class="token number">2</span></pre><tr><td data-num=3><td><pre>maybe <span class="token operator">=</span> x <span class="token operator">==</span> y</pre><tr><td data-num=4><td><pre>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>is_true<span class="token punctuation">(</span>yes<span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre><span class="token boolean">True</span></pre><tr><td data-num=6><td><pre>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>is_false<span class="token punctuation">(</span>yes<span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre><span class="token boolean">False</span></pre><tr><td data-num=8><td><pre>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>is_true<span class="token punctuation">(</span>no<span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre><span class="token boolean">False</span></pre><tr><td data-num=10><td><pre>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>is_false<span class="token punctuation">(</span>no<span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre><span class="token boolean">True</span></pre><tr><td data-num=12><td><pre>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>is_true<span class="token punctuation">(</span>maybe<span class="token punctuation">)</span></pre><tr><td data-num=13><td><pre><span class="token boolean">False</span></pre><tr><td data-num=14><td><pre>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>is_false<span class="token punctuation">(</span>maybe<span class="token punctuation">)</span></pre><tr><td data-num=15><td><pre><span class="token boolean">False</span></pre></table></figure><h4 id=constraint-solving><a class=anchor href=#constraint-solving>#</a> Constraint Solving</h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>x <span class="token operator">></span> y<span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>y <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">></span> x<span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre><span class="token number">4</span> <span class="token comment"># result might vary</span></pre></table></figure><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># get a fresh state without constraints</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">input</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> operation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">input</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">input</span></pre><tr><td data-num=5><td><pre><span class="token operator">>></span><span class="token operator">></span> output <span class="token operator">=</span> <span class="token number">200</span></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>operation <span class="token operator">==</span> output<span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre><span class="token number">0x3333333333333381</span></pre><tr><td data-num=9><td><pre></pre><tr><td data-num=10><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">input</span> <span class="token operator"><</span> <span class="token number">2</span><span class="token operator">**</span><span class="token number">32</span><span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>satisfiable<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre><span class="token boolean">False</span></pre></table></figure><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># fresh state</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>x <span class="token operator">-</span> y <span class="token operator">>=</span> <span class="token number">4</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>add<span class="token punctuation">(</span>y <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre><span class="token number">5</span></pre><tr><td data-num=7><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre><span class="token number">1</span></pre><tr><td data-num=9><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>x <span class="token operator">+</span> y<span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre><span class="token number">6</span></pre></table></figure><h4 id=floating-point-numbers><a class=anchor href=#floating-point-numbers>#</a> Floating point numbers</h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># fresh state</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>FPV<span class="token punctuation">(</span><span class="token number">3.2</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>fp<span class="token punctuation">.</span>FSORT_DOUBLE<span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> a</pre><tr><td data-num=5><td><pre><span class="token operator"><</span>FP64 FPV<span class="token punctuation">(</span><span class="token number">3.2</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token operator">></span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>FPS<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>fp<span class="token punctuation">.</span>FSORT_DOUBLE<span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre><span class="token operator">>></span><span class="token operator">></span> b</pre><tr><td data-num=9><td><pre><span class="token operator"><</span>FP64 FPS<span class="token punctuation">(</span><span class="token string">'FP_b_0_64'</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token operator">></span></pre><tr><td data-num=10><td><pre></pre><tr><td data-num=11><td><pre><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">+</span> b</pre><tr><td data-num=12><td><pre><span class="token operator"><</span>FP64 fpAdd<span class="token punctuation">(</span><span class="token string">'RNE'</span><span class="token punctuation">,</span> FPV<span class="token punctuation">(</span><span class="token number">3.2</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token punctuation">,</span> FPS<span class="token punctuation">(</span><span class="token string">'FP_b_0_64'</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">></span></pre><tr><td data-num=13><td><pre></pre><tr><td data-num=14><td><pre><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">+</span> <span class="token number">4.4</span></pre><tr><td data-num=15><td><pre><span class="token operator"><</span>FP64 FPV<span class="token punctuation">(</span><span class="token number">7.6000000000000005</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token operator">></span></pre><tr><td data-num=16><td><pre></pre><tr><td data-num=17><td><pre><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator"><</span> <span class="token number">0</span></pre><tr><td data-num=18><td><pre><span class="token operator"><</span>Bool fpLT<span class="token punctuation">(</span>fpAdd<span class="token punctuation">(</span><span class="token string">'RNE'</span><span class="token punctuation">,</span> FPS<span class="token punctuation">(</span><span class="token string">'FP_b_0_64'</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token punctuation">,</span> FPV<span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FPV<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">></span></pre></table></figure><p>This is nice, but sometimes we need to be able to work directly with the representation of the float as a bitvector. You can interpret bitvectors as floats and vice versa, with the methods <code>raw_to_bv</code> and <code>raw_to_fp</code> :<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>raw_to_bv<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre><span class="token operator"><</span>BV64 <span class="token number">0x400999999999999a</span><span class="token operator">></span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> b<span class="token punctuation">.</span>raw_to_bv<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token operator"><</span>BV64 fpToIEEEBV<span class="token punctuation">(</span>FPS<span class="token punctuation">(</span><span class="token string">'FP_b_0_64'</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">></span></pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">.</span>raw_to_fp<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre><span class="token operator"><</span>FP64 FPV<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token operator">></span></pre><tr><td data-num=8><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">.</span>raw_to_fp<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre><span class="token operator"><</span>FP64 fpToFP<span class="token punctuation">(</span>x_1_64<span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token operator">></span></pre></table></figure><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> a</pre><tr><td data-num=2><td><pre><span class="token operator"><</span>FP64 FPV<span class="token punctuation">(</span><span class="token number">3.2</span><span class="token punctuation">,</span> DOUBLE<span class="token punctuation">)</span><span class="token operator">></span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>val_to_bv<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token operator"><</span>BV12 <span class="token number">0x3</span><span class="token operator">></span></pre><tr><td data-num=5><td><pre><span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>val_to_bv<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">.</span>val_to_fp<span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>fp<span class="token punctuation">.</span>FSORT_FLOAT<span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre><span class="token operator"><</span>FP32 FPV<span class="token punctuation">(</span><span class="token number">3.0</span><span class="token punctuation">,</span> FLOAT<span class="token punctuation">)</span><span class="token operator">></span></pre></table></figure><h4 id=more-solving-methods><a class=anchor href=#more-solving-methods>#</a> More Solving Methods</h4><p><code>eval</code> will give you one possible solution to an expression, but what if you want several? What if you want to ensure that the solution is unique? The solver provides you with several methods for common solving patterns:<ul><li><code>solver.eval(expression)</code> will give you one possible solution to the given expression.<li><code>solver.eval_one(expression)</code> will give you the solution to the given expression, or throw an error if more than one solution is possible.<li><code>solver.eval_upto(expression, n)</code> will give you up to n solutions to the given expression, returning fewer than n if fewer than n are possible.<li><code>solver.eval_atleast(expression, n)</code> will give you n solutions to the given expression, throwing an error if fewer than n are possible.<li><code>solver.eval_exact(expression, n)</code> will give you n solutions to the given expression, throwing an error if fewer or more than are possible.<li><code>solver.min(expression)</code> will give you the minimum possible solution to the given expression.<li><code>solver.max(expression)</code> will give you the maximum possible solution to the given expression.</ul><p>Additionally, all of these methods can take the following keyword arguments:<ul><li><code>extra_constraints</code> can be passed as a tuple of constraints. These constraints will be taken into account for this evaluation, but will not be added to the state.<li><code>cast_to</code> can be passed a data type to cast the result to. Currently, this can only be <code>int</code> and <code>bytes</code> , which will cause the method to return the corresponding representation of the underlying data. For example, <code>state.solver.eval(state.solver.BVV(0x41424344, 32), cast_to=bytes)</code> will return <code>b'ABCD'</code> .</ul><h3 id=machine-state-memory-registers-and-so-on><a class=anchor href=#machine-state-memory-registers-and-so-on>#</a> Machine State - memory, registers, and so on</h3><p>quick examples:<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> angr<span class="token punctuation">,</span> claripy</pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'/bin/true'</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre></pre><tr><td data-num=5><td><pre><span class="token comment"># copy rsp to rbp</span></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rbp <span class="token operator">=</span> state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rsp</pre><tr><td data-num=7><td><pre></pre><tr><td data-num=8><td><pre><span class="token comment"># store rdx to memory at 0x1000</span></pre><tr><td data-num=9><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>mem<span class="token punctuation">[</span><span class="token number">0x1000</span><span class="token punctuation">]</span><span class="token punctuation">.</span>uint64_t <span class="token operator">=</span> state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rdx</pre><tr><td data-num=10><td><pre></pre><tr><td data-num=11><td><pre><span class="token comment"># dereference rbp</span></pre><tr><td data-num=12><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rbp <span class="token operator">=</span> state<span class="token punctuation">.</span>mem<span class="token punctuation">[</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rbp<span class="token punctuation">]</span><span class="token punctuation">.</span>uint64_t<span class="token punctuation">.</span>resolved</pre><tr><td data-num=13><td><pre></pre><tr><td data-num=14><td><pre><span class="token comment"># add rax, qword ptr [rsp + 8]</span></pre><tr><td data-num=15><td><pre><span class="token operator">>></span><span class="token operator">></span> state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rax <span class="token operator">+=</span> state<span class="token punctuation">.</span>mem<span class="token punctuation">[</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rsp <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span>uint64_t<span class="token punctuation">.</span>resolved</pre></table></figure><p>这里开始使用更简单的执行方法： <code>state.step()</code> ，其会进行一步符号执行并且返回名为<a href=https://docs.angr.io/en/latest/api.html#angr.engines.successors.SimSuccessors rel=noopener target=_blank> <code>angr.engines.successors.SimSuccessors</code> </a> 的对象，并且会提供若干可以被分类成不同执行路径的继承状态，关注该对象的 <code>.successors</code> 属性，其是一个包含所有 “normal” successors of a given step 的 list。<p>该 list 会包含所有 constraint 的正误状态作为新的 constraint<p>(这里的 example 应该是用一个 strcmp 作为 constraint)<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'examples/fauxware/fauxware'</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span>stdin<span class="token operator">=</span>angr<span class="token punctuation">.</span>SimFile<span class="token punctuation">)</span>  <span class="token comment"># ignore that argument for now - we're disabling a more complicated default setup for the sake of education</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></pre><tr><td data-num=4><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     succ <span class="token operator">=</span> state<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>succ<span class="token punctuation">.</span>successors<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span></pre><tr><td data-num=6><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">break</span></pre><tr><td data-num=7><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     state <span class="token operator">=</span> succ<span class="token punctuation">.</span>successors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre><span class="token operator">>></span><span class="token operator">></span> state1<span class="token punctuation">,</span> state2 <span class="token operator">=</span> succ<span class="token punctuation">.</span>successors</pre><tr><td data-num=10><td><pre><span class="token operator">>></span><span class="token operator">></span> state1</pre><tr><td data-num=11><td><pre><span class="token operator"><</span>SimState @ <span class="token number">0x400629</span><span class="token operator">></span></pre><tr><td data-num=12><td><pre><span class="token operator">>></span><span class="token operator">></span> state2</pre><tr><td data-num=13><td><pre><span class="token operator"><</span>SimState @ <span class="token number">0x400699</span><span class="token operator">></span></pre></table></figure><p>可以 use <code>state.posix.stdin.load(0, state.posix.stdin.size)</code> to retrieve a bitvector representing all the content read from stdin so far<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> input_data <span class="token operator">=</span> state1<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> state1<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>size<span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> state1<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>input_data<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token string">b'\x00\x00\x00\x00\x00\x00\x00\x00\x00SOSNEAKY\x00\x00\x00'</span></pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> state2<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>input_data<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre><span class="token string">b'\x00\x00\x00\x00\x00\x00\x00\x00\x00S\x00\x80N\x00\x00 \x00\x00\x00\x00'</span></pre></table></figure><h4 id=state-presets><a class=anchor href=#state-presets>#</a> State Presets</h4><p><code>project.factory.</code><ul><li><code>.blank_state()</code> constructs a “blank slate” blank state, with most of its data left uninitialized. When accessing uninitialized data, an unconstrained symbolic value will be returned.<li><code>.entry_state()</code> constructs a state ready to execute at the main binary’s entry point.<li><code>.full_init_state()</code> constructs a state that is ready to execute through any initializers that need to be run before the main binary’s entry point, for example, shared library constructors or preinitializers. When it is finished with these it will jump to the entry point.<li><code>.call_state()</code> constructs a state ready to execute a given function.</ul><p>使用方法：<ul><li>传入起始地址：</ul><p>​ All of these constructors can take an <code>addr</code> argument to specify the exact address to start.<ul><li>传入参数：</ul><p>​ If you’re executing in an environment that can take command line arguments or an environment, you can pass a list of arguments through <code>args</code> and a dictionary of environment variables through <code>env</code> into <code>entry_state</code> and <code>full_init_state</code> . The values in these structures can be strings or bitvectors, and will be serialized into the state as the arguments and environment to the simulated execution. The default <code>args</code> is an empty list, so if the program you’re analyzing expects to find at least an <code>argv[0]</code> , you should always provide that!<ul><li>可以传入符号</ul><p>​ If you’d like to have <code>argc</code> be symbolic, you can pass a symbolic bitvector as <code>argc</code> to the <code>entry_state</code> and <code>full_init_state</code> constructors. Be careful, though: if you do this, you should also add a constraint to the resulting state that your value for argc cannot be larger than the number of args you passed into <code>args</code> .<ul><li>传入函数参数</ul><p>​ To use the call state, you should call it with <code>.call_state(addr, arg1, arg2, ...)</code> , where <code>addr</code> is the address of the function you want to call and <code>argN</code> is the Nth argument to that function, either as a Python integer, string, or array, or a bitvector. If you want to have memory allocated and actually pass in a pointer to an object, you should wrap it in an PointerWrapper, i.e. <code>angr.PointerWrapper("point to me!")</code> . The results of this API can be a little unpredictable, but we’re working on it.<p>​ To specify the calling convention used for a function with <code>call_state</code> , you can pass a <a href=https://docs.angr.io/en/latest/api.html#angr.calling_conventions.SimCC rel=noopener target=_blank> <code>SimCC</code> </a> instance as the <code>cc</code> argument.:raw-html-m2r: We try to pick a sane default, but for special cases you will need to help angr out.<h4 id=对内存操作><a class=anchor href=#对内存操作>#</a> 对内存操作</h4><p>对内存地址批量操作<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span><span class="token number">0x4000</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>solver<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0x0123456789abcdef0123456789abcdef</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token number">0x4004</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment"># load-size is in bytes</span></pre><tr><td data-num=4><td><pre><span class="token operator"><</span>BV48 <span class="token number">0x89abcdef0123</span><span class="token operator">></span></pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> archinfo</pre><tr><td data-num=7><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token number">0x4000</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> endness<span class="token operator">=</span>archinfo<span class="token punctuation">.</span>Endness<span class="token punctuation">.</span>LE<span class="token punctuation">)</span> <span class="token comment"># 小端序存储</span></pre><tr><td data-num=8><td><pre><span class="token operator"><</span>BV32 <span class="token number">0x67452301</span><span class="token operator">></span></pre></table></figure><h4 id=对寄存器操作><a class=anchor href=#对寄存器操作>#</a> 对寄存器操作</h4><p><code>state.registers</code> ： <a href=https://docs.angr.io/en/latest/advanced-topics/ir.html#intermediate-representation rel=noopener target=_blank>Intermediate Representation - angr documentation</a><p><a href=https://github.com/angr/archinfo rel=noopener target=_blank>angr/archinfo: Classes with architecture-specific information useful to other projects. (github.com)</a><h4 id=state-options><a class=anchor href=#state-options>#</a> State Options</h4><p><a href=https://docs.angr.io/en/latest/appendix/options.html#list-of-state-options rel=noopener target=_blank>https://docs.angr.io/en/latest/appendix/options.html#list-of-state-options</a><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># Example: enable lazy solves, an option that causes state satisfiability to be checked as infrequently as possible.</span></pre><tr><td data-num=2><td><pre><span class="token comment"># This change to the settings will be propagated to all successor states created from this state after this line.</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>options<span class="token punctuation">.</span>add<span class="token punctuation">(</span>angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>LAZY_SOLVES<span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre></pre><tr><td data-num=5><td><pre><span class="token comment"># Create a new state with lazy solves enabled</span></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span>add_options<span class="token operator">=</span><span class="token punctuation">{</span>angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>LAZY_SOLVES<span class="token punctuation">}</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre></pre><tr><td data-num=8><td><pre><span class="token comment"># Create a new state without simplification options enabled</span></pre><tr><td data-num=9><td><pre><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span>remove_options<span class="token operator">=</span>angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>simplification<span class="token punctuation">)</span></pre></table></figure><h3 id=plugins><a class=anchor href=#plugins>#</a> Plugins</h3><h4 id=state-plugins><a class=anchor href=#state-plugins>#</a> State Plugins</h4><p><a href=https://docs.angr.io/en/latest/extending-angr/state_plugins.html#state-plugins rel=noopener target=_blank>implement new kinds of data storage</a><p>For example, the normal <code>memory</code> plugin simulates a flat memory space, but analyses can choose to enable the “abstract memory” plugin, which uses alternate data types for addresses to simulate free-floating memory mappings independent of address, to provide <code>state.memory</code> . Conversely, plugins can reduce code complexity: <code>state.memory</code> and <code>state.registers</code> are actually two different instances of the same plugin, since the registers are emulated with an address space as well.<h4 id=the-globals-plugin><a class=anchor href=#the-globals-plugin>#</a> The globals plugin</h4><p><code>state.globals</code> is an extremely simple plugin: it implements the interface of a standard Python dict, allowing you to store arbitrary data on a state.<h4 id=the-history-plugin><a class=anchor href=#the-history-plugin>#</a> The history plugin</h4><p><code>state.history</code> is a very important plugin storing historical data about the path a state has taken during execution. It is actually a linked list of several history nodes, each one representing a single round of execution—you can traverse this list with <code>state.history.parent.parent</code> etc.<p>To make it more convenient to work with this structure, the history also provides several efficient iterators over the history of certain values. In general, these values are stored as <code>history.recent_NAME</code> and the iterator over them is just <code>history.NAME</code> . For example, <code>for addr in state.history.bbl_addrs: print hex(addr)</code> will print out a basic block address trace for the binary, while <code>state.history.recent_bbl_addrs</code> is the list of basic blocks executed in the most recent step, <code>state.history.parent.recent_bbl_addrs</code> is the list of basic blocks executed in the previous step, etc. If you ever need to quickly obtain a flat list of these values, you can access <code>.hardcopy</code> , e.g. <code>state.history.bbl_addrs.hardcopy</code> . Keep in mind though, index-based accessing is implemented on the iterators.<p>Here is a brief listing of some of the values stored in the history:<ul><li><code>history.descriptions</code> is a listing of string descriptions of each of the rounds of execution performed on the state.<li><code>history.bbl_addrs</code> is a listing of the basic block addresses executed by the state. There may be more than one per round of execution, and not all addresses may correspond to binary code - some may be addresses at which SimProcedures are hooked.<li><code>history.jumpkinds</code> is a listing of the disposition of each of the control flow transitions in the state’s history, as VEX enum strings.<li><code>history.jump_guards</code> is a listing of the conditions guarding each of the branches that the state has encountered.<li><code>history.events</code> is a semantic listing of “interesting events” which happened during execution, such as the presence of a symbolic jump condition, the program popping up a message box, or execution terminating with an exit code.<li><code>history.actions</code> is usually empty, but if you add the <code>angr.options.refs</code> options to the state, it will be populated with a log of all the memory, register, and temporary value accesses performed by the program.</ul><h4 id=the-callstack-plugin><a class=anchor href=#the-callstack-plugin>#</a> The callstack plugin</h4><p>angr will track the call stack for the emulated program. On every call instruction, a frame will be added to the top of the tracked callstack, and whenever the stack pointer drops below the point where the topmost frame was called, a frame is popped. This allows angr to robustly store data local to the current emulated function.<p>Similar to the history, the callstack is also a linked list of nodes, but there are no provided iterators over the contents of the nodes - instead you can directly iterate over <code>state.callstack</code> to get the callstack frames for each of the active frames, in order from most recent to oldest. If you just want the topmost frame, this is <code>state.callstack</code> .<ul><li><code>callstack.func_addr</code> is the address of the function currently being executed<li><code>callstack.call_site_addr</code> is the address of the basic block which called the current function<li><code>callstack.stack_ptr</code> is the value of the stack pointer from the beginning of the current function<li><code>callstack.ret_addr</code> is the location that the current function will return to if it returns</ul><h4 id=io><a class=anchor href=#io>#</a> I/O</h4><p><a href=https://docs.angr.io/en/latest/advanced-topics/file_system.html#working-with-file-system-sockets-and-pipes rel=noopener target=_blank>Working with File System, Sockets, and Pipes</a><h4 id=copying-and-merging><a class=anchor href=#copying-and-merging>#</a> Copying and Merging</h4><p>A state supports very fast copies, so that you can explore different possibilities:<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'/bin/true'</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> s1 <span class="token operator">=</span> s<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> s2 <span class="token operator">=</span> s<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> s1<span class="token punctuation">.</span>mem<span class="token punctuation">[</span><span class="token number">0x1000</span><span class="token punctuation">]</span><span class="token punctuation">.</span>uint32_t <span class="token operator">=</span> <span class="token number">0x41414141</span></pre><tr><td data-num=7><td><pre><span class="token operator">>></span><span class="token operator">></span> s2<span class="token punctuation">.</span>mem<span class="token punctuation">[</span><span class="token number">0x1000</span><span class="token punctuation">]</span><span class="token punctuation">.</span>uint32_t <span class="token operator">=</span> <span class="token number">0x42424242</span></pre></table></figure><p>States can also be merged together.<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># merge will return a tuple. the first element is the merged state</span></pre><tr><td data-num=2><td><pre><span class="token comment"># the second element is a symbolic variable describing a state flag</span></pre><tr><td data-num=3><td><pre><span class="token comment"># the third element is a boolean describing whether any merging was done</span></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span>s_merged<span class="token punctuation">,</span> m<span class="token punctuation">,</span> anything_merged<span class="token punctuation">)</span> <span class="token operator">=</span> s1<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>s2<span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre><span class="token comment"># this is now an expression that can resolve to "AAAA" *or* "BBBB"</span></pre><tr><td data-num=7><td><pre><span class="token operator">>></span><span class="token operator">></span> aaaa_or_bbbb <span class="token operator">=</span> s_merged<span class="token punctuation">.</span>mem<span class="token punctuation">[</span><span class="token number">0x1000</span><span class="token punctuation">]</span><span class="token punctuation">.</span>uint32_t</pre><tr><td data-num=8><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>aaaa_or_bbbb<span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre><span class="token comment"># 打印该地址可能的数值集合</span></pre><tr><td data-num=10><td><pre><span class="token comment"># &LTuint32_t &LTBV32 (if state_merge_0_0_16 == 0x1 then 66 else (if state_merge_0_0_16 == 0x0 then 65 else 0)) .. (if state_merge_0_0_16 == 0x1 then 66 else (if state_merge_0_0_16 == 0x0 then 65 else 0)) .. (if state_merge_0_0_16 == 0x1 then 66 else (if state_merge_0_0_16 == 0x0 then 65 else 0)) .. (if state_merge_0_0_16 == 0x1 then 66 else (if state_merge_0_0_16 == 0x0 then 65 else 0))> at 0x1000></span></pre></table></figure><h3 id=simulation-managers><a class=anchor href=#simulation-managers>#</a> Simulation Managers</h3><p>描述：<pre><code>Simulation managers let you wrangle multiple states in a slick way. States are organized into “stashes”, which you can step forward, filter, merge, and move around as you wish.
</code></pre><h4 id=stepping><a class=anchor href=#stepping>#</a> Stepping</h4><p><code>.step()</code> ： 前进一个 basic block<p><code>.run()</code> ：执行到所有 deadended，并且获得所有 deadended states（例如到达 exit syscall，此时该 state 会被从 <code>active stash</code> 中移除并放入 <code>deadended states</code> ）<h4 id=stash-management><a class=anchor href=#stash-management>#</a> Stash Management</h4><p><code>.move()</code> ： <code>from_stash</code> <code>to_stash</code> <code>filter_func (optional, default:everything)</code><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># eg. 检查所有执行路径已终止（deadended）的状态，查找其中在程序的标准输出中打印了 'Welcome' 的状态，并将这些状态移动到一个名为 'authenticated' 的新 stash，以便进一步分析或单独处理。</span></pre><tr><td data-num=2><td><pre>simgr<span class="token punctuation">.</span>move<span class="token punctuation">(</span>from_stash<span class="token operator">=</span><span class="token string">'deadended'</span><span class="token punctuation">,</span> to_stash<span class="token operator">=</span><span class="token string">'authenticated'</span><span class="token punctuation">,</span> filter_func<span class="token operator">=</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> <span class="token string">b'Welcome'</span> <span class="token keyword">in</span> s<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> simgr</pre><tr><td data-num=4><td><pre><span class="token operator"><</span>SimulationManager <span class="token keyword">with</span> <span class="token number">2</span> authenticated<span class="token punctuation">,</span> <span class="token number">1</span> deadended<span class="token operator">></span></pre></table></figure><p>stash 的类型为 list，可以通过如下方式访问：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">for</span> s <span class="token keyword">in</span> simgr<span class="token punctuation">.</span>deadended <span class="token operator">+</span> simgr<span class="token punctuation">.</span>authenticated<span class="token punctuation">:</span></pre><tr><td data-num=2><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token number">0x1000030</span></pre><tr><td data-num=4><td><pre><span class="token number">0x1000078</span></pre><tr><td data-num=5><td><pre><span class="token number">0x1000078</span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre><span class="token operator">>></span><span class="token operator">></span> simgr<span class="token punctuation">.</span>one_deadended</pre><tr><td data-num=8><td><pre><span class="token operator"><</span>SimState @ <span class="token number">0x1000030</span><span class="token operator">></span></pre><tr><td data-num=9><td><pre><span class="token operator">>></span><span class="token operator">></span> simgr<span class="token punctuation">.</span>mp_authenticated</pre><tr><td data-num=10><td><pre>MP<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator"><</span>SimState @ <span class="token number">0x1000078</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator"><</span>SimState @ <span class="token number">0x1000078</span><span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre><span class="token operator">>></span><span class="token operator">></span> simgr<span class="token punctuation">.</span>mp_authenticated<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre>MP<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'\x00\x00\x00\x00\x00\x00\x00\x00\x00SOSNEAKY\x00'</span><span class="token punctuation">,</span></pre><tr><td data-num=13><td><pre>    <span class="token string">'\x00\x00\x00\x00\x00\x00\x00\x00\x00S\x80\x80\x80\x80@\x80@\x00'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></table></figure><p>所以 link 呢<p><img alt=image-20231024140622184 data-src=angr%E5%88%9D%E6%8E%A2/image-20231024140622184-16981317543812.png loading=lazy><h4 id=stash-types><a class=anchor href=#stash-types>#</a> Stash types</h4><table><thead><tr><th>Stash<th>Description<tbody><tr><td>active<td>This stash contains the states that will be stepped by default, unless an alternate stash is specified.<tr><td>deadended<td>A state goes to the deadended stash when it cannot continue the execution for some reason, including no more valid instructions, unsat state of all of its successors, or an invalid instruction pointer.<tr><td>pruned<td>When using <code>LAZY_SOLVES</code> , states are not checked for satisfiability unless absolutely necessary. When a state is found to be unsat in the presence of <code>LAZY_SOLVES</code> , the state hierarchy is traversed to identify when, in its history, it initially became unsat. All states that are descendants of that point (which will also be unsat, since a state cannot become un-unsat) are pruned and put in this stash.<tr><td>unconstrained<td>If the <code>save_unconstrained</code> option is provided to the SimulationManager constructor, states that are determined to be unconstrained (i.e., with the instruction pointer controlled by user data or some other source of symbolic data) are placed here.<tr><td>unsat<td>If the <code>save_unsat</code> option is provided to the SimulationManager constructor, states that are determined to be unsatisfiable (i.e., they have constraints that are contradictory, like the input having to be both “AAAA” and “BBBB” at the same time) are placed here.<tr><td>errored<td>If, during execution, an error is raised, then the state will be wrapped in an <code>ErrorRecord</code> object, which contains the state and the error it raised, and then the record will be inserted into <code>errored</code> . launch a debug shell at the site of the error with <code>record.debug()</code> .</table><h3 id=exploration><a class=anchor href=#exploration>#</a> Exploration</h3><p><code>.explore()</code> ： <code>find</code> argument (指令的结束地址或结束地址列表，或函数根据某种标准的返回状态)<p>当满足后，放入 <code>found</code> stash，然后结束符号执行，可以同样声明 <code>avoid</code> condition（格式与 <code>find</code> 相同）<p><code>num_find</code> 指定 return 前找到多少数量的 <code>find</code> （default = 1，如果所有 active stash 的 state 被全部执行则同样 return）<p>eg.<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'examples/CSCI-4968-MBE/challenges/crackme0x00a/crackme0x00a'</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> <span class="token string">b"Congrats"</span> <span class="token keyword">in</span> s<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre>s <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=5><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre><span class="token comment"># Enter password: Congrats!</span></pre><tr><td data-num=7><td><pre>flag <span class="token operator">=</span> s<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre><span class="token comment"># g00dJ0B!</span></pre></table></figure><p>其他样例：<a href=https://docs.angr.io/en/latest/examples.html#angr-examples rel=noopener target=_blank>angr examples - angr documentation</a><h3 id=exploration-techniques><a class=anchor href=#exploration-techniques>#</a> Exploration Techniques</h3><p>angr ships with several pieces of canned functionality that let you customize the behavior of a simulation manager, called <em>exploration techniques</em>. The archetypical example of why you would want an exploration technique is to modify the pattern in which the state space of the program is explored - the default “step everything at once” strategy is effectively breadth-first search, but with an exploration technique you could implement, for example, depth-first search. However, the instrumentation power of these techniques is much more flexible than that - you can totally alter the behavior of angr’s stepping process. Writing your own exploration techniques will be covered in a later chapter.<p>To use an exploration technique, call <code>simgr.use_technique(tech)</code> , where tech is an instance of an ExplorationTechnique subclass. angr’s built-in exploration techniques can be found under <code>angr.exploration_techniques</code> .<p>Here’s a quick overview of some of the built-in ones:<ul><li><em>DFS</em>: Depth first search, as mentioned earlier. Keeps only one state active at once, putting the rest in the <code>deferred</code> stash until it deadends or errors.<li><em>Explorer</em>: This technique implements the <code>.explore()</code> functionality, allowing you to search for and avoid addresses.<li><em>LengthLimiter</em>: Puts a cap on the maximum length of the path a state goes through.<li><em>LoopSeer</em>: Uses a reasonable approximation of loop counting to discard states that appear to be going through a loop too many times, putting them in a <code>spinning</code> stash and pulling them out again if we run out of otherwise viable states.<li><em>ManualMergepoint</em>: Marks an address in the program as a merge point, so states that reach that address will be briefly held, and any other states that reach that same point within a timeout will be merged together.<li><em>MemoryWatcher</em>: Monitors how much memory is free/available on the system between simgr steps and stops exploration if it gets too low.<li><em>Oppologist</em>: The “operation apologist” is an especially fun gadget - if this technique is enabled and angr encounters an unsupported instruction, for example a bizzare and foreign floating point SIMD op, it will concretize all the inputs to that instruction and emulate the single instruction using the unicorn engine, allowing execution to continue.<li><em>Spiller</em>: When there are too many states active, this technique can dump some of them to disk in order to keep memory consumption low.<li><em>Threading</em>: Adds thread-level parallelism to the stepping process. This doesn’t help much because of Python’s global interpreter locks, but if you have a program whose analysis spends a lot of time in angr’s native-code dependencies (unicorn, z3, libvex) you can seem some gains.<li><em>Tracer</em>: An exploration technique that causes execution to follow a dynamic trace recorded from some other source. The <a href=https://github.com/angr/tracer rel=noopener target=_blank>dynamic tracer repository</a> has some tools to generate those traces.<li><em>Veritesting</em>: An implementation of a [CMU paper](<a href=https://users.ece.cmu.edu/~dbrumley/pdf/Avgerinos rel=noopener target=_blank>https://users.ece.cmu.edu/~dbrumley/pdf/Avgerinos</a> et al._2014_Enhancing Symbolic Execution with Veritesting.pdf) on automatically identifying useful merge points. This is so useful, you can enable it automatically with <code>veritesting=True</code> in the SimulationManager constructor! Note that it frequenly doesn’t play nice with other techniques due to the invasive way it implements static symbolic execution.</ul><p>Look at the API documentation for the <a href=https://docs.angr.io/en/latest/api.html#angr.sim_manager.SimulationManager rel=noopener target=_blank> <code>SimulationManager</code> </a> and <a href=https://docs.angr.io/en/latest/api.html#angr.exploration_techniques.ExplorationTechnique rel=noopener target=_blank> <code>ExplorationTechnique</code> </a> classes for more information.<h3 id=simulation-and-instrumentation><a class=anchor href=#simulation-and-instrumentation>#</a> Simulation and Instrumentation</h3><table><thead><tr><th>Attribute<th>Guard Condition<th>Instruction Pointer<th>Description<tbody><tr><td><code>successors</code><td>True (can be symbolic, but constrained to True)<td>Can be symbolic (but 256 solutions or less; see <code>unconstrained_successors</code> ).<td>A normal, satisfiable successor state to the state processed by the engine. The instruction pointer of this state may be symbolic (i.e., a computed jump based on user input), so the state might actually represent <em>several</em> potential continuations of execution going forward.<tr><td><code>unsat_successors</code><td>False (can be symbolic, but constrained to False).<td>Can be symbolic.<td>Unsatisfiable successors. These are successors whose guard conditions can only be false (i.e., jumps that cannot be taken, or the default branch of jumps that <em>must</em> be taken).<tr><td><code>flat_successors</code><td>True (can be symbolic, but constrained to True).<td>Concrete value.<td>As noted above, states in the <code>successors</code> list can have symbolic instruction pointers. This is rather confusing, as elsewhere in the code (i.e., in <code>SimEngineVEX.process</code> , when it’s time to step that state forward), we make assumptions that a single program state only represents the execution of a single spot in the code. To alleviate this, when we encounter states in <code>successors</code> with symbolic instruction pointers, we compute all possible concrete solutions (up to an arbitrary threshold of 256) for them, and make a copy of the state for each such solution. We call this process “flattening”. These <code>flat_successors</code> are states, each of which has a different, concrete instruction pointer. For example, if the instruction pointer of a state in <code>successors</code> was <code>X+5</code> , where <code>X</code> had constraints of <code>X > 0x800000</code> and <code>X <= 0x800010</code> , we would flatten it into 16 different <code>flat_successors</code> states, one with an instruction pointer of <code>0x800006</code> , one with <code>0x800007</code> , and so on until <code>0x800015</code> .<tr><td><code>unconstrained_successors</code><td>True (can be symbolic, but constrained to True).<td>Symbolic (with more than 256 solutions).<td>During the flattening procedure described above, if it turns out that there are more than 256 possible solutions for the instruction pointer, we assume that the instruction pointer has been overwritten with unconstrained data (i.e., a stack overflow with user data). <em>This assumption is not sound in general</em>. Such states are placed in <code>unconstrained_successors</code> and not in <code>successors</code> .<tr><td><code>all_successors</code><td>Anything<td>Can be symbolic.<td>This is <code>successors + unsat_successors + unconstrained_successors</code> .</table><h4 id=breakpoints><a class=anchor href=#breakpoints>#</a> Breakpoints</h4><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'examples/fauxware/fauxware'</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre></pre><tr><td data-num=4><td><pre><span class="token comment"># get our state</span></pre><tr><td data-num=5><td><pre><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> b<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre><span class="token comment"># add a breakpoint. This breakpoint will drop into ipdb right before a memory write happens.</span></pre><tr><td data-num=8><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>b<span class="token punctuation">(</span><span class="token string">'mem_write'</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre></pre><tr><td data-num=10><td><pre><span class="token comment"># on the other hand, we can have a breakpoint trigger right *after* a memory write happens.</span></pre><tr><td data-num=11><td><pre><span class="token comment"># we can also have a callback function run instead of opening ipdb.</span></pre><tr><td data-num=12><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">debug_func</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=13><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"State %s is about to do a memory write!"</span><span class="token punctuation">)</span></pre><tr><td data-num=14><td><pre></pre><tr><td data-num=15><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>b<span class="token punctuation">(</span><span class="token string">'mem_write'</span><span class="token punctuation">,</span> when<span class="token operator">=</span>angr<span class="token punctuation">.</span>BP_AFTER<span class="token punctuation">,</span> action<span class="token operator">=</span>debug_func<span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre></pre><tr><td data-num=17><td><pre><span class="token comment"># or, you can have it drop you in an embedded IPython!</span></pre><tr><td data-num=18><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>b<span class="token punctuation">(</span><span class="token string">'mem_write'</span><span class="token punctuation">,</span> when<span class="token operator">=</span>angr<span class="token punctuation">.</span>BP_AFTER<span class="token punctuation">,</span> action<span class="token operator">=</span>angr<span class="token punctuation">.</span>BP_IPYTHON<span class="token punctuation">)</span></pre></table></figure><table><thead><tr><th>Event type<th>Event meaning<tbody><tr><td>mem_read<td>Memory is being read.<tr><td>mem_write<td>Memory is being written.<tr><td>address_concretization<td>A symbolic memory access is being resolved.<tr><td>reg_read<td>A register is being read.<tr><td>reg_write<td>A register is being written.<tr><td>tmp_read<td>A temp is being read.<tr><td>tmp_write<td>A temp is being written.<tr><td>expr<td>An expression is being created (i.e., a result of an arithmetic operation or a constant in the IR).<tr><td>statement<td>An IR statement is being translated.<tr><td>instruction<td>A new (native) instruction is being translated.<tr><td>irsb<td>A new basic block is being translated.<tr><td>constraints<td>New constraints are being added to the state.<tr><td>exit<td>A successor is being generated from execution.<tr><td>fork<td>A symbolic execution state has forked into multiple states.<tr><td>symbolic_variable<td>A new symbolic variable is being created.<tr><td>call<td>A call instruction is hit.<tr><td>return<td>A ret instruction is hit.<tr><td>simprocedure<td>A simprocedure (or syscall) is executed.<tr><td>dirty<td>A dirty IR callback is executed.<tr><td>syscall<td>A syscall is executed (called in addition to the simprocedure event).<tr><td>engine_process<td>A SimEngine is about to process some code.</table><p>These events expose different attributes:<table><thead><tr><th>Event type<th>Attribute name<th>Attribute availability<th>Attribute meaning<tbody><tr><td>mem_read<td>mem_read_address<td>BP_BEFORE or BP_AFTER<td>The address at which memory is being read.<tr><td>mem_read<td>mem_read_expr<td>BP_AFTER<td>The expression at that address.<tr><td>mem_read<td>mem_read_length<td>BP_BEFORE or BP_AFTER<td>The length of the memory read.<tr><td>mem_read<td>mem_read_condition<td>BP_BEFORE or BP_AFTER<td>The condition of the memory read.<tr><td>mem_write<td>mem_write_address<td>BP_BEFORE or BP_AFTER<td>The address at which memory is being written.<tr><td>mem_write<td>mem_write_length<td>BP_BEFORE or BP_AFTER<td>The length of the memory write.<tr><td>mem_write<td>mem_write_expr<td>BP_BEFORE or BP_AFTER<td>The expression that is being written.<tr><td>mem_write<td>mem_write_condition<td>BP_BEFORE or BP_AFTER<td>The condition of the memory write.<tr><td>reg_read<td>reg_read_offset<td>BP_BEFORE or BP_AFTER<td>The offset of the register being read.<tr><td>reg_read<td>reg_read_length<td>BP_BEFORE or BP_AFTER<td>The length of the register read.<tr><td>reg_read<td>reg_read_expr<td>BP_AFTER<td>The expression in the register.<tr><td>reg_read<td>reg_read_condition<td>BP_BEFORE or BP_AFTER<td>The condition of the register read.<tr><td>reg_write<td>reg_write_offset<td>BP_BEFORE or BP_AFTER<td>The offset of the register being written.<tr><td>reg_write<td>reg_write_length<td>BP_BEFORE or BP_AFTER<td>The length of the register write.<tr><td>reg_write<td>reg_write_expr<td>BP_BEFORE or BP_AFTER<td>The expression that is being written.<tr><td>reg_write<td>reg_write_condition<td>BP_BEFORE or BP_AFTER<td>The condition of the register write.<tr><td>tmp_read<td>tmp_read_num<td>BP_BEFORE or BP_AFTER<td>The number of the temp being read.<tr><td>tmp_read<td>tmp_read_expr<td>BP_AFTER<td>The expression of the temp.<tr><td>tmp_write<td>tmp_write_num<td>BP_BEFORE or BP_AFTER<td>The number of the temp written.<tr><td>tmp_write<td>tmp_write_expr<td>BP_AFTER<td>The expression written to the temp.<tr><td>expr<td>expr<td>BP_BEFORE or BP_AFTER<td>The IR expression.<tr><td>expr<td>expr_result<td>BP_AFTER<td>The value (e.g. AST) which the expression was evaluated to.<tr><td>statement<td>statement<td>BP_BEFORE or BP_AFTER<td>The index of the IR statement (in the IR basic block).<tr><td>instruction<td>instruction<td>BP_BEFORE or BP_AFTER<td>The address of the native instruction.<tr><td>irsb<td>address<td>BP_BEFORE or BP_AFTER<td>The address of the basic block.<tr><td>constraints<td>added_constraints<td>BP_BEFORE or BP_AFTER<td>The list of constraint expressions being added.<tr><td>call<td>function_address<td>BP_BEFORE or BP_AFTER<td>The name of the function being called.<tr><td>exit<td>exit_target<td>BP_BEFORE or BP_AFTER<td>The expression representing the target of a SimExit.<tr><td>exit<td>exit_guard<td>BP_BEFORE or BP_AFTER<td>The expression representing the guard of a SimExit.<tr><td>exit<td>exit_jumpkind<td>BP_BEFORE or BP_AFTER<td>The expression representing the kind of SimExit.<tr><td>symbolic_variable<td>symbolic_name<td>BP_AFTER<td>The name of the symbolic variable being created. The solver engine might modify this name (by appending a unique ID and length). Check the symbolic_expr for the final symbolic expression.<tr><td>symbolic_variable<td>symbolic_size<td>BP_AFTER<td>The size of the symbolic variable being created.<tr><td>symbolic_variable<td>symbolic_expr<td>BP_AFTER<td>The expression representing the new symbolic variable.<tr><td>address_concretization<td>address_concretization_strategy<td>BP_BEFORE or BP_AFTER<td>The SimConcretizationStrategy being used to resolve the address. This can be modified by the breakpoint handler to change the strategy that will be applied. If your breakpoint handler sets this to None, this strategy will be skipped.<tr><td>address_concretization<td>address_concretization_action<td>BP_BEFORE or BP_AFTER<td>The SimAction object being used to record the memory action.<tr><td>address_concretization<td>address_concretization_memory<td>BP_BEFORE or BP_AFTER<td>The SimMemory object on which the action was taken.<tr><td>address_concretization<td>address_concretization_expr<td>BP_BEFORE or BP_AFTER<td>The AST representing the memory index being resolved. The breakpoint handler can modify this to affect the address being resolved.<tr><td>address_concretization<td>address_concretization_add_constraints<td>BP_BEFORE or BP_AFTER<td>Whether or not constraints should/will be added for this read.<tr><td>address_concretization<td>address_concretization_result<td>BP_AFTER<td>The list of resolved memory addresses (integers). The breakpoint handler can overwrite these to effect a different resolution result.<tr><td>syscall<td>syscall_name<td>BP_BEFORE or BP_AFTER<td>The name of the system call.<tr><td>simprocedure<td>simprocedure_name<td>BP_BEFORE or BP_AFTER<td>The name of the simprocedure.<tr><td>simprocedure<td>simprocedure_addr<td>BP_BEFORE or BP_AFTER<td>The address of the simprocedure.<tr><td>simprocedure<td>simprocedure_result<td>BP_AFTER<td>The return value of the simprocedure. You can also <em>override</em> it in BP_BEFORE, which will cause the actual simprocedure to be skipped and for your return value to be used instead.<tr><td>simprocedure<td>simprocedure<td>BP_BEFORE or BP_AFTER<td>The actual SimProcedure object.<tr><td>dirty<td>dirty_name<td>BP_BEFORE or BP_AFTER<td>The name of the dirty call.<tr><td>dirty<td>dirty_handler<td>BP_BEFORE<td>The function that will be run to handle the dirty call. You can override this.<tr><td>dirty<td>dirty_args<td>BP_BEFORE or BP_AFTER<td>The address of the dirty.<tr><td>dirty<td>dirty_result<td>BP_AFTER<td>The return value of the dirty call. You can also <em>override</em> it in BP_BEFORE, which will cause the actual dirty call to be skipped and for your return value to be used instead.<tr><td>engine_process<td>sim_engine<td>BP_BEFORE or BP_AFTER<td>The SimEngine that is processing.<tr><td>engine_process<td>successors<td>BP_BEFORE or BP_AFTER<td>The SimSuccessors object defining the result of the engine.</table><p>eg. 每当程序状态 <code>s</code> 执行内存读取时， <code>angr</code> 都会在读取完成后立即调用 <code>track_reads</code> ，打印出读取的值和发生读取的内存地址。<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">track_reads</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=2><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Read'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>mem_read_expr<span class="token punctuation">,</span> <span class="token string">'from'</span><span class="token punctuation">,</span> state<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>mem_read_address<span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre><tr><td data-num=4><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>b<span class="token punctuation">(</span><span class="token string">'mem_read'</span><span class="token punctuation">,</span> when<span class="token operator">=</span>angr<span class="token punctuation">.</span>BP_AFTER<span class="token punctuation">,</span> action<span class="token operator">=</span>track_reads<span class="token punctuation">)</span></pre></table></figure><figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># This will break before a memory write if 0x1000 is a possible value of its target expression</span></pre><tr><td data-num=2><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>b<span class="token punctuation">(</span><span class="token string">'mem_write'</span><span class="token punctuation">,</span> mem_write_address<span class="token operator">=</span><span class="token number">0x1000</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre></pre><tr><td data-num=4><td><pre><span class="token comment"># This will break before a memory write if 0x1000 is the *only* value of its target expression</span></pre><tr><td data-num=5><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>b<span class="token punctuation">(</span><span class="token string">'mem_write'</span><span class="token punctuation">,</span> mem_write_address<span class="token operator">=</span><span class="token number">0x1000</span><span class="token punctuation">,</span> mem_write_address_unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre></pre><tr><td data-num=7><td><pre><span class="token comment"># This will break after instruction 0x8000, but only 0x1000 is a possible value of the last expression that was read from memory</span></pre><tr><td data-num=8><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>b<span class="token punctuation">(</span><span class="token string">'instruction'</span><span class="token punctuation">,</span> when<span class="token operator">=</span>angr<span class="token punctuation">.</span>BP_AFTER<span class="token punctuation">,</span> instruction<span class="token operator">=</span><span class="token number">0x8000</span><span class="token punctuation">,</span> mem_read_expr<span class="token operator">=</span><span class="token number">0x1000</span><span class="token punctuation">)</span></pre></table></figure><p>声明函数作为 condition<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># this is a complex condition that could do anything! In this case, it makes sure that RAX is 0x41414141 and</span></pre><tr><td data-num=2><td><pre><span class="token comment"># that the basic block starting at 0x8004 was executed sometime in this path's history</span></pre><tr><td data-num=3><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">cond</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=4><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>rax<span class="token punctuation">,</span> cast_to<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'AAAA'</span> <span class="token keyword">and</span> <span class="token number">0x8004</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>backtrace</pre><tr><td data-num=5><td><pre></pre><tr><td data-num=6><td><pre><span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>inspect<span class="token punctuation">.</span>b<span class="token punctuation">(</span><span class="token string">'mem_write'</span><span class="token punctuation">,</span> condition<span class="token operator">=</span>cond<span class="token punctuation">)</span></pre></table></figure><h5 id=caution-about-mem_read-breakpoint><a class=anchor href=#caution-about-mem_read-breakpoint>#</a> Caution about <code>mem_read</code> breakpoint</h5><p>The <code>mem_read</code> breakpoint gets triggered anytime there are memory reads by either the executing program or the binary analysis. If you are using breakpoint on <code>mem_read</code> and also using <code>state.mem</code> to load data from memory addresses, then know that the breakpoint will be fired as you are technically reading memory.<p>So if you want to load data from memory and not trigger any <code>mem_read</code> breakpoint you have had set up, then use <code>state.memory.load</code> with the keyword arguments <code>disable_actions=True</code> and <code>inspect=False</code> .<p>This is also true for <code>state.find</code> and you can use the same keyword arguments to prevent <code>mem_read</code> breakpoints from firing.<h3 id=analyses-2><a class=anchor href=#analyses-2>#</a> Analyses</h3><p><a href=https://docs.angr.io/en/latest/extending-angr/analysis_writing.html#writing-analyses rel=noopener target=_blank>Writing Analyses - angr documentation</a><p>the idea is that all the analyses appear under <code>project.analyses</code> (for example, <code>project.analyses.CFGFast()</code> ) and can be called as functions, returning analysis result instances.<table><thead><tr><th>Name<th>Description<tbody><tr><td>CFGFast<td>Constructs a fast <em>Control Flow Graph</em> of the program<tr><td>CFGEmulated<td>Constructs an accurate <em>Control Flow Graph</em> of the program<tr><td>VFG<td>Performs VSA on every function of the program, creating a <em>Value Flow Graph</em> and detecting stack variables<tr><td>DDG<td>Calculates a <em>Data Dependency Graph</em>, allowing one to determine what statements a given value depends on<tr><td>BackwardSlice<td>Computes a <em>Backward Slice</em> of a program with respect to a certain target<tr><td>Identifier<td>Identifies common library functions in CGC binaries<tr><td>More!<td>angr has quite a few analyses, most of which work! If you’d like to know how to use one, please submit an issue requesting documentation.</table><h4 id=resilience><a class=anchor href=#resilience>#</a> Resilience</h4><p>Analyses can be written to be resilient, and catch and log basically any error. These errors, depending on how they’re caught, are logged to the <code>errors</code> or <code>named_errors</code> attribute of the analysis. However, you might want to run an analysis in “fail fast” mode, so that errors are not handled. To do this, the argument <code>fail_fast=True</code> can be passed into the analysis constructor.<h3 id=symbolic-execution><a class=anchor href=#symbolic-execution>#</a> Symbolic Execution</h3><h6 id=为什么这里是todo><a class=anchor href=#为什么这里是todo>#</a> 为什么这里是 todo...</h6><p><a href=https://docs.angr.io/en/latest/core-concepts/symbolic.html rel=noopener target=_blank>Symbolic Execution - angr documentation</a><h3 id=angr_ctf><a class=anchor href=#angr_ctf>#</a> angr_ctf</h3><h6 id=官方给的样例文档里还有很多真实ctf比赛的例题orz初探就做到这里吧><a class=anchor href=#官方给的样例文档里还有很多真实ctf比赛的例题orz初探就做到这里吧>#</a> 官方给的样例，文档里还有很多真实 ctf 比赛的例题 orz，初探就做到这里吧</h6><h4 id=环境配置><a class=anchor href=#环境配置>#</a> 环境配置</h4><p>添加环境变量：<pre><code>export C_INCLUDE_PATH=/usr/include/x86_64-linux-gnu
</code></pre><p>支持编译 32 位程序包：<pre><code>sudo apt-get install libc6-dev-i386
</code></pre><p>生成可执行程序<pre><code>python3 generate.py [seed] [output_file]
</code></pre><h4 id=00_angr_find><a class=anchor href=#00_angr_find>#</a> 00_angr_find</h4><p>直接找对应标准输出的输入即可<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> <span class="token string">b"Good Job."</span> <span class="token keyword">in</span> s<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre>s <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=6><td><pre>flag <span class="token operator">=</span> s<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></pre></table></figure><h4 id=01_angr_avoid><a class=anchor href=#01_angr_avoid>#</a> 01_angr_avoid</h4><p>main 函数的节点过多<p><img alt=image-20231024151111618 data-src=angr%E5%88%9D%E6%8E%A2/image-20231024151111618-16981317398901.png loading=lazy><p>可以看到 <code>avoid_me</code> 函数被大量调用<p>这里需要让 angr 走到 <code>avoid_me</code> 函数后就剪枝<p>可以使用函数传入所有需要 avoid 的状态<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token keyword">def</span> <span class="token function">should_avoid</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=5><td><pre>    <span class="token comment"># 检查输出是否包含 "Try again"</span></pre><tr><td data-num=6><td><pre>    <span class="token keyword">if</span> <span class="token string">b"Try again"</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=7><td><pre>        <span class="token keyword">return</span> <span class="token boolean">True</span></pre><tr><td data-num=8><td><pre>    <span class="token comment"># 检查当前地址是否是我们想要避免的地址</span></pre><tr><td data-num=9><td><pre>    <span class="token keyword">if</span> state<span class="token punctuation">.</span>addr <span class="token operator">==</span> <span class="token number">0x8049243</span><span class="token punctuation">:</span></pre><tr><td data-num=10><td><pre>        <span class="token keyword">return</span> <span class="token boolean">True</span></pre><tr><td data-num=11><td><pre>    <span class="token comment"># 如果以上条件都不满足，那么我们不避免这个状态</span></pre><tr><td data-num=12><td><pre>    <span class="token keyword">return</span> <span class="token boolean">False</span></pre><tr><td data-num=13><td><pre>    </pre><tr><td data-num=14><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find <span class="token operator">=</span> <span class="token keyword">lambda</span> s1<span class="token punctuation">:</span> <span class="token string">b"Good Job."</span> <span class="token keyword">in</span> s1<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> avoid <span class="token operator">=</span> should_avoid<span class="token punctuation">)</span></pre><tr><td data-num=15><td><pre></pre><tr><td data-num=16><td><pre>s <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=17><td><pre>flag <span class="token operator">=</span> s<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre><tr><td data-num=18><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></pre></table></figure><h4 id=02_angr_find_condition><a class=anchor href=#02_angr_find_condition>#</a> 02_angr_find_condition</h4><p>和上面一样<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token keyword">def</span> <span class="token function">should_avoid</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=5><td><pre>    <span class="token keyword">if</span> <span class="token string">b"Try again."</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=6><td><pre>        <span class="token keyword">return</span> <span class="token boolean">True</span></pre><tr><td data-num=7><td><pre>    <span class="token keyword">return</span> <span class="token boolean">False</span></pre><tr><td data-num=8><td><pre>    </pre><tr><td data-num=9><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find <span class="token operator">=</span> <span class="token keyword">lambda</span> s1<span class="token punctuation">:</span> <span class="token string">b"Good Job."</span> <span class="token keyword">in</span> s1<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> avoid <span class="token operator">=</span> should_avoid<span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre></pre><tr><td data-num=11><td><pre>s <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=12><td><pre>flag <span class="token operator">=</span> s<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre><tr><td data-num=13><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></pre></table></figure><h4 id=03_angr_symbolic_registers><a class=anchor href=#03_angr_symbolic_registers>#</a> 03_angr_symbolic_registers</h4><p>和上面一样可以打通<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre><tr><td data-num=3><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre><span class="token keyword">def</span> <span class="token function">should_avoid</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=5><td><pre>    <span class="token comment"># 检查输出是否包含 "Try again"</span></pre><tr><td data-num=6><td><pre>    <span class="token keyword">if</span> <span class="token string">b"Try again"</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=7><td><pre>        <span class="token keyword">return</span> <span class="token boolean">True</span></pre><tr><td data-num=8><td><pre>    <span class="token keyword">return</span> <span class="token boolean">False</span></pre><tr><td data-num=9><td><pre>    </pre><tr><td data-num=10><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find <span class="token operator">=</span> <span class="token keyword">lambda</span> s1<span class="token punctuation">:</span> <span class="token string">b"Good Job."</span> <span class="token keyword">in</span> s1<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> avoid <span class="token operator">=</span> should_avoid<span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre></pre><tr><td data-num=12><td><pre>s <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=13><td><pre>flag <span class="token operator">=</span> s<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></pre><tr><td data-num=14><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span></pre></table></figure><p>不过官方 exp 是打算让分段打（yysy，看起来没啥用，也就是省去了初始化的一些时间，不会优化太多）：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># Angr doesn't currently support reading multiple things with scanf (Ex: </span></pre><tr><td data-num=2><td><pre><span class="token comment"># scanf("%u %u).) You will have to tell the simulation engine to begin the</span></pre><tr><td data-num=3><td><pre><span class="token comment"># program after scanf is called and manually inject the symbols into registers.</span></pre><tr><td data-num=4><td><pre></pre><tr><td data-num=5><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=6><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=7><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=10><td><pre>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=11><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre></pre><tr><td data-num=13><td><pre>  <span class="token comment"># Sometimes, you want to specify where the program should start. The variable</span></pre><tr><td data-num=14><td><pre>  <span class="token comment"># start_address will specify where the symbolic execution engine should begin.</span></pre><tr><td data-num=15><td><pre>  <span class="token comment"># Note that we are using blank_state, not entry_state.</span></pre><tr><td data-num=16><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=17><td><pre>  start_address <span class="token operator">=</span> <span class="token number">0x80488c7</span>  <span class="token comment"># :integer (probably hexadecimal)</span></pre><tr><td data-num=18><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre><tr><td data-num=19><td><pre>    addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre><tr><td data-num=20><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=21><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=22><td><pre>  <span class="token punctuation">)</span></pre><tr><td data-num=23><td><pre></pre><tr><td data-num=24><td><pre>  <span class="token comment"># Create a symbolic bitvector (the datatype Angr uses to inject symbolic</span></pre><tr><td data-num=25><td><pre>  <span class="token comment"># values into the binary.) The first parameter is just a name Angr uses</span></pre><tr><td data-num=26><td><pre>  <span class="token comment"># to reference it. </span></pre><tr><td data-num=27><td><pre>  <span class="token comment"># You will have to construct multiple bitvectors. Copy the two lines below</span></pre><tr><td data-num=28><td><pre>  <span class="token comment"># and change the variable names. To figure out how many (and of what size)</span></pre><tr><td data-num=29><td><pre>  <span class="token comment"># you need, dissassemble the binary and determine the format parameter passed</span></pre><tr><td data-num=30><td><pre>  <span class="token comment"># to scanf.</span></pre><tr><td data-num=31><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=32><td><pre>  password0_size_in_bits <span class="token operator">=</span> <span class="token number">32</span>  <span class="token comment"># :integer</span></pre><tr><td data-num=33><td><pre>  password0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> password0_size_in_bits<span class="token punctuation">)</span></pre><tr><td data-num=34><td><pre></pre><tr><td data-num=35><td><pre>  password1_size_in_bits <span class="token operator">=</span> <span class="token number">32</span>  <span class="token comment"># :integer</span></pre><tr><td data-num=36><td><pre>  password1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">,</span> password1_size_in_bits<span class="token punctuation">)</span></pre><tr><td data-num=37><td><pre></pre><tr><td data-num=38><td><pre>  password2_size_in_bits <span class="token operator">=</span> <span class="token number">32</span>  <span class="token comment"># :integer</span></pre><tr><td data-num=39><td><pre>  password2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password2'</span><span class="token punctuation">,</span> password2_size_in_bits<span class="token punctuation">)</span></pre><tr><td data-num=40><td><pre></pre><tr><td data-num=41><td><pre>  <span class="token comment"># Set a register to a symbolic value. This is one way to inject symbols into</span></pre><tr><td data-num=42><td><pre>  <span class="token comment"># the program.</span></pre><tr><td data-num=43><td><pre>  <span class="token comment"># initial_state.regs stores a number of convenient attributes that reference</span></pre><tr><td data-num=44><td><pre>  <span class="token comment"># registers by name. For example, to set eax to password0, use:</span></pre><tr><td data-num=45><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=46><td><pre>  <span class="token comment"># initial_state.regs.eax = password0</span></pre><tr><td data-num=47><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=48><td><pre>  <span class="token comment"># You will have to set multiple registers to distinct bitvectors. Copy and</span></pre><tr><td data-num=49><td><pre>  <span class="token comment"># paste the line below and change the register. To determine which registers</span></pre><tr><td data-num=50><td><pre>  <span class="token comment"># to inject which symbol, dissassemble the binary and look at the instructions</span></pre><tr><td data-num=51><td><pre>  <span class="token comment"># immediately following the call to scanf.</span></pre><tr><td data-num=52><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=53><td><pre>  initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> password0</pre><tr><td data-num=54><td><pre>  initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>ebx <span class="token operator">=</span> password1</pre><tr><td data-num=55><td><pre>  initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>edx <span class="token operator">=</span> password2</pre><tr><td data-num=56><td><pre></pre><tr><td data-num=57><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=58><td><pre></pre><tr><td data-num=59><td><pre>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=60><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=61><td><pre>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=62><td><pre></pre><tr><td data-num=63><td><pre>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=64><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=65><td><pre>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=66><td><pre></pre><tr><td data-num=67><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre><tr><td data-num=68><td><pre></pre><tr><td data-num=69><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=70><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=71><td><pre></pre><tr><td data-num=72><td><pre>    <span class="token comment"># Solve for the symbolic values. If there are multiple solutions, we only</span></pre><tr><td data-num=73><td><pre>    <span class="token comment"># care about one, so we can use eval, which returns any (but only one)</span></pre><tr><td data-num=74><td><pre>    <span class="token comment"># solution. Pass eval the bitvector you want to solve for.</span></pre><tr><td data-num=75><td><pre>    <span class="token comment"># (!)</span></pre><tr><td data-num=76><td><pre>    solution0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password0<span class="token punctuation">)</span></pre><tr><td data-num=77><td><pre>    solution1 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password1<span class="token punctuation">)</span></pre><tr><td data-num=78><td><pre>    solution2 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password2<span class="token punctuation">)</span></pre><tr><td data-num=79><td><pre></pre><tr><td data-num=80><td><pre>    <span class="token comment"># Aggregate and format the solutions you computed above, and then print</span></pre><tr><td data-num=81><td><pre>    <span class="token comment"># the full string. Pay attention to the order of the integers, and the</span></pre><tr><td data-num=82><td><pre>    <span class="token comment"># expected base (decimal, octal, hexadecimal, etc).</span></pre><tr><td data-num=83><td><pre>    solution <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token string">'{:x}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> solution0<span class="token punctuation">,</span> solution1<span class="token punctuation">,</span> solution2 <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># :string</span></pre><tr><td data-num=84><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre><tr><td data-num=85><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=86><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre><tr><td data-num=87><td><pre></pre><tr><td data-num=88><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=89><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><h4 id=04_angr_symbolic_stack><a class=anchor href=#04_angr_symbolic_stack>#</a> 04_angr_symbolic_stack</h4><p>老 exp 还是可以打通..... 不过官方 exp 是要求把栈模拟一下的，贴一下先<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># This challenge will be more challenging than the previous challenges that you</span></pre><tr><td data-num=2><td><pre><span class="token comment"># have encountered thus far. Since the goal of this CTF is to teach symbolic</span></pre><tr><td data-num=3><td><pre><span class="token comment"># execution and not how to construct stack frames, these comments will work you</span></pre><tr><td data-num=4><td><pre><span class="token comment"># through understanding what is on the stack.</span></pre><tr><td data-num=5><td><pre><span class="token comment">#   ! ! !</span></pre><tr><td data-num=6><td><pre><span class="token comment"># IMPORTANT: Any addresses in this script aren't necessarily right! Dissassemble</span></pre><tr><td data-num=7><td><pre><span class="token comment">#            the binary yourself to determine the correct addresses!</span></pre><tr><td data-num=8><td><pre><span class="token comment">#   ! ! !</span></pre><tr><td data-num=9><td><pre></pre><tr><td data-num=10><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=11><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=12><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=13><td><pre></pre><tr><td data-num=14><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=15><td><pre>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=16><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=17><td><pre></pre><tr><td data-num=18><td><pre>  <span class="token comment"># For this challenge, we want to begin after the call to scanf. Note that this</span></pre><tr><td data-num=19><td><pre>  <span class="token comment"># is in the middle of a function.</span></pre><tr><td data-num=20><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=21><td><pre>  <span class="token comment"># This challenge requires dealing with the stack, so you have to pay extra</span></pre><tr><td data-num=22><td><pre>  <span class="token comment"># careful attention to where you start, otherwise you will enter a condition</span></pre><tr><td data-num=23><td><pre>  <span class="token comment"># where the stack is set up incorrectly. In order to determine where after</span></pre><tr><td data-num=24><td><pre>  <span class="token comment"># scanf to start, we need to look at the dissassembly of the call and the</span></pre><tr><td data-num=25><td><pre>  <span class="token comment"># instruction immediately following it:</span></pre><tr><td data-num=26><td><pre>  <span class="token comment">#   sub    $0x4,%esp</span></pre><tr><td data-num=27><td><pre>  <span class="token comment">#   lea    -0x10(%ebp),%eax</span></pre><tr><td data-num=28><td><pre>  <span class="token comment">#   push   %eax</span></pre><tr><td data-num=29><td><pre>  <span class="token comment">#   lea    -0xc(%ebp),%eax</span></pre><tr><td data-num=30><td><pre>  <span class="token comment">#   push   %eax</span></pre><tr><td data-num=31><td><pre>  <span class="token comment">#   push   $0x80489c3</span></pre><tr><td data-num=32><td><pre>  <span class="token comment">#   call   8048370 <__isoc99_scanf@plt></span></pre><tr><td data-num=33><td><pre>  <span class="token comment">#   add    $0x10,%esp</span></pre><tr><td data-num=34><td><pre>  <span class="token comment"># Now, the question is: do we start on the instruction immediately following</span></pre><tr><td data-num=35><td><pre>  <span class="token comment"># scanf (add $0x10,%esp), or the instruction following that (not shown)?</span></pre><tr><td data-num=36><td><pre>  <span class="token comment"># Consider what the 'add $0x10,%esp' is doing. Hint: it has to do with the</span></pre><tr><td data-num=37><td><pre>  <span class="token comment"># scanf parameters that are pushed to the stack before calling the function.</span></pre><tr><td data-num=38><td><pre>  <span class="token comment"># Given that we are not calling scanf in our Angr simulation, where should we</span></pre><tr><td data-num=39><td><pre>  <span class="token comment"># start?</span></pre><tr><td data-num=40><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=41><td><pre>  start_address <span class="token operator">=</span> <span class="token number">0x80486ae</span></pre><tr><td data-num=42><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre><tr><td data-num=43><td><pre>    addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre><tr><td data-num=44><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=45><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=46><td><pre>  <span class="token punctuation">)</span></pre><tr><td data-num=47><td><pre></pre><tr><td data-num=48><td><pre>  <span class="token comment"># We are jumping into the middle of a function! Therefore, we need to account</span></pre><tr><td data-num=49><td><pre>  <span class="token comment"># for how the function constructs the stack. The second instruction of the</span></pre><tr><td data-num=50><td><pre>  <span class="token comment"># function is:</span></pre><tr><td data-num=51><td><pre>  <span class="token comment">#   mov    %esp,%ebp</span></pre><tr><td data-num=52><td><pre>  <span class="token comment"># At which point it allocates the part of the stack frame we plan to target:</span></pre><tr><td data-num=53><td><pre>  <span class="token comment">#   sub    $0x18,%esp</span></pre><tr><td data-num=54><td><pre>  <span class="token comment"># Note the value of esp relative to ebp. The space between them is (usually)</span></pre><tr><td data-num=55><td><pre>  <span class="token comment"># the stack space. Since esp was decreased by 0x18</span></pre><tr><td data-num=56><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=57><td><pre>  <span class="token comment">#        /-------- The stack --------\</span></pre><tr><td data-num=58><td><pre>  <span class="token comment"># ebp -> |                           |</span></pre><tr><td data-num=59><td><pre>  <span class="token comment">#        |---------------------------|</span></pre><tr><td data-num=60><td><pre>  <span class="token comment">#        |                           |</span></pre><tr><td data-num=61><td><pre>  <span class="token comment">#        |---------------------------|</span></pre><tr><td data-num=62><td><pre>  <span class="token comment">#         . . . (total of 0x18 bytes)</span></pre><tr><td data-num=63><td><pre>  <span class="token comment">#         . . . Somewhere in here is</span></pre><tr><td data-num=64><td><pre>  <span class="token comment">#         . . . the data that stores</span></pre><tr><td data-num=65><td><pre>  <span class="token comment">#         . . . the result of scanf.</span></pre><tr><td data-num=66><td><pre>  <span class="token comment"># esp -> |                           |</span></pre><tr><td data-num=67><td><pre>  <span class="token comment">#        \---------------------------/</span></pre><tr><td data-num=68><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=69><td><pre>  <span class="token comment"># Since we are starting after scanf, we are skipping this stack construction</span></pre><tr><td data-num=70><td><pre>  <span class="token comment"># step. To make up for this, we need to construct the stack ourselves. Let us</span></pre><tr><td data-num=71><td><pre>  <span class="token comment"># start by initializing ebp in the exact same way the program does.</span></pre><tr><td data-num=72><td><pre>  initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>ebp <span class="token operator">=</span> initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>esp</pre><tr><td data-num=73><td><pre></pre><tr><td data-num=74><td><pre>  <span class="token comment"># scanf("%u %u") needs to be replaced by injecting two bitvectors. The</span></pre><tr><td data-num=75><td><pre>  <span class="token comment"># reason for this is that Angr does not (currently) automatically inject</span></pre><tr><td data-num=76><td><pre>  <span class="token comment"># symbols if scanf has more than one input parameter. This means Angr can</span></pre><tr><td data-num=77><td><pre>  <span class="token comment"># handle 'scanf("%u")', but not 'scanf("%u %u")'.</span></pre><tr><td data-num=78><td><pre>  <span class="token comment"># You can either copy and paste the line below or use a Python list.</span></pre><tr><td data-num=79><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=80><td><pre>  password0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre><tr><td data-num=81><td><pre>  password1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre><tr><td data-num=82><td><pre></pre><tr><td data-num=83><td><pre>  <span class="token comment"># Here is the hard part. We need to figure out what the stack looks like, at</span></pre><tr><td data-num=84><td><pre>  <span class="token comment"># least well enough to inject our symbols where we want them. In order to do</span></pre><tr><td data-num=85><td><pre>  <span class="token comment"># that, let's figure out what the parameters of scanf are:</span></pre><tr><td data-num=86><td><pre>  <span class="token comment">#   sub    $0x4,%esp</span></pre><tr><td data-num=87><td><pre>  <span class="token comment">#   lea    -0x10(%ebp),%eax</span></pre><tr><td data-num=88><td><pre>  <span class="token comment">#   push   %eax</span></pre><tr><td data-num=89><td><pre>  <span class="token comment">#   lea    -0xc(%ebp),%eax</span></pre><tr><td data-num=90><td><pre>  <span class="token comment">#   push   %eax</span></pre><tr><td data-num=91><td><pre>  <span class="token comment">#   push   $0x80489c3</span></pre><tr><td data-num=92><td><pre>  <span class="token comment">#   call   8048370 <__isoc99_scanf@plt></span></pre><tr><td data-num=93><td><pre>  <span class="token comment">#   add    $0x10,%esp </span></pre><tr><td data-num=94><td><pre>  <span class="token comment"># As you can see, the call to scanf looks like this:</span></pre><tr><td data-num=95><td><pre>  <span class="token comment"># scanf(  0x80489c3,   ebp - 0xc,   ebp - 0x10  )</span></pre><tr><td data-num=96><td><pre>  <span class="token comment">#      format_string    password0    password1</span></pre><tr><td data-num=97><td><pre>  <span class="token comment">#  From this, we can construct our new, more accurate stack diagram:</span></pre><tr><td data-num=98><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=99><td><pre>  <span class="token comment">#            /-------- The stack --------\</span></pre><tr><td data-num=100><td><pre>  <span class="token comment"># ebp ->     |          padding          |</span></pre><tr><td data-num=101><td><pre>  <span class="token comment">#            |---------------------------|</span></pre><tr><td data-num=102><td><pre>  <span class="token comment"># ebp - 0x01 |       more padding        |</span></pre><tr><td data-num=103><td><pre>  <span class="token comment">#            |---------------------------|</span></pre><tr><td data-num=104><td><pre>  <span class="token comment"># ebp - 0x02 |     even more padding     |</span></pre><tr><td data-num=105><td><pre>  <span class="token comment">#            |---------------------------|</span></pre><tr><td data-num=106><td><pre>  <span class="token comment">#                        . . .               &LT- How much padding? Hint: how</span></pre><tr><td data-num=107><td><pre>  <span class="token comment">#            |---------------------------|      many bytes is password0?</span></pre><tr><td data-num=108><td><pre>  <span class="token comment"># ebp - 0x0b |   password0, second byte  |</span></pre><tr><td data-num=109><td><pre>  <span class="token comment">#            |---------------------------|</span></pre><tr><td data-num=110><td><pre>  <span class="token comment"># ebp - 0x0c |   password0, first byte   |</span></pre><tr><td data-num=111><td><pre>  <span class="token comment">#            |---------------------------|</span></pre><tr><td data-num=112><td><pre>  <span class="token comment"># ebp - 0x0d |   password1, last byte    |</span></pre><tr><td data-num=113><td><pre>  <span class="token comment">#            |---------------------------|</span></pre><tr><td data-num=114><td><pre>  <span class="token comment">#                        . . .</span></pre><tr><td data-num=115><td><pre>  <span class="token comment">#            |---------------------------|</span></pre><tr><td data-num=116><td><pre>  <span class="token comment"># ebp - 0x10 |   password1, first byte   |</span></pre><tr><td data-num=117><td><pre>  <span class="token comment">#            |---------------------------|</span></pre><tr><td data-num=118><td><pre>  <span class="token comment">#                        . . .</span></pre><tr><td data-num=119><td><pre>  <span class="token comment">#            |---------------------------|</span></pre><tr><td data-num=120><td><pre>  <span class="token comment"># esp ->     |                           |</span></pre><tr><td data-num=121><td><pre>  <span class="token comment">#            \---------------------------/</span></pre><tr><td data-num=122><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=123><td><pre>  <span class="token comment"># Figure out how much space there is and allocate the necessary padding to</span></pre><tr><td data-num=124><td><pre>  <span class="token comment"># the stack by decrementing esp before you push the password bitvectors.</span></pre><tr><td data-num=125><td><pre>  padding_length_in_bytes <span class="token operator">=</span> <span class="token number">8</span>  <span class="token comment"># :integer</span></pre><tr><td data-num=126><td><pre>  initial_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>esp <span class="token operator">-=</span> padding_length_in_bytes</pre><tr><td data-num=127><td><pre></pre><tr><td data-num=128><td><pre>  <span class="token comment"># Push the variables to the stack. Make sure to push them in the right order!</span></pre><tr><td data-num=129><td><pre>  <span class="token comment"># The syntax for the following function is:</span></pre><tr><td data-num=130><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=131><td><pre>  <span class="token comment"># initial_state.stack_push(bitvector)</span></pre><tr><td data-num=132><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=133><td><pre>  <span class="token comment"># This will push the bitvector on the stack, and increment esp the correct</span></pre><tr><td data-num=134><td><pre>  <span class="token comment"># amount. You will need to push multiple bitvectors on the stack.</span></pre><tr><td data-num=135><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=136><td><pre>  initial_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>password0<span class="token punctuation">)</span>  <span class="token comment"># :bitvector (claripy.BVS, claripy.BVV, claripy.BV)</span></pre><tr><td data-num=137><td><pre>  initial_state<span class="token punctuation">.</span>stack_push<span class="token punctuation">(</span>password1<span class="token punctuation">)</span></pre><tr><td data-num=138><td><pre></pre><tr><td data-num=139><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=140><td><pre></pre><tr><td data-num=141><td><pre>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=142><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=143><td><pre>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=144><td><pre></pre><tr><td data-num=145><td><pre>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=146><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=147><td><pre>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=148><td><pre></pre><tr><td data-num=149><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre><tr><td data-num=150><td><pre></pre><tr><td data-num=151><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=152><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=153><td><pre></pre><tr><td data-num=154><td><pre>    solution0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password0<span class="token punctuation">)</span></pre><tr><td data-num=155><td><pre>    solution1 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password1<span class="token punctuation">)</span></pre><tr><td data-num=156><td><pre></pre><tr><td data-num=157><td><pre>    solution <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> solution0<span class="token punctuation">,</span> solution1 <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=158><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre><tr><td data-num=159><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=160><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre><tr><td data-num=161><td><pre></pre><tr><td data-num=162><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=163><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><p>分析一下：<p>主要是这里：<p><img alt=image-20231024162621516 data-src=angr%E5%88%9D%E6%8E%A2/image-20231024162621516.png loading=lazy><p>实际上就是找到栈上的参数，用于做初始化状态，再进行符号执行<h4 id=05_angr_symbolic_memory><a class=anchor href=#05_angr_symbolic_memory>#</a> 05_angr_symbolic_memory</h4><p>对应到全局变量的方法<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=4><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">,</span> auto_load_libs<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre>start_address <span class="token operator">=</span> <span class="token number">0x8049299</span></pre><tr><td data-num=6><td><pre>initial_state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre><tr><td data-num=7><td><pre>  addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre><tr><td data-num=8><td><pre>  add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=9><td><pre>                  angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=10><td><pre><span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre></pre><tr><td data-num=12><td><pre>password0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password0'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span></pre><tr><td data-num=13><td><pre>password1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password1'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span></pre><tr><td data-num=14><td><pre>password2 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password2'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span></pre><tr><td data-num=15><td><pre>password3 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password3'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre>password0_address <span class="token operator">=</span> <span class="token number">0xBFA1EE0</span></pre><tr><td data-num=17><td><pre>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password0_address<span class="token punctuation">,</span> password0<span class="token punctuation">)</span></pre><tr><td data-num=18><td><pre>password1_address <span class="token operator">=</span> <span class="token number">0xBFA1EE0</span> <span class="token operator">+</span> <span class="token number">8</span></pre><tr><td data-num=19><td><pre>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password1_address<span class="token punctuation">,</span> password1<span class="token punctuation">)</span></pre><tr><td data-num=20><td><pre>password2_address <span class="token operator">=</span> <span class="token number">0xBFA1EE0</span> <span class="token operator">+</span> <span class="token number">16</span></pre><tr><td data-num=21><td><pre>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password2_address<span class="token punctuation">,</span> password2<span class="token punctuation">)</span></pre><tr><td data-num=22><td><pre>password3_address <span class="token operator">=</span> <span class="token number">0xBFA1EE0</span> <span class="token operator">+</span> <span class="token number">24</span></pre><tr><td data-num=23><td><pre>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password3_address<span class="token punctuation">,</span> password3<span class="token punctuation">)</span></pre><tr><td data-num=24><td><pre></pre><tr><td data-num=25><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=26><td><pre></pre><tr><td data-num=27><td><pre><span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=28><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=29><td><pre>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=30><td><pre>      </pre><tr><td data-num=31><td><pre><span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=32><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=33><td><pre>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=34><td><pre>    </pre><tr><td data-num=35><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find <span class="token operator">=</span> is_successful<span class="token punctuation">,</span> avoid <span class="token operator">=</span> should_abort<span class="token punctuation">)</span></pre><tr><td data-num=36><td><pre>solution_state <span class="token operator">=</span> simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=37><td><pre>solution0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password0<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=38><td><pre>solution1 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password1<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=39><td><pre>solution2 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password2<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=40><td><pre>solution3 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password3<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=41><td><pre>solution <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span> solution0<span class="token punctuation">,</span> solution1<span class="token punctuation">,</span> solution2<span class="token punctuation">,</span> solution3 <span class="token punctuation">]</span><span class="token punctuation">)</span></pre><tr><td data-num=42><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre></table></figure><h4 id=06_angr_symbolic_dynamic_memory><a class=anchor href=#06_angr_symbolic_dynamic_memory>#</a> 06_angr_symbolic_dynamic_memory</h4><p><s>最早的仍旧能打通</s><p>不过这题主要还是教你把堆模拟（分配未分配过的内存即可）<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre>fake_heap_address0 <span class="token operator">=</span> <span class="token number">0x4444444</span></pre><tr><td data-num=2><td><pre>pointer_to_malloc_memory_address0 <span class="token operator">=</span> <span class="token number">0xa2def74</span></pre><tr><td data-num=3><td><pre>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>pointer_to_malloc_memory_address0<span class="token punctuation">,</span> fake_heap_address0<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre>fake_heap_address1 <span class="token operator">=</span> <span class="token number">0x4444454</span></pre><tr><td data-num=5><td><pre>pointer_to_malloc_memory_address1 <span class="token operator">=</span> <span class="token number">0xa2def7c</span></pre><tr><td data-num=6><td><pre>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>pointer_to_malloc_memory_address1<span class="token punctuation">,</span> fake_heap_address1<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre></pre><tr><td data-num=8><td><pre><span class="token comment"># Store our symbolic values at our fake_heap_address. Look at the binary to</span></pre><tr><td data-num=9><td><pre><span class="token comment"># determine the offsets from the fake_heap_address where scanf writes.</span></pre><tr><td data-num=10><td><pre><span class="token comment"># (!)</span></pre><tr><td data-num=11><td><pre>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>fake_heap_address0<span class="token punctuation">,</span> password0<span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre>initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>fake_heap_address1<span class="token punctuation">,</span> password1<span class="token punctuation">)</span></pre></table></figure><h4 id=07_angr_symbolic_file><a class=anchor href=#07_angr_symbolic_file>#</a> 07_angr_symbolic_file</h4><p><s>最早的仍旧能打通，而且官方的反而打不通 ee</s><p>还是贴一个官方的吧，其实就是教怎么模拟文件<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># This challenge could, in theory, be solved in multiple ways. However, for the</span></pre><tr><td data-num=2><td><pre><span class="token comment"># sake of learning how to simulate an alternate filesystem, please solve this</span></pre><tr><td data-num=3><td><pre><span class="token comment"># challenge according to structure provided below. As a challenge, once you have</span></pre><tr><td data-num=4><td><pre><span class="token comment"># an initial solution, try solving this in an alternate way.</span></pre><tr><td data-num=5><td><pre><span class="token comment">#</span></pre><tr><td data-num=6><td><pre><span class="token comment"># Problem description and general solution strategy:</span></pre><tr><td data-num=7><td><pre><span class="token comment"># The binary loads the password from a file using the fread function. If the</span></pre><tr><td data-num=8><td><pre><span class="token comment"># password is correct, it prints "Good Job." In order to keep consistency with</span></pre><tr><td data-num=9><td><pre><span class="token comment"># the other challenges, the input from the console is written to a file in the </span></pre><tr><td data-num=10><td><pre><span class="token comment"># ignore_me function. As the name suggests, ignore it, as it only exists to</span></pre><tr><td data-num=11><td><pre><span class="token comment"># maintain consistency with other challenges.</span></pre><tr><td data-num=12><td><pre><span class="token comment"># We want to:</span></pre><tr><td data-num=13><td><pre><span class="token comment"># 1. Determine the file from which fread reads.</span></pre><tr><td data-num=14><td><pre><span class="token comment"># 2. Use Angr to simulate a filesystem where that file is replaced with our own</span></pre><tr><td data-num=15><td><pre><span class="token comment">#    simulated file.</span></pre><tr><td data-num=16><td><pre><span class="token comment"># 3. Initialize the file with a symbolic value, which will be read with fread</span></pre><tr><td data-num=17><td><pre><span class="token comment">#    and propogated through the program.</span></pre><tr><td data-num=18><td><pre><span class="token comment"># 4. Solve for the symbolic input to determine the password.</span></pre><tr><td data-num=19><td><pre></pre><tr><td data-num=20><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=21><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=22><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=23><td><pre></pre><tr><td data-num=24><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=25><td><pre>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=26><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=27><td><pre></pre><tr><td data-num=28><td><pre>  start_address <span class="token operator">=</span> <span class="token number">0x80488bc</span></pre><tr><td data-num=29><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre><tr><td data-num=30><td><pre>    addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre><tr><td data-num=31><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=32><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=33><td><pre>  <span class="token punctuation">)</span></pre><tr><td data-num=34><td><pre></pre><tr><td data-num=35><td><pre>  <span class="token comment"># Specify some information needed to construct a simulated file. For this</span></pre><tr><td data-num=36><td><pre>  <span class="token comment"># challenge, the filename is hardcoded, but in theory, it could be symbolic. </span></pre><tr><td data-num=37><td><pre>  <span class="token comment"># Note: to read from the file, the binary calls</span></pre><tr><td data-num=38><td><pre>  <span class="token comment"># 'fread(buffer, sizeof(char), 64, file)'.</span></pre><tr><td data-num=39><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=40><td><pre>  filename <span class="token operator">=</span> <span class="token string">'FOQVSBZB.txt'</span>  <span class="token comment"># :string</span></pre><tr><td data-num=41><td><pre>  symbolic_file_size_bytes <span class="token operator">=</span> <span class="token number">8</span></pre><tr><td data-num=42><td><pre></pre><tr><td data-num=43><td><pre>  <span class="token comment"># Construct a bitvector for the password and then store it in the file's</span></pre><tr><td data-num=44><td><pre>  <span class="token comment"># backing memory. For example, imagine a simple file, 'hello.txt':</span></pre><tr><td data-num=45><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=46><td><pre>  <span class="token comment"># Hello world, my name is John.</span></pre><tr><td data-num=47><td><pre>  <span class="token comment"># ^                       ^</span></pre><tr><td data-num=48><td><pre>  <span class="token comment"># ^ address 0             ^ address 24 (count the number of characters)</span></pre><tr><td data-num=49><td><pre>  <span class="token comment"># In order to represent this in memory, we would want to write the string to</span></pre><tr><td data-num=50><td><pre>  <span class="token comment"># the beginning of the file:</span></pre><tr><td data-num=51><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=52><td><pre>  <span class="token comment"># hello_txt_contents = claripy.BVV('Hello world, my name is John.', 30*8)</span></pre><tr><td data-num=53><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=54><td><pre>  <span class="token comment"># Perhaps, then, we would want to replace John with a</span></pre><tr><td data-num=55><td><pre>  <span class="token comment"># symbolic variable. We would call:</span></pre><tr><td data-num=56><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=57><td><pre>  <span class="token comment"># name_bitvector = claripy.BVS('symbolic_name', 4*8)</span></pre><tr><td data-num=58><td><pre>  <span class="token comment">#</span></pre><tr><td data-num=59><td><pre>  <span class="token comment"># Then, after the program calls fopen('hello.txt', 'r') and then</span></pre><tr><td data-num=60><td><pre>  <span class="token comment"># fread(buffer, sizeof(char), 30, hello_txt_file), the buffer would contain</span></pre><tr><td data-num=61><td><pre>  <span class="token comment"># the string from the file, except four symbolic bytes where the name would be</span></pre><tr><td data-num=62><td><pre>  <span class="token comment"># stored.</span></pre><tr><td data-num=63><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=64><td><pre>  password <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> symbolic_file_size_bytes <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span></pre><tr><td data-num=65><td><pre></pre><tr><td data-num=66><td><pre>  <span class="token comment"># Construct the symbolic file. The file_options parameter specifies the Linux</span></pre><tr><td data-num=67><td><pre>  <span class="token comment"># file permissions (read, read/write, execute etc.) The content parameter</span></pre><tr><td data-num=68><td><pre>  <span class="token comment"># specifies from where the stream of data should be supplied. If content is</span></pre><tr><td data-num=69><td><pre>  <span class="token comment"># an instance of SimSymbolicMemory (we constructed one above), the stream will</span></pre><tr><td data-num=70><td><pre>  <span class="token comment"># contain the contents (including any symbolic contents) of the memory,</span></pre><tr><td data-num=71><td><pre>  <span class="token comment"># beginning from address zero.</span></pre><tr><td data-num=72><td><pre>  <span class="token comment"># Set the content parameter to our BVS instance that holds the symbolic data.</span></pre><tr><td data-num=73><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=74><td><pre>  password_file <span class="token operator">=</span> angr<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>SimFile<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> content<span class="token operator">=</span>password<span class="token punctuation">)</span></pre><tr><td data-num=75><td><pre>  </pre><tr><td data-num=76><td><pre>  <span class="token comment"># Add the symbolic file we created to the symbolic filesystem.</span></pre><tr><td data-num=77><td><pre>  initial_state<span class="token punctuation">.</span>fs<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> password_file<span class="token punctuation">)</span></pre><tr><td data-num=78><td><pre></pre><tr><td data-num=79><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=80><td><pre></pre><tr><td data-num=81><td><pre>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=82><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=83><td><pre>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=84><td><pre></pre><tr><td data-num=85><td><pre>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=86><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=87><td><pre>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=88><td><pre></pre><tr><td data-num=89><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre><tr><td data-num=90><td><pre></pre><tr><td data-num=91><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=92><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=93><td><pre></pre><tr><td data-num=94><td><pre>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=95><td><pre></pre><tr><td data-num=96><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre><tr><td data-num=97><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=98><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre><tr><td data-num=99><td><pre></pre><tr><td data-num=100><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=101><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><p>ps. 找到 issue 了：<p>Scaffold and solution challenge 07 are not working with latest angr, because SimFile class changed.<p>This is working code with latest version of angr for the filesystem part:<pre><code>  filename = "OJKSQYDP.txt"  # :string
  symbolic_file_size_bytes = 64

  password = claripy.BVS('password', symbolic_file_size_bytes * 8)
  password_file = angr.storage.SimFile(filename, content=password, size=symbolic_file_size_bytes)

  initial_state.fs.insert(filename, password_file)
  simulation = project.factory.simgr(initial_state)
</code></pre><p>TODO：改了 issue 仍旧打不通<h4 id=08_angr_constraints><a class=anchor href=#08_angr_constraints>#</a> 08_angr_constraints</h4><p><s>老 exp 打不通了，好耶（什）</s><p>原理：<pre><code># While you, as a human, can easily determine that this function is equivalent
# to simply comparing the strings, the computer cannot. Instead the computer 
# would need to branch every time the if statement in the loop was called (16 
# times), resulting in 2^16 = 65,536 branches, which will take too long of a 
# time to evaluate for our needs.
</code></pre><p>TODO：这里尝试过在 check 的 jnz 地址处对 zf 寄存器状态做剪枝，也跑不出来，后续看看为啥<p>官方给的解法是手动获取模拟比较（设置终止状态在真正的 check 之前，然后手动设置比较），将其转化为 constraint，约束求解得到最终结果，贴一个吧先：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=4><td><pre></pre><tr><td data-num=5><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=6><td><pre>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=7><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre>  start_address <span class="token operator">=</span> <span class="token number">0x80492ED</span></pre><tr><td data-num=10><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre><tr><td data-num=11><td><pre>    addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre><tr><td data-num=12><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=13><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=14><td><pre>  <span class="token punctuation">)</span></pre><tr><td data-num=15><td><pre>  password <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">16</span><span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre></pre><tr><td data-num=17><td><pre>  password_address <span class="token operator">=</span> <span class="token number">0x804C034</span></pre><tr><td data-num=18><td><pre>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password_address<span class="token punctuation">,</span> password<span class="token punctuation">)</span></pre><tr><td data-num=19><td><pre></pre><tr><td data-num=20><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=21><td><pre></pre><tr><td data-num=22><td><pre>  address_to_check_constraint <span class="token operator">=</span> <span class="token number">0x804933E</span></pre><tr><td data-num=23><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>address_to_check_constraint<span class="token punctuation">)</span></pre><tr><td data-num=24><td><pre></pre><tr><td data-num=25><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=26><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=27><td><pre>    </pre><tr><td data-num=28><td><pre>    constrained_parameter_address <span class="token operator">=</span> <span class="token number">0x804C034</span></pre><tr><td data-num=29><td><pre>    constrained_parameter_size_bytes <span class="token operator">=</span> <span class="token number">16</span></pre><tr><td data-num=30><td><pre>    constrained_parameter_bitvector <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre><tr><td data-num=31><td><pre>      constrained_parameter_address<span class="token punctuation">,</span></pre><tr><td data-num=32><td><pre>      constrained_parameter_size_bytes</pre><tr><td data-num=33><td><pre>    <span class="token punctuation">)</span></pre><tr><td data-num=34><td><pre></pre><tr><td data-num=35><td><pre>    constrained_parameter_desired_value <span class="token operator">=</span> <span class="token string">'PPBVDNMJABAQHZQQ'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=36><td><pre></pre><tr><td data-num=37><td><pre>    solution_state<span class="token punctuation">.</span>add_constraints<span class="token punctuation">(</span>constrained_parameter_bitvector <span class="token operator">==</span> constrained_parameter_desired_value<span class="token punctuation">)</span></pre><tr><td data-num=38><td><pre></pre><tr><td data-num=39><td><pre>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=40><td><pre></pre><tr><td data-num=41><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre><tr><td data-num=42><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=43><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre><tr><td data-num=44><td><pre></pre><tr><td data-num=45><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=46><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><h4 id=09_angr_hooks><a class=anchor href=#09_angr_hooks>#</a> 09_angr_hooks</h4><p><s>他说要 hook，但是我强行给他分段打通楽（什）</s><p>一开始写的 exp（注意给 password 初始值写上，开始的时候忘了）可以打通<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=4><td><pre></pre><tr><td data-num=5><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=6><td><pre>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=7><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre>  start_address <span class="token operator">=</span> <span class="token number">0x80492FD</span></pre><tr><td data-num=10><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre><tr><td data-num=11><td><pre>    addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre><tr><td data-num=12><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=13><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=14><td><pre>  <span class="token punctuation">)</span></pre><tr><td data-num=15><td><pre>  password <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">16</span><span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre></pre><tr><td data-num=17><td><pre>  password_address <span class="token operator">=</span> <span class="token number">0x804C038</span></pre><tr><td data-num=18><td><pre>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password_address<span class="token punctuation">,</span> password<span class="token punctuation">)</span></pre><tr><td data-num=19><td><pre></pre><tr><td data-num=20><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=21><td><pre></pre><tr><td data-num=22><td><pre>  address_to_check_constraint <span class="token operator">=</span> <span class="token number">0x804934E</span></pre><tr><td data-num=23><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>address_to_check_constraint<span class="token punctuation">)</span></pre><tr><td data-num=24><td><pre></pre><tr><td data-num=25><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=26><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=27><td><pre>    </pre><tr><td data-num=28><td><pre>    constrained_parameter_address <span class="token operator">=</span> <span class="token number">0x804C038</span></pre><tr><td data-num=29><td><pre>    constrained_parameter_size_bytes <span class="token operator">=</span> <span class="token number">16</span></pre><tr><td data-num=30><td><pre>    constrained_parameter_bitvector <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre><tr><td data-num=31><td><pre>      constrained_parameter_address<span class="token punctuation">,</span></pre><tr><td data-num=32><td><pre>      constrained_parameter_size_bytes</pre><tr><td data-num=33><td><pre>    <span class="token punctuation">)</span></pre><tr><td data-num=34><td><pre></pre><tr><td data-num=35><td><pre>    constrained_parameter_desired_value <span class="token operator">=</span> <span class="token string">'PPBVDNMJABAQHZQQ'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=36><td><pre></pre><tr><td data-num=37><td><pre>    solution_state<span class="token punctuation">.</span>add_constraints<span class="token punctuation">(</span>constrained_parameter_bitvector <span class="token operator">==</span> constrained_parameter_desired_value<span class="token punctuation">)</span></pre><tr><td data-num=38><td><pre></pre><tr><td data-num=39><td><pre>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=40><td><pre></pre><tr><td data-num=41><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre><tr><td data-num=42><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=43><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre><tr><td data-num=44><td><pre></pre><tr><td data-num=45><td><pre></pre><tr><td data-num=46><td><pre><span class="token comment">#################################################</span></pre><tr><td data-num=47><td><pre>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=48><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=49><td><pre>  start_address <span class="token operator">=</span> <span class="token number">0x804935B</span></pre><tr><td data-num=50><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre><tr><td data-num=51><td><pre>    addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre><tr><td data-num=52><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=53><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=54><td><pre>  <span class="token punctuation">)</span></pre><tr><td data-num=55><td><pre>  password <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">16</span><span class="token punctuation">)</span></pre><tr><td data-num=56><td><pre></pre><tr><td data-num=57><td><pre>  password_address <span class="token operator">=</span> <span class="token number">0x804C038</span></pre><tr><td data-num=58><td><pre>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>password_address<span class="token punctuation">,</span> password<span class="token punctuation">)</span></pre><tr><td data-num=59><td><pre></pre><tr><td data-num=60><td><pre><span class="token comment"># 这里记得把 password 初始值写入</span></pre><tr><td data-num=61><td><pre>  pwd_addr <span class="token operator">=</span> <span class="token number">0x804C04C</span></pre><tr><td data-num=62><td><pre>  pwd <span class="token operator">=</span> <span class="token string">b'PPBVDNMJABAQHZQQ'</span></pre><tr><td data-num=63><td><pre>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>pwd_addr<span class="token punctuation">,</span> pwd<span class="token punctuation">)</span></pre><tr><td data-num=64><td><pre></pre><tr><td data-num=65><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=66><td><pre></pre><tr><td data-num=67><td><pre>  address_to_check_constraint <span class="token operator">=</span> <span class="token number">0x80493A3</span></pre><tr><td data-num=68><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>address_to_check_constraint<span class="token punctuation">)</span></pre><tr><td data-num=69><td><pre></pre><tr><td data-num=70><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=71><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=72><td><pre>    </pre><tr><td data-num=73><td><pre>    constrained_parameter_address <span class="token operator">=</span> <span class="token number">0x804C038</span></pre><tr><td data-num=74><td><pre>    constrained_parameter_size_bytes <span class="token operator">=</span> <span class="token number">16</span></pre><tr><td data-num=75><td><pre>    constrained_parameter_bitvector <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre><tr><td data-num=76><td><pre>      constrained_parameter_address<span class="token punctuation">,</span></pre><tr><td data-num=77><td><pre>      constrained_parameter_size_bytes</pre><tr><td data-num=78><td><pre>    <span class="token punctuation">)</span></pre><tr><td data-num=79><td><pre></pre><tr><td data-num=80><td><pre>    check <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre><tr><td data-num=81><td><pre>      pwd_addr<span class="token punctuation">,</span></pre><tr><td data-num=82><td><pre>      constrained_parameter_size_bytes</pre><tr><td data-num=83><td><pre>    <span class="token punctuation">)</span></pre><tr><td data-num=84><td><pre>    constrained_parameter_desired_value <span class="token operator">=</span> check</pre><tr><td data-num=85><td><pre></pre><tr><td data-num=86><td><pre>    solution_state<span class="token punctuation">.</span>add_constraints<span class="token punctuation">(</span>constrained_parameter_bitvector <span class="token operator">==</span> constrained_parameter_desired_value<span class="token punctuation">)</span></pre><tr><td data-num=87><td><pre></pre><tr><td data-num=88><td><pre>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=89><td><pre></pre><tr><td data-num=90><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre><tr><td data-num=91><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=92><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution???'</span><span class="token punctuation">)</span></pre><tr><td data-num=93><td><pre></pre><tr><td data-num=94><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=95><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><p>然后看看官方怎么 hook 的<p>结论是这么写将中间那个过不去的函数转化为手动的 check，那比上一个的做法还简洁点点<p>主要就是这里：<p><img alt=image-20231024213817285 data-src=angr%E5%88%9D%E6%8E%A2/image-20231024213817285.png loading=lazy><p>直接贴一个：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># This level performs the following computations:</span></pre><tr><td data-num=2><td><pre><span class="token comment">#</span></pre><tr><td data-num=3><td><pre><span class="token comment"># 1. Get 16 bytes of user input and encrypt it.</span></pre><tr><td data-num=4><td><pre><span class="token comment"># 2. Save the result of check_equals_AABBCCDDEEFFGGHH (or similar)</span></pre><tr><td data-num=5><td><pre><span class="token comment"># 3. Get another 16 bytes from the user and encrypt it.</span></pre><tr><td data-num=6><td><pre><span class="token comment"># 4. Check that it's equal to a predefined password.</span></pre><tr><td data-num=7><td><pre><span class="token comment">#</span></pre><tr><td data-num=8><td><pre><span class="token comment"># The ONLY part of this program that we have to worry about is #2. We will be</span></pre><tr><td data-num=9><td><pre><span class="token comment"># replacing the call to check_equals_ with our own version, using a hook, since</span></pre><tr><td data-num=10><td><pre><span class="token comment"># check_equals_ will run too slowly otherwise.</span></pre><tr><td data-num=11><td><pre></pre><tr><td data-num=12><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=13><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=14><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=15><td><pre></pre><tr><td data-num=16><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=17><td><pre>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=18><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=19><td><pre></pre><tr><td data-num=20><td><pre>  <span class="token comment"># Since Angr can handle the initial call to scanf, we can start from the</span></pre><tr><td data-num=21><td><pre>  <span class="token comment"># beginning.</span></pre><tr><td data-num=22><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span></pre><tr><td data-num=23><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=24><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=25><td><pre>  <span class="token punctuation">)</span></pre><tr><td data-num=26><td><pre></pre><tr><td data-num=27><td><pre>  <span class="token comment"># Hook the address of where check_equals_ is called.</span></pre><tr><td data-num=28><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=29><td><pre>  check_equals_called_address <span class="token operator">=</span> <span class="token number">0x80486ca</span></pre><tr><td data-num=30><td><pre></pre><tr><td data-num=31><td><pre>  <span class="token comment"># The length parameter in angr.Hook specifies how many bytes the execution</span></pre><tr><td data-num=32><td><pre>  <span class="token comment"># engine should skip after completing the hook. This will allow hooks to</span></pre><tr><td data-num=33><td><pre>  <span class="token comment"># replace certain instructions (or groups of instructions). Determine the</span></pre><tr><td data-num=34><td><pre>  <span class="token comment"># instructions involved in calling check_equals_, and then determine how many</span></pre><tr><td data-num=35><td><pre>  <span class="token comment"># bytes are used to represent them in memory. This will be the skip length.</span></pre><tr><td data-num=36><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=37><td><pre>  instruction_to_skip_length <span class="token operator">=</span> <span class="token number">5</span></pre><tr><td data-num=38><td><pre>  <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span>check_equals_called_address<span class="token punctuation">,</span> length<span class="token operator">=</span>instruction_to_skip_length<span class="token punctuation">)</span></pre><tr><td data-num=39><td><pre>  <span class="token keyword">def</span> <span class="token function">skip_check_equals_</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=40><td><pre>    <span class="token comment"># Determine the address where user input is stored. It is passed as a</span></pre><tr><td data-num=41><td><pre>    <span class="token comment"># parameter ot the check_equals_ function. Then, load the string. Reminder:</span></pre><tr><td data-num=42><td><pre>    <span class="token comment"># int check_equals_(char* to_check, int length) { ...</span></pre><tr><td data-num=43><td><pre>    user_input_buffer_address <span class="token operator">=</span> <span class="token number">0x804a044</span> <span class="token comment"># :integer, probably hexadecimal</span></pre><tr><td data-num=44><td><pre>    user_input_buffer_length <span class="token operator">=</span> <span class="token number">16</span></pre><tr><td data-num=45><td><pre></pre><tr><td data-num=46><td><pre>    <span class="token comment"># Reminder: state.memory.load will read the stored value at the address</span></pre><tr><td data-num=47><td><pre>    <span class="token comment"># user_input_buffer_address of byte length user_input_buffer_length.</span></pre><tr><td data-num=48><td><pre>    <span class="token comment"># It will return a bitvector holding the value. This value can either be</span></pre><tr><td data-num=49><td><pre>    <span class="token comment"># symbolic or concrete, depending on what was stored there in the program.</span></pre><tr><td data-num=50><td><pre>    user_input_string <span class="token operator">=</span> state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre><tr><td data-num=51><td><pre>      user_input_buffer_address<span class="token punctuation">,</span></pre><tr><td data-num=52><td><pre>      user_input_buffer_length</pre><tr><td data-num=53><td><pre>    <span class="token punctuation">)</span></pre><tr><td data-num=54><td><pre>    </pre><tr><td data-num=55><td><pre>    <span class="token comment"># Determine the string this function is checking the user input against.</span></pre><tr><td data-num=56><td><pre>    <span class="token comment"># It's encoded in the name of this function; decompile the program to find</span></pre><tr><td data-num=57><td><pre>    <span class="token comment"># it.</span></pre><tr><td data-num=58><td><pre>    check_against_string <span class="token operator">=</span> <span class="token string">'OSIWHBXIFOQVSBZB'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># :string</span></pre><tr><td data-num=59><td><pre></pre><tr><td data-num=60><td><pre>    <span class="token comment"># gcc uses eax to store the return value, if it is an integer. We need to</span></pre><tr><td data-num=61><td><pre>    <span class="token comment"># set eax to 1 if check_against_string == user_input_string and 0 otherwise.</span></pre><tr><td data-num=62><td><pre>    <span class="token comment"># However, since we are describing an equation to be used by z3 (not to be</span></pre><tr><td data-num=63><td><pre>    <span class="token comment"># evaluated immediately), we cannot use Python if else syntax. Instead, we </span></pre><tr><td data-num=64><td><pre>    <span class="token comment"># have to use claripy's built in function that deals with if statements.</span></pre><tr><td data-num=65><td><pre>    <span class="token comment"># claripy.If(expression, ret_if_true, ret_if_false) will output an</span></pre><tr><td data-num=66><td><pre>    <span class="token comment"># expression that evaluates to ret_if_true if expression is true and</span></pre><tr><td data-num=67><td><pre>    <span class="token comment"># ret_if_false otherwise.</span></pre><tr><td data-num=68><td><pre>    <span class="token comment"># Think of it like the Python "value0 if expression else value1".</span></pre><tr><td data-num=69><td><pre>    state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">=</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span></pre><tr><td data-num=70><td><pre>      user_input_string <span class="token operator">==</span> check_against_string<span class="token punctuation">,</span> </pre><tr><td data-num=71><td><pre>      claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </pre><tr><td data-num=72><td><pre>      claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre><tr><td data-num=73><td><pre>    <span class="token punctuation">)</span></pre><tr><td data-num=74><td><pre></pre><tr><td data-num=75><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=76><td><pre></pre><tr><td data-num=77><td><pre>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=78><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=79><td><pre>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=80><td><pre></pre><tr><td data-num=81><td><pre>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=82><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=83><td><pre>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=84><td><pre></pre><tr><td data-num=85><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre><tr><td data-num=86><td><pre></pre><tr><td data-num=87><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=88><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=89><td><pre></pre><tr><td data-num=90><td><pre>    <span class="token comment"># Since we are allowing Angr to handle the input, retrieve it by printing</span></pre><tr><td data-num=91><td><pre>    <span class="token comment"># the contents of stdin. Use one of the early levels as a reference.</span></pre><tr><td data-num=92><td><pre>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=93><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre><tr><td data-num=94><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=95><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre><tr><td data-num=96><td><pre></pre><tr><td data-num=97><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=98><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><h4 id=10_angr_simprocedures><a class=anchor href=#10_angr_simprocedures>#</a> 10_angr_simprocedures</h4><p><img alt=image-20231025094815541 data-src=angr%E5%88%9D%E6%8E%A2/image-20231025094815541.png loading=lazy><p>将 check 部分的 basic block 拆了很多很多，看源码是加了不透明谓词和分发块：<p><img alt=image-20231025094941057 data-src=angr%E5%88%9D%E6%8E%A2/image-20231025094941057.png loading=lazy><p>ida 做了的伪代码做了代码优化，看起来其实和前面两个题差不多<p>但是下面这种写法不行，不知道是为啥不能这样 hook，这样 hook 的话约束不出来解：<p>（先 hook 找输入的地址，然后手写 check，但是约束不出来，跑出来空解）<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=4><td><pre>user_input_buffer_address <span class="token operator">=</span> <span class="token number">0</span></pre><tr><td data-num=5><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=6><td><pre>    path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=7><td><pre>    project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre>    </pre><tr><td data-num=9><td><pre>    password <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">16</span><span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre></pre><tr><td data-num=11><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x8049310</span><span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre>    <span class="token keyword">def</span> <span class="token function">skip_check_equals_</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=13><td><pre>        <span class="token keyword">global</span> user_input_buffer_address</pre><tr><td data-num=14><td><pre>        user_input_buffer_address <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span></pre><tr><td data-num=15><td><pre>        state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>user_input_buffer_address<span class="token punctuation">,</span> password<span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre></pre><tr><td data-num=17><td><pre>    check_equals_called_address <span class="token operator">=</span> <span class="token number">0x8049362</span></pre><tr><td data-num=18><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=19><td><pre>    simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>check_equals_called_address<span class="token punctuation">)</span></pre><tr><td data-num=20><td><pre></pre><tr><td data-num=21><td><pre>    <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=22><td><pre>        check_against_string <span class="token operator">=</span> <span class="token string">b'PPBVDNMJABAQHZQQ'</span></pre><tr><td data-num=23><td><pre>        solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=24><td><pre>        user_input_string <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre><tr><td data-num=25><td><pre>            user_input_buffer_address<span class="token punctuation">,</span></pre><tr><td data-num=26><td><pre>            <span class="token number">16</span></pre><tr><td data-num=27><td><pre>        <span class="token punctuation">)</span></pre><tr><td data-num=28><td><pre>        solution_state<span class="token punctuation">.</span>add_constraints<span class="token punctuation">(</span>user_input_string <span class="token operator">==</span> check_against_string<span class="token punctuation">)</span></pre><tr><td data-num=29><td><pre></pre><tr><td data-num=30><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=31><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=32><td><pre>        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre><tr><td data-num=33><td><pre></pre><tr><td data-num=34><td><pre></pre><tr><td data-num=35><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=36><td><pre>    main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><p>看看官方的吧：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=4><td><pre></pre><tr><td data-num=5><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=6><td><pre>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=7><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span></pre><tr><td data-num=10><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=11><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=12><td><pre>  <span class="token punctuation">)</span></pre><tr><td data-num=13><td><pre></pre><tr><td data-num=14><td><pre>  <span class="token keyword">class</span> <span class="token class-name">ReplacementCheckEquals</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=15><td><pre>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> to_check<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=16><td><pre>      user_input_buffer_address <span class="token operator">=</span> to_check</pre><tr><td data-num=17><td><pre>      user_input_buffer_length <span class="token operator">=</span> length</pre><tr><td data-num=18><td><pre></pre><tr><td data-num=19><td><pre>      user_input_string <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span></pre><tr><td data-num=20><td><pre>        user_input_buffer_address<span class="token punctuation">,</span></pre><tr><td data-num=21><td><pre>        user_input_buffer_length</pre><tr><td data-num=22><td><pre>      <span class="token punctuation">)</span></pre><tr><td data-num=23><td><pre></pre><tr><td data-num=24><td><pre>      check_against_string <span class="token operator">=</span> <span class="token string">'OSIWHBXIFOQVSBZB'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=25><td><pre></pre><tr><td data-num=26><td><pre>      <span class="token keyword">return</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span></pre><tr><td data-num=27><td><pre>        user_input_string <span class="token operator">==</span> check_against_string<span class="token punctuation">,</span></pre><tr><td data-num=28><td><pre>        claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre><tr><td data-num=29><td><pre>        claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre><tr><td data-num=30><td><pre>      <span class="token punctuation">)</span></pre><tr><td data-num=31><td><pre></pre><tr><td data-num=32><td><pre>  check_equals_symbol <span class="token operator">=</span> <span class="token string">'check_equals_OSIWHBXIFOQVSBZB'</span> <span class="token comment"># :string</span></pre><tr><td data-num=33><td><pre>  project<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span>check_equals_symbol<span class="token punctuation">,</span> ReplacementCheckEquals<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=34><td><pre></pre><tr><td data-num=35><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=36><td><pre></pre><tr><td data-num=37><td><pre>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=38><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=39><td><pre>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=40><td><pre></pre><tr><td data-num=41><td><pre>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=42><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=43><td><pre>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=44><td><pre></pre><tr><td data-num=45><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre><tr><td data-num=46><td><pre></pre><tr><td data-num=47><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=48><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=49><td><pre></pre><tr><td data-num=50><td><pre>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=51><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre><tr><td data-num=52><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=53><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre><tr><td data-num=54><td><pre></pre><tr><td data-num=55><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=56><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><p>定义一个类，遇到 check 函数后直接 hook 并且跳过<p>简写<s>偷</s>一个，方便看：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre></pre><tr><td data-num=4><td><pre><span class="token keyword">class</span> <span class="token class-name">MyCheckEquals</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=5><td><pre>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> buffer_addr<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=6><td><pre>        <span class="token builtin">buffer</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span>buffer_addr<span class="token punctuation">,</span> length<span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre>        <span class="token keyword">return</span> claripy<span class="token punctuation">.</span>If<span class="token punctuation">(</span><span class="token builtin">buffer</span> <span class="token operator">==</span> <span class="token string">b'PPBVDNMJABAQHZQQ'</span><span class="token punctuation">,</span> claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre>proj<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span>symbol_name<span class="token operator">=</span><span class="token string">'check_equals_PPBVDNMJABAQHZQQ'</span><span class="token punctuation">,</span> simproc<span class="token operator">=</span>MyCheckEquals<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre>state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>state<span class="token punctuation">)</span></pre><tr><td data-num=13><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span></pre><tr><td data-num=14><td><pre>    find<span class="token operator">=</span><span class="token keyword">lambda</span> state <span class="token punctuation">:</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre><tr><td data-num=15><td><pre>    avoid<span class="token operator">=</span><span class="token keyword">lambda</span> state<span class="token punctuation">:</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre><span class="token punctuation">)</span></pre><tr><td data-num=17><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></table></figure><p><s>所以为啥我的跑不通</s><h4 id=11_angr_sim_scanf><a class=anchor href=#11_angr_sim_scanf>#</a> 11_angr_sim_scanf</h4><p>看起来比上个还过分一点<p><img alt=image-20231026160856414 data-src=angr%E5%88%9D%E6%8E%A2/image-20231026160856414.png loading=lazy><p>看起来是很多 <code>scanf</code> 了<p><img alt=image-20231026161037670 data-src=angr%E5%88%9D%E6%8E%A2/image-20231026161037670.png loading=lazy><p>这个从源程序看起来可以直接手动 check 秒掉，还是小写一个<p>（然后其实 check 也是不必要的，就这样 hook 就行）<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=4><td><pre>user_input_buffer_address <span class="token operator">=</span> <span class="token number">0</span></pre><tr><td data-num=5><td><pre>tmp <span class="token operator">=</span> <span class="token string">''</span></pre><tr><td data-num=6><td><pre>pwd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre><tr><td data-num=7><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=8><td><pre>    path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=9><td><pre>    project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre></pre><tr><td data-num=11><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x80492D7</span><span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre>    <span class="token keyword">def</span> <span class="token function">skip_check_equals_</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=13><td><pre>        <span class="token keyword">global</span> user_input_buffer_address<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> pwd</pre><tr><td data-num=14><td><pre>        user_input_buffer_address <span class="token operator">=</span> state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span></pre><tr><td data-num=15><td><pre>        tmp <span class="token operator">+=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span>user_input_buffer_address<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span></pre><tr><td data-num=16><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            </pre><tr><td data-num=17><td><pre>            tmp <span class="token operator">=</span> <span class="token punctuation">[</span>tmp<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre><tr><td data-num=18><td><pre>            tmp <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span></pre><tr><td data-num=19><td><pre>            pwd<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=20><td><pre>            tmp <span class="token operator">=</span> <span class="token string">''</span></pre><tr><td data-num=21><td><pre></pre><tr><td data-num=22><td><pre>    check_equals_called_address <span class="token operator">=</span> <span class="token number">0x80492E1</span></pre><tr><td data-num=23><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=24><td><pre>    simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>check_equals_called_address<span class="token punctuation">)</span></pre><tr><td data-num=25><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>pwd<span class="token punctuation">)</span></pre><tr><td data-num=26><td><pre></pre><tr><td data-num=27><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=28><td><pre>    main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><p>来看看这题想考怎么个事<pre><code># This time, the solution involves simply replacing scanf with our own version,
# since Angr does not support requesting multiple parameters with scanf.
</code></pre><p>结果<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre></pre><tr><td data-num=3><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre>state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>state<span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span></pre><tr><td data-num=7><td><pre>    find<span class="token operator">=</span><span class="token keyword">lambda</span> state <span class="token punctuation">:</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre><tr><td data-num=8><td><pre>    avoid<span class="token operator">=</span><span class="token keyword">lambda</span> state<span class="token punctuation">:</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre><span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></table></figure><p>其实可以打通的，结论是 angr 在不断进步～～，楽～～<p>不过这题还是想跟你说说 hook 系统函数的方法，其实也就是 hook 一下符号<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># This time, the solution involves simply replacing scanf with our own version,</span></pre><tr><td data-num=2><td><pre><span class="token comment"># since Angr does not support requesting multiple parameters with scanf.</span></pre><tr><td data-num=3><td><pre></pre><tr><td data-num=4><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=5><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=6><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=7><td><pre></pre><tr><td data-num=8><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=9><td><pre>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=10><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre></pre><tr><td data-num=12><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span></pre><tr><td data-num=13><td><pre>    add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=14><td><pre>                    angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=15><td><pre>  <span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre></pre><tr><td data-num=17><td><pre>  <span class="token keyword">class</span> <span class="token class-name">ReplacementScanf</span><span class="token punctuation">(</span>angr<span class="token punctuation">.</span>SimProcedure<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=18><td><pre>    <span class="token comment"># Finish the parameters to the scanf function. Hint: 'scanf("%u %u", ...)'.</span></pre><tr><td data-num=19><td><pre>    <span class="token comment"># (!)</span></pre><tr><td data-num=20><td><pre>    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> format_string<span class="token punctuation">,</span> scanf0_address<span class="token punctuation">,</span> scanf1_address<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=21><td><pre>      <span class="token comment"># Hint: scanf0_address is passed as a parameter, isn't it?</span></pre><tr><td data-num=22><td><pre>      scanf0 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'scanf0'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre><tr><td data-num=23><td><pre>      scanf1 <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'scanf1'</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span></pre><tr><td data-num=24><td><pre></pre><tr><td data-num=25><td><pre>      <span class="token comment"># The scanf function writes user input to the buffers to which the </span></pre><tr><td data-num=26><td><pre>      <span class="token comment"># parameters point.</span></pre><tr><td data-num=27><td><pre>      self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>scanf0_address<span class="token punctuation">,</span> scanf0<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">)</span></pre><tr><td data-num=28><td><pre>      self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>scanf1_address<span class="token punctuation">,</span> scanf1<span class="token punctuation">,</span> endness<span class="token operator">=</span>project<span class="token punctuation">.</span>arch<span class="token punctuation">.</span>memory_endness<span class="token punctuation">)</span></pre><tr><td data-num=29><td><pre></pre><tr><td data-num=30><td><pre>      <span class="token comment"># Now, we want to 'set aside' references to our symbolic values in the</span></pre><tr><td data-num=31><td><pre>      <span class="token comment"># globals plugin included by default with a state. You will need to</span></pre><tr><td data-num=32><td><pre>      <span class="token comment"># store multiple bitvectors. You can either use a list, tuple, or multiple</span></pre><tr><td data-num=33><td><pre>      <span class="token comment"># keys to reference the different bitvectors.</span></pre><tr><td data-num=34><td><pre>      <span class="token comment"># (!)</span></pre><tr><td data-num=35><td><pre>      self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solution0'</span><span class="token punctuation">]</span> <span class="token operator">=</span> scanf0</pre><tr><td data-num=36><td><pre>      self<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solution1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> scanf1</pre><tr><td data-num=37><td><pre></pre><tr><td data-num=38><td><pre>  scanf_symbol <span class="token operator">=</span> <span class="token string">'__isoc99_scanf'</span></pre><tr><td data-num=39><td><pre>  project<span class="token punctuation">.</span>hook_symbol<span class="token punctuation">(</span>scanf_symbol<span class="token punctuation">,</span> ReplacementScanf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=40><td><pre></pre><tr><td data-num=41><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=42><td><pre></pre><tr><td data-num=43><td><pre>  <span class="token keyword">def</span> <span class="token function">is_successful</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=44><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=45><td><pre>    <span class="token keyword">return</span> <span class="token string">'Good Job.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=46><td><pre></pre><tr><td data-num=47><td><pre>  <span class="token keyword">def</span> <span class="token function">should_abort</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=48><td><pre>    stdout_output <span class="token operator">=</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=49><td><pre>    <span class="token keyword">return</span> <span class="token string">'Try again.'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> stdout_output</pre><tr><td data-num=50><td><pre></pre><tr><td data-num=51><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>is_successful<span class="token punctuation">,</span> avoid<span class="token operator">=</span>should_abort<span class="token punctuation">)</span></pre><tr><td data-num=52><td><pre></pre><tr><td data-num=53><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=54><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=55><td><pre></pre><tr><td data-num=56><td><pre>    <span class="token comment"># Grab whatever you set aside in the globals dict.</span></pre><tr><td data-num=57><td><pre>    stored_solutions0 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solution0'</span><span class="token punctuation">]</span></pre><tr><td data-num=58><td><pre>    stored_solutions1 <span class="token operator">=</span> solution_state<span class="token punctuation">.</span><span class="token builtin">globals</span><span class="token punctuation">[</span><span class="token string">'solution1'</span><span class="token punctuation">]</span></pre><tr><td data-num=59><td><pre>    solution <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>stored_solutions0<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>stored_solutions1<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span></pre><tr><td data-num=60><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre><tr><td data-num=61><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=62><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre><tr><td data-num=63><td><pre></pre><tr><td data-num=64><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=65><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><h4 id=12_angr_veritesting><a class=anchor href=#12_angr_veritesting>#</a> 12_angr_veritesting</h4><p>？？？为什么又 hook 不成功了（这里因为代码又变了，想做一些新的尝试）<p>↓失败的代码<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=4><td><pre>user_input_buffer_address <span class="token operator">=</span> <span class="token number">0</span></pre><tr><td data-num=5><td><pre>tmp <span class="token operator">=</span> <span class="token string">''</span></pre><tr><td data-num=6><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=7><td><pre>    path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=8><td><pre>    project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre></pre><tr><td data-num=10><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x80492D6</span><span class="token punctuation">)</span></pre><tr><td data-num=11><td><pre>    <span class="token keyword">def</span> <span class="token function">skip_check_equals_</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=12><td><pre>        <span class="token keyword">global</span> tmp</pre><tr><td data-num=13><td><pre>        tmp <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=14><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>load<span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=15><td><pre></pre><tr><td data-num=16><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x8049287</span><span class="token punctuation">)</span></pre><tr><td data-num=17><td><pre>    <span class="token keyword">def</span> <span class="token function">skip_check_equals_</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>length <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=18><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span></pre><tr><td data-num=19><td><pre>    </pre><tr><td data-num=20><td><pre>    check_equals_called_address <span class="token operator">=</span> <span class="token number">0x80492EB</span></pre><tr><td data-num=21><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=22><td><pre>    simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>check_equals_called_address<span class="token punctuation">)</span></pre><tr><td data-num=23><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span></pre><tr><td data-num=24><td><pre></pre><tr><td data-num=25><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=26><td><pre>    main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><p>这里进行一点 debug 看看...<p>修改代码如下：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre>user_input_buffer_address <span class="token operator">=</span> <span class="token number">0</span></pre><tr><td data-num=4><td><pre>tmp <span class="token operator">=</span> <span class="token string">''</span></pre><tr><td data-num=5><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=6><td><pre>    project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre></pre><tr><td data-num=8><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x80492D6</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre>    <span class="token keyword">def</span> <span class="token function">hook_for_fun</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=10><td><pre>        <span class="token keyword">global</span> tmp</pre><tr><td data-num=11><td><pre>        tmp <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre>        <span class="token comment"># print( state.solver.eval((state.solver.eval(state.regs.eax))) )   </span></pre><tr><td data-num=13><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">)</span></pre><tr><td data-num=14><td><pre></pre><tr><td data-num=15><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x8049287</span><span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre>    <span class="token keyword">def</span> <span class="token function">skip_scanf</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=17><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span></pre><tr><td data-num=18><td><pre></pre><tr><td data-num=19><td><pre>    check_equals_called_address <span class="token operator">=</span> <span class="token number">0x80492EB</span></pre><tr><td data-num=20><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=21><td><pre></pre><tr><td data-num=22><td><pre>    <span class="token comment"># @project.hook(0x80492B5)</span></pre><tr><td data-num=23><td><pre>    <span class="token comment"># def skip_stash(state, length = 14):</span></pre><tr><td data-num=24><td><pre>    <span class="token comment">#     nonlocal simulation</span></pre><tr><td data-num=25><td><pre>    <span class="token comment">#     print("len : " + str(len(simulation.stashes)))</span></pre><tr><td data-num=26><td><pre></pre><tr><td data-num=27><td><pre>    simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>check_equals_called_address<span class="token punctuation">)</span></pre><tr><td data-num=28><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span></pre><tr><td data-num=29><td><pre></pre><tr><td data-num=30><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=31><td><pre>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></table></figure><p>打印的内容如下：<pre><code>T W W Z Z Z Z C C C C C C C C F F F F F F F F F F F F F F F F I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I I L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L L
</code></pre><p>实际上，这里去重之后就是正确答案了，说明这里出现了路径爆炸，在某个地方被分化，stash 内路径数量翻倍了，导致每次 bfs 路径都幂指数上升了<p>猜测是因为输入的不确定，在赋值的时候就需要 hook 掉，把这段补上（打印 stash 的长度看眼）：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x80492B5</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre>    <span class="token keyword">def</span> <span class="token function">skip_stash</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=3><td><pre>        <span class="token keyword">nonlocal</span> simulation</pre><tr><td data-num=4><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"len : "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>simulation<span class="token punctuation">.</span>stashes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></table></figure><p>看一下目前 hook 后剩下的代码（ida 中 patch 替代）<p><img alt=image-20231027152918240 data-src=angr%E5%88%9D%E6%8E%A2/image-20231027152918240.png loading=lazy><p>晚上睡前想着，会不会是循环的时候 <code>jle</code> 给分化出来了 stash，但是早起看了眼前面的程序，也是循环应该没有问题的<p>加上上面又 hook 的代码，输出大约如下：<pre><code>len : 9
T len : 9
len : 9
W W len : 9
len : 9
len : 9
len : 9
Z Z Z Z len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
C C C C C C C C len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
len : 9
F F F F F F F F F F F F F F F F len : 9
</code></pre><p>结果 stash 长度并没有变化，但是仍旧有路径分化的现象，这就有些闹鬼了<p>打在上面看看：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre>user_input_buffer_address <span class="token operator">=</span> <span class="token number">0</span></pre><tr><td data-num=4><td><pre>tmp <span class="token operator">=</span> <span class="token string">''</span></pre><tr><td data-num=5><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=6><td><pre>    project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre></pre><tr><td data-num=8><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x80492D6</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre>    <span class="token keyword">def</span> <span class="token function">hook_for_fun</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=10><td><pre>        <span class="token keyword">global</span> tmp</pre><tr><td data-num=11><td><pre>        tmp <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=12><td><pre>        <span class="token comment"># print( state.solver.eval((state.solver.eval(state.regs.eax))) )   </span></pre><tr><td data-num=13><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">)</span></pre><tr><td data-num=14><td><pre>        <span class="token keyword">nonlocal</span> simulation</pre><tr><td data-num=15><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"len : "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>simulation<span class="token punctuation">.</span>stashes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=16><td><pre></pre><tr><td data-num=17><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x8049287</span><span class="token punctuation">)</span></pre><tr><td data-num=18><td><pre>    <span class="token keyword">def</span> <span class="token function">skip_scanf</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=19><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'---'</span><span class="token punctuation">)</span></pre><tr><td data-num=20><td><pre></pre><tr><td data-num=21><td><pre>    check_equals_called_address <span class="token operator">=</span> <span class="token number">0x80492EB</span></pre><tr><td data-num=22><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=23><td><pre></pre><tr><td data-num=24><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x80492B5</span><span class="token punctuation">)</span></pre><tr><td data-num=25><td><pre>    <span class="token keyword">def</span> <span class="token function">skip_stash</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=26><td><pre>        <span class="token number">1</span> <span class="token operator">==</span> <span class="token number">1</span></pre><tr><td data-num=27><td><pre></pre><tr><td data-num=28><td><pre>    simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>check_equals_called_address<span class="token punctuation">)</span></pre><tr><td data-num=29><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span></pre><tr><td data-num=30><td><pre></pre><tr><td data-num=31><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=32><td><pre>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></table></figure><p>结论是 stash 还是 9，为啥 9 啊，整个程序才 9 个 <code>basic block</code> ，结束地址前面已经不存在分支了<p>这里直接从 scanf 后面开始 <code>init blank_state</code> 也是一样的结果，说明不是 <code>scanf</code> 或者环境变量传入的问题<p>问了 r1mao 学长，发现这里对 <code>stash</code> 和 <code>state</code> 的理解有点问题了：<p>state 会分在不同 types 的 stash，如果这里打印 <code>simulation.active</code> 的话，得到的就是当前的 state 数量，和执行的重复数量结果是一致的<pre><code>active len : 32
stashLen : 9
</code></pre><p>打印一下 stash 和 state 的结构<br> 实际上是这样子的<pre><code>stash:
----------------------------------------------------------------------------------------
active              |              kill              |              etc.          
   |							    |							     |
   ----> active state               ----> killed state				 ----> else state
</code></pre><p>所以应该这样子用：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre>simulation<span class="token punctuation">.</span>stashes<span class="token punctuation">[</span><span class="token string">'active'</span><span class="token punctuation">]</span></pre></table></figure><p>检查一下是不是 <code>jle</code> 惹的锅<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x80492E9</span><span class="token punctuation">)</span></pre><tr><td data-num=2><td><pre>    <span class="token keyword">def</span> <span class="token function">test01</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=3><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"len before jle"</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>simulation<span class="token punctuation">.</span>stashes<span class="token punctuation">[</span><span class="token string">'active'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre></pre><tr><td data-num=5><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x80492B5</span><span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre>    <span class="token keyword">def</span> <span class="token function">test01</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=7><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"len after jle"</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>simulation<span class="token punctuation">.</span>stashes<span class="token punctuation">[</span><span class="token string">'active'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></table></figure><pre><code>不是，那还好：
len before jle 1
len after jle 1
len before jle 2
len before jle 2
len after jle 2
len after jle 2
</code></pre><p>同理，只剩一个地方了...<p><img alt=image-20231027202218062 data-src=angr%E5%88%9D%E6%8E%A2/image-20231027202218062.png loading=lazy><p>这下赛博鬼抓到了...hook 以后机器指令没跳过去...<p>ok，找到了，语法错误，也没报...<p>exp：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=3><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=4><td><pre>tmp <span class="token operator">=</span> <span class="token string">''</span></pre><tr><td data-num=5><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=6><td><pre>    project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">"./angr"</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre></pre><tr><td data-num=8><td><pre>    start_address <span class="token operator">=</span> <span class="token number">0x80492A5</span></pre><tr><td data-num=9><td><pre>    initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>blank_state<span class="token punctuation">(</span></pre><tr><td data-num=10><td><pre>      addr<span class="token operator">=</span>start_address<span class="token punctuation">,</span></pre><tr><td data-num=11><td><pre>      add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=12><td><pre>                      angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=13><td><pre>    <span class="token punctuation">)</span></pre><tr><td data-num=14><td><pre>    simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=15><td><pre></pre><tr><td data-num=16><td><pre>    address_to_check_constraint <span class="token operator">=</span> <span class="token number">0x80492EB</span></pre><tr><td data-num=17><td><pre>    <span class="token decorator annotation punctuation">@project<span class="token punctuation">.</span>hook</span><span class="token punctuation">(</span><span class="token number">0x80492D6</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">)</span></pre><tr><td data-num=18><td><pre>    <span class="token keyword">def</span> <span class="token function">hook_for_fun</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=19><td><pre>        <span class="token keyword">global</span> tmp</pre><tr><td data-num=20><td><pre>        tmp <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=21><td><pre></pre><tr><td data-num=22><td><pre>    simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>address_to_check_constraint<span class="token punctuation">)</span></pre><tr><td data-num=23><td><pre></pre><tr><td data-num=24><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span></pre><tr><td data-num=25><td><pre></pre><tr><td data-num=26><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=27><td><pre>  main<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></table></figure><p>还是看看官方吧，虽然被折磨了一把...<p>这里是想教你用 <code>veritesting</code> ，这样子 <code>veritesting=True</code> 即可<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre></pre><tr><td data-num=3><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'../dist/12_angr_veritesting'</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre>state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>state<span class="token punctuation">,</span> veritesting<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span></pre><tr><td data-num=7><td><pre>    find<span class="token operator">=</span><span class="token keyword">lambda</span> state <span class="token punctuation">:</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre><tr><td data-num=8><td><pre>    avoid<span class="token operator">=</span><span class="token keyword">lambda</span> state<span class="token punctuation">:</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre><span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></table></figure><h4 id=13_angr_static_binary><a class=anchor href=#13_angr_static_binary>#</a> 13_angr_static_binary</h4><p>可以看到原本的 <code>strcmp</code> 函数被分解成了很复杂的样子，会导致 angr 陷进去出不来了，其他库函数也一样<p><img alt=image-20231027204604093 data-src=angr%E5%88%9D%E6%8E%A2/image-20231027204604093.png loading=lazy><p>这里是编译时加了静态链接的参数导致的<p><img alt=image-20231027204948008 data-src=angr%E5%88%9D%E6%8E%A2/image-20231027204948008.png loading=lazy><p>把系统函数 hook 掉换成 libc 和 glibc 里的标准符号即可<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=2><td><pre></pre><tr><td data-num=3><td><pre>proj <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span><span class="token string">'./angr'</span><span class="token punctuation">)</span></pre><tr><td data-num=4><td><pre>proj<span class="token punctuation">.</span>hook<span class="token punctuation">(</span><span class="token number">0x8051E40</span><span class="token punctuation">,</span> angr<span class="token punctuation">.</span>SIM_PROCEDURES<span class="token punctuation">[</span><span class="token string">'libc'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=5><td><pre>proj<span class="token punctuation">.</span>hook<span class="token punctuation">(</span><span class="token number">0x8051E90</span><span class="token punctuation">,</span> angr<span class="token punctuation">.</span>SIM_PROCEDURES<span class="token punctuation">[</span><span class="token string">'libc'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'scanf'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=6><td><pre>proj<span class="token punctuation">.</span>hook<span class="token punctuation">(</span><span class="token number">0x805EBE0</span><span class="token punctuation">,</span> angr<span class="token punctuation">.</span>SIM_PROCEDURES<span class="token punctuation">[</span><span class="token string">'libc'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=7><td><pre>proj<span class="token punctuation">.</span>hook<span class="token punctuation">(</span><span class="token number">0x804AB50</span><span class="token punctuation">,</span> angr<span class="token punctuation">.</span>SIM_PROCEDURES<span class="token punctuation">[</span><span class="token string">'glibc'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre><tr><td data-num=8><td><pre>state <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>entry_state<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=9><td><pre>simgr <span class="token operator">=</span> proj<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>state<span class="token punctuation">,</span> veritesting<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre><tr><td data-num=10><td><pre>simgr<span class="token punctuation">.</span>explore<span class="token punctuation">(</span></pre><tr><td data-num=11><td><pre>    find<span class="token operator">=</span><span class="token keyword">lambda</span> state <span class="token punctuation">:</span> <span class="token string">b'Good Job.'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre><tr><td data-num=12><td><pre>    avoid<span class="token operator">=</span><span class="token keyword">lambda</span> state<span class="token punctuation">:</span> <span class="token string">b'Try again.'</span> <span class="token keyword">in</span> state<span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre><tr><td data-num=13><td><pre><span class="token punctuation">)</span></pre><tr><td data-num=14><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>simgr<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>posix<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></table></figure><h4 id=14_angr_shared_library><a class=anchor href=#14_angr_shared_library>#</a> 14_angr_shared_library</h4><p>坏了，这题目编译不明白了开始<p><img alt=image-20231027205911605 data-src=angr%E5%88%9D%E6%8E%A2/image-20231027205911605.png loading=lazy><p><s>直接 gh 上拿了... 懒得研究了...</s><p>从 so 里面导入的 check：<p><img alt=image-20231027211858381 data-src=angr%E5%88%9D%E6%8E%A2/image-20231027211858381.png loading=lazy><p><img alt=image-20231027211814511 data-src=angr%E5%88%9D%E6%8E%A2/image-20231027211814511.png loading=lazy><p>直接看官方 exp 吧（也就是做了个模拟，不过这个挺经典的感觉，后面单独模拟函数会很用得上）：<figure class="highlight python"><figcaption data-lang=python></figcaption><table><tr><td data-num=1><td><pre><span class="token comment"># The shared library has the function validate, which takes a string and returns</span></pre><tr><td data-num=2><td><pre><span class="token comment"># either true (1) or false (0). The binary calls this function. If it returns</span></pre><tr><td data-num=3><td><pre><span class="token comment"># true, the program prints "Good Job." otherwise, it prints "Try again."</span></pre><tr><td data-num=4><td><pre><span class="token comment">#</span></pre><tr><td data-num=5><td><pre><span class="token comment"># Note: When you run this script, make sure you run it on</span></pre><tr><td data-num=6><td><pre><span class="token comment"># lib14_angr_shared_library.so, not the executable. This level is intended to</span></pre><tr><td data-num=7><td><pre><span class="token comment"># teach how to analyse binary formats that are not typical executables.</span></pre><tr><td data-num=8><td><pre></pre><tr><td data-num=9><td><pre><span class="token keyword">import</span> angr</pre><tr><td data-num=10><td><pre><span class="token keyword">import</span> claripy</pre><tr><td data-num=11><td><pre><span class="token keyword">import</span> sys</pre><tr><td data-num=12><td><pre></pre><tr><td data-num=13><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre><tr><td data-num=14><td><pre>  path_to_binary <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre><tr><td data-num=15><td><pre></pre><tr><td data-num=16><td><pre>  <span class="token comment"># The shared library is compiled with position-independent code. You will need</span></pre><tr><td data-num=17><td><pre>  <span class="token comment"># to specify the base address. All addresses in the shared library will be</span></pre><tr><td data-num=18><td><pre>  <span class="token comment"># base + offset, where offset is their address in the file.</span></pre><tr><td data-num=19><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=20><td><pre>  base <span class="token operator">=</span> <span class="token number">0x4000000</span></pre><tr><td data-num=21><td><pre>  project <span class="token operator">=</span> angr<span class="token punctuation">.</span>Project<span class="token punctuation">(</span>path_to_binary<span class="token punctuation">,</span> load_options<span class="token operator">=</span><span class="token punctuation">{</span></pre><tr><td data-num=22><td><pre>    <span class="token string">'main_opts'</span> <span class="token punctuation">:</span> <span class="token punctuation">{</span></pre><tr><td data-num=23><td><pre>      <span class="token string">'base_addr'</span> <span class="token punctuation">:</span> base</pre><tr><td data-num=24><td><pre>    <span class="token punctuation">}</span></pre><tr><td data-num=25><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span></pre><tr><td data-num=26><td><pre></pre><tr><td data-num=27><td><pre>  <span class="token comment"># Initialize any symbolic values here; you will need at least one to pass to</span></pre><tr><td data-num=28><td><pre>  <span class="token comment"># the validate function.</span></pre><tr><td data-num=29><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=30><td><pre>  buffer_pointer <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">0x3000000</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token comment"># 这里乱写一个就行</span></pre><tr><td data-num=31><td><pre></pre><tr><td data-num=32><td><pre>  <span class="token comment"># Begin the state at the beginning of the validate function, as if it was</span></pre><tr><td data-num=33><td><pre>  <span class="token comment"># called by the program. Determine the parameters needed to call validate and</span></pre><tr><td data-num=34><td><pre>  <span class="token comment"># replace 'parameters...' with bitvectors holding the values you wish to pass.</span></pre><tr><td data-num=35><td><pre>  <span class="token comment"># Recall that 'claripy.BVV(value, size_in_bits)' constructs a bitvector</span></pre><tr><td data-num=36><td><pre>  <span class="token comment"># initialized to a single value.</span></pre><tr><td data-num=37><td><pre>  <span class="token comment"># Remember to add the base value you specified at the beginning to the</span></pre><tr><td data-num=38><td><pre>  <span class="token comment"># function address!</span></pre><tr><td data-num=39><td><pre>  <span class="token comment"># Hint: int validate(char* buffer, int length) { ...</span></pre><tr><td data-num=40><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=41><td><pre>  validate_function_address <span class="token operator">=</span> base <span class="token operator">+</span> <span class="token number">0x670</span></pre><tr><td data-num=42><td><pre>  initial_state <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>call_state<span class="token punctuation">(</span></pre><tr><td data-num=43><td><pre>                    validate_function_address<span class="token punctuation">,</span></pre><tr><td data-num=44><td><pre>                    buffer_pointer<span class="token punctuation">,</span></pre><tr><td data-num=45><td><pre>                    claripy<span class="token punctuation">.</span>BVV<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre><tr><td data-num=46><td><pre>                    add_options <span class="token operator">=</span> <span class="token punctuation">{</span> angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_MEMORY<span class="token punctuation">,</span></pre><tr><td data-num=47><td><pre>                                   angr<span class="token punctuation">.</span>options<span class="token punctuation">.</span>SYMBOL_FILL_UNCONSTRAINED_REGISTERS<span class="token punctuation">}</span></pre><tr><td data-num=48><td><pre>                  <span class="token punctuation">)</span></pre><tr><td data-num=49><td><pre></pre><tr><td data-num=50><td><pre>  <span class="token comment"># Inject a symbolic value for the password buffer into the program and</span></pre><tr><td data-num=51><td><pre>  <span class="token comment"># instantiate the simulation. Another hint: the password is 8 bytes long.</span></pre><tr><td data-num=52><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=53><td><pre>  password <span class="token operator">=</span> claripy<span class="token punctuation">.</span>BVS<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span></pre><tr><td data-num=54><td><pre>  initial_state<span class="token punctuation">.</span>memory<span class="token punctuation">.</span>store<span class="token punctuation">(</span>buffer_pointer<span class="token punctuation">,</span> password<span class="token punctuation">)</span></pre><tr><td data-num=55><td><pre></pre><tr><td data-num=56><td><pre>  simulation <span class="token operator">=</span> project<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>simgr<span class="token punctuation">(</span>initial_state<span class="token punctuation">)</span></pre><tr><td data-num=57><td><pre></pre><tr><td data-num=58><td><pre>  <span class="token comment"># We wish to reach the end of the validate function and constrain the</span></pre><tr><td data-num=59><td><pre>  <span class="token comment"># return value of the function (stored in eax) to equal true (value of 1)</span></pre><tr><td data-num=60><td><pre>  <span class="token comment"># just before the function returns. We could use a hook, but instead we</span></pre><tr><td data-num=61><td><pre>  <span class="token comment"># can search for the address just before the function returns and then</span></pre><tr><td data-num=62><td><pre>  <span class="token comment"># constrain eax</span></pre><tr><td data-num=63><td><pre>  <span class="token comment"># (!)</span></pre><tr><td data-num=64><td><pre>  check_constraint_address <span class="token operator">=</span> base <span class="token operator">+</span> <span class="token number">0x71c</span></pre><tr><td data-num=65><td><pre>  simulation<span class="token punctuation">.</span>explore<span class="token punctuation">(</span>find<span class="token operator">=</span>check_constraint_address<span class="token punctuation">)</span></pre><tr><td data-num=66><td><pre></pre><tr><td data-num=67><td><pre>  <span class="token keyword">if</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">:</span></pre><tr><td data-num=68><td><pre>    solution_state <span class="token operator">=</span> simulation<span class="token punctuation">.</span>found<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre><tr><td data-num=69><td><pre></pre><tr><td data-num=70><td><pre>    <span class="token comment"># Determine where the program places the return value, and constrain it so</span></pre><tr><td data-num=71><td><pre>    <span class="token comment"># that it is true. Then, solve for the solution and print it.</span></pre><tr><td data-num=72><td><pre>    <span class="token comment"># (!)</span></pre><tr><td data-num=73><td><pre>    solution_state<span class="token punctuation">.</span>add_constraints<span class="token punctuation">(</span>solution_state<span class="token punctuation">.</span>regs<span class="token punctuation">.</span>eax <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre><tr><td data-num=74><td><pre>    solution <span class="token operator">=</span> solution_state<span class="token punctuation">.</span>solver<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span>cast_to<span class="token operator">=</span><span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span></pre><tr><td data-num=75><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>solution<span class="token punctuation">)</span></pre><tr><td data-num=76><td><pre>  <span class="token keyword">else</span><span class="token punctuation">:</span></pre><tr><td data-num=77><td><pre>    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">'Could not find the solution'</span><span class="token punctuation">)</span></pre><tr><td data-num=78><td><pre></pre><tr><td data-num=79><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre><tr><td data-num=80><td><pre>  main<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span></pre></table></figure><hr><p>莫名其妙的下面变成 pwn 题了...<h6 id=-pwn-><a class=anchor href=#-pwn->#</a> -pwn-</h6><h4 id=15_angr_arbitrary_read><a class=anchor href=#15_angr_arbitrary_read>#</a> 15_angr_arbitrary_read</h4><p>乍看一下就很怪了，只得翻 exp，发现是用 pwn...<p><img alt=image-20231027213412278 data-src=angr%E5%88%9D%E6%8E%A2/image-20231027213412278.png loading=lazy><p><s>那这里到了期待已久的 auto pwn 环节哩</s><div class=tags><a href=/tags/re/ rel=tag><i class="ic i-tag"></i>re</a></div></div><footer><div class=meta><span class=item><span class=icon><i class="ic i-calendar-check"></i></span><span class=text>Edited on</span><time title="Modified: 2024-05-05 09:59:16" datetime=2024-05-05T09:59:16+08:00 itemprop=dateModified>2024-05-05</time></span></div><div class=reward><button><i class="ic i-heartbeat"></i>Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*<div id=qr><div><img alt="Moyao WeChat Pay" data-src=/assets/wechatpay.png loading=lazy><p>WeChat Pay</div><div><img alt="Moyao Alipay" data-src=/assets/alipay.png loading=lazy><p>Alipay</div></div></div><div id=copyright><ul><li class=author><strong>Post author: </strong>Moyao<i class="ic i-at"><em>@</em></i>rev@天枢<li class=link><strong>Post link: </strong><a href=https://demoyao100.github.io/2023/10/24/angr%E5%88%9D%E6%8E%A2/ title=angr初探>https://demoyao100.github.io/2023/10/24/angr初探/</a><li class=license><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh rel=noopener target=_blank><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> unless stating additionally.</ul></div></footer></article></div><div class=post-nav><div class="item left"><a data-background-image=https://tva4.sinaimg.cn/mw690/6833939bly1gicitcxhpij20zk0m8hdt.jpg href=/2023/10/17/ISITDTUCTF/ itemprop=url rel=prev title=ISITDTUCTF><span class=type>Previous Post</span><h3>ISITDTUCTF</h3></a></div><div class="item right"><a data-background-image=https://tva4.sinaimg.cn/mw690/6833939bly1giciryrr3rj20zk0m8nhk.jpg href=/2023/10/25/das202310/ itemprop=url rel=next title=das202310><span class=type>Next Post</span><h3>das202310</h3></a></div></div></div><div id=sidebar><div class=inner><div class=panels><div class=inner><div class="contents panel pjax" data-title=Contents><ol class=toc><li class="toc-item toc-level-6"><a class=toc-link href=#preface%E6%9C%80%E8%BF%91%E9%81%87%E5%88%B0%E9%9C%80%E8%A6%81%E5%8A%A8%E6%80%81%E6%A8%A1%E6%8B%9F%E7%9A%84%E9%A2%98%E6%AF%94%E8%BE%83%E5%A4%9A%E8%BF%99%E9%87%8C%E8%BF%98%E6%98%AF%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B8%80%E4%B8%8Bangr><span class=toc-number>1.</span> <span class=toc-text> PREFACE：最近遇到需要动态模拟的题比较多，这里还是系统学一下 angr</span></a><li class="toc-item toc-level-6"><a class=toc-link href=#ps-angr%E7%9A%84%E6%96%87%E6%A1%A3%E8%BF%98%E6%98%AF%E5%86%99%E7%9A%84%E6%AF%94%E8%BE%83%E6%9C%89%E6%84%8F%E6%80%9D%E8%80%8C%E4%B8%94%E8%AF%A6%E7%BB%86%E7%9A%84%E9%80%82%E5%90%88%E5%BD%93%E7%9D%A1%E5%89%8D%E8%AF%BB%E7%89%A9%E7%82%B9%E5%90%8D%E6%89%B9%E8%AF%84%E6%9F%90%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E6%96%87%E6%A1%A3><span class=toc-number>2.</span> <span class=toc-text> ps. angr 的文档还是写的比较有意思而且详细的，适合当睡前读物，点名批评某二进制分析工具的文档......</span></a></ol><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5><span class=toc-number></span> <span class=toc-text> 参考链接：</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83><span class=toc-number></span> <span class=toc-text> 虚拟环境</span></a><li class="toc-item toc-level-3"><a class=toc-link href=#%E4%BD%BF%E7%94%A8%E6%A0%B7%E4%BE%8B><span class=toc-number></span> <span class=toc-text> 使用样例</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%AF%BC%E5%85%A5%E6%A8%A1%E5%9D%97><span class=toc-number></span> <span class=toc-text> 导入模块</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BD%BF%E7%94%A8%E6%97%B6%E5%8F%AF%E4%BB%A5%E5%AF%BC%E5%85%A5monkeyhex%E8%BD%AC%E5%8C%96%E4%B8%BA%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E8%BE%93%E5%87%BA><span class=toc-number></span> <span class=toc-text> 命令行使用时可以导入 monkeyhex 转化为十六进制输出</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#project%E7%9A%84%E5%9F%BA%E7%A1%80%E5%B1%9E%E6%80%A7><span class=toc-number></span> <span class=toc-text> project 的基础属性</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%AF%B9%E5%9F%BA%E6%9C%AC%E5%9D%97%E7%9A%84%E6%93%8D%E4%BD%9C><span class=toc-number></span> <span class=toc-text> 对基本块的操作</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#%E6%A8%A1%E6%8B%9F%E7%8A%B6%E6%80%81-simstate><span class=toc-number></span> <span class=toc-text> 模拟状态 SimState</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#%E6%A8%A1%E6%8B%9F%E7%AE%A1%E7%90%86%E5%99%A8-simulation-managers><span class=toc-number></span> <span class=toc-text> 模拟管理器 Simulation Managers</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#analyses><span class=toc-number></span> <span class=toc-text> Analyses</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#the-loader><span class=toc-number></span> <span class=toc-text> The Loader</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#symbols-and-relocations><span class=toc-number></span> <span class=toc-text> Symbols and Relocations</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#loading-options><span class=toc-number></span> <span class=toc-text> Loading Options</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#symbolic-function-summaries><span class=toc-number></span> <span class=toc-text> Symbolic Function Summaries</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#hook><span class=toc-number></span> <span class=toc-text> hook</span></a></ol><li class="toc-item toc-level-3"><a class=toc-link href=#%E7%AC%A6%E5%8F%B7%E6%A0%B7%E4%BE%8B><span class=toc-number></span> <span class=toc-text> 符号样例</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#bitvectors><span class=toc-number></span> <span class=toc-text> Bitvectors</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#symbolic-constraints><span class=toc-number></span> <span class=toc-text> Symbolic Constraints</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#constraint-solving><span class=toc-number></span> <span class=toc-text> Constraint Solving</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#floating-point-numbers><span class=toc-number></span> <span class=toc-text> Floating point numbers</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#more-solving-methods><span class=toc-number></span> <span class=toc-text> More Solving Methods</span></a></ol><li class="toc-item toc-level-3"><a class=toc-link href=#machine-state-memory-registers-and-so-on><span class=toc-number></span> <span class=toc-text> Machine State - memory, registers, and so on</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#state-presets><span class=toc-number></span> <span class=toc-text> State Presets</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%AF%B9%E5%86%85%E5%AD%98%E6%93%8D%E4%BD%9C><span class=toc-number></span> <span class=toc-text> 对内存操作</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#%E5%AF%B9%E5%AF%84%E5%AD%98%E5%99%A8%E6%93%8D%E4%BD%9C><span class=toc-number></span> <span class=toc-text> 对寄存器操作</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#state-options><span class=toc-number></span> <span class=toc-text> State Options</span></a></ol><li class="toc-item toc-level-3"><a class=toc-link href=#plugins><span class=toc-number></span> <span class=toc-text> Plugins</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#state-plugins><span class=toc-number></span> <span class=toc-text> State Plugins</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#the-globals-plugin><span class=toc-number></span> <span class=toc-text> The globals plugin</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#the-history-plugin><span class=toc-number></span> <span class=toc-text> The history plugin</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#the-callstack-plugin><span class=toc-number></span> <span class=toc-text> The callstack plugin</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#io><span class=toc-number></span> <span class=toc-text> I/O</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#copying-and-merging><span class=toc-number></span> <span class=toc-text> Copying and Merging</span></a></ol><li class="toc-item toc-level-3"><a class=toc-link href=#simulation-managers><span class=toc-number></span> <span class=toc-text> Simulation Managers</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#stepping><span class=toc-number></span> <span class=toc-text> Stepping</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#stash-management><span class=toc-number></span> <span class=toc-text> Stash Management</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#stash-types><span class=toc-number></span> <span class=toc-text> Stash types</span></a></ol><li class="toc-item toc-level-3"><a class=toc-link href=#exploration><span class=toc-number></span> <span class=toc-text> Exploration</span></a><li class="toc-item toc-level-3"><a class=toc-link href=#exploration-techniques><span class=toc-number></span> <span class=toc-text> Exploration Techniques</span></a><li class="toc-item toc-level-3"><a class=toc-link href=#simulation-and-instrumentation><span class=toc-number></span> <span class=toc-text> Simulation and Instrumentation</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#breakpoints><span class=toc-number></span> <span class=toc-text> Breakpoints</span></a><ol class=toc-child><li class="toc-item toc-level-5"><a class=toc-link href=#caution-about-mem_read-breakpoint><span class=toc-number></span> <span class=toc-text> Caution about mem_read breakpoint</span></a></ol></ol><li class="toc-item toc-level-3"><a class=toc-link href=#analyses-2><span class=toc-number></span> <span class=toc-text> Analyses</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#resilience><span class=toc-number></span> <span class=toc-text> Resilience</span></a></ol><li class="toc-item toc-level-3"><a class=toc-link href=#symbolic-execution><span class=toc-number></span> <span class=toc-text> Symbolic Execution</span></a><ol class=toc-child><li class="toc-item toc-level-6"><a class=toc-link href=#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E9%87%8C%E6%98%AFtodo><span class=toc-number>1.</span> <span class=toc-text> 为什么这里是 todo...</span></a></ol><li class="toc-item toc-level-3"><a class=toc-link href=#angr_ctf><span class=toc-number></span> <span class=toc-text> angr_ctf</span></a><ol class=toc-child><li class="toc-item toc-level-6"><a class=toc-link href=#%E5%AE%98%E6%96%B9%E7%BB%99%E7%9A%84%E6%A0%B7%E4%BE%8B%E6%96%87%E6%A1%A3%E9%87%8C%E8%BF%98%E6%9C%89%E5%BE%88%E5%A4%9A%E7%9C%9F%E5%AE%9Ectf%E6%AF%94%E8%B5%9B%E7%9A%84%E4%BE%8B%E9%A2%98orz%E5%88%9D%E6%8E%A2%E5%B0%B1%E5%81%9A%E5%88%B0%E8%BF%99%E9%87%8C%E5%90%A7><span class=toc-number>1.</span> <span class=toc-text> 官方给的样例，文档里还有很多真实 ctf 比赛的例题 orz，初探就做到这里吧</span></a></ol><li class="toc-item toc-level-4"><a class=toc-link href=#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE><span class=toc-number></span> <span class=toc-text> 环境配置</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#00_angr_find><span class=toc-number></span> <span class=toc-text> 00_angr_find</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#01_angr_avoid><span class=toc-number></span> <span class=toc-text> 01_angr_avoid</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#02_angr_find_condition><span class=toc-number></span> <span class=toc-text> 02_angr_find_condition</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#03_angr_symbolic_registers><span class=toc-number></span> <span class=toc-text> 03_angr_symbolic_registers</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#04_angr_symbolic_stack><span class=toc-number></span> <span class=toc-text> 04_angr_symbolic_stack</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#05_angr_symbolic_memory><span class=toc-number></span> <span class=toc-text> 05_angr_symbolic_memory</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#06_angr_symbolic_dynamic_memory><span class=toc-number></span> <span class=toc-text> 06_angr_symbolic_dynamic_memory</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#07_angr_symbolic_file><span class=toc-number></span> <span class=toc-text> 07_angr_symbolic_file</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#08_angr_constraints><span class=toc-number></span> <span class=toc-text> 08_angr_constraints</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#09_angr_hooks><span class=toc-number></span> <span class=toc-text> 09_angr_hooks</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#10_angr_simprocedures><span class=toc-number></span> <span class=toc-text> 10_angr_simprocedures</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#11_angr_sim_scanf><span class=toc-number></span> <span class=toc-text> 11_angr_sim_scanf</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#12_angr_veritesting><span class=toc-number></span> <span class=toc-text> 12_angr_veritesting</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#13_angr_static_binary><span class=toc-number></span> <span class=toc-text> 13_angr_static_binary</span></a><li class="toc-item toc-level-4"><a class=toc-link href=#14_angr_shared_library><span class=toc-number></span> <span class=toc-text> 14_angr_shared_library</span></a><ol class=toc-child><li class="toc-item toc-level-6"><a class=toc-link href=#-pwn-><span class=toc-number>1.</span> <span class=toc-text> -pwn-</span></a></ol><li class="toc-item toc-level-4"><a class=toc-link href=#15_angr_arbitrary_read><span class=toc-number></span> <span class=toc-text> 15_angr_arbitrary_read</span></a></div><div class="related panel pjax" data-title=Related></div><div class="overview panel" data-title=Overview><div class=author itemprop=author itemscope itemtype=http://schema.org/Person><img alt=Moyao class=image data-src=/assets/avatar.jpg itemprop=image loading=lazy><p class=name itemprop=name>Moyao<div class=description itemprop=description>Write down something interesting I met<br> Feel free to mail me if you have something wanted to talk about, plz mail: &LTmoyaoxue@outlook.com></div></div><nav class=state><div class="item posts"><a href=/archives/><span class=count>74</span><span class=name>posts</span></a></div><div class="item tags"><a href=/tags/><span class=count>14</span><span class=name>tags</span></a></div></nav><div class=social><a class="item github" href=https://github.com/name rel=noopener target=_blank title=https://github.com/name><i class="ic i-github"></i></a></div><div class=menu><li class=item><a href=/ rel=section><i class="ic i-home"></i>Home</a></div></div></div></div><ul id=quick><li class="prev pjax"><a title="Previous Post" href=/2023/10/25/das202310/ rel=prev><i class="ic i-chevron-left"></i></a><li class=up><i class="ic i-arrow-up"></i><li class=down><i class="ic i-arrow-down"></i><li class="next pjax"><a title="Next Post" href=/2023/10/17/ISITDTUCTF/ rel=next><i class="ic i-chevron-right"></i></a><li class=percent></ul></div></div><div class=dimmer></div></div></main><footer id=footer><div class=inner><div class=widgets><div class="rpost pjax"><h2>Random Posts</h2><ul><li class=item><div class=breadcrumb></div><span><a href=/2023/07/18/junk-code-demo/>junk code demo</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/03/03/VM/>VM</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/10/04/flare-on2023/>flare-on2023</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/11/13/%E3%80%8A%E8%A2%AB%E8%AE%A8%E5%8E%8C%E7%9A%84%E5%8B%87%E6%B0%94%E3%80%8B/>《被讨厌的勇气》</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/11/26/das202311%E6%9C%88%E8%B5%9B/>das202311月赛</a></span><li class=item><div class=breadcrumb></div><span><a href=/2024/05/03/%E4%B8%8D%E5%90%8C%E7%9A%84android-hook%E5%A7%BF%E5%8A%BF/>不同的android hook姿势</a></span><li class=item><div class=breadcrumb></div><span><a href=/2024/03/28/flutter%E5%BC%80%E5%8F%91%E5%88%9D%E6%8E%A2/>flutter开发初探</a></span><li class=item><div class=breadcrumb></div><span><a href=/2022/09/02/codeforce-817E/>codeforce-817E</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/11/27/%E3%80%8A%E6%9D%80%E6%AD%BB%E4%B8%80%E5%8F%AA%E7%9F%A5%E6%9B%B4%E9%B8%9F%E3%80%8B/>《杀死一只知更鸟》</a></span><li class=item><div class=breadcrumb></div><span><a href=/2023/10/02/BuckeyeCTF2023/>BuckeyeCTF2023</a></span></ul></div><div class="rpost pjax"><h2>Recent Comments</h2><ul class=leancloud-recent-comment id=new-comment></ul></div></div><div class=status><div class=copyright>© 2022 -<span itemprop=copyrightYear>2024</span><span class=with-love><i class="ic i-sakura rotate"></i></span><span class=author itemprop=copyrightHolder>Moyao @ Moyao の小屋</span></div><div class=count><span class=post-meta-item-icon><i class="ic i-chart-area"></i></span><span title="Symbols count total">649k words</span><span class=post-meta-divider>|</span><span class=post-meta-item-icon><i class="ic i-coffee"></i></span><span title="Reading time total">9:50</span></div><div class=powered-by>Powered by <a href=https://hexo.io/ rel=noopener target=_blank>Hexo</a> & Theme.<a href=https://github.com/theme-shoka-x/hexo-theme-shokaX/ rel=noopener target=_blank>ShokaX</a></div></div></div></footer></div><script data-config>var LOCAL = {
        path: `2023/10/24/angr初探/`,
        favicon: {
        show: `(●´3｀●) Here we go again.`,
        hide: `(´Д｀) It's a disaster!`
    },
    search: {
        placeholder: "Search for Posts",
        empty: "We didn't find any results for the search: ${query}",
        stats: "${hits} results found in ${time} ms"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">Article Timeliness Alert</span><br>This is an article published {{publish}} days ago and last updated {{updated}} days ago. Some information may have changed, so please be careful to screen it.</p></div>`,
    quiz: {
        choice: `Multiple Choice`,
        multiple: `Multiple Answer`,
        true_false: `True/False`,
        essay: `Questions`,
        gap_fill: `Gap Filling`,
        mistake: `Wrong Answer`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};</script><script src=https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.prod.min.js></script><script src=https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.2.4/pace.min.js></script><script src=https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/algoliasearch/4.12.1/algoliasearch-lite.umd.min.js></script><script src=https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/instantsearch.js/4.39.0/instantsearch.production.min.js></script><script src=https://npm.webcache.cn/quicklink@2.3.0/dist/quicklink.umd.js></script><script src=/js/app.js?v=0.3.15></script>