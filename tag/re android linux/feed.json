{
    "version": "https://jsonfeed.org/version/1",
    "title": "Moyao の小屋 • All posts by \"re android linux\" tag",
    "description": "Write down something interesting I met<br />\nFeel free to mail me if you have something wanted to talk about, plz\nmail: &lt;moyaoxue@outlook.com&gt;\n",
    "home_page_url": "https://demoyao100.github.io",
    "items": [
        {
            "id": "https://demoyao100.github.io/selinux%E5%88%9D%E6%8E%A2/",
            "url": "https://demoyao100.github.io/selinux%E5%88%9D%E6%8E%A2/",
            "title": "selinux初探",
            "date_published": "2024-05-03T11:37:56.000Z",
            "content_html": "<p>PREFACE：啥也不懂，爬来学学</p>\n<span id=\"more\"></span>\n<h3 id=\"linux-控制访问模型\"><a class=\"markdownIt-Anchor\" href=\"#linux-控制访问模型\">#</a> linux 控制访问模型</h3>\n<p><a href=\"https://elixir.bootlin.com/linux/v5.10-rc4/source/include/linux/sched.h#L632\">sched.h - include/linux/sched.h - Linux source code (v5.10-rc4) - Bootlin</a></p>\n<p>运行一个程序本质上是当前用户有没有权限访问并运行该文件、是否有创建进程的权限，以及新进程如何继承当前进程的属性</p>\n<figure class=\"highlight jsx\"><figcaption data-lang=\"React JSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>struct task_struct <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t#ifdef <span class=\"token constant\">CONFIG_THREAD_INFO_IN_TASK</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t * For reasons of header soup (see current_thread_info()), this</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t * must be the first element of task_struct.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t */</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tstruct thread_info\t\tthread_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>#endif</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">/* -1 unrunnable, 0 runnable, >0 stopped: */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tvolatile long\t\t\tstate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t * This begins the randomizable portion of task_struct. Only</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t * scheduling-critical items should be added above here.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t */</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\trandomized_struct_fields_start</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">void</span>\t\t\t\t<span class=\"token operator\">*</span>stack<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\trefcount_t\t\t\tusage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">/* Per task flags (PF_*), defined further below: */</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tunsigned int\t\t\tflags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tunsigned int\t\t\tptrace<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">//...</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  struct sched_info\t\tsched_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tstruct list_head\t\ttasks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tstruct mm_struct\t\t<span class=\"token operator\">*</span>mm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tstruct mm_struct\t\t<span class=\"token operator\">*</span>active_mm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\">/* Real parent process: */</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tstruct task_struct __rcu\t<span class=\"token operator\">*</span>real_parent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">/* Recipient of SIGCHLD, wait4() reports: */</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tstruct task_struct __rcu\t<span class=\"token operator\">*</span>parent<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tstruct list_head\t\tptraced<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tstruct list_head\t\tptrace_entry<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token comment\">/* PID/PID hash table linkage. */</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tstruct pid\t\t\t<span class=\"token operator\">*</span>thread_pid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tstruct hlist_node\t\tpid_links<span class=\"token punctuation\">[</span><span class=\"token constant\">PIDTYPE_MAX</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tstruct list_head\t\tthread_group<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tstruct list_head\t\tthread_node<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token comment\">/* Process credentials: */</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token comment\">/* Tracer's credentials at attach: */</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token keyword\">const</span> struct cred __rcu\t\t<span class=\"token operator\">*</span>ptracer_cred<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token comment\">/* Objective and real subjective task credentials (COW): */</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token keyword\">const</span> struct cred __rcu\t\t<span class=\"token operator\">*</span>real_cred<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token comment\">/* Effective (overridable) subjective task credentials (COW): */</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token keyword\">const</span> struct cred __rcu\t\t<span class=\"token operator\">*</span>cred<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  char\t\t\t\tcomm<span class=\"token punctuation\">[</span><span class=\"token constant\">TASK_COMM_LEN</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  struct seccomp\t\t\tseccomp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  \t<span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t * New fields for task_struct should be added above here, so that</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t * they are included in the randomized portion of task_struct.</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t */</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\trandomized_struct_fields_end</pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token comment\">/* CPU-specific state of this task: */</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\tstruct thread_struct\t\tthread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t * WARNING: on x86, 'thread_struct' contains a variable-sized</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t * structure.  It *MUST* be at the end of 'task_struct'.</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t *</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t * Do not put anything below here!</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t */</pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"mac\"><a class=\"markdownIt-Anchor\" href=\"#mac\">#</a> MAC</h3>\n<p>MAC 即 <strong>Mandatory Access Control</strong>，用于将系统中的信息分密级和类进行管理，以保证每个用户只能访问到那些被标明可以由他访问的信息的一种访问约束机制。在强制访问控制下，用户 (或其他主体) 与文件 ((其他客体) 都被标记了固定的安全属性 (如安全级、访问权限等)，在每次访问发生时，系统检测安全属性以便确定一个用户是否有权访问该文件。其中 SELinux 和 <a href=\"https://en.wikipedia.org/wiki/AppArmor\">AppArmor</a> 就是 Linux 中典型的强制访问控制实现。</p>\n<h3 id=\"dac\"><a class=\"markdownIt-Anchor\" href=\"#dac\">#</a> DAC</h3>\n<p>DAC 即 <strong>Discretionary Access Control</strong>，称为自主访问控制。在 Linux 中最为常见的一种访问控制方案，即用户可以自主选择控制哪些用户可以共享他的文件，有两种自主访问控制策略，分别是文件权限码和访问控制列表 ACL (Access Control List)。</p>\n<p>文件权限码</p>\n<figure class=\"highlight jsx\"><figcaption data-lang=\"React JSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ ls <span class=\"token operator\">-</span>l test</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">-</span>rw<span class=\"token operator\">-</span>r<span class=\"token operator\">--</span>r<span class=\"token operator\">--</span> <span class=\"token number\">1</span> pan staff <span class=\"token number\">0</span> Nov <span class=\"token number\">21</span> <span class=\"token number\">14</span><span class=\"token operator\">:</span><span class=\"token number\">35</span> test</pre></td></tr></table></figure><p>分别表示当前用户 (user/owner)、用户组 (group) 和其他用户 (other) 对应的 读、写、执行 (rwx) 访问权限，可以参考 <a href=\"https://linux.die.net/man/1/chmod\">chmod(1)</a>。实际上在 Linux 操作系统中在前面还增加了三位，分别是:</p>\n<ul>\n<li><strong>S_ISUID</strong> (04000): SETUID 位，用于在 exeve 系统调用时设置进程的有效用户 ID (effective user ID)；</li>\n<li><strong>S_ISGID</strong> (02000): SETGID 位，和 SETUID 类似，从父目录中继承；</li>\n<li><strong>S_ISVTX</strong> (01000): sticky bit，即防删除位，防止其他用户删除公共文件，通常用于 <code>/tmp</code>  目录下；</li>\n</ul>\n<p>通过文件权限码可以实现一定程度上的自主访问控制，但是对于多用户系统而言只能通过用户组去管理，无法控制某个文件可以让用户 A 访问而不让用户 B 访问。ACL 就是为了实现这个目标而出现的。例如，需要单独给某个用户添加文件的读权限如下:</p>\n<pre><code>$ setfacl -m u:evilpan:r /etc/passwd\n</code></pre>\n<hr>\n<p>具体命令可以参考 <a href=\"https://linux.die.net/man/1/setfacl\">setfacl(1)</a>，ACL 需要内核和文件系统的支持。</p>\n<p>DAC 和 MAC 的对比</p>\n<p>在 DAC 模式下，只要相应目录有相应用户的权限，就可以被访问。而在 MAC 模式下，还要受进程允许访问目录范围的限制。</p>\n<h3 id=\"uid\"><a class=\"markdownIt-Anchor\" href=\"#uid\">#</a> UID</h3>\n<p>对于操作系统而言，为了方便管理，用户和组都分别对应数字 ID，即 UID 和 GID。传统上获取 root 权限就是执行下 <code>su</code>  程序，即可获得一个 root shell。一般情况下 su 是一个设置了 SETUID 位的程序，并且 owner 是 root 用户。普通用户执行该程序只是上是对该文件执行了 execve 系统调用，也就是说，内核会根据 SETUID 位来调整当前进程的权限，这主要是通过有效用户 ID 去实现的。</p>\n<p>Linux 中的用户 ID 分为 <strong>real user id</strong> 和 <strong>effective user id</strong>，这样区分的原因是进程在执行过程中需要动态切换到其他用户，如果只有一个用户 ID，那么切换之后就无法换回原来的用户了。因此前者用来表示进程的真实用户，后者用来表示当前所表示的有效用户。</p>\n<p>在内核上面介绍的 task_struct 中有一个 <strong>struct cred</strong> 字段，该字段对应的结构就包含了当前任务的安全相关上下文信息，其中就有 uid:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">cred</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tatomic_t\tusage<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">CONFIG_DEBUG_CREDENTIALS</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tatomic_t\tsubscribers<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* number of processes subscribed */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">void</span>\t\t<span class=\"token operator\">*</span>put_addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span>\tmagic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CRED_MAGIC</span>\t<span class=\"token expression\"><span class=\"token number\">0x43736564</span></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">CRED_MAGIC_DEAD</span>\t<span class=\"token expression\"><span class=\"token number\">0x44656144</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tkuid_t\t\tuid<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* real UID of the task */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tkgid_t\t\tgid<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* real GID of the task */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tkuid_t\t\tsuid<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* saved UID of the task */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tkgid_t\t\tsgid<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* saved GID of the task */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tkuid_t\t\teuid<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* effective UID of the task */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\tkgid_t\t\tegid<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* effective GID of the task */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tkuid_t\t\tfsuid<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* UID for VFS ops */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tkgid_t\t\tfsgid<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* GID for VFS ops */</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span> __randomize_layout<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"capabilities\"><a class=\"markdownIt-Anchor\" href=\"#capabilities\">#</a> <strong>Capabilities</strong></h3>\n<p>传统 Linux 执行权限检测主要是基于 UID，而且只有两个分类，即 (effective) UID 为 0 的超级用户和其他普通用户。这样一来就会面临权限划分粒度太粗的问题，比如只想让普通用户可以访问 ping 程序，就需要给 ping 文件加上 SETUID 位，如果该可执行文件的实现存在漏洞，就可能被利用造成权限提升。</p>\n<p>因此，从 Linux 2.2 开始，就引入了 capabilities，将超级用户的权限进行切分，并且按需要给普通用户进行分配，解决了传统 UID-0 的局限性。</p>\n<p>capabilities 以任务 (线程) 为单位，还是在上面内核的  <code>struct cred</code>  结构体中，其相关的字段为:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>structcred<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token class-name\">kernel_cap_t</span> cap_inheritable<span class=\"token punctuation\">;</span><span class=\"token comment\">/* caps our children can inherit */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token class-name\">kernel_cap_t</span> cap_permitted<span class=\"token punctuation\">;</span><span class=\"token comment\">/* caps we're permitted */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token class-name\">kernel_cap_t</span> cap_effective<span class=\"token punctuation\">;</span><span class=\"token comment\">/* caps we can actually use */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token class-name\">kernel_cap_t</span> cap_bset<span class=\"token punctuation\">;</span><span class=\"token comment\">/* capability bounding set */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token class-name\">kernel_cap_t</span> cap_ambient<span class=\"token punctuation\">;</span><span class=\"token comment\">/* Ambient capability set */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr>\n<p>从用户空间看，获取、设置线程的系统调用为 <a href=\"https://man7.org/linux/man-pages/man2/capget.2.html\">capget</a>、<a href=\"https://man7.org/linux/man-pages/man2/capset.2.html\">capset</a>，如下所示:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;sys/capability.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">intcapget</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">cap_user_header_t</span> hdrp<span class=\"token punctuation\">,</span><span class=\"token class-name\">cap_user_data_t</span> datap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">intcapset</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">cap_user_header_t</span> hdrp<span class=\"token punctuation\">,</span><span class=\"token class-name\">constcap_user_data_t</span> datap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr>\n<p>参数的结构体定义如下:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> struct__user_cap_header_struct<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t__u32 version<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">int</span> pid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token operator\">*</span><span class=\"token class-name\">cap_user_header_t</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">typedef</span> struct__user_cap_data_struct<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t__u32 effective<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t__u32 permitted<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t__u32 inheritable<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token operator\">*</span><span class=\"token class-name\">cap_user_data_t</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr>\n<p>从定义上看，一共有三类 capability，分别是 effective、permitted 和 inheritable，这和 UID 的设计初衷是类似的，因为进程可以被复制 (fork)，因此增加了 inheritable 的控制。对于每一类 capabilities，由于其类型是 <code>__u32</code> ，每项 capability 通过位与方式进行组合，因此最多可以支持 32 种 capability，其中一些常见的包括:</p>\n<ul>\n<li>CAP_NET_RAW: 创建和使用 RAW/PACKET socket 的权限以及绑定透明代理地址的权限；</li>\n<li>CAP_NET_ADMIN: 各类网关相关的操作，比如网卡接口配置、路由表修改等；</li>\n<li>CAP_SETUID: 设置和修改进程 UID 的权限；</li>\n<li>CAP_SYS_PTRACE: 使用 ptrace 跟踪任意其他进程的能力；</li>\n<li>….</li>\n</ul>\n<p>完整的权限列表可以参考 <a href=\"https://man7.org/linux/man-pages/man7/capabilities.7.html\">capabilities(7)</a>。</p>\n<p>对于系统管理员而言，更多是使用 capsh、getcap、setcap 等命令行工具，不过本质上都是通过 <a href=\"https://git.kernel.org/pub/scm/libs/libcap/libcap.git/\">libcap</a> 对系统调用进行封装实现的。</p>\n<h3 id=\"selinux\"><a class=\"markdownIt-Anchor\" href=\"#selinux\">#</a> selinux</h3>\n<p>ubuntu 安装工具</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sudo apt install policycoreutils</pre></td></tr></table></figure><p>检查 selinux 状态</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ubuntu@VM<span class=\"token operator\">-</span><span class=\"token number\">8</span><span class=\"token operator\">-</span><span class=\"token number\">8</span><span class=\"token operator\">-</span>ubuntu<span class=\"token operator\">:</span><span class=\"token operator\">~</span>$ sestatus <span class=\"token operator\">-</span>v</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>SELinux status<span class=\"token operator\">:</span>                 disabled</pre></td></tr></table></figure><p>setenforce 命令的可能参数有：Enforcing、Permissive、1（启用）或 0（禁用）。</p>\n<figure class=\"highlight jsx\"><figcaption data-lang=\"React JSX\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre># setenforce <span class=\"token number\">0</span></pre></td></tr></table></figure><p>或永久修改：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>vim <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>selinux<span class=\"token operator\">/</span>config</pre></td></tr></table></figure><p>SELinux （Security Enhanced Linux）是由美国 NSA（国安局）和 SCC 开发的 Linux 的一个扩张强制访问控制安全模块，目的是最大限度减少系统中服务进程可访问的资源。Google 在 <strong>Android 4.4 上正式添加以 SELinux 为基础的系统安全机制</strong>，命名为 ** <code>SEAndroid</code> **。SEAndroid 在架构和机制上与 SELinux 完全一样，基于移动设备的特点，SEAndroid 的只是移植 SELinux 的一个子集。</p>\n<p>SELinux 主要作用就是最大限度地减小系统中服务进程可访问的资源（最小权限原则）。</p>\n<p>基于 Android 4.3（宽容模式）和 Android 4.4（部分强制模式），在 Android 5.0 及更高版本中，已全面强制执行 SELinux。通过此项变更，Android 已从对有限的一组关键域（ <code>installd</code> 、 <code>netdvold</code>  和  <code>zygote</code> ）强制执行 SELinux 转为对所有域（超过 60 个）强制执行 SELinux。</p>\n<p><strong>类型强制执行</strong></p>\n<p>SElinux is a labeling system. Every process has a label. Every file/directory object in the operating system has a label. Even network ports, devices, and potentially hostnames have labels assigned to them. We write rules to control the access of a process label to an a object label like a file. We call this <em>policy</em>. The kernel enforces the rules. Sometimes this enforcement is called Mandatory Access Control (MAC).</p>\n<p>The owner of an object does not have discretion over the security attributes of a object. Standard Linux access control, owner/group + permission flags like rwx, is often called Discretionary Access Control (DAC). SELinux has no concept of UID or ownership of files. Everything is controlled by the labels. Meaning an SELinux system can be setup without an all powerful root process.</p>\n<p><strong>Note:</strong> <em>SELinux does not let you side step DAC Controls. SELinux is a parallel enforcement model. An application has to be allowed by BOTH SELinux and DAC to do certain activities. This can lead to confusion for administrators because the process gets Permission Denied. Administrators see Permission Denied means something is wrong with DAC, not SELinux labels.</em></p>\n<p>更多关于 SELinux 细节：<a href=\"https://opensource.com/business/13/11/selinux-policy-guide\">SELinux 可视化指南</a></p>\n<h3 id=\"用户态\"><a class=\"markdownIt-Anchor\" href=\"#用户态\">#</a> 用户态</h3>\n<p>在 SELinux 中，访问控制通过 context 来描述访问权限，例如对于文件系统，可以使用  <code>ls -Z</code>  查看文件对应的标签</p>\n<p>对于网络端口的标签，可以用  <code>netstat -Z</code>  查看；对于进程标签，则可以通过 <code>ps -Z</code>  查看</p>\n<p>context 可以分为几个部分，使用冒号 <code>:</code>  分隔，分别是:</p>\n<ul>\n<li><strong>user</strong>: 表示 SELinux 用户账号，与 Linux 用户账号不同，前者在 policy 中定义，包含多层级权限；</li>\n<li><strong>role</strong>: 定义了主体 (subject) 在特定域 (domain) 中可以对客体 (object) 进行的操作；</li>\n<li><strong>type</strong>: 定义了文件的类型；</li>\n<li>sensitivity: 即最后一个字段，表示涉密等级，范围可以从 c0 到 c1023，c3 表示 <code>Top Secret</code> 。该字段仅在 MLS 模式中使用，用于高敏感度的国防军事机构，对于客户端或者一般数据服务器而言只需保留默认值。</li>\n</ul>\n<p>对一系列系统资源增加标签后，系统就可以根据标签来判断访问是否应该允许，一个示例的访问拒绝日志如下:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token number\">1400</span> audit<span class=\"token punctuation\">(</span><span class=\"token number\">18.250</span>:15<span class=\"token punctuation\">)</span>: avc: denied<span class=\"token punctuation\">&#123;</span> getattr<span class=\"token punctuation\">&#125;</span>forpid<span class=\"token operator\">=</span>939comm<span class=\"token operator\">=</span><span class=\"token string\">\"ls\"</span>path<span class=\"token operator\">=</span><span class=\"token string\">\"/ueventd.rc\"</span>dev<span class=\"token operator\">=</span><span class=\"token string\">\"rootfs\"</span>ino<span class=\"token operator\">=</span>2842scontext<span class=\"token operator\">=</span>u:r:shell:s0tcontext<span class=\"token operator\">=</span>u:object_r:rootfs:s0tclass<span class=\"token operator\">=</span>filepermissive<span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr></table></figure><hr>\n<p>访问权限的判断是在内核中实现的，但是访问规则可以动态生成和更新，内核中只预置了一系列触发点。SELinux 规则 (policy) 通常使用自定义的高级语言去描述，目前正在开发的是 <a href=\"https://github.com/SELinuxProject/cil.git\">CIL(Common Intermediate Language)</a>，但使用更多的是传统的 MLS Statements，比如访问规则的定义如下:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rule_name source_type target_type:class perm_set<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr>\n<p>一个具体的例子:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>allow initrc_t acct_exec_t:file<span class=\"token punctuation\">&#123;</span> getattrread execute<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><hr>\n<p>表示允许拥有 <code>initrc_t</code>  标签类型的主体访问带有 <code>acct_exec_t</code>  标签的目标 <code>文件</code> ，访问权限为 getattr、read 和 write。其中类型是使用 <code>type</code>  关键字定义的，一般使用单独的 <code>file_contexts</code>  文件记录。MLS 的完整语法见 <a href=\"https://selinuxproject.org/page/PolicyLanguage\">Kernel Policy Language Definition Links</a>。</p>\n<p>对于系统管理员而言，常用的相关命令有:</p>\n<ul>\n<li>chcon: 修改目标文件的 SELinux 标签；</li>\n<li>resotrecon: 重新加载 (恢复) 系统文件的 SELinux 标签；</li>\n<li>semanage: 实时修改当前系统的 SELinux 规则；</li>\n<li>…</li>\n</ul>\n<p>使用 MLS 提供的 SELinux Policy 语法，我们可以定义非常细粒度的访问控制，比如根据应用属性甚至签名来控制 IPC 访问。但是与此同时，规则调试也经常困扰 ROM 开发者，有一些脚本比如 <code>audit2allow</code> 、 <code>audit2why</code>  等可以辅助定位和添加规则，不过还是要注意避免添加过度宽泛的权限导致攻击面扩大。</p>\n<h3 id=\"内核态\"><a class=\"markdownIt-Anchor\" href=\"#内核态\">#</a> 内核态</h3>\n<p>前面说 SELinux 是在内核中进行检查的，那么就以打开文件的操作为例来简单分析下 SELinux 的校验过程。打开文件使用的系统调用是 <code>openat</code> ，该系统调用在内核中的大致调用路径如下:</p>\n<ul>\n<li>sys_openat</li>\n<li>do_sys_open</li>\n<li>do_filp_open</li>\n<li>path_openat</li>\n<li>do_last</li>\n<li>may_open</li>\n<li>inode_permission\n<ul>\n<li>do_inode_permission -&gt; generic_permission</li>\n<li>devcgroup_inode_permission</li>\n<li><strong>security_inode_permission</strong></li>\n</ul>\n</li>\n</ul>\n<p>inode_permission 是在文件打开之前检查文件系统 inode 权限的操作，其中包含常规的 DAC 检查、cgroup 权限检查以及我们所关心的 SELinux 检查:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">call_int_hook</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>FUNC<span class=\"token punctuation\">,</span> IRC<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\t\t\t\\\\</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">int</span> RC <span class=\"token operator\">=</span> IRC<span class=\"token punctuation\">;</span>\t\t\t\t\t\t\\\\</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span>\t\t\t\t\t\t\t\\\\</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">security_hook_list</span> <span class=\"token operator\">*</span>P<span class=\"token punctuation\">;</span>\t\t\t\\\\</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t\t\t\t\t\t\t\\\\</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token function\">list_for_each_entry</span><span class=\"token punctuation\">(</span>P<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>security_hook_heads<span class=\"token punctuation\">.</span>FUNC<span class=\"token punctuation\">,</span> list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> \\\\</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\tRC <span class=\"token operator\">=</span> P<span class=\"token operator\">-></span>hook<span class=\"token punctuation\">.</span><span class=\"token function\">FUNC</span><span class=\"token punctuation\">(</span>__VA_ARGS__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\\\\</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>RC <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\t\t\t\t\\\\</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\t\t\t\t\\\\</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span>\t\t\t\t\t\t\\\\</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\t\t\t\t\t\t\\\\</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tRC<span class=\"token punctuation\">;</span>\t\t\t\t\t\t\t\\\\</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">security_inode_permission</span><span class=\"token punctuation\">(</span>structinode<span class=\"token operator\">*</span>inode<span class=\"token punctuation\">,</span>intmask<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">unlikely</span><span class=\"token punctuation\">(</span><span class=\"token function\">IS_PRIVATE</span><span class=\"token punctuation\">(</span>inode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">call_int_hook</span><span class=\"token punctuation\">(</span>inode_permission<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>inode<span class=\"token punctuation\">,</span>mask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr>\n<p><strong>struct security_hook_heads</strong> 是一个结构体，其中包含一系列链表，每个链表都对应一类 SELinux hook:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">security_hook_heads</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> binder_set_context_mgr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> binder_transaction<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> binder_transfer_binder<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> binder_transfer_file<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> ptrace_access_check<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> ptrace_traceme<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> capget<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> capset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">//...</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> inode_permission<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr>\n<p>每个链表都是在内核启动时进行初始化的， <code>inode_permission</code>  也不例外。在 <code>security/linux/hooks.c</code>  中定义了静态数组 <code>selinux_hooks</code> :</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">security_hook_listselinux_hooks</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">LSM_HOOK_INIT</span><span class=\"token punctuation\">(</span>binder_set_context_mgr<span class=\"token punctuation\">,</span>selinux_binder_set_context_mgr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">LSM_HOOK_INIT</span><span class=\"token punctuation\">(</span>binder_transaction<span class=\"token punctuation\">,</span>selinux_binder_transaction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">LSM_HOOK_INIT</span><span class=\"token punctuation\">(</span>binder_transfer_binder<span class=\"token punctuation\">,</span>selinux_binder_transfer_binder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">LSM_HOOK_INIT</span><span class=\"token punctuation\">(</span>binder_transfer_file<span class=\"token punctuation\">,</span>selinux_binder_transfer_file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">LSM_HOOK_INIT</span><span class=\"token punctuation\">(</span>ptrace_access_check<span class=\"token punctuation\">,</span>selinux_ptrace_access_check<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">LSM_HOOK_INIT</span><span class=\"token punctuation\">(</span>ptrace_traceme<span class=\"token punctuation\">,</span>selinux_ptrace_traceme<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">LSM_HOOK_INIT</span><span class=\"token punctuation\">(</span>capget<span class=\"token punctuation\">,</span>selinux_capget<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">LSM_HOOK_INIT</span><span class=\"token punctuation\">(</span>capset<span class=\"token punctuation\">,</span>selinux_capset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">LSM_HOOK_INIT</span><span class=\"token punctuation\">(</span>inode_permission<span class=\"token punctuation\">,</span>selinux_inode_permission<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// ...</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr>\n<p>因此，selinux_inode_permission 就是实际进行 SELinux 检查的函数:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">selinux_inode_permission</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">inode</span> <span class=\"token operator\">*</span>inode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> mask<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">cred</span> <span class=\"token operator\">*</span>cred <span class=\"token operator\">=</span> <span class=\"token function\">current_cred</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tu32 perms<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tbool from_access<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> flags <span class=\"token operator\">=</span> mask <span class=\"token operator\">&amp;</span> MAY_NOT_BLOCK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">inode_security_struct</span> <span class=\"token operator\">*</span>isec<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tu32 sid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">av_decision</span> avd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">int</span> rc<span class=\"token punctuation\">,</span> rc2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tu32 audited<span class=\"token punctuation\">,</span> denied<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tfrom_access <span class=\"token operator\">=</span> mask <span class=\"token operator\">&amp;</span> MAY_ACCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\tmask <span class=\"token operator\">&amp;=</span> <span class=\"token punctuation\">(</span>MAY_READ<span class=\"token operator\">|</span>MAY_WRITE<span class=\"token operator\">|</span>MAY_EXEC<span class=\"token operator\">|</span>MAY_APPEND<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">/* No permission to check.  Existence test. */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mask<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token function\">validate_creds</span><span class=\"token punctuation\">(</span>cred<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">unlikely</span><span class=\"token punctuation\">(</span><span class=\"token function\">IS_PRIVATE</span><span class=\"token punctuation\">(</span>inode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tperms <span class=\"token operator\">=</span> <span class=\"token function\">file_mask_to_av</span><span class=\"token punctuation\">(</span>inode<span class=\"token operator\">-></span>i_mode<span class=\"token punctuation\">,</span> mask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\tsid <span class=\"token operator\">=</span> <span class=\"token function\">cred_sid</span><span class=\"token punctuation\">(</span>cred<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tisec <span class=\"token operator\">=</span> inode<span class=\"token operator\">-></span>i_security<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\trc <span class=\"token operator\">=</span> <span class=\"token function\">avc_has_perm_noaudit</span><span class=\"token punctuation\">(</span>sid<span class=\"token punctuation\">,</span> isec<span class=\"token operator\">-></span>sid<span class=\"token punctuation\">,</span> isec<span class=\"token operator\">-></span>sclass<span class=\"token punctuation\">,</span> perms<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>avd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\taudited <span class=\"token operator\">=</span> <span class=\"token function\">avc_audit_required</span><span class=\"token punctuation\">(</span>perms<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>avd<span class=\"token punctuation\">,</span> rc<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\t     from_access <span class=\"token operator\">?</span> FILE__AUDIT_ACCESS <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\t     <span class=\"token operator\">&amp;</span>denied<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">likely</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>audited<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> rc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\trc2 <span class=\"token operator\">=</span> <span class=\"token function\">audit_inode_permission</span><span class=\"token punctuation\">(</span>inode<span class=\"token punctuation\">,</span> perms<span class=\"token punctuation\">,</span> audited<span class=\"token punctuation\">,</span> denied<span class=\"token punctuation\">,</span> rc<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rc2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> rc2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token keyword\">return</span> rc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr>\n<p>这里有几个值得注意的地方，一个是 selinux_hooks 中注册了很多回调列表，这些模块就是内核中预置的检查点；另外，在  <code>selinux_inode_permission</code>  函数中，使用  <code>file_mask_to_av</code>  来将打开文件的 flag 转换成 SELinux 对应的访问动作 (Access Vector):</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Convert a Linux mode and permission mask to an access vector. */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> u32 <span class=\"token function\">file_mask_to_av</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> mode<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> mask<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tu32 av <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">S_ISDIR</span><span class=\"token punctuation\">(</span>mode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mask <span class=\"token operator\">&amp;</span> MAY_EXEC<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\tav <span class=\"token operator\">|=</span> FILE__EXECUTE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mask <span class=\"token operator\">&amp;</span> MAY_READ<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\tav <span class=\"token operator\">|=</span> FILE__READ<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mask <span class=\"token operator\">&amp;</span> MAY_APPEND<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\tav <span class=\"token operator\">|=</span> FILE__APPEND<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mask <span class=\"token operator\">&amp;</span> MAY_WRITE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\tav <span class=\"token operator\">|=</span> FILE__WRITE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mask <span class=\"token operator\">&amp;</span> MAY_EXEC<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tav <span class=\"token operator\">|=</span> DIR__SEARCH<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mask <span class=\"token operator\">&amp;</span> MAY_WRITE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\tav <span class=\"token operator\">|=</span> DIR__WRITE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mask <span class=\"token operator\">&amp;</span> MAY_READ<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\tav <span class=\"token operator\">|=</span> DIR__READ<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token keyword\">return</span> av<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr>\n<p>这些宏定义在  <code>&lt;build&gt;/security/selinux/av_permissions.h</code>  中，是编译内核时自动生成的。在确认该次访问需要审计后，就接着调用 audit_inode_permission -&gt; slow_avc_audit 进行实际的判断了。因为这类访问控制判断需要频繁调用，出于性能考虑判断过程所使用的访问规则预先编译好并已经加载到内核缓存中，称为 avc (Access Vector Cache)，这也是前面日志中 avc 的来源。</p>\n<p>参考：</p>\n<p><a href=\"https://opensource.com/business/13/11/selinux-policy-guide\">Your visual how-to guide for SELinux policy enforcement | Opensource.com</a></p>\n<p><a href=\"https://evilpan.com/2020/12/06/android-rooting/#selinux\">Android/Linux Root 的那些事儿 - 有价值炮灰 (evilpan.com)</a></p>\n<p><a href=\"https://blog.lleavesg.top/article/AVSS-SELinux#8165d4e544a74b898fa460d5e9357293\">2023AVSS-SELinux 题目 | LLeaves Blog (lleavesg.top)</a></p>\n<p><a href=\"https://blog.csdn.net/stone_gentle/article/details/128707024\">Android 中的 SELinux_android selinux-CSDN 博客</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/165974960\">一文彻底明白 linux 中的 selinux 到底是什么 - 知乎 (zhihu.com)</a></p>\n",
            "tags": [
                "re Android linux"
            ]
        }
    ]
}